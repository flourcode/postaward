<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post Award - Federal Contract Intelligence</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
  <style>
    :root {
      /* Enhanced Colors - Softer, more modern feel */
      --primary: #007AFF; /* Apple's Blue */
      --primary-dark: #0056b3;
      --primary-light: #58a6ff;
      --secondary: #8A8A8E; /* Apple's Gray */
      --success: #34C759; /* Apple's Green */
      --warning: #FF9500; /* Apple's Orange */
      --danger: #FF3B30;  /* Apple's Red */

      --text-primary: #1d1d1f; /* Near Black for high contrast text */
      --text-secondary: #6e6e73;
      --text-tertiary: #86868b;
      
      --bg-primary: #ffffff; /* Main background for light mode */
      --bg-secondary: #f2f2f7; /* Slightly off-white for secondary elements */
      --bg-tertiary: #e5e5ea;
      --border: #d1d1d6; /* Softer border color */
      --app-bg: #f2f2f7; /* Overall app background */
      
      /* Spacing - consistent rhythm */
      --space-1: 0.25rem; /* 4px */
      --space-2: 0.5rem;  /* 8px */
      --space-3: 0.75rem; /* 12px */
      --space-4: 1rem;    /* 16px */
      --space-5: 1.25rem; /* 20px */
      --space-6: 1.5rem;  /* 24px */
      --space-7: 1.75rem; /* 28px */
      --space-8: 2rem;    /* 32px */
      --space-10: 2.5rem; /* 40px */
      --space-12: 3rem;   /* 48px */

      /* Typography */
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      --font-xs: 0.75rem;   /* 12px */
      --font-sm: 0.875rem;  /* 14px */
      --font-base: 1rem;    /* 16px */
      --font-lg: 1.125rem;  /* 18px */
      --font-xl: 1.25rem;   /* 20px */
      --font-2xl: 1.5rem;   /* 24px */
      --font-3xl: 1.875rem; /* 30px */
      --font-4xl: 2.25rem;  /* 36px */

      /* Radiuses and Shadows - More subtle */
      --radius-sm: 4px;
      --radius: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 1px 0 rgba(0,0,0,0.02);
      --shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.04), 0 1px 2px 0 rgba(0,0,0,0.03);
      --shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0,0,0,0.04);
      --shadow-lg: 0 10px 20px -5px rgba(0, 0, 0, 0.06), 0 4px 10px -4px rgba(0,0,0,0.05);
      
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
/* Theme-specific overrides */
[data-theme="light"] {
  --primary: #007AFF;
  --primary-dark: #0056b3;
  --primary-light: #58a6ff;
  --secondary: #8A8A8E;
  --success: #34C759;
  --warning: #FF9500;
  --danger: #FF3B30;

  --text-primary: #1d1d1f;
  --text-secondary: #6e6e73;
  --text-tertiary: #86868b;
  
  --bg-primary: #ffffff; /* Main background for light mode */
  --bg-secondary: #f2f2f7; /* Slightly off-white for secondary elements */
  --bg-tertiary: #e5e5ea;
  --border: #d1d1d6;
  --app-bg: #f2f2f7;
}
    [data-theme="dark"] {
      --primary: #0A84FF; /* Apple's Blue (Dark Mode) */
      --primary-dark: #005ecb;
      --primary-light: #64b5f6;
      --secondary: #8E8E93;
      --success: #30D158;
      --warning: #FF9F0A;
      --danger: #FF453A;

      --text-primary: #ffffff;
      --text-secondary: #aeaeb2;
      --text-tertiary: #8e8e93;
      
      --bg-primary: #1c1c1e; /* Main background for dark mode (e.g. header) */
      --bg-secondary: #2c2c2e; /* Secondary elements (e.g. dashboard area) */
      --bg-tertiary: #3a3a3c;
      --border: #48484a;
	    --app-bg: #000000; /* True black for app background in dark mode */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow-x: hidden; 
    }

    body {
      font-family: var(--font-sans);
      background-color: var(--app-bg);
      color: var(--text-primary);
      line-height: 1.6; /* Slightly increased for readability */
      font-size: var(--font-base);
    }

    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      width: 100%; 
      margin: 0 auto; 
      max-width: 1900px; 
      padding: 0; 
    }

    /* Header Section */
    .app-header {
      background-color: var(--bg-primary);
      box-shadow: var(--shadow-md); /* Softer shadow */
      padding: var(--space-4) var(--space-6); 
      position: sticky;
      top: 0;
      z-index: 100; /* Higher z-index */
      display: flex;
      flex-direction: column;
      gap: var(--space-4); 
    }

    .header-main-content-row {
      display: flex;
      justify-content: space-between;
      align-items: center; /* Vertically center title and theme toggle */
      gap: var(--space-4); 
      position: relative; 
    }
    .header-main-content-row .logo-container { flex-grow: 1; }
    .logo-main-line { display: flex; align-items: center; gap: var(--space-2); }
    .logo-main-line > i { font-size: var(--font-3xl); color: var(--primary); } /* Primary color for icon */
    .logo-main-line > span { font-size: var(--font-3xl); font-weight: 600; color: var(--text-primary); }
    .header-main-content-row .logo-subtitle {
      font-size: var(--font-sm);
      color: var(--text-secondary);
      line-height: 1.5;
      margin-top: var(--space-1);
      max-width: 600px; /* Prevent subtitle from becoming too wide */
    }
    .header-actions { flex-shrink: 0; }

    /* Data Load Controls */
    .data-load-controls .example-csv-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-3);
      align-items: center;
    }
     .data-load-controls .example-csv-buttons .btn {
        font-weight: 500;
    }

    /* Status and Active Filters */
    .status-and-active-filters { 
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      padding: var(--space-3) 0; /* Add some vertical padding */
      border-bottom: 1px solid var(--border); /* Separator */
      margin-bottom: var(--space-3);
    }
    .status-and-active-filters .status-title {
        font-size: var(--font-2xl); 
        font-weight: 600;
        color: var(--text-primary);
    }
    .status-and-active-filters .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2); 
    }
    .filter-tag {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      background-color: var(--bg-tertiary);
      border-radius: var(--radius); /* Slightly more rounded */
      font-size: var(--font-xs);
      font-weight: 500;
      color: var(--text-secondary);
      transition: var(--transition);
    }
    .filter-tag:hover {
        background-color: var(--primary);
        color: white;
    }
    .filter-tag-remove {
      background: none; border: none; color: inherit; /* Inherit color from parent */
      cursor: pointer; display: flex; align-items: center; margin-left: var(--space-1);
    }
    .filter-tag:hover .filter-tag-remove { color: white; }


    /* Primary Controls: Search & Filters */
    .primary-controls-area {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    .main-filter-inputs {
      display: flex;
      flex-direction: column;
      gap: var(--space-3); /* Increased gap for better touch targets on mobile */
    }
    .main-filter-inputs > .search-bar,
    .main-filter-inputs > .filter-group {
      width: 100%;
    }
    .search-bar { position: relative; width: 100%; }
    .search-input {
      width: 100%; padding: var(--space-3) var(--space-4) var(--space-3) var(--space-8); /* More padding */
      border: 1px solid var(--border); border-radius: var(--radius-md); 
      background-color: var(--bg-secondary); color: var(--text-primary); 
      font-size: var(--font-base); transition: var(--transition);
    }
    .search-input::placeholder { color: var(--text-tertiary); }
    .search-icon { position: absolute; left: var(--space-4); top: 50%; transform: translateY(-50%); color: var(--text-tertiary); font-size: var(--font-lg); }
    .search-input:focus { 
        outline: none; border-color: var(--primary); 
        background-color: var(--bg-primary);
        box-shadow: 0 0 0 3px rgba(var(--primary), 0.1); 
    }

    .filter-group { display: flex; flex-direction: column; width: 100%; gap: var(--space-1); }
    .filter-label { font-size: var(--font-sm); color: var(--text-primary); font-weight: 500; margin-bottom: var(--space-1); }
    .filter-select {
      width: 100%; padding: var(--space-3); border: 1px solid var(--border); border-radius: var(--radius-md);
      background-color: var(--bg-secondary); color: var(--text-primary); font-size: var(--font-base); appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236e6e73'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right var(--space-3) center; background-size: 1.25em; padding-right: var(--space-8);
      transition: var(--transition);
    }
    .filter-select:focus { 
        outline: none; border-color: var(--primary); 
        background-color: var(--bg-primary);
        box-shadow: 0 0 0 3px rgba(var(--primary), 0.1);
    }
    .filter-actions { display: flex; gap: var(--space-3); justify-content: flex-start; }


    /* Advanced Filters Panel */
    #advancedFiltersPanel {
      background-color: var(--bg-secondary); /* Consistent with other secondary backgrounds */
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-6); 
      margin-top: var(--space-4); 
      display: none;
    }
    #advancedFiltersPanel.active { display: block; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); }
    .panel-header h3 { font-size: var(--font-2xl); font-weight: 600; color: var(--text-primary); }
    .filters-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-4); }
    .filter-date {
      flex: 1; min-width: 0; padding: var(--space-3); border: 1px solid var(--border);
      border-radius: var(--radius-md); background-color: var(--bg-primary);
      color: var(--text-primary); font-size: var(--font-base);
    }

    /* Buttons - Polished */
    .btn {
      padding: var(--space-3) var(--space-4); 
      border-radius: var(--radius-md); 
      font-weight: 500;
      cursor: pointer; transition: var(--transition); font-size: var(--font-base);
      display: inline-flex; align-items: center; justify-content: center;
      gap: var(--space-2); white-space: nowrap; border: 1px solid transparent; 
      box-shadow: var(--shadow-sm);
      line-height: 1; /* For better vertical alignment of text and icon */
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn:active { transform: translateY(0px); box-shadow: var(--shadow-sm); }

    .btn-primary { background-color: var(--primary); color: white; border-color: var(--primary); }
    .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
    
    .btn-secondary { 
        background-color: var(--bg-primary); 
        color: var(--primary); /* Use primary color for text for better affordance */
        border-color: var(--primary); /* Border with primary color */
    }
    .btn-secondary:hover { 
        background-color: var(--primary-light);
        color: white;
        border-color: var(--primary-light);
    }
    [data-theme="dark"] .btn-secondary {
        background-color: var(--bg-tertiary);
        color: var(--primary-light);
        border-color: var(--primary-light);
    }
    [data-theme="dark"] .btn-secondary:hover {
        background-color: var(--primary);
        color: var(--text-primary);
        border-color: var(--primary);
    }

    .btn-sm { padding: var(--space-2) var(--space-3); font-size: var(--font-sm); }
    .btn-icon {
      padding: var(--space-2); border-radius: 50%; display: flex; align-items: center; justify-content: center;
      background: transparent; border: none; color: var(--text-secondary); cursor: pointer; transition: var(--transition);
      box-shadow: none;
    }
    .btn-icon:hover { background-color: var(--bg-tertiary); color: var(--text-primary); box-shadow: none; transform: none;}
    .theme-toggle { font-size: var(--font-xl); }


    /* Main Dashboard - Integrated Look */
    main#dashboard {
      flex-grow: 1; 
      padding: var(--space-6) var(--space-4); /* Add horizontal padding here */
      background-color: var(--bg-secondary); /* Dashboard area distinct from app-bg */
      display: flex; 
      flex-direction: column;
      gap: var(--space-6); /* Generous gap between main sections */
      overflow-y: auto; 
    }
    /* Section headers for charts/tables if card-header is removed */
    .dashboard-section-header {
        font-size: var(--font-2xl);
        font-weight: 600;
        color: var(--text-primary);
        padding-bottom: var(--space-3);
        border-bottom: 1px solid var(--border);
        margin-bottom: var(--space-4);
    }

    /* Stats - Integrated */
    .stats-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); }
    .stat-card {
      background-color: var(--bg-primary); /* Keep individual stat backgrounds for clarity */
      border-radius: var(--radius-lg);
      padding: var(--space-4); 
      box-shadow: var(--shadow);
      text-align: left; /* Align text left for a cleaner look */
    }
    .stat-label { font-size: var(--font-sm); color: var(--text-secondary); margin-bottom: var(--space-1); }
    .stat-value { font-size: var(--font-3xl); font-weight: 600; color: var(--text-primary); line-height: 1.1; }

    /* Sankey, Charts, Tables - Removing Card Shells */
    .primary-viz, .charts-grid-container, .tables-section-container {
      background-color: var(--bg-primary);
      padding: var(--space-6);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }
    .sankey-chart-container { height: 350px; /* Adjusted height */ }
    .chart-container, .bubble-chart-container { height: 280px; /* Adjusted height */ }
    .sankey-controls { /* No changes, styling seems fine */ }
    
    .charts-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-6); }

    .tables-section .tabs { 
        border-bottom: 2px solid var(--border); /* Stronger tab baseline */
        margin-bottom: var(--space-4);
    }
    .tables-section .tab-btn {
      padding: var(--space-3) var(--space-4);
      font-weight: 500; 
      font-size: var(--font-base);
      color: var(--text-secondary); 
      position: relative; 
      border-bottom: 2px solid transparent; /* For active state */
      margin-bottom: -2px; /* Align with parent border */
    }
    .tables-section .tab-btn:hover { color: var(--primary); }
    .tables-section .tab-btn.active { 
        color: var(--primary); 
        border-bottom-color: var(--primary);
    }
    .tables-section .tab-btn.active::after { content: none; } /* Remove old underline */
    
    .data-table th, .data-table td { padding: var(--space-3) var(--space-4); }
    .data-table th { background-color: var(--bg-secondary); } /* Subtle header background */


    /* Loading, Error, Empty States - Centered within dashboard scroll area */
    .loading-state, .empty-state, .error-message {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: var(--space-8); text-align: center; 
      margin: var(--space-4) 0; /* Vertical margin only */
      width: 100%;
    }
    .loading-state, .empty-state { background-color: transparent; /* No card bg */ }
    .error-message { 
        background-color: var(--danger-light, rgba(255,59,48,0.1)); 
        color: var(--danger); 
        border: 1px solid var(--danger); 
        border-radius: var(--radius-md);
        max-width: 800px; /* Constrain width */
        margin-left: auto; margin-right: auto;
    }
    [data-theme="dark"] .error-message { background-color: rgba(255,69,58,0.15); }


    /* Modal - Enhanced */
    .modal-backdrop { 
      background-color: rgba(0, 0, 0, 0.7); /* Darker backdrop */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s linear 0.3s, opacity 0.3s ease;
    }
    .modal-backdrop.active {
      visibility: visible;
      opacity: 1;
      transition-delay: 0s;
    }
    .modal {
      background-color: var(--bg-primary); 
      border-radius: var(--radius-lg);
      width: 90%; 
      max-width: 700px; 
      max-height: 90vh; 
      overflow: auto; /* Ensure scroll */
      box-shadow: var(--shadow-lg); 
      transform: translateY(0) scale(1); /* Initial state for smoother entry */
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal-backdrop:not(.active) .modal {
        transform: translateY(20px) scale(0.98);
        opacity: 0;
    }
    .modal-header { 
      padding: var(--space-6); 
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title { font-size: var(--font-2xl); font-weight: 600; }
    .modal-close {
      background: none;
      border: none;
      font-size: var(--font-xl);
      color: var(--text-secondary);
      cursor: pointer;
    }
    .modal-body { padding: var(--space-6); }
    .modal-footer { 
      padding: var(--space-4) var(--space-6); 
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
    }


    /* Mobile FAB - Keep as is, generally a good UX pattern */
    .mobile-action-btn {
      position: fixed; bottom: var(--space-6); right: var(--space-6); width: 60px; height: 60px; /* Slightly larger */
      border-radius: 50%; background-color: var(--primary); color: white; border: none;
      box-shadow: var(--shadow-lg); display: flex; align-items: center; justify-content: center;
      font-size: var(--font-2xl); cursor: pointer; z-index: 900; transition: var(--transition);
    }
    .mobile-action-btn:hover { background-color: var(--primary-dark); transform: scale(1.08); }

    /* Table Styling */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      text-align: left;
      cursor: pointer;
      position: relative;
    }
    .data-table th.sort-asc::after,
    .data-table th.sort-desc::after {
      content: '';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
    }
    .data-table th.sort-asc::after {
      border-bottom: 5px solid var(--primary);
    }
    .data-table th.sort-desc::after {
      border-top: 5px solid var(--primary);
    }
    .data-table tr:nth-child(even) {
      background-color: var(--bg-secondary);
    }
    .data-table tr:hover {
      background-color: var(--bg-tertiary);
    }
    .data-table td {
      border-top: 1px solid var(--border);
    }
    .data-table .money {
      text-align: right;
      font-weight: 500;
    }

    /* Entity Badges */
    .agency-badge,
    .office-badge,
    .vendor-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: 500;
    }

    .agency-icon {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%; /* Circle */
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xs);
      font-weight: 600;
      flex-shrink: 0; /* Prevents the icon from shrinking */
    }

    .office-icon {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: var(--radius-sm); /* Rounded square for offices too */
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xs);
      font-weight: 600;
      flex-shrink: 0; /* Prevents the icon from shrinking */
    }

    .vendor-icon {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 0; /* Rounded square */
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xs);
      font-weight: 600;
      flex-shrink: 0; /* Prevents the icon from shrinking */
    }
	
    .badge {
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--font-xs);
      font-weight: 500;
      display: inline-block;
    }

    .badge-primary {
      background-color: rgba(0, 112, 243, 0.1);
      color: var(--primary);
    }

    /* Chart tooltip */
    .chart-tooltip {
      position: absolute;
      display: none;
      background-color: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      box-shadow: var(--shadow-md);
      pointer-events: none;
      z-index: 100;
      max-width: 250px;
    }

    /* Selection indicator */
    .selection-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--primary);
      display: none;
    }

    /* Loading spinner */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--space-4);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }


    /* RESPONSIVE ADJUSTMENTS */
    @media (max-width: 767px) { 
      .app-header { padding: var(--space-4) var(--space-3); gap: var(--space-3); }
      .header-main-content-row .header-actions { position: absolute; top: calc(var(--space-4) - var(--space-1)); right: var(--space-3); }
      .header-main-content-row .logo-container { padding-right: 50px; } 
      .logo-subtitle {
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        overflow: hidden; text-overflow: ellipsis;
        font-size: 0.65rem; 
        margin-top: var(--space-1);
      }
      .logo-main-line > i { font-size: var(--font-2xl); }
      .logo-main-line > span { font-size: var(--font-2xl); }
      .status-and-active-filters .status-title { font-size: var(--font-xl); }

      .data-load-controls .example-csv-buttons { justify-content: center; }
      .data-load-controls .example-csv-buttons .btn { min-width: 100px; }
      
      .main-filter-inputs { gap: var(--space-3); }
      .filter-actions { justify-content: center; }
      .filter-actions .btn { flex-grow: 1; max-width: 180px;}

      main#dashboard { padding: var(--space-4) var(--space-3); gap: var(--space-4); }
      .stats-row { gap: var(--space-3); }
      .stat-card { padding: var(--space-3); }
      .stat-value { font-size: var(--font-2xl); }

      .primary-viz, .charts-grid-container, .tables-section-container {
        padding: var(--space-4);
      }
      .charts-grid { gap: var(--space-4); }
      .sankey-chart-container { height: 280px; }
      .chart-container, .bubble-chart-container { height: 220px; }
    }

    @media (min-width: 768px) { 
      .app-header {
        padding: var(--space-4) var(--space-6); 
        gap: var(--space-4); 
      }
      .header-main-content-row .header-actions { 
        position: static;
        padding-top: 0; 
      }
	  .header-main-content-row .logo-container { padding-right: 0; }
      .logo-subtitle { 
        display: block; -webkit-line-clamp: unset; font-size: var(--font-sm);
      }

      .primary-controls-area {
        flex-direction: row;
        align-items: flex-end; /* Align filter groups and action buttons nicely */
        gap: var(--space-4);
      }
      .main-filter-inputs {
        flex-grow: 1;
        flex-direction: row;
        gap: var(--space-3);
        align-items: flex-end;
      }
      .main-filter-inputs > .search-bar { flex: 2 1 280px; width: auto; } /* More specific basis */
      .main-filter-inputs > .filter-group { flex: 1 1 200px; width: auto; } /* More specific basis */
      .filter-actions { justify-content: flex-end; flex-shrink: 0; }

      .filters-grid { grid-template-columns: repeat(2, 1fr); gap: var(--space-4); }
      .stats-row { grid-template-columns: repeat(2, 1fr); gap: var(--space-4); } /* 2 stats on tablet */
      .charts-grid { grid-template-columns: repeat(2, 1fr); gap: var(--space-4); }
      .sankey-chart-container { height: 400px; }
      .mobile-action-btn { display: none; }
    }

    @media (min-width: 1024px) { 
        .stats-row { grid-template-columns: repeat(4, 1fr); } /* 4 stats on desktop */
    }
    @media (min-width: 1280px) { /* Larger Desktop */
      .app-header { padding: var(--space-6) var(--space-8); }
      main#dashboard { padding: var(--space-8); gap: var(--space-8); }
      .main-filter-inputs > .search-bar { flex-basis: 350px; }
      .main-filter-inputs > .filter-group { flex-basis: 220px; }
      .filters-grid { grid-template-columns: repeat(4, 1fr); } 
      .charts-grid { grid-template-columns: repeat(4, 1fr); }
      .primary-viz, .charts-grid-container, .tables-section-container {
        padding: var(--space-8);
      }
    }
	.file-input {
    display: none;
}
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}
/* Table Tabs Styling */
.tables-section .tabs {
  border-bottom: 2px solid var(--border);
  margin-bottom: var(--space-4);
  background-color: transparent; /* Ensure no background color */
}

.tables-section .tab-btn {
  padding: var(--space-3) var(--space-4);
  font-weight: 500;
  font-size: var(--font-base);
  color: var(--text-secondary);
  background-color: transparent;
  border: none;
  position: relative;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  cursor: pointer;
  transition: var(--transition);
}

.tables-section .tab-btn:hover {
  color: var(--primary);
}

.tables-section .tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

/* Adjust container backgrounds for light/dark modes */
[data-theme="dark"] .primary-viz,
[data-theme="dark"] .charts-grid-container,
[data-theme="dark"] .tables-section-container {
  background-color: var(--bg-primary);
}

[data-theme="light"] .primary-viz,
[data-theme="light"] .charts-grid-container,
[data-theme="light"] .tables-section-container {
  background-color: var(--bg-primary);
  box-shadow: var(--shadow);
}

/* Cohesive wrapper for both light and dark modes */
main#dashboard {
  flex-grow: 1;
  padding: var(--space-6) var(--space-4);
  background-color: var(--bg-secondary);
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
  overflow-y: auto;
}

/* Additional styling for table container for better visual appearance */
.tab-content {
  background-color: var(--bg-primary);
  border-radius: 0 0 var(--radius-lg) var(--radius-lg);
  overflow: hidden;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
}

/* Make table headers more distinct */
.data-table th {
  background-color: var(--bg-secondary);
  color: var(--text-primary);
  font-weight: 600;
  text-align: left;
  padding: var(--space-3) var(--space-4);
  border-bottom: 1px solid var(--border);
}

/* Style table rows */
.data-table td {
  padding: var(--space-3) var(--space-4);
  border-top: 1px solid var(--border);
  color: var(--text-primary);
}

.data-table tr:nth-child(even) {
  background-color: var(--bg-secondary);
}

.data-table tr:hover {
  background-color: var(--bg-tertiary);
}
:root {
  /* Base colors for light theme */
  --primary: #007AFF; 
  --primary-dark: #0056b3;
  --primary-light: #58a6ff;
  --secondary: #8A8A8E; 
  --success: #34C759; 
  --warning: #FF9500; 
  --danger: #FF3B30;  

  --text-primary: #1d1d1f; 
  --text-secondary: #6e6e73;
  --text-tertiary: #86868b;
  
  --bg-primary: #ffffff; /* Card background - pure white */
  --bg-secondary: #f7f7f9; /* Middle layer - very light grayish-white */
  --bg-tertiary: #e5e5ea;
  --border: #d1d1d6; 
  --app-bg: #eaeaef; /* App background - light gray with slight blue tint */
}

[data-theme="dark"] {
  --primary: #0A84FF; 
  --primary-dark: #005ecb;
  --primary-light: #64b5f6;
  --secondary: #8E8E93;
  --success: #30D158;
  --warning: #FF9F0A;
  --danger: #FF453A;

  --text-primary: #ffffff;
  --text-secondary: #aeaeb2;
  --text-tertiary: #8e8e93;
  
  --bg-primary: #1c1c1e; /* Card background in dark mode */
  --bg-secondary: #2c2c2e; /* Secondary elements background */
  --bg-tertiary: #3a3a3c;
  --border: #48484a;
  --app-bg: #000000; /* Darkest black for app background */
}
/* First row: Sankey and Value by Month */
.primary-viz-row {
  background-color: var(--bg-primary);
  padding: var(--space-6);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  margin-bottom: var(--space-2);
}

.primary-viz-container {
  display: flex;
  flex-direction: row;
  gap: var(--space-4);
  width: 100%;
  height: 450px; /* Adjust as needed */
}

.sankey-wrapper {
  flex: 2; /* Takes 2/3 of the available space */
  height: 100%;
}

.month-chart-wrapper {
  flex: 1; /* Takes 1/3 of the available space */
  height: 100%;
  display: flex;
  flex-direction: column;
}

.month-chart-wrapper .chart-container {
  flex-grow: 1;
  width: 100%;
}

.month-chart-wrapper .chart-title-integrated {
  margin-bottom: var(--space-2);
  font-size: var(--font-lg);
  font-weight: 600;
}

.sankey-chart-container {
  height: 100%;
  width: 100%;
}

/* Second row: Three equal charts */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* Three equal columns */
  gap: var(--space-6);
  width: 100%;
}

.chart-item {
  width: 100%;
}

.chart-container, .bubble-chart-container {
  height: 280px;
  width: 100%;
}

/* Media query for mobile */
@media (max-width: 767px) {
  .primary-viz-container {
    flex-direction: column;
    height: auto;
  }
  
  .sankey-wrapper, .month-chart-wrapper {
    width: 100%;
  }
  
  .sankey-wrapper {
    height: 280px;
  }
  
  .month-chart-wrapper .chart-container {
    height: 220px;
  }
  
  .charts-grid {
    grid-template-columns: 1fr; /* Stack on mobile */
    gap: var(--space-4);
  }
}

/* Media query for tablets */
@media (min-width: 768px) and (max-width: 1023px) {
  .charts-grid {
    grid-template-columns: repeat(2, 1fr); /* Two columns on tablet */
  }
}
/* Theme Toggle Switch - Sun/Moon */
#darkmode-toggle {
  width: 0;
  height: 0;
  visibility: hidden;
}

#themeToggle {
  width: 60px;
  height: 30px;
  position: relative;
  display: block;
  background: #ebebeb;
  border-radius: 30px;
  box-shadow: inset 0px 2px 5px rgba(0, 0, 0, 0.4),
    inset 0px -2px 5px rgba(255, 255, 255, 0.4);
  cursor: pointer;
  transition: 0.3s;
}

#themeToggle:after {
  content: "";
  width: 26px;
  height: 26px;
  position: absolute;
  top: 2px;
  left: 2px;
  background: linear-gradient(180deg, #ffcc89, #d8860b);
  border-radius: 50%;
  box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
  transition: 0.3s;
}

#themeToggle svg {
  position: absolute;
  width: 14px;
  top: 8px;
  z-index: 100;
}

#themeToggle svg.sun {
  left: 8px;
  fill: #fff;
  transition: 0.3s;
}

#themeToggle svg.moon {
  left: 38px;
  fill: #7e7e7e;
  transition: 0.3s;
}

#darkmode-toggle:checked + #themeToggle {
  background: #242424;
}

#darkmode-toggle:checked + #themeToggle:after {
  left: 58px;
  transform: translateX(-100%);
  background: linear-gradient(180deg, #777, #3a3a3a);
}

#darkmode-toggle:checked + #themeToggle svg.sun {
  fill: #7e7e7e;
}

#darkmode-toggle:checked + #themeToggle svg.moon {
  fill: #fff;
}

#darkmode-toggle:active + #themeToggle:after {
  width: 35px;
}

/* Responsive adjustments */
@media (max-width: 767px) {
  #themeToggle {
    width: 50px;
    height: 25px;
  }
  
  #themeToggle:after {
    width: 21px;
    height: 21px;
  }
  
  #themeToggle svg {
    width: 12px;
    top: 6px;
  }
  
  #themeToggle svg.sun {
    left: 6px;
  }
  
  #themeToggle svg.moon {
    left: 32px;
  }
  
  #darkmode-toggle:checked + #themeToggle:after {
    left: 48px;
  }
}
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
        <div class="header-main-content-row">
            <div class="logo-container">
                <div class="logo-main-line">
                    <i class="fa-regular fa-newspaper"></i>
                    <span>Post Award</span>
                </div>
                <span class="logo-subtitle">
                    Daily Federal Awards Dashboard<br><br>
                    We're showing YTD. Want to dig deeper? Go to FPDS.gov and run an "EZ Search" using an agency, vendor, keyword, or NAICS code.<br>Download the CSV, upload it to FedLook.com, and instantly spot who's buying what from whom. See examples below.
                </span>
            </div>
    <input type="checkbox" id="darkmode-toggle" />
<label for="darkmode-toggle" id="themeToggle">
    <svg version="1.1" class="sun" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 496 496" style="enable-background:new 0 0 496 496;" xml:space="preserve">
        <rect x="152.994" y="58.921" transform="matrix(0.3827 0.9239 -0.9239 0.3827 168.6176 -118.5145)" width="40.001" height="16" />
        <rect x="46.9" y="164.979" transform="matrix(0.9239 0.3827 -0.3827 0.9239 71.29 -12.4346)" width="40.001" height="16" />
        <rect x="46.947" y="315.048" transform="matrix(0.9239 -0.3827 0.3827 0.9239 -118.531 50.2116)" width="40.001" height="16" />
        <rect x="164.966" y="409.112" transform="matrix(-0.9238 -0.3828 0.3828 -0.9238 168.4872 891.7491)" width="16" height="39.999" />
        <rect x="303.031" y="421.036" transform="matrix(-0.3827 -0.9239 0.9239 -0.3827 50.2758 891.6655)" width="40.001" height="16" />
        <rect x="409.088" y="315.018" transform="matrix(-0.9239 -0.3827 0.3827 -0.9239 701.898 785.6559)" width="40.001" height="16" />
        <rect x="409.054" y="165.011" transform="matrix(-0.9239 0.3827 -0.3827 -0.9239 891.6585 168.6574)" width="40.001" height="16" />
        <rect x="315.001" y="46.895" transform="matrix(0.9238 0.3828 -0.3828 0.9238 50.212 -118.5529)" width="16" height="39.999" />
        <path d="M248,88c-88.224,0-160,71.776-160,160s71.776,160,160,160s160-71.776,160-160S336.224,88,248,88z M248,392
            c-79.4,0-144-64.6-144-144s64.6-144,144-144s144,64.6,144,144S327.4,392,248,392z" />
        <rect x="240" width="16" height="72" />
        <rect x="62.097" y="90.096" transform="matrix(0.7071 0.7071 -0.7071 0.7071 98.0963 -40.6334)" width="71.999" height="16" />
        <rect y="240" width="72" height="16" />
        <rect x="90.091" y="361.915" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 -113.9157 748.643)" width="16" height="71.999" />
        <rect x="240" y="424" width="16" height="72" />
        <rect x="361.881" y="389.915" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 397.8562 960.6281)" width="71.999" height="16" />
        <rect x="424" y="240" width="72" height="16" />
        <rect x="389.911" y="62.091" transform="matrix(0.7071 0.7071 -0.7071 0.7071 185.9067 -252.6357)" width="16" height="71.999" />
    </svg>
    <svg version="1.1" class="moon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 49.739 49.739" style="enable-background:new 0 0 49.739 49.739;" xml:space="preserve">
        <path d="M25.068,48.889c-9.173,0-18.017-5.06-22.396-13.804C-3.373,23.008,1.164,8.467,13.003,1.979l2.061-1.129l-0.615,2.268
           c-1.479,5.459-0.899,11.25,1.633,16.306c2.75,5.493,7.476,9.587,13.305,11.526c5.831,1.939,12.065,1.492,17.559-1.258v0
           c0.25-0.125,0.492-0.258,0.734-0.391l2.061-1.13l-0.585,2.252c-1.863,6.873-6.577,12.639-12.933,15.822
           C32.639,48.039,28.825,48.888,25.068,48.889z M12.002,4.936c-9.413,6.428-12.756,18.837-7.54,29.253
           c5.678,11.34,19.522,15.945,30.864,10.268c5.154-2.582,9.136-7.012,11.181-12.357c-5.632,2.427-11.882,2.702-17.752,0.748
           c-6.337-2.108-11.473-6.557-14.463-12.528C11.899,15.541,11.11,10.16,12.002,4.936z" />
    </svg>
</label>        
        </div>

      <div class="data-load-controls example-csv-loader">
    <div class="example-csv-buttons">
        <button id="loadExample1" class="btn btn-primary"><span class="btn-text">YTD</span></button>
        <button id="loadExample2" class="btn btn-secondary"><span class="btn-text">SaaS 3YR</span></button>
        <input type="file" id="csvFile" accept=".csv,.xls" class="file-input" style="display: none;">
        <label for="csvFile" class="btn btn-secondary"><i class="fas fa-upload mr-2"></i>
            <span class="btn-text">Upload CSV</span>
        </label>
    </div>
</div>
        
        <div class="status-and-active-filters" id="statusBox">
            <div class="status-title">No data loaded</div>
            <div id="activeFilters" class="active-filters">
            </div>
        </div>

        <div class="primary-controls-area">
            <div class="main-filter-inputs">
                <div class="search-bar">
                    <span class="search-icon"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" placeholder="Search contracts, agencies, vendors..." class="search-input">
                </div>
                <div class="filter-group">
                    <select id="agencyFilter" class="filter-select" aria-label="Filter by agency">
                        <option value="">All Agencies</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="vendorFilter" class="filter-select" aria-label="Filter by vendor">
                        <option value="">All Vendors</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="pscFilter" class="filter-select" aria-label="Filter by PSC">
                        <option value="">Any PSC</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button id="resetFilters" class="btn btn-secondary">
                    <i class="fas fa-undo"></i>
                    <span class="btn-text">Reset</span>
                </button>
                <button id="moreFiltersBtn" class="btn btn-secondary">
                    <i class="fas fa-sliders-h"></i>
                    <span class="btn-text">More Filters</span>
                </button>
            </div>
        </div>

        <section id="advancedFiltersPanel" class="filters-panel">
            <div class="panel-header">
                <h3>Advanced Filters</h3>
                <button id="closeFilters" class="btn-icon" aria-label="Close advanced filters">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="startDate" class="filter-label">Date Signed</label> 
                    <div class="date-range-picker" id="dateRangeLabel">
                        <input type="date" id="startDate" class="filter-date" aria-label="Start date">
                        <span class="date-separator">to</span>
                        <input type="date" id="endDate" class="filter-date" aria-label="End date">
                    </div>
                </div>
                <div class="filter-group">
                    <label for="officeFilter" class="filter-label">Contracting Office</label> 
                    <select id="officeFilter" class="filter-select" aria-label="Filter by contracting office">
                        <option value="">Any Office</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="naicsFilter" class="filter-label">NAICS Code</label> 
                    <select id="naicsFilter" class="filter-select" aria-label="Filter by NAICS code">
                        <option value="">Any NAICS</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="valueFilter" class="filter-label">Action Obligation ($)</label> 
                    <select id="valueFilter" class="filter-select" aria-label="Filter by action obligation value">
                        <option value="">Any Value</option>
                        <option value="0-100000">Under $100K</option>
                        <option value="100000-500000">$100K - $500K</option>
                        <option value="500000-1000000">$500K - $1M</option>
                        <option value="1000000-5000000">$1M - $5M</option>
                        <option value="5000000-10000000">$5M - $10M</option>
                        <option value="10000000-999999999999">Over $10M</option>
                    </select>
                </div>
            </div>
        </section>
    </header> 

    <div id="loadingIndicator" class="loading-state" style="display: none;">
        <div class="loading-spinner"></div>
        <div>Loading and processing contract data...</div>
    </div>
    <div id="errorMessage" class="error-message" style="display: none;">
    </div>
    <div id="noDataMessage" class="empty-state">
        <i class="fas fa-file-upload"></i>
        <h2>No Contract Data Loaded</h2>
        <p>Upload a CSV file from an FPDS.gov Search Result.</p>
    </div>
    
    <main id="dashboard" style="display: none;">
      
<!-- First row: Sankey (2/3) and Value by Month (1/3) -->
<section class="primary-viz-row">
  <div class="dashboard-section-header" style="display:flex; justify-content: space-between; align-items:center;">
    <span>Contract Value Flow & Monthly Trends</span>
    <div class="sankey-controls">
      <button id="sankeyTop10" class="btn btn-sm btn-primary"><span class="btn-text">Top 10</span></button>
      <button id="sankeyTop25" class="btn btn-sm btn-secondary"><span class="btn-text">Top 25</span></button>
      <button id="sankeyAll" class="btn btn-sm btn-secondary"><span class="btn-text">All</span></button>
    </div>
  </div>
  <div class="primary-viz-container">
    <div class="sankey-wrapper">
      <div class="sankey-chart-container" id="sankeyChartContainer">
        <div id="sankeyTooltip" class="chart-tooltip"></div>
      </div>
    </div>
    <div class="month-chart-wrapper">
      <h3 class="chart-title-integrated">Contract Value by Month</h3>
      <div class="chart-container" id="valueTimeChartContainer">
        <canvas id="valueTimeChart"></canvas>
        <div class="selection-indicator"></div>
      </div>
    </div>
  </div>
</section>

<!-- Second row: Three equal charts -->
<section class="charts-grid-container">
  <h2 class="dashboard-section-header">Visualizations</h2>
  <div class="charts-grid">
    <div class="chart-item">
      <h3 class="chart-title-integrated">Top Agencies</h3>
      <div class="chart-container" id="agencyChartContainer">
        <canvas id="agencyChart"></canvas>
        <div class="selection-indicator"></div>
      </div>
    </div>
    <div class="chart-item">
      <h3 class="chart-title-integrated">Top Vendors</h3>
      <div class="chart-container" id="vendorChartContainer">
        <canvas id="vendorChart"></canvas>
        <div class="selection-indicator"></div>
      </div>
    </div>
    <div class="chart-item">
      <h3 class="chart-title-integrated">NAICS Distribution</h3>
      <div class="bubble-chart-container" id="naicsBubbleChartContainer">
        <canvas id="naicsBubbleChart"></canvas>
        <div class="selection-indicator"></div>
      </div>
    </div>
  </div>
</section>
<section class="stats-section">
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Total Contracts</div>
            <div id="totalContracts" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Value</div>
            <div id="totalValue" class="stat-value">$0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg. Contract</div>
            <div id="avgValue" class="stat-value">$0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Unique Vendors</div>
            <div id="uniqueVendors" class="stat-value">0</div>
          </div>
        </div>
      </section>
<section class="tables-section-container">
  <h2 class="dashboard-section-header">Contract Details</h2>
  <div class="tables-section">
    <div class="tabs">
      <button class="tab-btn active" data-tab="recent">Recent Awards</button>
      <button class="tab-btn" data-tab="largest">Largest Awards</button>
      <button class="tab-btn" data-tab="offices">Top Contracting Offices</button>
    </div>
    <div id="recentTab" class="tab-content active">
      <div class="table-container">
        <table id="contractsTable" class="data-table">
          <thead>
            <tr>
              <th data-sort="date">Date</th>
              <th data-sort="id">Contract ID</th>
              <th data-sort="agency">Agency</th>
              <th data-sort="office">Office</th>
              <th data-sort="vendor">Vendor</th>
              <th data-sort="description">Description</th>
              <th data-sort="value">Value</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div id="largestTab" class="tab-content">
      <div class="table-container">
        <table id="largestContractsTable" class="data-table">
          <thead>
            <tr>
              <th data-sort="date">Date</th>
              <th data-sort="id">Contract ID</th>
              <th data-sort="agency">Agency</th>
              <th data-sort="office">Office</th>
              <th data-sort="vendor">Vendor</th>
              <th data-sort="description">Description</th>
              <th data-sort="value">Value</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div id="officesTab" class="tab-content">
      <div class="table-container">
        <table id="officesTable" class="data-table">
          <thead>
            <tr>
              <th data-sort="agency">Agency</th>
              <th data-sort="office">Office</th>
              <th data-sort="contracts">Contracts</th>
              <th data-sort="value">Total Value</th>
              <th data-sort="naics">Top NAICS</th>
              <th data-sort="vendor">Top Vendor</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</section>
	</main> 

  </div> 

  <div id="contractModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Contract Details</h3>
        <button id="closeModal" class="modal-close" aria-label="Close modal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="contractModalBody"></div>
      <div class="modal-footer">
        <button id="closeModalBtn" class="btn btn-secondary"><span class="btn-text">Close</span></button>
      </div>
    </div>
  </div>
  
  <button id="mobileFilterBtn" class="mobile-action-btn" aria-label="Open filters">
    <i class="fas fa-filter"></i>
  </button>

  <script>
    
    const app = {
      data: [],
      filteredData: [],
      agencies: {},
      offices: {},
      vendors: {},
      naicsCodes: {},
      pscCodes: {},
      charts: {},
      filters: {},
      selection: { type: null, value: null, container: null },
      sankeyDisplayLimit: 10
    };

    const elements = {
      csvFile: document.getElementById('csvFile'),
      uploadBtn: document.querySelector('label[for="csvFile"]'),
      loadExample1Btn: document.getElementById('loadExample1'),
      loadExample2Btn: document.getElementById('loadExample2'),
      statusBox: document.getElementById('statusBox'), 
      activeFilters: document.getElementById('activeFilters'),
      searchInput: document.getElementById('searchInput'),
      agencyFilter: document.getElementById('agencyFilter'),
      vendorFilter: document.getElementById('vendorFilter'),
      pscFilter: document.getElementById('pscFilter'),
      resetFilters: document.getElementById('resetFilters'),
      moreFiltersBtn: document.getElementById('moreFiltersBtn'),
      advancedFiltersPanel: document.getElementById('advancedFiltersPanel'),
      closeFilters: document.getElementById('closeFilters'),
      startDate: document.getElementById('startDate'),
      endDate: document.getElementById('endDate'),
      officeFilter: document.getElementById('officeFilter'), 
      naicsFilter: document.getElementById('naicsFilter'),   
      valueFilter: document.getElementById('valueFilter'),   
      themeToggle: document.getElementById('themeToggle'),
      loadingIndicator: document.getElementById('loadingIndicator'),
      errorMessage: document.getElementById('errorMessage'),
      noDataMessage: document.getElementById('noDataMessage'),
      dashboard: document.getElementById('dashboard'),
      mobileFilterBtn: document.getElementById('mobileFilterBtn'),
      totalContracts: document.getElementById('totalContracts'),
      totalValue: document.getElementById('totalValue'),
      avgValue: document.getElementById('avgValue'),
      uniqueVendors: document.getElementById('uniqueVendors'),
      sankeyTop10: document.getElementById('sankeyTop10'),
      sankeyTop25: document.getElementById('sankeyTop25'),
      sankeyAll: document.getElementById('sankeyAll'),
      sankeyChartContainer: document.getElementById('sankeyChartContainer'),
      sankeyTooltip: document.getElementById('sankeyTooltip'),
      valueTimeChartContainer: document.getElementById('valueTimeChartContainer'),
      agencyChartContainer: document.getElementById('agencyChartContainer'),
      naicsBubbleChartContainer: document.getElementById('naicsBubbleChartContainer'),
      vendorChartContainer: document.getElementById('vendorChartContainer'),
      valueTimeChart: document.getElementById('valueTimeChart').getContext('2d'), // Get context directly
      agencyChart: document.getElementById('agencyChart').getContext('2d'),     // Get context directly
      naicsBubbleChart: document.getElementById('naicsBubbleChart').getContext('2d'), // Get context directly
      vendorChart: document.getElementById('vendorChart').getContext('2d'),   // Get context directly
      contractsTable: document.getElementById('contractsTable').querySelector('tbody'),
      largestContractsTable: document.getElementById('largestContractsTable').querySelector('tbody'),
      officesTable: document.getElementById('officesTable').querySelector('tbody'),
      tabButtons: document.querySelectorAll('.tab-btn'),
      tabContents: document.querySelectorAll('.tab-content'),
      contractModal: document.getElementById('contractModal'),
      closeModal: document.getElementById('closeModal'),
      closeModalBtn: document.getElementById('closeModalBtn'),
      contractModalBody: document.getElementById('contractModalBody')
    };

    const utils = {
      formatMoney: function(value) {
        if (!value && value !== 0) return '$0';
        const number = parseFloat(value);
        if (isNaN(number)) return '$0';
        if (Math.abs(number) >= 1000000000) return '$' + (number / 1000000000).toFixed(1) + 'B';
        if (Math.abs(number) >= 1000000) return '$' + (number / 1000000).toFixed(1) + 'M';
        if (Math.abs(number) >= 1000) return '$' + (number / 1000).toFixed(1) + 'K';
        return '$' + number.toFixed(0);
      },
      formatDate: function(dateInput) { 
        if (!dateInput) return 'N/A';
        const date = (dateInput instanceof Date && !isNaN(dateInput)) ? dateInput : new Date(dateInput);
        if (isNaN(date.getTime())) {
          if (typeof dateInput === 'string') {
            const parts = dateInput.split('-'); 
            if (parts.length === 3) {
              const months = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11};
              const day = parseInt(parts[0]);
              const month = months[parts[1]];
              let year = parseInt(parts[2]);
              if (year < 100) year = year < 50 ? 2000 + year : 1900 + year; 
              if (!isNaN(day) && month !== undefined && !isNaN(year)) {
                const parsedDate = new Date(year, month, day);
                return parsedDate.toLocaleDateString('en-US', { year: '2-digit', month: 'short', day: 'numeric' });
              }
            }
          }
          return String(dateInput); 
        }
        return date.toLocaleDateString('en-US', { year: '2-digit', month: 'short', day: 'numeric' });
      },
      parseMoney: function(value) {
        if (!value) return 0;
        return parseFloat(String(value).replace(/[$,\s]/g, '')) || 0;
      },
      parseCSV: function(text) {
        const lines = text.split(/\r\n|\n/);
        if (lines.length === 0) return { headers: [], data: [] };
        
        const parseLine = function(line) {
          const values = []; let current = ''; let inQuotes = false;
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1] || '';
            if (char === '"') {
              if (inQuotes && nextChar === '"') { current += '"'; i++; } 
              else { inQuotes = !inQuotes; }
            } else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; } 
            else { current += char; }
          }
          values.push(current.trim()); return values;
        };

        const headers = parseLine(lines[0]);
        const data = [];
        for (let i = 1; i < lines.length; i++) {
          if (lines[i].trim()) { 
            const values = parseLine(lines[i]);
            const row = {};
            for (let j = 0; j < Math.min(headers.length, values.length); j++) {
              if (headers[j]) row[headers[j].trim()] = values[j] || ''; 
            }
            data.push(row);
          }
        }
        return { headers, data };
      },
      parseDate: function(dateString) {
        if (!dateString) return null;
        if (dateString instanceof Date && !isNaN(dateString)) return dateString; 

        const s = String(dateString);
        const fpdsParts = s.match(/^(\d{1,2})-([A-Za-z]{3})-(\d{2})$/);
        if (fpdsParts) {
            const day = parseInt(fpdsParts[1]);
            const monthStr = fpdsParts[2];
            const yearDigits = parseInt(fpdsParts[3]);
            const months = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11};
            const month = months[monthStr.charAt(0).toUpperCase() + monthStr.slice(1).toLowerCase()];
            if (!isNaN(day) && month !== undefined && !isNaN(yearDigits)) {
                const year = yearDigits < 50 ? 2000 + yearDigits : 1900 + yearDigits; 
                return new Date(year, month, day);
            }
        }
        const date = new Date(s);
        return !isNaN(date.getTime()) ? date : null;
      },
      truncateText: function(text, maxLength) {
        if (!text || text.length <= maxLength) return text || '';
        return text.substring(0, maxLength) + '...';
      },
      stringToColor: function(str) {
        if (!str) return '#cccccc'; let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const mutedColors = ['#4F6D7A','#56A3A6','#84B59F','#A6D3A0','#D1B280','#EDAE49','#D1495B','#9D5C63','#647AA3','#7D938A','#BFAE9F','#FAD4C0','#CE8147','#B0C592','#91A6FF'];
        return mutedColors[Math.abs(hash) % mutedColors.length];
      },
      getInitials: function(name) {
        if (!name) return '?'; const words = name.trim().split(/\s+/).filter(Boolean); 
        if (words.length === 0) return '?';
        return words.length > 1 ? (words[0].charAt(0) + words[words.length-1].charAt(0)).toUpperCase() : words[0].charAt(0).toUpperCase();
      },
      parseValueRange: function(rangeStr) {
        if (!rangeStr) return null; const parts = rangeStr.split('-');
        return parts.length !== 2 ? null : {min:parseFloat(parts[0]),max:parseFloat(parts[1])};
      }
    };
    
const dataProcessor = {
  processData: function(csvData) {
    if (!csvData || !csvData.data || csvData.data.length === 0) throw new Error('No valid data found in CSV file');
    const requiredFields = ['Contract ID','Date Signed','Contracting Agency','Legal Business Name','Action Obligation ($)'];
    for (const field of requiredFields) {
        if (!csvData.headers.some(h => h.trim() === field)) {
            throw new Error(`Required field "${field}" not found in CSV file headers: ${csvData.headers.join(', ')}`);
        }
    }
    return csvData.data.map(row => ({
      id:row['Contract ID']||'', reference:row['Reference IDV']||'', modification:row['Modification Number']||'',
      date:row['Date Signed']||'', parsedDate:utils.parseDate(row['Date Signed']), type:row['Award/IDV Type']||'',
      value:utils.parseMoney(row['Action Obligation ($)']), agency:row['Contracting Agency']||'', office:row['Contracting Office Name']||'',
      psc:row['PSC']||'', pscDescription:row['PSC Description']||'', naics:row['NAICS']||'', naicsDescription:row['NAICS Description']||'',
      vendor:row['Legal Business Name']||'', parentVendor:row['Ultimate Parent Legal Business Name']||'', 
      description:row['PSC Description'] || row['Product or Service Code (PSC) / NAICS Code Description'] || row['NAICS Description'] || '' 
    }));
  },
  
  analyzeData: function(data) {
    const agencies={},offices={},vendors={},naicsCodes={},pscCodes={};
    data.forEach(contract => {
      if(contract.agency){
        if(!agencies[contract.agency]) agencies[contract.agency]={name:contract.agency,count:0,value:0,offices:new Set(),vendors:new Set()};
        agencies[contract.agency].count++; agencies[contract.agency].value+=contract.value;
        if(contract.office) agencies[contract.agency].offices.add(contract.office);
        if(contract.vendor) agencies[contract.agency].vendors.add(contract.vendor);
      }
      if(contract.office){
        if(!offices[contract.office]) offices[contract.office]={name:contract.office,agency:contract.agency,count:0,value:0,vendors:new Set(),naicsCodes:{}};
        offices[contract.office].count++; offices[contract.office].value+=contract.value;
        if(contract.vendor) offices[contract.office].vendors.add(contract.vendor);
        if(contract.naics){
          if(!offices[contract.office].naicsCodes[contract.naics]) offices[contract.office].naicsCodes[contract.naics]={code:contract.naics,description:contract.naicsDescription,count:0,value:0};
          offices[contract.office].naicsCodes[contract.naics].count++; offices[contract.office].naicsCodes[contract.naics].value+=contract.value;
        }
      }
      if(contract.vendor){
        if(!vendors[contract.vendor]) vendors[contract.vendor]={name:contract.vendor,parent:contract.parentVendor,count:0,value:0,agencies:new Set(),naicsCodes:{}};
        vendors[contract.vendor].count++; vendors[contract.vendor].value+=contract.value;
        if(contract.agency) vendors[contract.vendor].agencies.add(contract.agency);
        if(contract.naics){
          if(!vendors[contract.vendor].naicsCodes[contract.naics]) vendors[contract.vendor].naicsCodes[contract.naics]={code:contract.naics,description:contract.naicsDescription,count:0,value:0};
          vendors[contract.vendor].naicsCodes[contract.naics].count++; vendors[contract.vendor].naicsCodes[contract.naics].value+=contract.value;
        }
      }
      if(contract.naics){
        if(!naicsCodes[contract.naics]) naicsCodes[contract.naics]={code:contract.naics,description:contract.naicsDescription,count:0,value:0,vendors:new Set()};
        naicsCodes[contract.naics].count++; naicsCodes[contract.naics].value+=contract.value;
        if(contract.vendor) naicsCodes[contract.naics].vendors.add(contract.vendor);
      }
      if(contract.psc){
        if(!pscCodes[contract.psc]) pscCodes[contract.psc]={code:contract.psc,description:contract.pscDescription,count:0,value:0};
        pscCodes[contract.psc].count++; pscCodes[contract.psc].value+=contract.value;
      }
    });
    return {agencies,offices,vendors,naicsCodes,pscCodes};
  },
  
  generateSankeyData: function(data, limit=10) {
    const agencyOfficeFlows = {}, officeVendorFlows = {}, nodeMap = new Map();
    
    // Process each contract to build flows
    data.forEach(c => {
      if (c.agency && c.office && c.vendor && c.value > 0) { 
        // Add agency-office flow
        const aok = `${c.agency}|${c.office}`;
        if (!agencyOfficeFlows[aok]) {
          agencyOfficeFlows[aok] = {source: c.agency, target: c.office, value: 0};
        } 
        agencyOfficeFlows[aok].value += c.value;
        
        // Add office-vendor flow
        const ovk = `${c.office}|${c.vendor}`;
        if (!officeVendorFlows[ovk]) {
          officeVendorFlows[ovk] = {source: c.office, target: c.vendor, value: 0};
        }
        officeVendorFlows[ovk].value += c.value;
        
        // Add nodes to the map
        if (!nodeMap.has(c.agency)) nodeMap.set(c.agency, {name: c.agency, type: 'agency'});
        if (!nodeMap.has(c.office)) nodeMap.set(c.office, {name: c.office, type: 'office'});
        if (!nodeMap.has(c.vendor)) nodeMap.set(c.vendor, {name: c.vendor, type: 'vendor'});
      }
    });
    
    // Convert nodes to array with IDs
    const nodesArray = Array.from(nodeMap.values()).map((n, i) => ({...n, id: i}));
    
    // Create a map of node names to IDs
    const nodeIndexMap = new Map(nodesArray.map(n => [n.name, n.id]));
    
    // Create links from both types of flows
    const allLinks = [
      ...Object.values(agencyOfficeFlows).map(f => ({
        sourceName: f.source,
        targetName: f.target,
        value: f.value,
        type: 'agency-office'
      })),
      ...Object.values(officeVendorFlows).map(f => ({
        sourceName: f.source,
        targetName: f.target,
        value: f.value,
        type: 'office-vendor'
      }))
    ]
    // Filter to include only nodes that exist in our nodeMap
    .filter(l => nodeIndexMap.has(l.sourceName) && nodeIndexMap.has(l.targetName))
    // Convert node names to IDs
    .map(l => ({
      source: nodeIndexMap.get(l.sourceName),
      target: nodeIndexMap.get(l.targetName),
      value: l.value,
      type: l.type
    }))
    // Sort by value descending
    .sort((a, b) => b.value - a.value);
    
    // Apply limit if specified
    let finalLinks = limit === 0 ? allLinks : allLinks.slice(0, limit * 2);
    
    // If limit is applied, ensure we have a mix of both flow types
    if (limit > 0) {
      const agencyOfficeLinks = allLinks
        .filter(l => l.type === 'agency-office')
        .slice(0, limit);
      
      const officeVendorLinks = allLinks
        .filter(l => l.type === 'office-vendor')
        .slice(0, limit);
      
      finalLinks = [...agencyOfficeLinks, ...officeVendorLinks];
    }
    
    // Find all nodes used in our links
    const includedNodeIndices = new Set();
    finalLinks.forEach(l => {
      includedNodeIndices.add(l.source);
      includedNodeIndices.add(l.target);
    });
    
    // Filter nodes to include only those in our links
    const finalNodes = nodesArray.filter(n => includedNodeIndices.has(n.id));
    
    // Create a mapping from old IDs to new sequential IDs
    const finalNodeReIndexMap = new Map(finalNodes.map((n, i) => [n.id, i]));
    
    // Update links to use new node IDs
    finalLinks = finalLinks
      .map(l => ({
        source: finalNodeReIndexMap.get(l.source),
        target: finalNodeReIndexMap.get(l.target),
        value: l.value,
        type: l.type
      }))
      .filter(l => l.source !== undefined && l.target !== undefined);
    
    return {
      nodes: finalNodes.map(n => ({name: n.name, type: n.type})),
      links: finalLinks
    };
  }
};

    const filterManager = {
      applyFilters: function() {
        const filters = app.filters;
        let filtered = [...app.data];
        if (filters.valueRange) filtered = filtered.filter(c => c.value >= filters.valueRange.min && c.value <= filters.valueRange.max);
        if (filters.startDate) filtered = filtered.filter(c => c.parsedDate && c.parsedDate >= new Date(filters.startDate));
        if (filters.endDate) { const ed = new Date(filters.endDate); ed.setHours(23, 59, 59, 999); filtered = filtered.filter(c => c.parsedDate && c.parsedDate <= ed); }
        if (filters.agency) filtered = filtered.filter(c => c.agency === filters.agency);
        if (filters.office) filtered = filtered.filter(c => c.office === filters.office);
        if (filters.naics) filtered = filtered.filter(c => c.naics === filters.naics);
        if (filters.psc) filtered = filtered.filter(c => c.psc === filters.psc);
        if (filters.vendor) filtered = filtered.filter(c => c.vendor === filters.vendor);
        if (filters.search) { 
            const s = filters.search.toLowerCase(); 
            filtered = filtered.filter(c => 
                (c.id && c.id.toLowerCase().includes(s)) || 
                (c.agency && c.agency.toLowerCase().includes(s)) || 
                (c.office && c.office.toLowerCase().includes(s)) || 
                (c.vendor && c.vendor.toLowerCase().includes(s)) || 
                (c.description && c.description.toLowerCase().includes(s)) || 
                (c.naics && c.naics.toLowerCase().includes(s)) ||
                (c.naicsDescription && c.naicsDescription.toLowerCase().includes(s)) || 
                (c.psc && c.psc.toLowerCase().includes(s)) ||
                (c.pscDescription && c.pscDescription.toLowerCase().includes(s))
            ); 
        }
        app.filteredData = filtered;
        return filtered;
      },
      applySelectionFilter: function(type, value, container) {
        document.querySelectorAll('.selection-indicator').forEach(ind => ind.style.display = 'none');
        if (app.selection.type === type && app.selection.value === value) { 
            app.selection = { type: null, value: null, container: null }; 
            delete app.filters[type]; 
            if (type === 'agency' && elements.agencyFilter) elements.agencyFilter.value = '';
            if (type === 'office' && elements.officeFilter) elements.officeFilter.value = '';
            if (type === 'naics' && elements.naicsFilter) elements.naicsFilter.value = '';
            if (type === 'vendor' && elements.vendorFilter) elements.vendorFilter.value = '';
            if (type === 'psc' && elements.pscFilter) elements.pscFilter.value = '';
        } else {
          if (['agency', 'office', 'naics', 'vendor', 'psc'].includes(type)) {
            Object.keys(app.filters).forEach(key => {
                if (['agency', 'office', 'naics', 'vendor', 'psc'].includes(key) && key !== type) {
                }
            });
          }
          if (type && value) { 
            app.filters[type] = value; 
            app.selection = { type, value, container }; 
            if (container) { const ind = container.querySelector('.selection-indicator'); if (ind) ind.style.display = 'block'; } 
          } else { 
            delete app.filters[type];
            app.selection = { type: null, value: null, container: null };
          }
        }
        this.applyFilters(); this.updateFilterTags(); dashboardManager.refreshDashboard();
      },
      updateFilterTags: function() {
        const filters = app.filters;
        const activeFiltersContainer = elements.activeFilters;
        if (!activeFiltersContainer) return;
        activeFiltersContainer.innerHTML = '';
        const tags = [];
        if (filters.valueRange) tags.push({ key: 'valueRange', label: 'Value', value: `${utils.formatMoney(filters.valueRange.min)} - ${utils.formatMoney(filters.valueRange.max)}` });
        if (filters.startDate) tags.push({ key: 'startDate', label: 'From', value: utils.formatDate(new Date(filters.startDate + 'T00:00:00')) }); 
        if (filters.endDate) tags.push({ key: 'endDate', label: 'To', value: utils.formatDate(new Date(filters.endDate + 'T00:00:00')) });     
        if (filters.agency) tags.push({ key: 'agency', label: 'Agency', value: filters.agency });
        if (filters.office) tags.push({ key: 'office', label: 'Office', value: filters.office });
        if (filters.naics) tags.push({ key: 'naics', label: 'NAICS', value: filters.naics });
        if (filters.psc) tags.push({ key: 'psc', label: 'PSC', value: filters.psc });
        if (filters.vendor) tags.push({ key: 'vendor', label: 'Vendor', value: filters.vendor });
        if (filters.search) tags.push({ key: 'search', label: 'Search', value: filters.search });
        
        tags.forEach(tag => {
          const tagElement = document.createElement('div');
          tagElement.className = 'filter-tag';
          tagElement.innerHTML = `<span class="filter-tag-label">${tag.label}:</span> ${utils.truncateText(tag.value, 20)} <button class="filter-tag-remove" data-filter="${tag.key}"><i class="fas fa-times"></i></button>`;
          activeFiltersContainer.appendChild(tagElement);
          tagElement.querySelector('.filter-tag-remove').addEventListener('click', function() {
            const filterKey = this.getAttribute('data-filter');
            if (filterKey === 'valueRange') { delete app.filters.valueRange; elements.valueFilter.value = ''; } 
            else if (filterKey === 'startDate') { delete app.filters.startDate; elements.startDate.value = ''; } 
            else if (filterKey === 'endDate') { delete app.filters.endDate; elements.endDate.value = ''; } 
            else if (filterKey === 'agency') { delete app.filters.agency; elements.agencyFilter.value = ''; if (app.selection.type === 'agency') app.selection = { type: null, value: null, container: null }; } 
            else if (filterKey === 'office') { delete app.filters.office; elements.officeFilter.value = ''; if (app.selection.type === 'office') app.selection = { type: null, value: null, container: null }; } 
            else if (filterKey === 'naics') { delete app.filters.naics; elements.naicsFilter.value = ''; if (app.selection.type === 'naics') app.selection = { type: null, value: null, container: null }; } 
            else if (filterKey === 'psc') { delete app.filters.psc; elements.pscFilter.value = ''; if (app.selection.type === 'psc') app.selection = { type: null, value: null, container: null }; } 
            else if (filterKey === 'vendor') { delete app.filters.vendor; elements.vendorFilter.value = ''; if (app.selection.type === 'vendor') app.selection = { type: null, value: null, container: null }; } 
            else if (filterKey === 'search') { delete app.filters.search; elements.searchInput.value = ''; }
            document.querySelectorAll('.selection-indicator').forEach(ind => ind.style.display = 'none');
            filterManager.applyFilters(); dashboardManager.refreshDashboard();
          });
        });

        const statusTitleElement = document.querySelector('#statusBox .status-title');
        if (!statusTitleElement) return;
        let titleText = '';
        let dateRangeSuffix = '';

        if (app.filteredData.length > 0) {
            let minDate = null;
            let maxDate = null;
            app.filteredData.forEach(contract => {
                if (contract.parsedDate && contract.parsedDate instanceof Date && !isNaN(contract.parsedDate.getTime())) {
                    if (!minDate || contract.parsedDate < minDate) minDate = contract.parsedDate;
                    if (!maxDate || contract.parsedDate > maxDate) maxDate = contract.parsedDate;
                }
            });
            if (minDate && maxDate) {
                const formattedMinDate = utils.formatDate(minDate);
                const formattedMaxDate = utils.formatDate(maxDate);
                if (formattedMinDate === formattedMaxDate) {
                    if (formattedMinDate !== 'N/A') dateRangeSuffix = ` (Date: ${formattedMinDate})`;
                } else {
                    if (formattedMinDate !== 'N/A' && formattedMaxDate !== 'N/A') dateRangeSuffix = ` (${formattedMinDate} - ${formattedMaxDate})`;
                    else if (formattedMinDate !== 'N/A') dateRangeSuffix = ` (From: ${formattedMinDate})`;
                    else if (formattedMaxDate !== 'N/A') dateRangeSuffix = ` (To: ${formattedMaxDate})`;
                }
            }
        }
        if (statusTitleElement) {
            if (app.data.length === 0 && app.filteredData.length === 0) titleText = 'No data loaded';
            else if (app.filteredData.length === 0 && app.data.length > 0) titleText = 'No contracts match current filters';
            else if (app.filteredData.length < app.data.length) titleText = `Viewing ${app.filteredData.length.toLocaleString()} filtered contracts`;
            else titleText = `Viewing all ${app.filteredData.length.toLocaleString()} contracts`;
            statusTitleElement.textContent = titleText + dateRangeSuffix;
        }
      },
      resetFilters: function() {
        app.filters = {}; app.selection = { type: null, value: null, container: null };
        if(elements.valueFilter) elements.valueFilter.value = ''; 
        if(elements.startDate) elements.startDate.value = ''; 
        if(elements.endDate) elements.endDate.value = '';
        if(elements.agencyFilter) elements.agencyFilter.value = ''; 
        if(elements.officeFilter) elements.officeFilter.value = ''; 
        if(elements.naicsFilter) elements.naicsFilter.value = '';
        if(elements.pscFilter) elements.pscFilter.value = ''; 
        if(elements.vendorFilter) elements.vendorFilter.value = ''; 
        if(elements.searchInput) elements.searchInput.value = '';
        document.querySelectorAll('.selection-indicator').forEach(ind => ind.style.display = 'none');
        app.filteredData = [...app.data];
        this.updateFilterTags(); dashboardManager.refreshDashboard();
      }
    };
const chartManager = {
  initCharts: function() {
    Object.values(app.charts).forEach(c => { if (c instanceof Chart) c.destroy(); });
    app.charts = {};
    if (!Chart) { console.error("Chart.js not loaded"); return; }
    
    const cssVars = {
      fontFamily: getComputedStyle(document.documentElement).getPropertyValue('--font-sans').trim(),
      textSecondary: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim(),
      border: getComputedStyle(document.documentElement).getPropertyValue('--border').trim(),
      bgPrimary: getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim(),
      textPrimary: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
      primary: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
      radiusSm: 4, // var(--radius-sm)
      radiusMd: 8, // var(--radius-md)
    };
    
    Chart.defaults.font.family = cssVars.fontFamily;
    Chart.defaults.font.size = 12;
    Chart.defaults.color = cssVars.textSecondary;
    Chart.defaults.borderColor = cssVars.border;
    
    // Tooltip defaults
    Chart.defaults.plugins.tooltip.backgroundColor = cssVars.bgPrimary;
    Chart.defaults.plugins.tooltip.titleColor = cssVars.textPrimary;
    Chart.defaults.plugins.tooltip.bodyColor = cssVars.textSecondary;
    Chart.defaults.plugins.tooltip.borderColor = cssVars.border;
    Chart.defaults.plugins.tooltip.borderWidth = 1;
    Chart.defaults.plugins.tooltip.padding = 10;
    Chart.defaults.plugins.tooltip.cornerRadius = cssVars.radiusMd;
    Chart.defaults.plugins.tooltip.boxPadding = 5;

    this.initValueTimeChart(cssVars); 
    this.initAgencyChart(cssVars); 
    this.initNaicsBubbleChart(cssVars); 
    this.initVendorChart(cssVars); 
    this.initSankeyChart(); 
    this.addChartClickEvents();
  },
  
  initValueTimeChart: function(cssVars) {
    if (!elements.valueTimeChart) return;
    app.charts.valueTimeChart = new Chart(elements.valueTimeChart, {
        type: 'line', 
        data: { 
            labels: [], 
            datasets: [{ 
                label: 'Contract Value', 
                data: [], 
                borderColor: cssVars.primary, 
                backgroundColor: cssVars.primary + '26', // Softer fill
                tension: 0.3, 
                fill: true, 
                pointBackgroundColor: cssVars.primary, 
                pointBorderColor: cssVars.bgPrimary, 
                pointHoverBackgroundColor: cssVars.bgPrimary,
                pointHoverBorderColor: cssVars.primary,
                pointBorderWidth: 2,
                pointHoverBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 2.5 
            }] 
        }, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { display: false }, 
                tooltip: { callbacks: { label: c => utils.formatMoney(c.raw) } } 
            }, 
            scales: { 
                x: { 
                    grid: { display: false }, 
                    ticks: { font: { size: 11 } } 
                }, 
                y: { 
                    beginAtZero: true, 
                    grid: { color: cssVars.border + '80' }, // Softer grid lines
                    ticks: { callback: v => utils.formatMoney(v), font: { size: 11 } } 
                } 
            },
            interaction: {
                mode: 'index',
                intersect: false,
            },
        } 
    });
  },
  
  initAgencyChart: function(cssVars) {
    if (!elements.agencyChart) return;
    app.charts.agencyChart = new Chart(elements.agencyChart, { 
        type: 'bar', 
        data: { 
            labels: [], 
            datasets: [{ 
                label: 'Contract Value', 
                data: [], 
                backgroundColor: [], 
                borderWidth: 0, 
                borderRadius: { topLeft: cssVars.radiusSm, topRight: cssVars.radiusSm }, // Only top radius for vertical bars
                barPercentage: 0.7, // Relative to Category
                categoryPercentage: 0.6 // Relative to Bar
            }] 
        }, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            indexAxis: 'y', 
            plugins: { 
                legend: { display: false }, 
                tooltip: { callbacks: { label: c => utils.formatMoney(c.raw) } } 
            }, 
            scales: { 
                x: { 
                    beginAtZero: true, 
                    grid: { color: cssVars.border + '80' },
                    ticks: { callback: v => utils.formatMoney(v), font: { size: 11 } } 
                }, 
                y: { 
                    grid: { display: false }, 
                    ticks: { font: { size: 11 }, callback: function(value) { return utils.truncateText(this.getLabelForValue(value), 18);} } // More text
                } 
            } 
        } 
    });
  },
  
  initNaicsBubbleChart: function(cssVars) {
    if (!elements.naicsBubbleChart) return;
    app.charts.naicsBubbleChart = new Chart(elements.naicsBubbleChart, { 
        type: 'bubble', 
        data: { datasets: [] }, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { display: false }, 
                tooltip: { 
                    callbacks: { 
                        label: c => { 
                            const d = c.dataset.data[c.dataIndex]; 
                            return [
                                utils.truncateText(d.label, 40) || '', 
                                `Contracts: ${d.x.toLocaleString()}`, 
                                `Value: ${utils.formatMoney(d.y)}`
                            ]; 
                        } 
                    } 
                } 
            }, 
            scales: { 
                x: { 
                    type: 'logarithmic', // Better for wide range of contract counts
                    position: 'bottom', 
                    title: { display: true, text: 'Number of Contracts (Log Scale)', font: { size: 11 } }, 
                    grid: { color: cssVars.border + '80' },
                    ticks: { font: { size: 10 }, 
                        callback: function(value, index, values) {
                            if (value === 1 || value === 10 || value === 100 || value === 1000 || value === 10000 || value === 100000) {
                                return value.toLocaleString();
                            }
                            return null; // Hide other ticks for log scale
                        }
                    } 
                }, 
                y: { 
                    type: 'logarithmic', // Better for wide range of values
                    title: { display: true, text: 'Total Contract Value (Log Scale)', font: { size: 11 } }, 
                    grid: { color: cssVars.border + '80' },
                    ticks: { callback: v => {
                            if (v >= 1000000000) return (v/1000000000).toFixed(0) + 'B';
                            if (v >= 1000000) return (v/1000000).toFixed(0) + 'M';
                            if (v >= 1000) return (v/1000).toFixed(0) + 'K';
                            return v.toFixed(0);
                        }, font: { size: 10 } 
                    } 
                } 
            } 
        } 
    });
  },
  
  initVendorChart: function(cssVars) {
    if (!elements.vendorChart) return;
    app.charts.vendorChart = new Chart(elements.vendorChart, { 
        type: 'bar', 
        data: { 
            labels: [], 
            datasets: [{ 
                label: 'Contract Value', 
                data: [], 
                backgroundColor: [], 
                borderWidth: 0, 
                borderRadius: { topLeft: cssVars.radiusSm, topRight: cssVars.radiusSm },
                barPercentage: 0.7,
                categoryPercentage: 0.6 
            }] 
        }, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            indexAxis: 'y', 
            plugins: { 
                legend: { display: false }, 
                tooltip: { callbacks: { label: c => utils.formatMoney(c.raw) } } 
            }, 
            scales: { 
                x: { 
                    beginAtZero: true, 
                    grid: { color: cssVars.border + '80' },
                    ticks: { callback: v => utils.formatMoney(v), font: { size: 11 } } 
                }, 
                y: { 
                    grid: { display: false }, 
                    ticks: { font: { size: 11 }, callback: function(value) { return utils.truncateText(this.getLabelForValue(value), 18);}} 
                } 
            } 
        } 
    });
  },
  
  initSankeyChart: function() {
    if (!elements.sankeyChartContainer || !d3 || !d3.sankey) {
         console.warn("Sankey chart container or D3/D3-Sankey not found."); return;
    }
    const c = elements.sankeyChartContainer; c.innerHTML = ''; 
    elements.sankeyTop10.addEventListener('click', () => { app.sankeyDisplayLimit = 10; elements.sankeyTop10.className = 'btn btn-sm btn-primary'; elements.sankeyTop25.className = 'btn btn-sm btn-secondary'; elements.sankeyAll.className = 'btn btn-sm btn-secondary'; this.updateSankeyChart(); });
    elements.sankeyTop25.addEventListener('click', () => { app.sankeyDisplayLimit = 25; elements.sankeyTop10.className = 'btn btn-sm btn-secondary'; elements.sankeyTop25.className = 'btn btn-sm btn-primary'; elements.sankeyAll.className = 'btn btn-sm btn-secondary'; this.updateSankeyChart(); });
    elements.sankeyAll.addEventListener('click', () => { app.sankeyDisplayLimit = 0; elements.sankeyTop10.className = 'btn btn-sm btn-secondary'; elements.sankeyTop25.className = 'btn btn-sm btn-secondary'; elements.sankeyAll.className = 'btn btn-sm btn-primary'; this.updateSankeyChart(); });
  },
  
  updateSankeyChart: function() {
    if (!elements.sankeyChartContainer || !d3 || !d3.sankey) return;
    const data = app.filteredData; 
    if (!data || data.length === 0) { 
        elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:20px; color:var(--text-secondary);">No data for Sankey chart.</p>'; 
        return; 
    }
    
    const sankeyData = dataProcessor.generateSankeyData(data, app.sankeyDisplayLimit);
    if (!sankeyData || !sankeyData.nodes || sankeyData.nodes.length === 0 || !sankeyData.links || sankeyData.links.length === 0) {
        elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:20px; color:var(--text-secondary);">Not enough data relationships for Sankey chart.</p>';
        return;
    }

    const container = elements.sankeyChartContainer; container.innerHTML = ''; 
    const width = container.clientWidth, height = container.clientHeight;
    if (width <= 0 || height <= 0) { 
        console.warn("Sankey container has no dimensions."); 
        return;
    }

    const svg = d3.select(container).append('svg').attr('width', width).attr('height', height);
    const sankeyLayout = d3.sankey()
        .nodeWidth(18) // Slightly wider nodes
        .nodePadding(12) // More padding
        .extent([[10, 10], [width - 10, height - 10]])
        .nodeSort((a,b) => b.value - a.value); 
    
    try {
        const graph = sankeyLayout({ nodes: sankeyData.nodes.map(d => ({...d})), links: sankeyData.links.map(d => ({...d})) });
        
        graph.nodes.forEach(n => n.color = utils.stringToColor(n.name + n.type)); 
        graph.links.forEach(l => {
          l.gradientId = `gradient-${l.source.index}-${l.target.index}`;
          const sourceColor = graph.nodes[l.source.index].color;
          const targetColor = graph.nodes[l.target.index].color;
        
          const gradient = svg.append("defs")
            .append("linearGradient")
            .attr("id", l.gradientId)
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", l.source.x1)
            .attr("x2", l.target.x0);

          gradient.append("stop").attr("offset", "0%").attr("stop-color", sourceColor);
          gradient.append("stop").attr("offset", "100%").attr("stop-color", targetColor);
        });

        const link = svg.append('g').attr('fill', 'none').attr('stroke-opacity', 0.6) // Slightly more opaque
          .selectAll('path')
          .data(graph.links)
          .join('path')
            .attr('d', d3.sankeyLinkHorizontal())
            .attr('stroke', d => `url(#${d.gradientId})`)
            .attr('stroke-width', d => Math.max(1.5, d.width)); // Slightly thicker base
        
        link.on('mouseover', function(event, d) {
              d3.select(this).attr('stroke-opacity', 0.9);
              elements.sankeyTooltip.style.opacity = 1;
              elements.sankeyTooltip.style.left = (event.pageX + 15) + 'px';
              elements.sankeyTooltip.style.top = (event.pageY - 15) + 'px';
              elements.sankeyTooltip.innerHTML = `
                <div style="font-weight:600;">${utils.truncateText(d.source.name, 25)} → ${utils.truncateText(d.target.name, 25)}</div>
                <div>Value: ${utils.formatMoney(d.value)}</div>`;
            })
            .on('mouseout', function() {
              d3.select(this).attr('stroke-opacity', 0.6);
              elements.sankeyTooltip.style.opacity = 0;
            })
            .on('click', (event, d) => {
              const sourceNode = d.source; const targetNode = d.target;
              if (sourceNode.type === 'agency' && targetNode.type === 'office') { filterManager.applySelectionFilter('agency', sourceNode.name, null); elements.agencyFilter.value = sourceNode.name; } 
              else if (sourceNode.type === 'office' && targetNode.type === 'vendor') { filterManager.applySelectionFilter('office', sourceNode.name, null); elements.officeFilter.value = sourceNode.name; }
            });

        const node = svg.append('g').attr('stroke', 'none') // No stroke on nodes for cleaner look
          .selectAll('rect')
          .data(graph.nodes)
          .join('rect')
            .attr('x', d => d.x0)
            .attr('y', d => d.y0)
            .attr('height', d => Math.max(1, d.y1 - d.y0)) 
            .attr('width', d => d.x1 - d.x0)
            .attr('fill', d => d.color)
            .attr('rx', 4) // Rounded corners for nodes
            .attr('ry', 4);

        node.on('mouseover', function(event, d) {
              d3.select(this).attr('fill', d3.color(d.color).darker(0.5));
              link.attr('stroke-opacity', l => l.source.index === d.index || l.target.index === d.index ? 0.9 : 0.15);
              elements.sankeyTooltip.style.opacity = 1;
              elements.sankeyTooltip.style.left = (event.pageX + 15) + 'px';
              elements.sankeyTooltip.style.top = (event.pageY - 15) + 'px';
              elements.sankeyTooltip.innerHTML = `
                <div style="font-weight:600;">${utils.truncateText(d.name, 30)}</div>
                <div>Type: ${d.type.charAt(0).toUpperCase() + d.type.slice(1)}</div>
                <div>Total Flow: ${utils.formatMoney(d.value)}</div>`;
            })
            .on('mouseout', function(event,d) {
              d3.select(this).attr('fill', d.color);
              link.attr('stroke-opacity', 0.6);
              elements.sankeyTooltip.style.opacity = 0;
            })
            .on('click', (event, d) => {
              if (d.type === 'agency') { filterManager.applySelectionFilter('agency', d.name, null); elements.agencyFilter.value = d.name; } 
              else if (d.type === 'office') { filterManager.applySelectionFilter('office', d.name, null); elements.officeFilter.value = d.name; } 
              else if (d.type === 'vendor') { filterManager.applySelectionFilter('vendor', d.name, null); elements.vendorFilter.value = d.name; }
            });
        
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
        
        svg.append('g').attr('font-family', 'var(--font-sans)').attr('font-size', 11).attr('font-weight', 500)
          .selectAll('text')
          .data(graph.nodes)
          .join('text')
            .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
            .attr('y', d => (d.y1 + d.y0) / 2)
            .attr('dy', '0.35em')
            .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
            .attr('fill', textColor)
            .text(d => utils.truncateText(d.name, (d.x1 - d.x0 > 60) ? 45 : 20)); 

    } catch (sankeyError) {
        console.error("Error rendering Sankey chart:", sankeyError);
        elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:20px; color:var(--text-secondary);">Error rendering Sankey chart.</p>';
    }
  },
  
  addChartClickEvents: function() {
    const addClickHandler = (container, chartGetter, filterTypeSetter) => {
        if (!container) return;
        container.addEventListener('click', ev => {
            const chart = chartGetter();
            if (!chart) return;
            const activePoints = chart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, true);
            if (activePoints.length > 0) {
                filterTypeSetter(chart, activePoints[0], container);
            }
        });
    };
    addClickHandler(elements.valueTimeChartContainer, () => app.charts.valueTimeChart, (chart, point) => {
        const label = chart.data.labels[point.index];
        const match = label.match(/(\w+)\s*'?(\d+)?/);
        if (match) {
            const monthName = match[1], yearShort = match[2] || new Date().getFullYear().toString().substr(2);
            const monthMap = { 'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5, 'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11 };
            if (monthMap[monthName] !== undefined) {
                const fullYear = parseInt('20' + yearShort);
                const startDate = new Date(fullYear, monthMap[monthName], 1);
                const endDate = new Date(fullYear, monthMap[monthName] + 1, 0);
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];
                elements.startDate.value = startDateStr; elements.endDate.value = endDateStr;
                app.filters.startDate = startDateStr; app.filters.endDate = endDateStr;
                filterManager.applyFilters(); filterManager.updateFilterTags(); dashboardManager.refreshDashboard();
            }
        }
    });
    addClickHandler(elements.agencyChartContainer, () => app.charts.agencyChart, (chart, point, cont) => {
        const label = chart.data.labels[point.index];
        const agencyName = Object.keys(app.agencies).find(name => utils.truncateText(name,18) === label || name === label);
        if (agencyName) { filterManager.applySelectionFilter('agency', agencyName, cont); if(elements.agencyFilter) elements.agencyFilter.value = agencyName; }
    });
    addClickHandler(elements.naicsBubbleChartContainer, () => app.charts.naicsBubbleChart, (chart, point, cont) => {
        const dataPoint = chart.data.datasets[point.datasetIndex].data[point.index];
        const fullLabel = dataPoint.label; // Get full label from data point
        const naicsCodeMatch = fullLabel.match(/^(\d[\d\w.-]*)/); 
        if (naicsCodeMatch && naicsCodeMatch[1]) {
            const naicsCode = naicsCodeMatch[1];
            filterManager.applySelectionFilter('naics', naicsCode, cont); if(elements.naicsFilter) elements.naicsFilter.value = naicsCode;
        }
    });
    addClickHandler(elements.vendorChartContainer, () => app.charts.vendorChart, (chart, point, cont) => {
        const label = chart.data.labels[point.index];
        const vendorName = Object.keys(app.vendors).find(name => utils.truncateText(name,18) === label || name === label);
        if (vendorName) { filterManager.applySelectionFilter('vendor', vendorName, cont); if(elements.vendorFilter) elements.vendorFilter.value = vendorName; }
    });
  },
  
  updateCharts: function() { 
      this.updateValueTimeChart(); this.updateAgencyChart(); this.updateNaicsBubbleChart(); this.updateVendorChart(); this.updateSankeyChart(); 
  },
  
  updateValueTimeChart: function() { 
    if (!app.charts.valueTimeChart) return;
    const data = app.filteredData; 
    const valueByMonth = {}; 
    data.forEach(c => { 
        if (c.parsedDate) { 
            const monthYear = `${c.parsedDate.getFullYear()}-${(c.parsedDate.getMonth() + 1).toString().padStart(2, '0')}`; 
            if (!valueByMonth[monthYear]) valueByMonth[monthYear] = 0; 
            valueByMonth[monthYear] += c.value; 
        } 
    }); 
    const sortedMonths = Object.keys(valueByMonth).sort(), labels = [], values = []; 
    sortedMonths.forEach(m => { 
        const [year, monthNum] = m.split('-'), date = new Date(parseInt(year), parseInt(monthNum) - 1, 1); 
        labels.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })); 
        values.push(valueByMonth[m]); 
    }); 
    const chart = app.charts.valueTimeChart; 
    chart.data.labels = labels; chart.data.datasets[0].data = values; chart.update(); 
  },
  
  updateAgencyChart: function() { 
    if (!app.charts.agencyChart) return;
    const data = app.filteredData; 
    const valueByAgency = {}; 
    data.forEach(c => { if (c.agency) { if (!valueByAgency[c.agency]) valueByAgency[c.agency] = 0; valueByAgency[c.agency] += c.value; } }); 
    const agencies = Object.keys(valueByAgency).map(a => ({ name: a, value: valueByAgency[a] })).sort((a, b) => b.value - a.value).slice(0, 10); // Top 10
    const chart = app.charts.agencyChart; 
    chart.data.labels = agencies.map(a => utils.truncateText(a.name, 18)); 
    chart.data.datasets[0].data = agencies.map(a => a.value); 
    chart.data.datasets[0].backgroundColor = agencies.map(a => utils.stringToColor(a.name)); 
    chart.update(); 
  },
  
  updateNaicsBubbleChart: function() { 
    if (!app.charts.naicsBubbleChart) return;
    const data = app.filteredData; 
    const naicsData = {}; 
    data.forEach(c => { 
        if (c.naics) { 
            if (!naicsData[c.naics]) naicsData[c.naics] = { code: c.naics, description: c.naicsDescription || c.naics, count: 0, value: 0 }; 
            naicsData[c.naics].count++; naicsData[c.naics].value += c.value; 
        } 
    }); 
    const topNaics = Object.values(naicsData).filter(n => n.count > 0 && n.value > 0).sort((a, b) => b.value - a.value).slice(0, 25); 
    
    const values = topNaics.map(n => n.value);
    const maxValue = Math.max(...values, 1); // Avoid division by zero if no values
    const radiusScale = d3.scaleSqrt().domain([0, maxValue]).range([4, 35]); // minRadius, maxRadius


    const chart = app.charts.naicsBubbleChart; 
    chart.data.datasets = [{ 
        label: topNaics.map(n => `${n.code} - ${utils.truncateText(n.description, 30)}`), // Used in tooltip
        data: topNaics.map(n => ({ 
            x: n.count, 
            y: n.value, 
            r: radiusScale(n.value), // Radius based on dollar value
            label: `${n.code} - ${n.description}` // Store full label for tooltip
        })), 
        backgroundColor: topNaics.map(n => utils.stringToColor(n.code) + 'B3'), 
        borderColor: topNaics.map(n => utils.stringToColor(n.code)), 
        borderWidth: 1.5 
    }]; 
    chart.update(); 
  },
  
  updateVendorChart: function() { 
    if (!app.charts.vendorChart) return;
    const data = app.filteredData; 
    const valueByVendor = {}; 
    data.forEach(c => { if (c.vendor) { if (!valueByVendor[c.vendor]) valueByVendor[c.vendor] = 0; valueByVendor[c.vendor] += c.value; } }); 
    const vendors = Object.keys(valueByVendor).map(v => ({ name: v, value: valueByVendor[v] })).sort((a, b) => b.value - a.value).slice(0, 10); // Top 10
    const chart = app.charts.vendorChart; 
    chart.data.labels = vendors.map(v => utils.truncateText(v.name, 18)); 
    chart.data.datasets[0].data = vendors.map(v => v.value); 
    chart.data.datasets[0].backgroundColor = vendors.map(v => utils.stringToColor(v.name)); 
    chart.update(); 
  }
};
    
	const tableManager = {
      initTableSorting: function() { 
        document.querySelectorAll('th[data-sort]').forEach(h => { 
            h.addEventListener('click', function() { 
                const table = this.closest('table');
                if (!table) return;
                const tbody = table.querySelector('tbody');
                if (!tbody) return;
                const rowsArray = Array.from(tbody.querySelectorAll('tr'));
                const sortField = this.getAttribute('data-sort'); 
                let sortDirection = 'asc'; 
                if (this.classList.contains('sort-asc')) { sortDirection = 'desc'; } 
                else if (this.classList.contains('sort-desc')) { sortDirection = 'asc'; }
                
                table.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc', 'sort-desc')); 
                this.classList.add(`sort-${sortDirection}`); 
                
                const compareFn = (a, b) => { 
                    const cellA = a.querySelector(`td:nth-child(${Array.from(this.parentNode.children).indexOf(this) + 1})`);
                    const cellB = b.querySelector(`td:nth-child(${Array.from(this.parentNode.children).indexOf(this) + 1})`);
                    if (!cellA || !cellB) return 0;
                    let valA = cellA.textContent.trim(), valB = cellB.textContent.trim(); 
                    
                    if (sortField === 'value' || sortField === 'contracts') { 
                        valA = utils.parseMoney(valA); valB = utils.parseMoney(valB); 
                    } else if (sortField === 'date') { 
                        valA = utils.parseDate(valA)?.getTime() || 0; valB = utils.parseDate(valB)?.getTime() || 0; 
                    } else { 
                        valA = valA.toLowerCase(); valB = valB.toLowerCase();
                    }
                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1; 
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1; 
                    return 0; 
                }; 
                rowsArray.sort(compareFn).forEach(r => tbody.appendChild(r)); 
            }); 
        }); 
      },
      updateContractsTable: function() { 
        if (!elements.contractsTable) return;
        const data = app.filteredData, tbody = elements.contractsTable; tbody.innerHTML = ''; 
        [...data].sort((a, b) => (b.parsedDate?.getTime() || 0) - (a.parsedDate?.getTime() || 0)).slice(0, 15).forEach(c => this.addContractRow(c, tbody)); 
      },
      updateLargestContractsTable: function() { 
        if (!elements.largestContractsTable) return;
        const data = app.filteredData, tbody = elements.largestContractsTable; tbody.innerHTML = ''; 
        [...data].sort((a, b) => b.value - a.value).slice(0, 15).forEach(c => this.addContractRow(c, tbody)); 
      },
      addContractRow: function(contract, tbody) { 
        const row = document.createElement('tr'); 
        const agencyInitials = utils.getInitials(contract.agency), agencyColor = utils.stringToColor(contract.agency);
        const officeInitials = utils.getInitials(contract.office), officeColor = utils.stringToColor(contract.office);
        const vendorInitials = utils.getInitials(contract.vendor), vendorColor = utils.stringToColor(contract.vendor); 
        row.innerHTML = `
            <td class="table-date-cell">${utils.formatDate(contract.date)}</td>
            <td>${utils.truncateText(contract.id, 15)}</td>
            <td><div class="agency-badge" title="${contract.agency}"><div class="agency-icon" style="background-color:${agencyColor}">${agencyInitials}</div> ${utils.truncateText(contract.agency,15)}</div></td>
            <td><div class="office-badge" title="${contract.office}"><div class="office-icon" style="background-color:${officeColor}">${officeInitials}</div> ${utils.truncateText(contract.office,15)}</div></td>
            <td><div class="vendor-badge" title="${contract.vendor}"><div class="vendor-icon" style="background-color:${vendorColor}">${vendorInitials}</div> ${utils.truncateText(contract.vendor,15)}</div></td>
            <td title="${contract.description}">${utils.truncateText(contract.description,30)}</td>
            <td class="money">${utils.formatMoney(contract.value)}</td>
            <td><button class="btn btn-sm btn-primary view-contract" data-id="${contract.id}"><span class="btn-text">Details</span></button></td>`; 
        tbody.appendChild(row); 
        const viewButton = row.querySelector('.view-contract');
        if(viewButton) viewButton.addEventListener('click', function() { tableManager.showContractDetails(this.getAttribute('data-id')); }); 
      },
      updateOfficesTable: function() { 
        if (!elements.officesTable) return;
        const data = app.filteredData, tbody = elements.officesTable; tbody.innerHTML = ''; 
        const officeData = {}; 
        data.forEach(c => { 
            if (c.office) { 
                if (!officeData[c.office]) officeData[c.office] = { name: c.office, agency: c.agency, count: 0, value: 0, naicsCodes: {}, vendors: {} }; 
                officeData[c.office].count++; officeData[c.office].value += c.value; 
                if (c.naics) { 
                    if (!officeData[c.office].naicsCodes[c.naics]) officeData[c.office].naicsCodes[c.naics] = { code: c.naics, description: c.naicsDescription, count: 0, value: 0 }; 
                    officeData[c.office].naicsCodes[c.naics].count++; officeData[c.office].naicsCodes[c.naics].value += c.value; 
                } 
                if (c.vendor) { 
                    if (!officeData[c.office].vendors[c.vendor]) officeData[c.office].vendors[c.vendor] = { name: c.vendor, count: 0, value: 0 }; 
                    officeData[c.office].vendors[c.vendor].count++; officeData[c.office].vendors[c.vendor].value += c.value; 
                } 
            } 
        }); 
        Object.values(officeData).sort((a, b) => b.value - a.value).slice(0, 10).forEach(office => { 
            const topNaics = Object.values(office.naicsCodes).sort((a, b) => b.value - a.value)[0] || { code: 'N/A', description: 'N/A' }; 
            const topVendor = Object.values(office.vendors).sort((a, b) => b.value - a.value)[0] || { name: 'N/A' }; 
            const agencyInitials = utils.getInitials(office.agency), agencyColor = utils.stringToColor(office.agency);
            const officeInitials = utils.getInitials(office.name), officeColor = utils.stringToColor(office.name);
            const vendorInitials = utils.getInitials(topVendor.name), vendorColor = utils.stringToColor(topVendor.name); 
            const row = document.createElement('tr'); 
            row.innerHTML = `
                <td><div class="agency-badge" title="${office.agency}"><div class="agency-icon" style="background-color:${agencyColor}">${agencyInitials}</div> ${utils.truncateText(office.agency,15)}</div></td>
                <td><div class="office-badge" title="${office.name}"><div class="office-icon" style="background-color:${officeColor}">${officeInitials}</div> ${utils.truncateText(office.name,15)}</div></td>
                <td>${office.count.toLocaleString()}</td>
                <td class="money">${utils.formatMoney(office.value)}</td>
                <td><span class="badge badge-primary" title="${topNaics.description}">${topNaics.code}</span></td>
                <td><div class="vendor-badge" title="${topVendor.name}"><div class="vendor-icon" style="background-color:${vendorColor}">${vendorInitials}</div> ${utils.truncateText(topVendor.name,15)}</div></td>`; 
            tbody.appendChild(row); 
            row.addEventListener('click', function() { filterManager.applySelectionFilter('office', office.name, null); if(elements.officeFilter) elements.officeFilter.value = office.name; }); 
        }); 
      },
      showContractDetails: function(contractId) { 
        const contract = app.data.find(c => c.id === contractId); if (!contract) { console.error('Contract not found:', contractId); return; } 
        const agencyInitials = utils.getInitials(contract.agency), agencyColor = utils.stringToColor(contract.agency);
        const officeInitials = utils.getInitials(contract.office), officeColor = utils.stringToColor(contract.office);
        const vendorInitials = utils.getInitials(contract.vendor), vendorColor = utils.stringToColor(contract.vendor); 
        elements.contractModalBody.innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:1.5rem;">
                <div>
                    <h4 style="margin-bottom:0.75rem;font-size:1.1rem;color:var(--primary);">Contract Information</h4>
                    <p><strong>Contract ID:</strong> ${contract.id}</p>
                    <p><strong>Reference IDV:</strong> ${contract.reference||'N/A'}</p>
                    <p><strong>Date Signed:</strong> ${utils.formatDate(contract.date)}</p>
                    <p><strong>Contract Type:</strong> ${contract.type||'N/A'}</p>
                    <p><strong>Value:</strong> <span class="money">${utils.formatMoney(contract.value)}</span></p>
                </div>
                <div>
                    <h4 style="margin-bottom:0.75rem;font-size:1.1rem;color:var(--primary);">Parties Involved</h4>
                    <p style="display:flex;align-items:center;margin-bottom:0.5rem;"><div class="agency-icon" style="background-color:${agencyColor};margin-right:0.5rem;">${agencyInitials}</div><strong>Agency:</strong> ${contract.agency}</p>
                    <p style="display:flex;align-items:center;margin-bottom:0.5rem;"><div class="office-icon" style="background-color:${officeColor};margin-right:0.5rem;">${officeInitials}</div><strong>Office:</strong> ${contract.office||'N/A'}</p>
                    <p style="display:flex;align-items:center;margin-bottom:0.5rem;"><div class="vendor-icon" style="background-color:${vendorColor};margin-right:0.5rem;">${vendorInitials}</div><strong>Vendor:</strong> ${contract.vendor}</p>
                    <p><strong>Parent Company:</strong> ${contract.parentVendor||'N/A'}</p>
                </div>
            <div style="margin-top:1.5rem;">
                <h4 style="margin-bottom:0.75rem;font-size:1.1rem;color:var(--primary);">Description & Codes</h4>
                <p><strong>Description:</strong> ${contract.description||'No description available.'}</p>
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:1rem;margin-top:1rem;">
                    <div><p><strong>NAICS:</strong> ${contract.naics||'N/A'}</p><p style="font-size:var(--font-xs);color:var(--text-secondary);">${contract.naicsDescription||''}</p></div>
                    <div><p><strong>PSC:</strong> ${contract.psc||'N/A'}</p><p style="font-size:var(--font-xs);color:var(--text-secondary);">${contract.pscDescription||''}</p></div>
                </div>
            </div>
            <div style="margin-top:1.5rem;display:flex;gap:0.75rem;flex-wrap:wrap;justify-content:center;">
                <button id="modalFilterByAgency" class="btn btn-sm btn-secondary"><i class="fas fa-filter"></i> <span class="btn-text">Filter by Agency</span></button>
                <button id="modalFilterByOffice" class="btn btn-sm btn-secondary"><i class="fas fa-filter"></i> <span class="btn-text">Filter by Office</span></button>
                <button id="modalFilterByVendor" class="btn btn-sm btn-secondary"><i class="fas fa-filter"></i> <span class="btn-text">Filter by Vendor</span></button>
            </div>`; 
        elements.contractModal.classList.add('active'); 
        document.getElementById('modalFilterByAgency')?.addEventListener('click', () => { filterManager.applySelectionFilter('agency', contract.agency, elements.agencyChartContainer); if(elements.agencyFilter) elements.agencyFilter.value = contract.agency; this.hideContractDetails(); }); 
        document.getElementById('modalFilterByOffice')?.addEventListener('click', () => { filterManager.applySelectionFilter('office', contract.office, null); if(elements.officeFilter) elements.officeFilter.value = contract.office; this.hideContractDetails(); }); 
        document.getElementById('modalFilterByVendor')?.addEventListener('click', () => { filterManager.applySelectionFilter('vendor', contract.vendor, elements.vendorChartContainer); if(elements.vendorFilter) elements.vendorFilter.value = contract.vendor; this.hideContractDetails(); }); 
      },
      hideContractDetails: function() { elements.contractModal.classList.remove('active'); },
      updateTables: function() { this.updateContractsTable(); this.updateLargestContractsTable(); this.updateOfficesTable(); }
    };
    
    const dashboardManager = {
      initDashboard: function() { 
        if (!elements.loadingIndicator || !elements.errorMessage || !elements.noDataMessage || !elements.dashboard || !elements.statusBox) {
            console.error("One or more critical dashboard elements are missing from the DOM.");
            return;
        }
        elements.loadingIndicator.style.display = 'none'; 
        elements.errorMessage.style.display = 'none'; 
        elements.noDataMessage.style.display = 'none'; 
        elements.dashboard.style.display = 'flex'; 
        elements.statusBox.style.display = 'flex'; 
        chartManager.initCharts(); 
        tableManager.initTableSorting(); 
        this.refreshDashboard(); 
      },
      refreshDashboard: function() { 
        this.updateStats(); chartManager.updateCharts(); tableManager.updateTables(); filterManager.updateFilterTags(); 
      },
      updateStats: function() { 
        const d = app.filteredData; 
        if(elements.totalContracts) elements.totalContracts.textContent = d.length.toLocaleString(); 
        if(elements.totalValue) elements.totalValue.textContent = utils.formatMoney(d.reduce((s, c) => s + c.value, 0)); 
        if(elements.avgValue) elements.avgValue.textContent = utils.formatMoney(d.length > 0 ? d.reduce((s, c) => s + c.value, 0) / d.length : 0); 
        if(elements.uniqueVendors) elements.uniqueVendors.textContent = new Set(d.map(c => c.vendor).filter(Boolean)).size.toLocaleString(); 
      }
    };

    // Data Generator for sample data
    const sampleDataGenerator = {
      agencies: [
        "Department of Defense", "Department of Veterans Affairs", "Department of Homeland Security", 
        "Department of Health and Human Services", "Department of Energy", "NASA", 
        "General Services Administration", "Department of Justice", "Department of State", 
        "Department of Agriculture"
      ],
      offices: {
        "Department of Defense": ["Pentagon Contracting Office", "Army Contracting Command", "Naval Supply Systems Command", "Air Force Materiel Command"],
        "Department of Veterans Affairs": ["VA National Acquisition Center", "VA Technology Acquisition Center", "Veterans Health Administration Procurement"],
        "Department of Homeland Security": ["DHS Office of Procurement Operations", "FEMA Acquisition Management Division", "CBP Procurement Directorate"],
        "Department of Health and Human Services": ["CMS Office of Acquisition and Grants", "NIH Office of Acquisition Management", "CDC Procurement and Grants Office"],
        "Department of Energy": ["DOE Office of Acquisition Management", "National Nuclear Security Administration", "Office of Environmental Management"],
        "NASA": ["NASA Shared Services Center", "Johnson Space Center Procurement", "Goddard Space Flight Center Procurement"],
        "General Services Administration": ["Federal Acquisition Service", "Public Buildings Service", "GSA IT Acquisition Operations"],
        "Department of Justice": ["FBI Procurement Section", "DEA Office of Acquisition", "Office of Justice Programs"],
        "Department of State": ["Office of Acquisition Management", "Overseas Buildings Operations", "Bureau of Diplomatic Security"],
        "Department of Agriculture": ["Agricultural Research Service", "Forest Service Acquisition Management", "Farm Service Agency"]
      },
      vendors: [
        "Lockheed Martin Corporation", "Boeing Company", "Raytheon Technologies", "General Dynamics Corporation", 
        "Northrop Grumman", "McKesson Corporation", "Leidos Holdings", "Booz Allen Hamilton", 
        "CACI International", "Science Applications International Corporation", "Humana Inc.", 
        "Microsoft Corporation", "Amazon Web Services", "Dell Technologies", "IBM Corporation",
        "Accenture Federal Services", "Deloitte Consulting", "ManTech International", "CGI Federal",
        "L3Harris Technologies"
      ],
      naicsCodes: [
        {code: "541330", description: "Engineering Services"},
        {code: "541512", description: "Computer Systems Design Services"},
        {code: "541519", description: "Other Computer Related Services"},
        {code: "541611", description: "Administrative Management Consulting Services"},
        {code: "541990", description: "All Other Professional and Technical Services"},
        {code: "334511", description: "Search, Detection & Navigation Instruments"},
        {code: "336411", description: "Aircraft Manufacturing"},
        {code: "336414", description: "Guided Missile and Space Vehicle Manufacturing"},
        {code: "541712", description: "Research and Development in Physical Sciences"},
        {code: "561210", description: "Facilities Support Services"}
      ],
      pscCodes: [
        {code: "R425", description: "Engineering and Technical Services"},
        {code: "D302", description: "IT and Telecom- Systems Development"},
        {code: "7030", description: "ADP Software"},
        {code: "6625", description: "Electrical and Electronic Properties Testing Instruments"},
        {code: "5895", description: "Miscellaneous Communication Equipment"},
        {code: "R408", description: "Program Management/Support Services"},
        {code: "AC65", description: "Medical- Hospital Equipment and Supplies"},
        {code: "M1GC", description: "Operation of Government-Owned Facilities"},
        {code: "4310", description: "Compressors and Vacuum Pumps"},
        {code: "8415", description: "Clothing, Special Purpose"}
      ],
      generateRandomContract: function(index) {
        const agency = this.agencies[Math.floor(Math.random() * this.agencies.length)];
        const office = this.offices[agency][Math.floor(Math.random() * this.offices[agency].length)];
        const vendor = this.vendors[Math.floor(Math.random() * this.vendors.length)];
        const naics = this.naicsCodes[Math.floor(Math.random() * this.naicsCodes.length)];
        const psc = this.pscCodes[Math.floor(Math.random() * this.pscCodes.length)];
        
        // Generate a date within the last 3 years
        const today = new Date();
        const threeYearsAgo = new Date();
        threeYearsAgo.setFullYear(today.getFullYear() - 3);
        const randomTimestamp = threeYearsAgo.getTime() + Math.random() * (today.getTime() - threeYearsAgo.getTime());
        const randomDate = new Date(randomTimestamp);
        
        // Format date as "DD-MMM-YY"
        const day = randomDate.getDate().toString().padStart(2, '0');
        const month = randomDate.toLocaleString('en-US', { month: 'short' });
        const year = randomDate.getFullYear().toString().slice(-2);
        const formattedDate = `${day}-${month}-${year}`;
        
        // Generate random contract value between $10K and $50M
        const value = Math.floor(Math.random() * 50000000) + 10000;
        
        return {
          id: `CONTRACT${index.toString().padStart(8, '0')}`,
          reference: `IDV${Math.floor(Math.random() * 10000000)}`,
          modification: `MOD${Math.floor(Math.random() * 100)}`,
          date: formattedDate,
          parsedDate: randomDate,
          type: Math.random() > 0.5 ? 'Award' : 'IDV',
          value: value,
          agency: agency,
          office: office,
          psc: psc.code,
          pscDescription: psc.description,
          naics: naics.code,
          naicsDescription: naics.description,
          vendor: vendor,
          parentVendor: Math.random() > 0.7 ? `Parent of ${vendor}` : vendor,
          description: `${psc.description} - ${naics.description}`
        };
      },
      generateSampleData: function(count) {
        const contracts = [];
        for (let i = 0; i < count; i++) {
          contracts.push(this.generateRandomContract(i + 1));
        }
        return contracts;
      },
      getCsvText: function(contracts) {
        // Create headers
        const headers = ["Contract ID", "Reference IDV", "Modification Number", "Date Signed", 
                        "Award/IDV Type", "Action Obligation ($)", "Contracting Agency", 
                        "Contracting Office Name", "PSC", "PSC Description", "NAICS", 
                        "NAICS Description", "Legal Business Name", "Ultimate Parent Legal Business Name"];
        
        let csvText = headers.join(",") + "\n";
        
        // Add rows
        contracts.forEach(contract => {
          const row = [
            contract.id,
            contract.reference,
            contract.modification,
            contract.date,
            contract.type,
            contract.value,
            contract.agency,
            contract.office,
            contract.psc,
            `"${contract.pscDescription}"`, // Adding quotes to handle commas in description
            contract.naics,
            `"${contract.naicsDescription}"`, // Adding quotes to handle commas in description
            `"${contract.vendor}"`, // Adding quotes to handle commas in vendor names
            `"${contract.parentVendor}"` // Adding quotes to handle commas in parent vendor names
          ];
          csvText += row.join(",") + "\n";
        });
        
        return csvText;
      }
    };

    const fileHandler = {
      processAndDisplayCsv: function(csvText, fileNameForDisplay = "Uploaded Data") {
        try {
          filterManager.resetFilters(); 
          const csvData = utils.parseCSV(csvText);
          const processedData = dataProcessor.processData(csvData);
          app.data = processedData; 
          app.filteredData = [...processedData]; 
          const analysis = dataProcessor.analyzeData(processedData);
          app.agencies = analysis.agencies; app.offices = analysis.offices; app.vendors = analysis.vendors;
          app.naicsCodes = analysis.naicsCodes; app.pscCodes = analysis.pscCodes;
          this.populateFilterDropdowns();
          dashboardManager.initDashboard(); 
          const uploadBtnTextSpan = elements.uploadBtn.querySelector('.btn-text');
          if(uploadBtnTextSpan) uploadBtnTextSpan.textContent = 'Upload CSV'; 
          if(elements.csvFile) elements.csvFile.value = ''; 
        } catch (error) {
          console.error(`Error processing ${fileNameForDisplay}:`, error);
          this.showError(`Error processing ${fileNameForDisplay}: ${error.message}. Please check CSV format and required columns.`);
          if(app.data.length === 0 && elements.dashboard && elements.noDataMessage && elements.statusBox) {
            elements.dashboard.style.display = 'none';
            if (elements.statusBox) elements.statusBox.style.display = 'flex'; 
            elements.noDataMessage.style.display = 'flex';
          }
        } finally {
          if(elements.loadingIndicator) elements.loadingIndicator.style.display = 'none';
        }
      },
      loadSampleData: function(dataType) {
        if (!elements.loadingIndicator || !elements.errorMessage || !elements.noDataMessage || !elements.dashboard || !elements.statusBox) return;
        elements.loadingIndicator.style.display = 'flex';
        elements.errorMessage.style.display = 'none';
        elements.noDataMessage.style.display = 'none'; 
        elements.dashboard.style.display = 'none'; 
        if (elements.statusBox) elements.statusBox.style.display = 'none'; 
        
        try {
          let numContracts = 100; // Default to 100 contracts
          
          if (dataType === 'ytd') {
            numContracts = 150; // More recent contracts for YTD
          } else if (dataType === 'saas') {
            numContracts = 75; // Fewer but larger contracts for SaaS 3YR
          }
          
          const sampleContracts = sampleDataGenerator.generateSampleData(numContracts);
          const csvText = sampleDataGenerator.getCsvText(sampleContracts);
          
          this.processAndDisplayCsv(csvText, `${dataType.toUpperCase()} Sample Data`);
        } catch (error) {
          console.error(`Error generating sample data:`, error);
          this.showError(`Failed to generate sample data: ${error.message}.`);
          if(elements.loadingIndicator) elements.loadingIndicator.style.display = 'none';
          if(app.data.length === 0 && elements.noDataMessage && elements.statusBox) {
            elements.noDataMessage.style.display = 'flex';
            if (elements.statusBox) elements.statusBox.style.display = 'flex';
          } else if (elements.dashboard && elements.statusBox) {
            elements.dashboard.style.display = 'flex'; 
            if (elements.statusBox) elements.statusBox.style.display = 'flex';
          }
        }
      },
      handleFileUpload: function() {
        if (!elements.csvFile || !elements.loadingIndicator || !elements.errorMessage || !elements.noDataMessage || !elements.dashboard || !elements.statusBox) return;
        const file = elements.csvFile.files[0];
        if (!file) return; 

        const fileName = file.name.toLowerCase();
        const isValidExtension = fileName.endsWith('.csv') || fileName.endsWith('.xls'); 
        if (!isValidExtension) { 
            this.showError('Please upload a valid CSV file (or .xls if from iOS).'); 
            elements.csvFile.value = ''; 
            return; 
        }
        elements.loadingIndicator.style.display = 'flex';
        elements.errorMessage.style.display = 'none';
        elements.noDataMessage.style.display = 'none';
        elements.dashboard.style.display = 'none';
        if (elements.statusBox) elements.statusBox.style.display = 'none';
        
        const reader = new FileReader();
        reader.onload = (event) => {
          this.processAndDisplayCsv(event.target.result, file.name);
          const uploadBtnTextSpan = elements.uploadBtn.querySelector('.btn-text');
          if(uploadBtnTextSpan) uploadBtnTextSpan.textContent = ` ${utils.truncateText(file.name,10)}`;
        };
        reader.onerror = () => {
          this.showError('Error reading the file.');
          if(elements.loadingIndicator) elements.loadingIndicator.style.display = 'none';
           if(app.data.length === 0 && elements.noDataMessage && elements.statusBox) {
                elements.noDataMessage.style.display = 'flex';
                if (elements.statusBox) elements.statusBox.style.display = 'flex';
           } else if (elements.dashboard && elements.statusBox) {
                elements.dashboard.style.display = 'flex';
                if (elements.statusBox) elements.statusBox.style.display = 'flex';
           }
        };
        reader.readAsText(file);
      },
      showError: function(message) { 
          if(elements.errorMessage) {
            elements.errorMessage.textContent = message; 
            elements.errorMessage.style.display = 'block'; 
          }
      },
      populateFilterDropdowns: function() {
        const populate = (el, items, valueField, labelFn, defaultOptionText) => { 
            if (!el) return;
            const currentVal = el.value;
            el.innerHTML = `<option value="">${defaultOptionText}</option>`; 
            Object.values(items) 
                .sort((a, b) => (b.value || 0) - (a.value || 0)) 
                .slice(0, 200) 
                .forEach(item => { 
                    const option = document.createElement('option'); 
                    option.value = item[valueField]; 
                    option.textContent = labelFn(item); 
                    el.appendChild(option); 
                });
            if (currentVal && Array.from(el.options).some(opt => opt.value === currentVal)) {
                el.value = currentVal;
            }
        };
        populate(elements.agencyFilter, app.agencies, 'name', i => `${utils.truncateText(i.name, 35)} (${i.count.toLocaleString()})`, 'All Agencies');
        populate(elements.officeFilter, app.offices, 'name', i => `${utils.truncateText(i.name, 35)} (${i.count.toLocaleString()})`, 'Any Office');
        populate(elements.naicsFilter, app.naicsCodes, 'code', i => `${i.code} - ${utils.truncateText(i.description, 30)} (${i.count.toLocaleString()})`, 'Any NAICS');
        populate(elements.pscFilter, app.pscCodes, 'code', i => `${i.code} - ${utils.truncateText(i.description, 30)} (${i.count.toLocaleString()})`, 'Any PSC');
        populate(elements.vendorFilter, app.vendors, 'name', i => `${utils.truncateText(i.name, 35)} (${i.count.toLocaleString()})`, 'All Vendors');
      }
    };

    function updateExampleButtonActiveState(activeButton) {
      const exampleButtons = [elements.loadExample1Btn, elements.loadExample2Btn ]; 
      exampleButtons.forEach(button => {
        if (button) {
          if (button === activeButton) {
            button.classList.remove('btn-secondary'); button.classList.add('btn-primary');
          } else {
            button.classList.remove('btn-primary'); button.classList.add('btn-secondary');
          }
        }
      });
    }

    function setupEventListeners() {
      if(elements.csvFile) elements.csvFile.addEventListener('change', () => fileHandler.handleFileUpload());
      if(elements.loadExample1Btn) elements.loadExample1Btn.addEventListener('click', () => { fileHandler.loadSampleData('ytd'); updateExampleButtonActiveState(elements.loadExample1Btn); });
      if(elements.loadExample2Btn) elements.loadExample2Btn.addEventListener('click', () => { fileHandler.loadSampleData('saas'); updateExampleButtonActiveState(elements.loadExample2Btn); });

      let searchTimeout;
      if(elements.searchInput) elements.searchInput.addEventListener('input', () => { 
          clearTimeout(searchTimeout); 
          searchTimeout = setTimeout(() => { 
              app.filters.search = elements.searchInput.value; 
              filterManager.applyFilters(); 
              dashboardManager.refreshDashboard(); 
          }, 400); 
      });

      const addFilterListener = (el, filterKey, chartContainerForSelection = null) => {
        if (el) {
            el.addEventListener('change', () => {
                const value = el.value;
                if (value) app.filters[filterKey] = value;
                else delete app.filters[filterKey];
                
                if (['agency', 'vendor', 'naics', 'psc', 'office'].includes(filterKey)) {
                     filterManager.applySelectionFilter(filterKey, value, chartContainerForSelection);
                } else { 
                    filterManager.applyFilters();
                    dashboardManager.refreshDashboard();
                }
            });
        }
      };

      addFilterListener(elements.agencyFilter, 'agency', elements.agencyChartContainer);
      addFilterListener(elements.vendorFilter, 'vendor', elements.vendorChartContainer);
      addFilterListener(elements.pscFilter, 'psc', null); 
      addFilterListener(elements.valueFilter, 'valueRange');
      addFilterListener(elements.startDate, 'startDate');
      addFilterListener(elements.endDate, 'endDate');
      addFilterListener(elements.officeFilter, 'office', null); 
      addFilterListener(elements.naicsFilter, 'naics', elements.naicsBubbleChartContainer); 

      if(elements.moreFiltersBtn) elements.moreFiltersBtn.addEventListener('click', () => elements.advancedFiltersPanel.classList.toggle('active'));
      if(elements.closeFilters) elements.closeFilters.addEventListener('click', () => elements.advancedFiltersPanel.classList.remove('active'));
      if(elements.mobileFilterBtn) elements.mobileFilterBtn.addEventListener('click', () => {
        if (elements.advancedFiltersPanel) {
            elements.advancedFiltersPanel.classList.toggle('active');
            if (elements.advancedFiltersPanel.classList.contains('active')) {
                elements.advancedFiltersPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        } else if (elements.appHeader) {
             elements.appHeader.scrollIntoView({behavior: 'smooth'}); 
        }
      });
      if(elements.resetFilters) elements.resetFilters.addEventListener('click', () => { filterManager.resetFilters(); if(elements.advancedFiltersPanel) elements.advancedFiltersPanel.classList.remove('active'); });
      
      if(elements.themeToggle) elements.themeToggle.addEventListener('click', () => toggleTheme());
      
      elements.tabButtons.forEach(btn => {
  btn.addEventListener('click', function() {
    // Remove active class from all buttons and tab contents
    elements.tabButtons.forEach(b => b.classList.remove('active'));
    elements.tabContents.forEach(c => c.classList.remove('active'));
    
    // Add active class to clicked button
    this.classList.add('active');
    
    // Show corresponding tab content
    const tabId = this.getAttribute('data-tab') + 'Tab';
    const tabContent = document.getElementById(tabId);
    if (tabContent) {
      tabContent.classList.add('active');
    }
  });
});

      if(elements.closeModal) elements.closeModal.addEventListener('click', () => tableManager.hideContractDetails());
      if(elements.closeModalBtn) elements.closeModalBtn.addEventListener('click', () => tableManager.hideContractDetails());
      if(elements.contractModal) elements.contractModal.addEventListener('click', e => { if (e.target === elements.contractModal) tableManager.hideContractDetails(); });
      
      let resizeTimer;
      window.addEventListener('resize', () => { 
          clearTimeout(resizeTimer); 
          resizeTimer = setTimeout(() => { 
              if (elements.dashboard && elements.dashboard.style.display !== 'none') { 
                  chartManager.updateSankeyChart(); 
                  Object.values(app.charts).forEach(c => { if (c instanceof Chart) c.resize(); }); 
              } 
          }, 250); 
      });
    }
function initThemeToggle() {
  const darkmodeToggle = document.getElementById('darkmode-toggle');
  
  // Set initial state based on current theme
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
  darkmodeToggle.checked = currentTheme === 'dark';
  
  darkmodeToggle.addEventListener('change', function() {
    // Toggle theme
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    // Update chart themes if needed
    if (app.charts && Object.keys(app.charts).length > 0 && typeof Chart !== 'undefined') {
      Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
      Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
      Chart.defaults.plugins.tooltip.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim();
      Chart.defaults.plugins.tooltip.titleColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
      Chart.defaults.plugins.tooltip.bodyColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
      Chart.defaults.plugins.tooltip.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();

      Object.values(app.charts).forEach(chartInstance => {
        if (chartInstance instanceof Chart) {
          // Update scales
          if (chartInstance.options.scales) {
            Object.values(chartInstance.options.scales).forEach(scale => {
              if (scale.ticks) scale.ticks.color = Chart.defaults.color;
              if (scale.grid) scale.grid.color = Chart.defaults.borderColor + '80'; // Softer grid
              if (scale.title && scale.title.display) scale.title.color = Chart.defaults.color;
            });
          }
          // Update line chart dataset colors
          if (chartInstance.config.type === 'line' && chartInstance.data.datasets.length > 0) {
            chartInstance.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
            chartInstance.data.datasets[0].backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() + '26';
            chartInstance.data.datasets[0].pointBackgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
            chartInstance.data.datasets[0].pointBorderColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim();
          }
          chartInstance.update('none'); // 'none' for no animation during theme change
        }
      });
      
      if (elements.dashboard && elements.dashboard.style.display !== 'none') {
        setTimeout(() => chartManager.updateSankeyChart(), 50); // Delay Sankey update slightly for styles to apply
      }
    }
  });
}
function loadSavedTheme() {
  const savedTheme = localStorage.getItem('theme');
  let effectiveTheme = document.documentElement.getAttribute('data-theme') || 
                      (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  
  if (savedTheme) { 
    document.documentElement.setAttribute('data-theme', savedTheme);
    effectiveTheme = savedTheme;
  } else {
    document.documentElement.setAttribute('data-theme', effectiveTheme); 
  }
  
  // Set initial toggle state based on theme
  const darkmodeToggle = document.getElementById('darkmode-toggle');
  if (darkmodeToggle) {
    darkmodeToggle.checked = effectiveTheme === 'dark';
  }
}

function init() {
  loadSavedTheme();
  initThemeToggle(); // Call the new function instead of your previous theme setup
  setupEventListeners();
  if(elements.loadExample1Btn) {
      updateExampleButtonActiveState(elements.loadExample1Btn);
      fileHandler.loadSampleData('ytd');
  } else { 
      fileHandler.loadSampleData('ytd');
  }
}

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init(); 
    }
  </script>
</body>
</html>