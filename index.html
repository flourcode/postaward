<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Post Award helps you analyze federal contract data to spot trends, find prime contractors, and identify subcontracting opportunities.">
  <meta name="keywords" content="federal contracts, FPDS, contract analysis, government procurement, subcontracting">
  <meta name="author" content="Mark">
  
  <!-- Open Graph / Social Media -->
  <meta property="og:title" content="Post Award - Federal Contract Intelligence">
  <meta property="og:description" content="Analyze federal contract data to find opportunities and track spending.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://postaward.com">
  <meta property="og:image" content="https://postaward.com/images/og-image.png">
  
  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <title>Post Award - Federal Contract Intelligence</title>
  
  <!-- Preconnect to external domains for faster loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  
  <!-- Stylesheets with preload for critical CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWJYQQZYFW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-YWJYQQZYFW');
  </script>
  
  <!-- Defer non-critical scripts -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
</script>

  <style>
    :root {
      /* Enhanced Colors - Softer, more modern feel */
      --primary: #007AFF; /* Apple's Blue */
      --primary-dark: #0056b3;
      --primary-light: #58a6ff;
      --secondary: #8A8A8E; /* Apple's Gray */
      --success: #34C759; /* Apple's Green */
      --warning: #FF9500; /* Apple's Orange */
      --danger: #FF3B30;  /* Apple's Red */

      --text-primary: #1d1d1f; /* Near Black for high contrast text */
      --text-secondary: #6e6e73;
      --text-tertiary: #86868b;
      
      --bg-primary: #ffffff; /* Main background for light mode */
      --bg-secondary: #f2f2f7; /* Slightly off-white for secondary elements */
      --bg-tertiary: #e5e5ea;
      --border: #d1d1d6; /* Softer border color */
      --app-bg: #f2f2f7; /* Overall app background */
      
      /* Spacing - consistent rhythm */
      --space-1: 0.25rem; /* 4px */
      --space-2: 0.5rem;  /* 8px */
      --space-3: 0.75rem; /* 12px */
      --space-4: 1rem;    /* 16px */
      --space-5: 1.25rem; /* 20px */
      --space-6: 1.5rem;  /* 24px */
      --space-7: 1.75rem; /* 28px */
      --space-8: 2rem;    /* 32px */
      --space-10: 2.5rem; /* 40px */
      --space-12: 3rem;   /* 48px */

      /* Typography */
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      --font-xs: 0.75rem;   /* 12px */
      --font-sm: 0.875rem;  /* 14px */
      --font-base: 1rem;    /* 16px */
      --font-lg: 1.125rem;  /* 18px */
      --font-xl: 1.25rem;   /* 20px */
      --font-2xl: 1.5rem;   /* 24px */
      --font-3xl: 1.875rem; /* 30px */
      --font-4xl: 2.25rem;  /* 36px */

      /* Radiuses and Shadows - More subtle */
      --radius-sm: 4px;
      --radius: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 1px 0 rgba(0,0,0,0.02);
      --shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.04), 0 1px 2px 0 rgba(0,0,0,0.03);
      --shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0,0,0,0.04);
      --shadow-lg: 0 10px 20px -5px rgba(0, 0, 0, 0.06), 0 4px 10px -4px rgba(0,0,0,0.05);
      
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Header Height */
      --header-height-mobile: 60px; /* Compact header height for mobile */
      --header-height-desktop: 80px; /* Standard header height for desktop */
    }

    /* Theme-specific overrides */
    [data-theme="light"] {
      --primary: #007AFF;
      --primary-dark: #0056b3;
      --primary-light: #58a6ff;
      --secondary: #8A8A8E;
      --success: #34C759;
      --warning: #FF9500;
      --danger: #FF3B30;

      --text-primary: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-tertiary: #86868b;
      
      --bg-primary: #ffffff; /* Main background for light mode */
      --bg-secondary: #f2f2f7; /* Slightly off-white for secondary elements */
      --bg-tertiary: #e5e5ea;
      --border: #d1d1d6;
      --app-bg: #f2f2f7;
    }
    [data-theme="dark"] {
      --primary: #0A84FF; /* Apple's Blue (Dark Mode) */
      --primary-dark: #005ecb;
      --primary-light: #64b5f6;
      --secondary: #8E8E93;
      --success: #30D158;
      --warning: #FF9F0A;
      --danger: #FF453A;

      --text-primary: #ffffff;
      --text-secondary: #aeaeb2;
      --text-tertiary: #8e8e93;
      
      --bg-primary: #1c1c1e; /* Main background for dark mode (e.g. header) */
      --bg-secondary: #2c2c2e; /* Secondary elements (e.g. dashboard area) */
      --bg-tertiary: #3a3a3c;
      --border: #48484a;
	    --app-bg: #000000; /* True black for app background in dark mode */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow-x: hidden; 
    }

    body {
      font-family: var(--font-sans);
      background-color: var(--app-bg);
      color: var(--text-primary);
      line-height: 1.6; /* Slightly increased for readability */
      font-size: var(--font-base);
    }

    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      width: 100%; 
      margin: 0 auto; 
      max-width: 1600px; 
      padding: 0; 
    }

    /* Header Section - Modified for mobile toggle */
    .app-header {
      background-color: var(--bg-primary);
      box-shadow: var(--shadow-md); /* Softer shadow */
      padding: var(--space-4) var(--space-6); 
      z-index: 100; /* Higher z-index */
      display: flex;
      flex-direction: column;
      gap: var(--space-4); 
      position: relative; /* Change to relative for mobile */
      transition: transform 0.3s ease;
    }
    
    /* Sticky Header on Mobile - Collapsed State */
    @media (max-width: 767px) {
      .app-header {
        height: var(--header-height-mobile); /* Fixed compact height */
        overflow: hidden; /* Hide overflow when collapsed */
        padding: var(--space-2) var(--space-3);
      }
      
      .app-header.expanded {
        height: auto; /* Expand when needed */
        overflow: visible;
        box-shadow: var(--shadow-lg);
      }
      
      /* Only show the main header row when collapsed */
      .app-header:not(.expanded) .header-content {
        display: none;
      }
    }

    .header-main-content-row {
      display: flex;
      justify-content: space-between;
      align-items: center; /* Vertically center title and theme toggle */
      gap: var(--space-4); 
      position: relative; 
    }
    
    /* Header toggle button for mobile */
    .header-toggle-btn {
      display: none; /* Hidden by default, shown on mobile */
      position: absolute;
      right: var(--space-3);
      font-size: var(--font-lg);
      background: transparent;
      border: none;
      color: var(--text-primary);
      padding: var(--space-2);
      cursor: pointer;
      z-index: 101; /* Above header */
    }
    
    @media (max-width: 767px) {
      .header-toggle-btn {
        display: block;
        top: calc(var(--header-height-mobile) / 2 - 16px); /* Center vertically */
      }
    }
    
    .header-content {
      display: flex;
      flex-direction: column;
      width: 100%;
      transition: opacity 0.3s ease;
    }
    
    .header-main-content-row .logo-container { flex-grow: 1; }
    .logo-main-line { display: flex; align-items: center; gap: var(--space-2); }
    .logo-main-line > i { font-size: var(--font-3xl); color: var(--text-primary); } /* Primary color for icon */
    .logo-main-line > span { font-size: var(--font-3xl); font-weight: 700; color: var(--text-primary); }
    .header-main-content-row .logo-subtitle {
      font-size: var(--font-sm);
      color: var(--text-secondary);
      line-height: 1.5;
      margin-top: var(--space-1);
      max-width: 600px; /* Prevent subtitle from becoming too wide */
    }
    .header-actions { flex-shrink: 0; }

    /* Data Load Controls */
    .data-load-controls .example-csv-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-3);
      align-items: center;
    }
    .data-load-controls .example-csv-buttons .btn {
      font-weight: 500;
    }

    /* Status and Active Filters */
    .status-and-active-filters { 
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      padding: var(--space-3) 0; /* Add some vertical padding */
      border-bottom: 1px solid var(--border); /* Separator */
      margin-bottom: var(--space-3);
    }
    .status-and-active-filters .status-title {
        font-size: var(--font-2xl); 
        font-weight: 600;
        color: var(--text-primary);
    }
    .status-and-active-filters .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2); 
    }
    .filter-tag {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      background-color: var(--bg-tertiary);
      border-radius: var(--radius); /* Slightly more rounded */
      font-size: var(--font-xs);
      font-weight: 500;
      color: var(--text-secondary);
      transition: var(--transition);
    }
    .filter-tag:hover {
        background-color: var(--primary);
        color: white;
    }
    .filter-tag-remove {
      background: none; border: none; color: inherit; /* Inherit color from parent */
      cursor: pointer; display: flex; align-items: center; margin-left: var(--space-1);
    }
    .filter-tag:hover .filter-tag-remove { color: white; }


    /* Primary Controls: Search & Filters */
    .primary-controls-area {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    .main-filter-inputs {
      display: flex;
      flex-direction: column;
      gap: var(--space-3); /* Increased gap for better touch targets on mobile */
    }
    .main-filter-inputs > .search-bar,
    .main-filter-inputs > .filter-group {
      width: 100%;
    }
    .search-bar { position: relative; width: 100%; }
    .search-input {
      width: 100%; padding: var(--space-3) var(--space-4) var(--space-3) var(--space-8); /* More padding */
      border: 1px solid var(--border); border-radius: var(--radius-md); 
      background-color: var(--bg-secondary); color: var(--text-primary); 
      font-size: var(--font-base); transition: var(--transition);
    }
    .search-input::placeholder { color: var(--text-tertiary); }
    .search-icon { position: absolute; left: var(--space-4); top: 50%; transform: translateY(-50%); color: var(--text-tertiary); font-size: var(--font-lg); }
    .search-input:focus { 
        outline: none; border-color: var(--primary); 
        background-color: var(--bg-primary);
        box-shadow: 0 0 0 3px rgba(var(--primary), 0.1); 
    }

    .filter-group { display: flex; flex-direction: column; width: 100%; gap: var(--space-1); }
    .filter-label { font-size: var(--font-sm); color: var(--text-primary); font-weight: 500; margin-bottom: var(--space-1); }
    .filter-select {
      width: 100%; padding: var(--space-3); border: 1px solid var(--border); border-radius: var(--radius-md);
      background-color: var(--bg-secondary); color: var(--text-primary); font-size: var(--font-base); appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236e6e73'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right var(--space-3) center; background-size: 1.25em; padding-right: var(--space-8);
      transition: var(--transition);
    }
    .filter-select:focus { 
        outline: none; border-color: var(--primary); 
        background-color: var(--bg-primary);
        box-shadow: 0 0 0 3px rgba(var(--primary), 0.1);
    }
    .filter-actions { display: flex; gap: var(--space-3); justify-content: flex-start; }


    /* Advanced Filters Panel */
    #advancedFiltersPanel {
      background-color: var(--bg-secondary); /* Consistent with other secondary backgrounds */
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-6); 
      margin-top: var(--space-4); 
      display: none;
    }
    #advancedFiltersPanel.active { display: block; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); }
    .panel-header h3 { font-size: var(--font-2xl); font-weight: 600; color: var(--text-primary); }
    .filters-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-4); }
    .filter-date {
      flex: 1; min-width: 0; padding: var(--space-3); border: 1px solid var(--border);
      border-radius: var(--radius-md); background-color: var(--bg-primary);
      color: var(--text-primary); font-size: var(--font-base);
    }

    /* Buttons - Polished */
    .btn {
      padding: var(--space-3) var(--space-4); 
      border-radius: var(--radius-md); 
      font-weight: 500;
      cursor: pointer; transition: var(--transition); font-size: var(--font-base);
      display: inline-flex; align-items: center; justify-content: center;
      gap: var(--space-2); white-space: nowrap; border: 1px solid transparent; 
      box-shadow: var(--shadow-sm);
      line-height: 1; /* For better vertical alignment of text and icon */
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn:active { transform: translateY(0px); box-shadow: var(--shadow-sm); }

    .btn-primary { background-color: var(--primary); color: white; border-color: var(--primary); }
    .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
    
    .btn-secondary { 
        background-color: var(--bg-primary); 
        color: var(--primary); /* Use primary color for text for better affordance */
        border-color: var(--primary); /* Border with primary color */
    }
    .btn-secondary:hover { 
        background-color: var(--primary-light);
        color: white;
        border-color: var(--primary-light);
    }
    [data-theme="dark"] .btn-secondary {
        background-color: var(--bg-tertiary);
        color: var(--primary-light);
        border-color: var(--primary-light);
    }
    [data-theme="dark"] .btn-secondary:hover {
        background-color: var(--primary);
        color: var(--text-primary);
        border-color: var(--primary);
    }

    .btn-sm { padding: var(--space-2) var(--space-3); font-size: var(--font-sm); }
    .btn-icon {
      padding: var(--space-2); border-radius: 50%; display: flex; align-items: center; justify-content: center;
      background: transparent; border: none; color: var(--text-secondary); cursor: pointer; transition: var(--transition);
      box-shadow: none;
    }
    .btn-icon:hover { background-color: var(--bg-tertiary); color: var(--text-primary); box-shadow: none; transform: none;}
    .theme-toggle { font-size: var(--font-xl); }


    /* Main Dashboard - Integrated Look */
    main#dashboard {
      flex-grow: 1; 
      padding: var(--space-6) var(--space-4); /* Add horizontal padding here */
      background-color: var(--bg-secondary); /* Dashboard area distinct from app-bg */
      display: flex; 
      flex-direction: column;
      gap: var(--space-6); /* Generous gap between main sections */
      overflow-y: auto; 
    }
    /* Section headers for charts/tables if card-header is removed */
    .dashboard-section-header {
        font-size: var(--font-2xl);
        font-weight: 600;
        color: var(--text-primary);
        padding-bottom: var(--space-3);
        border-bottom: 1px solid var(--border);
        margin-bottom: var(--space-4);
    }

    /* Stats - Integrated */
    .stats-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); }
    .stat-card {
      background-color: var(--bg-primary); /* Keep individual stat backgrounds for clarity */
      border-radius: var(--radius-lg);
      padding: var(--space-4); 
      box-shadow: var(--shadow);
      text-align: left; /* Align text left for a cleaner look */
    }
    .stat-label { font-size: var(--font-sm); color: var(--text-secondary); margin-bottom: var(--space-1); }
    .stat-value { font-size: var(--font-3xl); font-weight: 600; color: var(--text-primary); line-height: 1.1; }

    /* Sankey, Charts, Tables - Removing Card Shells */
    .primary-viz, .charts-grid-container, .tables-section-container {
      background-color: var(--bg-primary);
      padding: var(--space-6);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }
    .sankey-chart-container { height: 350px; /* Adjusted height */ }
    .chart-container, .bubble-chart-container { height: 280px; /* Adjusted height */ }
    .sankey-controls { /* No changes, styling seems fine */ }
    
    .charts-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-6); }

    .tables-section .tabs { 
        border-bottom: 2px solid var(--border); /* Stronger tab baseline */
        margin-bottom: var(--space-4);
    }
    .tables-section .tab-btn {
      padding: var(--space-3) var(--space-4);
      font-weight: 500; 
      font-size: var(--font-base);
      color: var(--text-secondary); 
      position: relative; 
      border-bottom: 2px solid transparent; /* For active state */
      margin-bottom: -2px; /* Align with parent border */
    }
    .tables-section .tab-btn:hover { color: var(--primary); }
    .tables-section .tab-btn.active { 
        color: var(--primary); 
        border-bottom-color: var(--primary);
    }
    .tables-section .tab-btn.active::after { content: none; } /* Remove old underline */
    
    .data-table th, .data-table td { padding: var(--space-3) var(--space-4); }
    .data-table th { background-color: var(--bg-secondary); } /* Subtle header background */


    /* Loading, Error, Empty States - Centered within dashboard scroll area */
    .loading-state, .empty-state, .error-message {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: var(--space-8); text-align: center; 
      margin: var(--space-4) 0; /* Vertical margin only */
      width: 100%;
    }
    .loading-state, .empty-state { background-color: transparent; /* No card bg */ }
    .error-message { 
        background-color: var(--danger-light, rgba(255,59,48,0.1)); 
        color: var(--danger); 
        border: 1px solid var(--danger); 
        border-radius: var(--radius-md);
        max-width: 800px; /* Constrain width */
        margin-left: auto; margin-right: auto;
    }
    [data-theme="dark"] .error-message { background-color: rgba(255,69,58,0.15); }


    /* Modal - Enhanced */
    .modal-backdrop { 
      background-color: rgba(0, 0, 0, 0.7); /* Darker backdrop */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s linear 0.3s, opacity 0.3s ease;
    }
    .modal-backdrop.active {
      visibility: visible;
      opacity: 1;
      transition-delay: 0s;
    }
    .modal {
      background-color: var(--bg-primary); 
      border-radius: var(--radius-lg);
      width: 90%; 
      max-width: 700px; 
      max-height: 90vh; 
      overflow: auto; /* Ensure scroll */
      box-shadow: var(--shadow-lg); 
      transform: translateY(0) scale(1); /* Initial state for smoother entry */
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal-backdrop:not(.active) .modal {
        transform: translateY(20px) scale(0.98);
        opacity: 0;
    }
    .modal-header { 
      padding: var(--space-6); 
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title { font-size: var(--font-2xl); font-weight: 600; }
    .modal-close {
      background: none;
      border: none;
      font-size: var(--font-xl);
      color: var(--text-secondary);
      cursor: pointer;
    }
    .modal-body { padding: var(--space-6); }
    .modal-footer { 
      padding: var(--space-4) var(--space-6); 
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
    }

    /* Mobile FAB - Keep as is, generally a good UX pattern */
    .mobile-action-btn {
      position: fixed; bottom: var(--space-6); right: var(--space-6); width: 60px; height: 60px; /* Slightly larger */
      border-radius: 50%; background-color: var(--primary); color: white; border: none;
      box-shadow: var(--shadow-lg); display: flex; align-items: center; justify-content: center;
      font-size: var(--font-2xl); cursor: pointer; z-index: 900; transition: var(--transition);
    }
    .mobile-action-btn:hover { background-color: var(--primary-dark); transform: scale(1.08); }

    /* Table Styling */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      text-align: left;
      cursor: pointer;
      position: relative;
    }
    .data-table th.sort-asc::after,
    .data-table th.sort-desc::after {
      content: '';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
    }
    .data-table th.sort-asc::after {
      border-bottom: 5px solid var(--primary);
    }
    .data-table th.sort-desc::after {
      border-top: 5px solid var(--primary);
    }
    .data-table tr:nth-child(even) {
      background-color: var(--bg-secondary);
    }
    .data-table tr:hover {
      background-color: var(--bg-tertiary);
    }
    .data-table td {
      border-top: 1px solid var(--border);
    }
    .data-table .money {
      text-align: right;
      font-weight: 500;
    }

    /* Entity Badges */
    .agency-badge,
    .office-badge,
    .vendor-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: 500;
    }

    .agency-icon {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%; /* Circle */
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xs);
      font-weight: 600;
      flex-shrink: 0; /* Prevents the icon from shrinking */
    }

    .office-icon {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: var(--radius-sm); /* Rounded square for offices too */
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xs);
      font-weight: 600;
      flex-shrink: 0; /* Prevents the icon from shrinking */
    }

    .vendor-icon {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 0; /* Rounded square */
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xs);
      font-weight: 600;
      flex-shrink: 0; /* Prevents the icon from shrinking */
    }
	
    .badge {
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--font-xs);
      font-weight: 500;
      display: inline-block;
    }

    .badge-primary {
      background-color: rgba(0, 112, 243, 0.1);
      color: var(--primary);
    }

    /* Chart tooltip */
    .chart-tooltip {
      position: absolute;
      display: none;
      background-color: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      box-shadow: var(--shadow-md);
      pointer-events: none;
      z-index: 100;
      max-width: 250px;
    }

    /* Selection indicator */
    .selection-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--primary);
      display: none;
    }

    /* Loading spinner */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--space-4);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Header Placeholder for Mobile */
    .header-placeholder {
      display: none;
      height: var(--header-height-mobile);
    }

    /* RESPONSIVE ADJUSTMENTS */
    @media (max-width: 767px) { 
      /* Add placeholder when header is fixed */
      .header-placeholder.visible {
        display: block;
      }
      
      /* Fixed header option for scroll */
      .app-header.fixed {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 200;
      }
      
      /* Adjust padding and spacing */
      .app-header { 
        padding: var(--space-3) var(--space-3); 
        gap: var(--space-2);
      }
      
      .header-main-content-row .header-actions { 
        position: absolute; 
        top: calc(var(--space-3) - var(--space-1)); 
        right: var(--space-3); 
      }
      
      .header-main-content-row .logo-container { padding-right: 50px; } 
      
      .logo-subtitle {
        display: -webkit-box; 
        -webkit-line-clamp: 2; 
        -webkit-box-orient: vertical;
        overflow: hidden; 
        text-overflow: ellipsis;
        font-size: 0.65rem; 
        margin-top: var(--space-1);
      }
      
      .logo-main-line > i { font-size: var(--font-2xl); }
      .logo-main-line > span { font-size: var(--font-2xl); }
      .status-and-active-filters .status-title { font-size: var(--font-xl); }

      .data-load-controls .example-csv-buttons { justify-content: center; }
      .data-load-controls .example-csv-buttons .btn { min-width: 100px; }
      
      .main-filter-inputs { gap: var(--space-3); }
      .filter-actions { justify-content: center; }
      .filter-actions .btn { flex-grow: 1; max-width: 180px;}

      main#dashboard { 
        padding: var(--space-4) var(--space-3); 
        gap: var(--space-4); 
      }
      
      .stats-row { gap: var(--space-3); }
      .stat-card { padding: var(--space-3); }
      .stat-value { font-size: var(--font-2xl); }

      .primary-viz, .charts-grid-container, .tables-section-container {
        padding: var(--space-4);
      }
      .charts-grid { gap: var(--space-4); }
      .sankey-chart-container { height: 280px; }
      .chart-container, .bubble-chart-container { height: 220px; }
    }

    @media (min-width: 768px) { 
      .app-header {
        padding: var(--space-4) var(--space-6); 
        gap: var(--space-4);
        position: sticky; /* Sticky header on desktop */
        top: 0;
      }
      
      .header-main-content-row .header-actions { 
        position: static;
        padding-top: 0; 
      }
	  .header-main-content-row .logo-container { padding-right: 0; }
      .logo-subtitle { 
        display: block; -webkit-line-clamp: unset; font-size: var(--font-sm);
      }

      .primary-controls-area {
        flex-direction: row;
        align-items: flex-end; /* Align filter groups and action buttons nicely */
        gap: var(--space-4);
      }
      .main-filter-inputs {
        flex-grow: 1;
        flex-direction: row;
        gap: var(--space-3);
        align-items: flex-end;
      }
      .main-filter-inputs > .search-bar { flex: 2 1 280px; width: auto; } /* More specific basis */
      .main-filter-inputs > .filter-group { flex: 1 1 200px; width: auto; } /* More specific basis */
      .filter-actions { justify-content: flex-end; flex-shrink: 0; }

      .filters-grid { grid-template-columns: repeat(2, 1fr); gap: var(--space-4); }
      .stats-row { grid-template-columns: repeat(2, 1fr); gap: var(--space-4); } /* 2 stats on tablet */
      .charts-grid { grid-template-columns: repeat(2, 1fr); gap: var(--space-4); }
      .sankey-chart-container { height: 400px; }
      .mobile-action-btn { display: none; }
    }

    @media (min-width: 1024px) { 
        .stats-row { grid-template-columns: repeat(4, 1fr); } /* 4 stats on desktop */
    }
    @media (min-width: 1280px) { /* Larger Desktop */
      .app-header { padding: var(--space-6) var(--space-8); }
      main#dashboard { padding: var(--space-8); gap: var(--space-8); }
      .main-filter-inputs > .search-bar { flex-basis: 350px; }
      .main-filter-inputs > .filter-group { flex-basis: 220px; }
      .filters-grid { grid-template-columns: repeat(4, 1fr); } 
      .charts-grid { grid-template-columns: repeat(4, 1fr); }
      .primary-viz, .charts-grid-container, .tables-section-container {
        padding: var(--space-8);
      }
    }
	.file-input {
    display: none;
}
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}
/* Table Tabs Styling */
.tables-section .tabs {
  border-bottom: 2px solid var(--border);
  margin-bottom: var(--space-4);
  background-color: transparent; /* Ensure no background color */
}

.tables-section .tab-btn {
  padding: var(--space-3) var(--space-4);
  font-weight: 500;
  font-size: var(--font-base);
  color: var(--text-secondary);
  background-color: transparent;
  border: none;
  position: relative;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  cursor: pointer;
  transition: var(--transition);
}

.tables-section .tab-btn:hover {
  color: var(--primary);
}

.tables-section .tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

/* Adjust container backgrounds for light/dark modes */
[data-theme="dark"] .primary-viz,
[data-theme="dark"] .charts-grid-container,
[data-theme="dark"] .tables-section-container {
  background-color: var(--bg-primary);
}

[data-theme="light"] .primary-viz,
[data-theme="light"] .charts-grid-container,
[data-theme="light"] .tables-section-container {
  background-color: var(--bg-primary);
  box-shadow: var(--shadow);
}

/* Cohesive wrapper for both light and dark modes */
main#dashboard {
  flex-grow: 1;
  padding: var(--space-6) var(--space-4);
  background-color: var(--bg-secondary);
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
  overflow-y: auto;
}

/* Additional styling for table container for better visual appearance */
.tab-content {
  background-color: var(--bg-primary);
  border-radius: 0 0 var(--radius-lg) var(--radius-lg);
  overflow: hidden;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
}

/* Make table headers more distinct */
.data-table th {
  background-color: var(--bg-secondary);
  color: var(--text-primary);
  font-weight: 600;
  text-align: left;
  padding: var(--space-3) var(--space-4);
  border-bottom: 1px solid var(--border);
}

/* Style table rows */
.data-table td {
  padding: var(--space-3) var(--space-4);
  border-top: 1px solid var(--border);
  color: var(--text-primary);
}

.data-table tr:nth-child(even) {
  background-color: var(--bg-secondary);
}

.data-table tr:hover {
  background-color: var(--bg-tertiary);
}
:root {
  /* Base colors for light theme */
  --primary: #007AFF; 
  --primary-dark: #0056b3;
  --primary-light: #58a6ff;
  --secondary: #8A8A8E; 
  --success: #34C759; 
  --warning: #FF9500; 
  --danger: #FF3B30;  

  --text-primary: #1d1d1f; 
  --text-secondary: #6e6e73;
  --text-tertiary: #86868b;
  
  --bg-primary: #ffffff; /* Card background - pure white */
  --bg-secondary: #f7f7f9; /* Middle layer - very light grayish-white */
  --bg-tertiary: #e5e5ea;
  --border: #d1d1d6; 
  --app-bg: #eaeaef; /* App background - light gray with slight blue tint */
}

[data-theme="dark"] {
  --primary: #0A84FF; 
  --primary-dark: #005ecb;
  --primary-light: #64b5f6;
  --secondary: #8E8E93;
  --success: #30D158;
  --warning: #FF9F0A;
  --danger: #FF453A;

  --text-primary: #ffffff;
  --text-secondary: #aeaeb2;
  --text-tertiary: #8e8e93;
  
  --bg-primary: #1c1c1e; /* Card background in dark mode */
  --bg-secondary: #2c2c2e; /* Secondary elements background */
  --bg-tertiary: #3a3a3c;
  --border: #48484a;
  --app-bg: #000000; /* Darkest black for app background */
}
/* First row: Sankey and Value by Month */
.primary-viz-row {
  background-color: var(--bg-primary);
  padding: var(--space-6);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  margin-bottom: var(--space-2);
}

.primary-viz-container {
  display: flex;
  flex-direction: row;
  gap: var(--space-4);
  width: 100%;
  height: 450px; /* Adjust as needed */
}

.sankey-wrapper {
  flex: 2; /* Takes 2/3 of the available space */
  height: 100%;
}

.month-chart-wrapper {
  flex: 1; /* Takes 1/3 of the available space */
  height: 100%;
  display: flex;
  flex-direction: column;
}

.month-chart-wrapper .chart-container {
  flex-grow: 1;
  width: 100%;
}

.month-chart-wrapper .chart-title-integrated {
  margin-bottom: var(--space-2);
  font-size: var(--font-lg);
  font-weight: 600;
}

.sankey-chart-container {
  height: 100%;
  width: 100%;
}

/* Second row: Three equal charts */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* Three equal columns */
  gap: var(--space-6);
  width: 100%;
}

.chart-item {
  width: 100%;
}

.chart-container, .bubble-chart-container {
  height: 280px;
  width: 100%;
}

/* Media query for mobile */
@media (max-width: 767px) {
  .primary-viz-container {
    flex-direction: column;
    height: auto;
  }
  
  .sankey-wrapper, .month-chart-wrapper {
    width: 100%;
  }
  
  .sankey-wrapper {
    height: 280px;
  }
  
  .month-chart-wrapper .chart-container {
    height: 220px;
  }
  
  .charts-grid {
    grid-template-columns: 1fr; /* Stack on mobile */
    gap: var(--space-4);
  }
}

/* Media query for tablets */
@media (min-width: 768px) and (max-width: 1023px) {
  .charts-grid {
    grid-template-columns: repeat(2, 1fr); /* Two columns on tablet */
  }
}
/* Improved header layout styles */
.header-main-content-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start; /* Align to top to account for subtitle */
  width: 100%;
  margin-bottom: var(--space-4);
}

.logo-container {
  flex: 1;
  max-width: 85%; /* Prevent overly wide content on smaller screens */
}

.header-actions {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: var(--space-4);
  padding-top: var(--space-2);
}

/* Theme Toggle Switch - Clean Slider */
#color-scheme {
  width: 0;
  height: 0;
  visibility: hidden;
  position: absolute;
}

.toggle-item {
  width: 3em;
  height: 1.5em;
  display: inline-block;
  border-radius: 50px;
  margin: 0;
  position: relative;
  transition: all .3s ease;
  cursor: pointer;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.toggle-item:before {
  content: '';
  position: absolute;
  display: block;
  width: 1.2em;
  height: 1.2em;
  top: 0.1em;
  left: 0.1em;
  border-radius: 50%;
  transition: .3s ease;
  background: var(--bg-primary);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  border: none;
}

#color-scheme:checked + .toggle-item {
  background: var(--secondary);
  border-color: var(--secondary);
}

#color-scheme:checked + .toggle-item:before {
  transform: translateX(1.4em);
  background: var(--bg-primary);
}

.toggle-item:hover {
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.15), 0 0 0 3px rgba(var(--primary-rgb, 0, 122, 255), 0.1);
}

/* Dark theme adjustments */
[data-theme="dark"] .toggle-item {
  background: var(--secondary);
  border-color: var(--border);
}

[data-theme="dark"] .toggle-item:before {
  background: var(--secondary);
  box-shadow: 0 2px 4px rgba(0,0,0,0.4);
}

[data-theme="dark"] #color-scheme:checked + .toggle-item:before {
  background: var(--bg-primary);
}

/* Responsive adjustments */
@media (max-width: 767px) {
  .toggle-item {
    width: 2.5em;
    height: 1.25em;
  }
  
  .toggle-item:before {
    width: 1em;
    height: 1em;
    top: 0.1em;
    left: 0.1em;
  }
  
  #color-scheme:checked + .toggle-item:before {
    transform: translateX(1.15em);
  }
}
/* Table column specific styling */
.data-table td.table-date-cell {
  white-space: nowrap;
  min-width: 80px;
  width: 80px;
}

.data-table td.table-contract-id {
  white-space: nowrap;
  min-width: 120px;
  font-family: monospace;
  font-size: 0.85em;
}

.data-table td.table-value-cell {
  white-space: nowrap;
  text-align: right;
  min-width: 90px;
}

.data-table td.table-actions-cell {
  white-space: nowrap;
  width: 80px;
  text-align: center;
}

/* Ensure badges don't wrap */
.agency-badge, .office-badge, .vendor-badge {
  white-space: nowrap;
  overflow: hidden;
}

/* Better responsive table handling */
@media (max-width: 768px) {
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .data-table {
    min-width: 800px; /* Force horizontal scroll on small screens */
  }
}
/* Updated styles to fix the mobile issues */

/* Hide floating action button on mobile */
@media (max-width: 767px) {
  .mobile-action-btn {
    display: none !important; /* Override other display settings */
  }
  
  /* Ensure subtitle is completely hidden when header is collapsed */
  .app-header:not(.expanded) .logo-subtitle {
    display: none !important;
  }
  
  /* Fix toggle switch alignment */
  .toggle-item {
    vertical-align: middle;
    display: inline-flex;
    align-items: center;
    justify-content: flex-start;
  }
  
  .toggle-item:before {
    position: relative;
    top: 0;
    margin: 0;
  }
  
  /* Improve header toggle button position */
  .header-toggle-btn {
    top: 50%;
    transform: translateY(-50%);
    right: var(--space-4);
  }
  
  /* Ensure clean header collapse with no elements peeking through */
  .app-header {
    overflow: hidden;
    height: var(--header-height-mobile);
  }
  
  .app-header.expanded {
    height: auto;
    overflow: visible;
  }
  
  /* Better padding for header row on mobile */
  .header-main-content-row {
    padding-right: 40px; /* Space for toggle button */
    margin-bottom: 0;
  }
  
  .logo-main-line {
    height: var(--header-height-mobile);
    align-items: center;
  }
}
/* Footer Styling */
  .app-footer {
    background-color: var(--bg-primary);
    border-top: 1px solid var(--border);
    padding: var(--space-8) var(--space-4);
    margin-top: var(--space-8);
    width: 100%;
  }
  
  .footer-container {
    max-width: 1600px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-6);
  }
  
  .footer-section {
    padding: var(--space-4);
  }
  
  .footer-section h3 {
    font-size: var(--font-lg);
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 2px solid var(--primary);
    display: inline-block;
  }
  
  .footer-section p {
    color: var(--text-secondary);
    margin-bottom: var(--space-3);
    font-size: var(--font-sm);
    line-height: 1.6;
  }
  
  .footer-links {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .footer-links li {
    margin-bottom: var(--space-2);
  }
  
  .footer-links a {
    color: var(--primary);
    text-decoration: none;
    font-size: var(--font-sm);
    display: inline-flex;
    align-items: center;
    transition: var(--transition);
  }
  
  .footer-links a:hover {
    color: var(--primary-dark);
    text-decoration: underline;
  }
  
  .footer-links a i {
    margin-right: var(--space-2);
    font-size: 14px;
  }
  
  .connect-card {
    display: flex;
    background-color: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-4);
    align-items: center;
    box-shadow: var(--shadow);
  }
  
  .connect-avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: var(--space-4);
    flex-shrink: 0;
    background-color: var(--bg-tertiary);
    border: 2px solid var(--primary);
  }
  
  .connect-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .connect-info {
    flex: 1;
  }
  
  .connect-info h4 {
    font-size: var(--font-base);
    font-weight: 600;
    margin-bottom: var(--space-1);
    color: var(--text-primary);
  }
  
  .connect-info p {
    font-size: var(--font-xs);
    margin-bottom: var(--space-2);
  }
  
  .connect-buttons {
    display: flex;
    gap: var(--space-2);
  }
  
  .connect-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
    border-radius: var(--radius);
    padding: var(--space-1) var(--space-2);
    font-size: var(--font-xs);
    transition: var(--transition);
    border: none;
    cursor: pointer;
    text-decoration: none;
  }
  
  .connect-button:hover {
    background-color: var(--primary);
    color: white;
  }
  
  .connect-button i {
    margin-right: var(--space-1);
  }
  
  .how-to-steps {
    counter-reset: step-counter;
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .how-to-steps li {
    position: relative;
    padding-left: 35px;
    margin-bottom: var(--space-4);
  }
  
  .how-to-steps li::before {
    content: counter(step-counter);
    counter-increment: step-counter;
    position: absolute;
    left: 0;
    top: 0;
    width: 24px;
    height: 24px;
    background-color: var(--primary);
    color: white;
    font-size: var(--font-xs);
    font-weight: 600;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .how-to-steps h4 {
    font-size: var(--font-base);
    font-weight: 600;
    margin-bottom: var(--space-1);
    color: var(--text-primary);
  }
  
  .copyright {
    text-align: center;
    padding-top: var(--space-6);
    border-top: 1px solid var(--border);
    color: var(--text-tertiary);
    font-size: var(--font-xs);
    margin-top: var(--space-6);
  }
  
  /* Responsive adjustments */
  @media (min-width: 768px) {
    .footer-container {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (min-width: 1024px) {
    .footer-container {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Placeholder for header height when header is fixed -->
    <div class="header-placeholder"></div>
    
    <header class="app-header">
        <!-- Mobile header toggle button -->
        <button class="header-toggle-btn" id="headerToggleBtn">
            <i class="fas fa-caret-down"></i>
        </button>
        
        <div class="header-main-content-row">
            <!-- Logo on the left -->
            <div class="logo-container">
                <div class="logo-main-line">
                    <i class="fa-regular fa-newspaper"></i>
			<span>Post Award</span>
                </div>
                <span class="logo-subtitle">
                    Federal Awards Dashboard<br><br>
                    PostAward.com lets you visualize fpds.gov search results.<br>Go to FPDS.gov and do an "EZ Search" by agency, vendor, keyword, etc.<br>Download the CSV and upload it here to spot who's buying what from who.
                </span>
            </div>
            <!-- Theme toggle on the right -->
            <div class="header-actions">
                <input id="color-scheme" type="checkbox" aria-hidden />
                <label class="toggle-item" for="color-scheme"></label>
            </div>
        </div>

        <!-- Rest of the header content -->
        <div class="header-content">
            <div class="data-load-controls example-csv-loader">
                <div class="example-csv-buttons">
                    <button id="loadExample3" class="btn btn-secondary"><span class="btn-text">Q125 > $100K</span></button>
					<button id="loadExample1" class="btn btn-primary"><span class="btn-text">Q225 > $100K</span></button>
					<button id="loadExample2" class="btn btn-secondary"><span class="btn-text">SaaS 3YR</span></button>
                    <input type="file" id="csvFile" accept=".csv,.xls" class="file-input" style="display: none;">
                    <label for="csvFile" class="btn btn-secondary"><i class="fas fa-upload mr-2"></i>
                        <span class="btn-text">Upload fpds.gov CSV</span>
                    </label>
                </div>
            </div>
            
            <div class="status-and-active-filters" id="statusBox">
                <div class="status-title">No data loaded</div>
                <div id="activeFilters" class="active-filters">
                </div>
            </div>

            <div class="primary-controls-area">
                <div class="main-filter-inputs">
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Search contracts, agencies, vendors..." class="search-input">
                    </div>
                    <div class="filter-group">
                        <select id="agencyFilter" class="filter-select" aria-label="Filter by agency">
                            <option value="">All Agencies</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select id="vendorFilter" class="filter-select" aria-label="Filter by vendor">
                            <option value="">All Vendors</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select id="pscFilter" class="filter-select" aria-label="Filter by PSC">
                            <option value="">Any PSC</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button id="resetFilters" class="btn btn-secondary">
                        <i class="fas fa-undo"></i>
                        <span class="btn-text">Reset</span>
                    </button>
                    <button id="moreFiltersBtn" class="btn btn-secondary">
                        <i class="fas fa-sliders-h"></i>
                        <span class="btn-text">More Filters</span>
                    </button>
                </div>
            </div>

            <section id="advancedFiltersPanel" class="filters-panel">
                <div class="panel-header">
                    <h3>Advanced Filters</h3>
                    <button id="closeFilters" class="btn-icon" aria-label="Close advanced filters">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="startDate" class="filter-label">Date Range</label> 
                        <div class="date-range-picker" id="dateRangeLabel">
                            <input type="date" id="startDate" class="filter-date" aria-label="Start date">
                            <span class="date-separator">to</span>
                            <input type="date" id="endDate" class="filter-date" aria-label="End date">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="officeFilter" class="filter-label">Office</label> 
                        <select id="officeFilter" class="filter-select" aria-label="Filter by contracting office">
                            <option value="">Any Office</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="naicsFilter" class="filter-label">NAICS Code</label> 
                        <select id="naicsFilter" class="filter-select" aria-label="Filter by NAICS code">
                            <option value="">Any NAICS</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="valueFilter" class="filter-label">Value Range</label> 
                        <select id="valueFilter" class="filter-select" aria-label="Filter by action obligation value">
                            <option value="">Any Value</option>
                            <option value="0-100000">Under $100K</option>
                            <option value="100000-500000">$100K - $500K</option>
                            <option value="500000-1000000">$500K - $1M</option>
                            <option value="1000000-5000000">$1M - $5M</option>
                            <option value="5000000-10000000">$5M - $10M</option>
                            <option value="10000000-999999999999">Over $10M</option>
                        </select>
                    </div>
                </div>
            </section>
        </div>
    </header> 

    <div id="loadingIndicator" class="loading-state" style="display: none;">
        <div class="loading-spinner"></div>
        <div>Loading and processing contract data...</div>
    </div>
    <div id="errorMessage" class="error-message" style="display: none;">
    </div>
    <div id="noDataMessage" class="empty-state">
        <i class="fas fa-file-upload"></i>
        <h2>No Contract Data Loaded</h2>
        <p>Upload a CSV file from an FPDS.gov Search Result.</p>
    </div>
    
    <main id="dashboard" style="display: none;">
      
<!-- First row: Sankey (2/3) and Value by Month (1/3) -->
<section class="primary-viz-row">
  <div class="dashboard-section-header" style="display:flex; justify-content: space-between; align-items:center;">
    <span>Award Flow & Monthly Buying Trends</span>
    <div class="sankey-controls">
      <button id="sankeyTop10" class="btn btn-sm btn-primary"><span class="btn-text">Top 10</span></button>
      <button id="sankeyTop25" class="btn btn-sm btn-secondary"><span class="btn-text">Top 25</span></button>
      <button id="sankeyAll" class="btn btn-sm btn-secondary"><span class="btn-text">All</span></button>
    </div>
  </div>
  <div class="primary-viz-container">
    <div class="sankey-wrapper">
      <div class="sankey-chart-container" id="sankeyChartContainer">
        <div id="sankeyTooltip" class="chart-tooltip"></div>
      </div>
    </div>
    <div class="month-chart-wrapper">
      <h3 class="chart-title-integrated">Award Value by Month</h3>
      <div class="chart-container" id="valueTimeChartContainer">
        <canvas id="valueTimeChart"></canvas>
        <div class="selection-indicator"></div>
      </div>
    </div>
  </div>
</section>

<!-- Second row: Three equal charts -->
<section class="charts-grid-container">
  <h2 class="dashboard-section-header">Visualizations</h2>
  <div class="charts-grid">
    <div class="chart-item">
      <h3 class="chart-title-integrated">Top Agencies</h3>
      <div class="chart-container" id="agencyChartContainer">
        <canvas id="agencyChart"></canvas>
        <div class="selection-indicator"></div>
      </div>
    </div>
    <div class="chart-item">
      <h3 class="chart-title-integrated">Top Vendors</h3>
      <div class="chart-container" id="vendorChartContainer">
        <canvas id="vendorChart"></canvas>
        <div class="selection-indicator"></div>
      </div>
    </div>
    <div class="chart-item">
      <h3 class="chart-title-integrated">NAICS Distribution</h3>
      <div class="bubble-chart-container" id="naicsBubbleChartContainer">
        <canvas id="naicsBubbleChart"></canvas>
        <div class="selection-indicator"></div>
      </div>
    </div>
  </div>
</section>
<section class="stats-section">
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Total Awards</div>
            <div id="totalContracts" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Value</div>
            <div id="totalValue" class="stat-value">$0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg. Award</div>
            <div id="avgValue" class="stat-value">$0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Unique Vendors</div>
            <div id="uniqueVendors" class="stat-value">0</div>
          </div>
        </div>
      </section>
<section class="tables-section-container">
  <h2 class="dashboard-section-header">Award Details</h2>
  <div class="tables-section">
    <div class="tabs">
      <button class="tab-btn active" data-tab="recent">Recent Awards</button>
      <button class="tab-btn" data-tab="largest">Largest Awards</button>
      <button class="tab-btn" data-tab="offices">Top Contracting Offices</button>
    </div>
    <div id="recentTab" class="tab-content active">
      <div class="table-container">
        <table id="contractsTable" class="data-table">
          <thead>
            <tr>
              <th data-sort="date">Date</th>
              <th data-sort="id">Contract ID</th>
              <th data-sort="agency">Agency</th>
              <th data-sort="office">Office</th>
			  <th data-sort="vendor">Vendor</th>
              <th data-sort="description">Description</th>
              <th data-sort="value">Value</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div id="largestTab" class="tab-content">
      <div class="table-container">
        <table id="largestContractsTable" class="data-table">
          <thead>
            <tr>
              <th data-sort="date">Date</th>
              <th data-sort="id">Contract ID</th>
              <th data-sort="agency">Agency</th>
              <th data-sort="office">Office</th>
              <th data-sort="vendor">Vendor</th>
              <th data-sort="description">Description</th>
              <th data-sort="value">Value</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div id="officesTab" class="tab-content">
      <div class="table-container">
        <table id="officesTable" class="data-table">
          <thead>
            <tr>
              <th data-sort="agency">Agency</th>
              <th data-sort="office">Office</th>
              <th data-sort="contracts">Contracts</th>
              <th data-sort="value">Total Value</th>
              <th data-sort="naics">Top NAICS</th>
              <th data-sort="vendor">Top Vendor</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</section>
	</main> 
<footer class="app-footer">
  <div class="footer-container">
    <!-- Connect Card Section -->
    <div class="footer-section">
      <h3>Let's Connect</h3>
      <div class="connect-card">
        <div class="connect-avatar">
          <img src="markgs.jpg" alt="Mark's profile picture">
        </div>
        <div class="connect-info">
          <h4>Hi, I'm Mark</h4>
          <p>Federal primes with contracts over $750K must create SBA subcontracting plans. After 30+ years of being both a governement customer and seller, I've created a suite of Post-Award Intelligence tools that help you find those primes, follow the money, and unlock more opportunities.</p>
          <div class="connect-buttons">
            <a href="https://www.linkedin.com/in/markflournoy/" class="connect-button" target="_blank" rel="noopener">
              <i class="fab fa-linkedin"></i> Connect
            </a>
            <a href="mailto:mark@subhoo.com" class="connect-button">
              <i class="fas fa-envelope"></i> Email
            </a>
          </div>
        </div>
      </div>
      <p>Reach out if I can help with federal contracting insights, subcontracting plans, or just to chat about government procurement opportunities.</p>
    </div>
    
    <!-- How To Use Section -->
    <div class="footer-section">
      <h3>How To Use PostAward</h3>
      <ul class="how-to-steps">
        <li>
          <h4>Find Contract Data</h4>
          <p>Go to FPDS.gov and perform an "EZ Search" by agency, vendor, or keyword to locate federal contract awards.</p>
        </li>
        <li>
          <h4>Download CSV File</h4>
          <p>Export your search results as a CSV file to get detailed contract information.</p>
        </li>
        <li>
          <h4>Upload & Analyze</h4>
          <p>Upload the CSV to PostAward to visualize spending patterns, identify key vendors, and explore subcontracting opportunities.</p>
        </li>
        <li>
          <h4>Filter & Explore</h4>
          <p>Use our interactive filters to narrow down results and find the most promising contracting opportunities.</p>
        </li>
      </ul>
    </div>
    
    <!-- Resources Section -->
    <div class="footer-section">
      <h3>Useful Resources</h3>
      <p>Explore these government contracting resources to enhance your federal procurement knowledge.</p>
      <ul class="footer-links">
        <li>
          <a href="https://www.fpds.gov" target="_blank" rel="noopener">
            <i class="fas fa-external-link-alt"></i> Federal Procurement Data System
          </a>
        </li>
        <li>
          <a href="https://www.sba.gov" target="_blank" rel="noopener">
            <i class="fas fa-external-link-alt"></i> Small Business Administration
          </a>
        </li>
        <li>
          <a href="https://sam.gov" target="_blank" rel="noopener">
            <i class="fas fa-external-link-alt"></i> SAM.gov
          </a>
        </li>
        <li>
          <a href="https://www.acquisition.gov" target="_blank" rel="noopener">
            <i class="fas fa-external-link-alt"></i> Acquisition.gov
          </a>
        </li>
        <li>
          <a href="https://www.gsa.gov" target="_blank" rel="noopener">
            <i class="fas fa-external-link-alt"></i> General Services Administration
          </a>
        </li>
        <li>
          <a href="https://www.subhoo.com" target="_blank" rel="noopener">
            <i class="fas fa-external-link-alt"></i> Subhoo.com
          </a>
        </li>
        <li>
          <a href="https://www.usaspending.gov" target="_blank" rel="noopener">
            <i class="fas fa-external-link-alt"></i> USAspending.gov
          </a>
        </li>
      </ul>
    </div>
  </div>
  
  <!-- Copyright Section -->
  <div class="copyright">
    <p>&copy; 2025 PostAward by Subhoo. All rights reserved.</p>
  </div>
</footer>
  </div> 

  <div id="contractModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Contract Details</h3>
        <button id="closeModal" class="modal-close" aria-label="Close modal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="contractModalBody"></div>
      <div class="modal-footer">
        <button id="closeModalBtn" class="btn btn-secondary"><span class="btn-text">Close</span></button>
      </div>
    </div>
  </div>
  
  <button id="mobileFilterBtn" class="mobile-action-btn" aria-label="Open filters">
    <i class="fas fa-filter"></i>
  </button>
<script>
// Main application data object
const app = {
  data: [],
  filteredData: [],
  agencies: {},
  offices: {},
  vendors: {},
  naicsCodes: {},
  pscCodes: {},
  charts: {},
  filters: {},
  selection: { type: null, value: null, container: null },
  sankeyDisplayLimit: 10,
  s3BaseUrl: "https://subhoodata.s3.us-east-1.amazonaws.com/data/",
  mobileHeaderState: {
    expanded: false,
    fixed: false,
    lastScrollY: 0
  }
};

const elements = {
  csvFile: document.getElementById('csvFile'),
  uploadBtn: document.querySelector('label[for="csvFile"]'),
  loadExample1Btn: document.getElementById('loadExample1'),
  loadExample2Btn: document.getElementById('loadExample2'),
  statusBox: document.getElementById('statusBox'), 
  activeFilters: document.getElementById('activeFilters'),
  searchInput: document.getElementById('searchInput'),
  agencyFilter: document.getElementById('agencyFilter'),
  vendorFilter: document.getElementById('vendorFilter'),
  pscFilter: document.getElementById('pscFilter'),
  resetFilters: document.getElementById('resetFilters'),
  moreFiltersBtn: document.getElementById('moreFiltersBtn'),
  advancedFiltersPanel: document.getElementById('advancedFiltersPanel'),
  closeFilters: document.getElementById('closeFilters'),
  startDate: document.getElementById('startDate'),
  endDate: document.getElementById('endDate'),
  officeFilter: document.getElementById('officeFilter'), 
  naicsFilter: document.getElementById('naicsFilter'),   
  valueFilter: document.getElementById('valueFilter'),   
  themeToggle: document.getElementById('themeToggle'),
  loadingIndicator: document.getElementById('loadingIndicator'),
  errorMessage: document.getElementById('errorMessage'),
  noDataMessage: document.getElementById('noDataMessage'),
  dashboard: document.getElementById('dashboard'),
  mobileFilterBtn: document.getElementById('mobileFilterBtn'),
  totalContracts: document.getElementById('totalContracts'),
  totalValue: document.getElementById('totalValue'),
  avgValue: document.getElementById('avgValue'),
  uniqueVendors: document.getElementById('uniqueVendors'),
  sankeyTop10: document.getElementById('sankeyTop10'),
  sankeyTop25: document.getElementById('sankeyTop25'),
  sankeyAll: document.getElementById('sankeyAll'),
  sankeyChartContainer: document.getElementById('sankeyChartContainer'),
  sankeyTooltip: document.getElementById('sankeyTooltip'),
  valueTimeChartContainer: document.getElementById('valueTimeChartContainer'),
  agencyChartContainer: document.getElementById('agencyChartContainer'),
  naicsBubbleChartContainer: document.getElementById('naicsBubbleChartContainer'),
  vendorChartContainer: document.getElementById('vendorChartContainer'),
  valueTimeChart: document.getElementById('valueTimeChart').getContext('2d'),
  agencyChart: document.getElementById('agencyChart').getContext('2d'),
  naicsBubbleChart: document.getElementById('naicsBubbleChart').getContext('2d'),
  vendorChart: document.getElementById('vendorChart').getContext('2d'),
  contractsTable: document.getElementById('contractsTable').querySelector('tbody'),
  largestContractsTable: document.getElementById('largestContractsTable').querySelector('tbody'),
  officesTable: document.getElementById('officesTable').querySelector('tbody'),
  tabButtons: document.querySelectorAll('.tab-btn'),
  tabContents: document.querySelectorAll('.tab-content'),
  contractModal: document.getElementById('contractModal'),
  closeModal: document.getElementById('closeModal'),
  closeModalBtn: document.getElementById('closeModalBtn'),
  contractModalBody: document.getElementById('contractModalBody'),
  // New mobile header elements
  appHeader: document.querySelector('.app-header'),
  headerToggleBtn: document.getElementById('headerToggleBtn'),
  headerPlaceholder: document.querySelector('.header-placeholder')
};

// Define the palette globally before the utils object
const FREYT_PALETTE = ['#004DF3', '#8BAAFA', '#34C759', '#FF9500', '#FF3B30', '#5E5CE6', '#FF2D55', '#AF52DE', '#5AC8FA', '#FF9500'];

const utils = {
  formatMoney: function(value) {
    if (!value && value !== 0) return '$0';
    const number = parseFloat(value);
    if (isNaN(number)) return '$0';
    if (number >= 1000000000) return '$' + (number / 1000000000).toFixed(1) + 'B';
    if (number >= 1000000) return '$' + (number / 1000000).toFixed(1) + 'M';
    if (number >= 1000) return '$' + (number / 1000).toFixed(1) + 'K';
    return '$' + number.toFixed(0);
  },
  formatDate: function(dateInput) { 
    if (!dateInput) return 'N/A';
    const date = (dateInput instanceof Date && !isNaN(dateInput)) ? dateInput : new Date(dateInput);
    if (isNaN(date.getTime())) {
      if (typeof dateInput === 'string') {
        const parts = dateInput.split('-');
        if (parts.length === 3) {
          const months = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11};
          const day = parseInt(parts[0]);
          const month = months[parts[1]];
          let year = parseInt(parts[2]);
          if (year < 100) year = year < 50 ? 2000 + year : 1900 + year;
          if (!isNaN(day) && month !== undefined && !isNaN(year)) {
            const parsedDate = new Date(year, month, day);
            return parsedDate.toLocaleDateString('en-US', { year: '2-digit', month: 'short', day: 'numeric' });
          }
        }
      }
      return String(dateInput); 
    }
    return date.toLocaleDateString('en-US', { year: '2-digit', month: 'short', day: 'numeric' });
  },
  parseMoney: function(value) {
    if (!value) return 0;
    return parseFloat(String(value).replace(/[$,\s]/g, '')) || 0;
  },
  parseCSV: function(text) {
    const lines = text.split(/\r\n|\n/);
    if (lines.length === 0) return { headers: [], data: [] };
    const parseLine = function(line) {
      const values = []; let current = ''; let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i], nextChar = line[i + 1] || '';
        if (char === '"') {
          if (inQuotes && nextChar === '"') { current += '"'; i++; } 
          else inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; } 
        else current += char;
      }
      values.push(current.trim()); return values;
    };
    const headers = parseLine(lines[0]);
    const data = [];
    for (let i = 1; i < lines.length; i++) {
      if (lines[i].trim()) {
        const values = parseLine(lines[i]);
        const row = {};
        for (let j = 0; j < Math.min(headers.length, values.length); j++) {
          if (headers[j]) row[headers[j]] = values[j] || '';
        }
        data.push(row);
      }
    }
    return { headers, data };
  },
  parseDate: function(dateString) {
    if (!dateString) return null;
    if (dateString instanceof Date && !isNaN(dateString)) return dateString; 

    const s = String(dateString);
    const parts = s.split('-');
    if (parts.length === 3) {
      const months = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11};
      const day = parseInt(parts[0]);
      const month = months[parts[1]];
      let year = parseInt(parts[2]);
      if (year < 100) year = year < 50 ? 2000 + year : 1900 + year;
      if (!isNaN(day) && month !== undefined && !isNaN(year)) {
        return new Date(year, month, day);
      }
    }
    const date = new Date(s);
    return !isNaN(date.getTime()) ? date : null;
  },
  truncateText: function(text, maxLength) {
    if (!text || text.length <= maxLength) return text || '';
    return text.substring(0, maxLength) + '...';
  },
  
  stringToColor: function(str) {
    if (!str) return '#cccccc'; 
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    return FREYT_PALETTE[Math.abs(hash) % FREYT_PALETTE.length];
  },
  
  // Consistent entity color mapping to ensure same entities have same colors across all charts
  getEntityColor: function(entityName, entityType = '') {
    if (!entityName) return '#cccccc';
    // Use consistent key for same entities regardless of chart
    const key = entityName.toLowerCase().trim();
    return this.stringToColor(key);
  },
  
  // Enhanced color functions with opacity support
  getEntityColorWithOpacity: function(entityName, opacity = 1, entityType = '') {
    const baseColor = this.getEntityColor(entityName, entityType);
    if (opacity === 1) return baseColor;
    // Convert hex to rgba
    const r = parseInt(baseColor.slice(1, 3), 16);
    const g = parseInt(baseColor.slice(3, 5), 16);
    const b = parseInt(baseColor.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
  },
  
  getInitials: function(name) {
    if (!name) return '?'; const words = name.split(/\s+/);
    return words.length > 1 ? (words[0].charAt(0) + words[1].charAt(0)).toUpperCase() : name.charAt(0).toUpperCase();
  },
  parseValueRange: function(rangeStr) {
    if (!rangeStr) return null; const parts = rangeStr.split('-');
    return parts.length !== 2 ? null : {min:parseFloat(parts[0]),max:parseFloat(parts[1])};
  }
};

const mobileHeaderManager = {
  init: function() {
    if (!elements.appHeader || !elements.headerToggleBtn || !elements.headerPlaceholder) {
      console.error("Mobile header elements missing");
      return;
    }
    
    // Start with header collapsed on mobile
    if (window.innerWidth < 768) {
      this.collapseHeader();
    }
    
    // Set up event listeners
    elements.headerToggleBtn.addEventListener('click', this.toggleHeader.bind(this));
    
    // Handle scroll events
    window.addEventListener('scroll', this.handleScroll.bind(this));
    
    // Handle resize events
    window.addEventListener('resize', this.handleResize.bind(this));
  },
  
  toggleHeader: function() {
    if (app.mobileHeaderState.expanded) {
      this.collapseHeader();
    } else {
      this.expandHeader();
    }
  },
  
  expandHeader: function() {
    elements.appHeader.classList.add('expanded');
    elements.headerToggleBtn.innerHTML = '<i class="fas fa-caret-up"></i>';
    app.mobileHeaderState.expanded = true;
  },
  
  collapseHeader: function() {
    elements.appHeader.classList.remove('expanded');
    elements.headerToggleBtn.innerHTML = '<i class="fas fa-caret-down"></i>';
    app.mobileHeaderState.expanded = false;
  },
  
  handleScroll: function() {
    if (window.innerWidth >= 768) return; // Only apply on mobile
    
    const currentScrollY = window.scrollY;
    const scrollDelta = currentScrollY - app.mobileHeaderState.lastScrollY;
    
    // If scrolling down more than 10px, fix header
    if (scrollDelta > 10 && currentScrollY > 50) {
      this.fixHeader();
    } 
    // If scrolling up more than 10px, unfix header
    else if (scrollDelta < -10) {
      this.unfixHeader();
    }
    
    app.mobileHeaderState.lastScrollY = currentScrollY;
  },
  
  fixHeader: function() {
    if (!app.mobileHeaderState.fixed) {
      elements.appHeader.classList.add('fixed');
      elements.headerPlaceholder.classList.add('visible');
      app.mobileHeaderState.fixed = true;
      this.collapseHeader(); // Ensure it's collapsed when fixed
    }
  },
  
  unfixHeader: function() {
    if (app.mobileHeaderState.fixed) {
      elements.appHeader.classList.remove('fixed');
      elements.headerPlaceholder.classList.remove('visible');
      app.mobileHeaderState.fixed = false;
    }
  },
  
  handleResize: function() {
    if (window.innerWidth >= 768) {
      // On desktop, ensure header is expanded and not fixed
      elements.appHeader.classList.remove('fixed');
      elements.headerPlaceholder.classList.remove('visible');
      elements.appHeader.classList.remove('expanded');
      app.mobileHeaderState.fixed = false;
      app.mobileHeaderState.expanded = false;
    } else {
      // On mobile, start with header collapsed
      if (!app.mobileHeaderState.expanded) {
        this.collapseHeader();
      }
    }
  }
};
const dataProcessor = {
  processData: function(csvData) {
    if (!csvData || !csvData.data || csvData.data.length === 0) throw new Error('No valid data found in CSV file');
    const requiredFields = ['Contract ID','Date Signed','Contracting Agency','Legal Business Name','Action Obligation ($)'];
    for (const field of requiredFields) if (!csvData.headers.includes(field)) throw new Error(`Required field "${field}" not found in CSV file`);
    return csvData.data.map(row => ({
      id:row['Contract ID']||'', reference:row['Reference IDV']||'', modification:row['Modification Number']||'',
      date:row['Date Signed']||'', parsedDate:utils.parseDate(row['Date Signed']), type:row['Award/IDV Type']||'',
      value:utils.parseMoney(row['Action Obligation ($)']), agency:row['Contracting Agency']||'', office:row['Contracting Office Name']||'',
      psc:row['PSC']||'', pscDescription:row['PSC Description']||'', naics:row['NAICS']||'', naicsDescription:row['NAICS Description']||'',
      vendor:row['Legal Business Name']||'', description:row['PSC Description']||''
    }));
  },
  analyzeData: function(data) {
    const agencies={},offices={},vendors={},naicsCodes={},pscCodes={};
    data.forEach(contract => {
      if(contract.agency){
        if(!agencies[contract.agency]) agencies[contract.agency]={name:contract.agency,count:0,value:0,offices:new Set(),vendors:new Set()};
        agencies[contract.agency].count++; agencies[contract.agency].value+=contract.value;
        if(contract.office) agencies[contract.agency].offices.add(contract.office);
        if(contract.vendor) agencies[contract.agency].vendors.add(contract.vendor);
      }
      if(contract.office){
        if(!offices[contract.office]) offices[contract.office]={name:contract.office,agency:contract.agency,count:0,value:0,vendors:new Set(),naicsCodes:{}};
        offices[contract.office].count++; offices[contract.office].value+=contract.value;
        if(contract.vendor) offices[contract.office].vendors.add(contract.vendor);
        if(contract.naics){
          if(!offices[contract.office].naicsCodes[contract.naics]) offices[contract.office].naicsCodes[contract.naics]={code:contract.naics,description:contract.naicsDescription,count:0,value:0};
          offices[contract.office].naicsCodes[contract.naics].count++; offices[contract.office].naicsCodes[contract.naics].value+=contract.value;
        }
      }
      if(contract.vendor){
        if(!vendors[contract.vendor]) vendors[contract.vendor] = {name: contract.vendor,count: 0,value:0,agencies:new Set(),naicsCodes:{}};
        vendors[contract.vendor].count++; vendors[contract.vendor].value+=contract.value;
        if(contract.agency) vendors[contract.vendor].agencies.add(contract.agency);
        if(contract.naics){
          if(!vendors[contract.vendor].naicsCodes[contract.naics]) vendors[contract.vendor].naicsCodes[contract.naics]={code:contract.naics,description:contract.naicsDescription,count:0,value:0};
          vendors[contract.vendor].naicsCodes[contract.naics].count++; vendors[contract.vendor].naicsCodes[contract.naics].value+=contract.value;
        }
      }
      if(contract.naics){
        if(!naicsCodes[contract.naics]) naicsCodes[contract.naics]={code:contract.naics,description:contract.naicsDescription,count:0,value:0,vendors:new Set()};
        naicsCodes[contract.naics].count++; naicsCodes[contract.naics].value+=contract.value;
        if(contract.vendor) naicsCodes[contract.naics].vendors.add(contract.vendor);
      }
      if(contract.psc){
        if(!pscCodes[contract.psc]) pscCodes[contract.psc]={code:contract.psc,description:contract.pscDescription,count:0,value:0};
        pscCodes[contract.psc].count++; pscCodes[contract.psc].value+=contract.value;
      }
    });
    return {agencies,offices,vendors,naicsCodes,pscCodes};
  },
  
removeSankeyCircularLinks: function(nodes, links) {
  // The current implementation isn't completely resolving circular dependencies
  // Let's implement a more robust solution
  
  // Step 1: Create a graph representation
  const graph = {};
  nodes.forEach(node => {
    graph[node.id] = {
      id: node.id,
      name: node.name,
      type: node.type,
      outgoing: [],
      incoming: []
    };
  });
  
  // Step 2: Populate the graph with links
  links.forEach((link, index) => {
    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
    
    // Store link indices instead of the links themselves
    if (graph[sourceId]) graph[sourceId].outgoing.push({ target: targetId, linkIndex: index });
    if (graph[targetId]) graph[targetId].incoming.push({ source: sourceId, linkIndex: index });
  });
  
  // Step 3: Identify and break cycles
  const visited = {};
  const stack = {};
  const linksToRemove = new Set();
  
  function dfs(nodeId) {
    // Already completely visited this node
    if (visited[nodeId] === 2) return false;
    
    // Found a cycle (node is in current path)
    if (visited[nodeId] === 1) return true;
    
    visited[nodeId] = 1; // Mark as being in current path
    stack[nodeId] = true;
    
    // Check all outgoing links
    const node = graph[nodeId];
    if (node && node.outgoing) {
      for (const edge of node.outgoing) {
        if (stack[edge.target] || dfs(edge.target)) {
          // We found a cycle, mark this link for removal
          linksToRemove.add(edge.linkIndex);
          return true;
        }
      }
    }
    
    delete stack[nodeId]; // Remove from current path
    visited[nodeId] = 2; // Mark as completely visited
    return false;
  }
  
  // Run DFS from each node
  nodes.forEach(node => {
    if (!visited[node.id]) {
      dfs(node.id);
    }
  });
  
  // Alternative strategy: If removing links by cycle detection doesn't work well,
  // we enforce a hierarchical structure based on node types
  if (linksToRemove.size === 0) {
    // Group nodes by type
    const nodesByType = {};
    nodes.forEach(node => {
      if (!nodesByType[node.type]) nodesByType[node.type] = [];
      nodesByType[node.type].push(node.id);
    });
    
    // Check for type-based circular dependencies
    // For example, ensuring vendor -> office or office -> agency links don't exist
    links.forEach((link, index) => {
      const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
      const targetId = typeof link.target === 'object' ? link.target.id : link.target;
      const sourceType = nodes[sourceId]?.type;
      const targetType = nodes[targetId]?.type;
      
      // Define hierarchy: agency -> office -> vendor
      if ((sourceType === 'vendor' && targetType === 'office') ||
          (sourceType === 'vendor' && targetType === 'agency') ||
          (sourceType === 'office' && targetType === 'agency')) {
        linksToRemove.add(index);
      }
    });
  }
  
  // Step 4: Return filtered links
  return links.filter((_, index) => !linksToRemove.has(index));
},

// Improved generateSankeyData function that better handles circular references
generateSankeyData: function(data, limit=10) {
  // Step 1: Create the initial flow mappings
  const agencyOfficeFlows = {}, officeVendorFlows = {}, nodeMap = new Map();
  
  data.forEach(c => {
    if (c.agency && c.office && c.vendor && c.value > 0) {
      const aok = `${c.agency}|${c.office}`;
      if (!agencyOfficeFlows[aok]) agencyOfficeFlows[aok] = {source: c.agency, target: c.office, value: 0};
      agencyOfficeFlows[aok].value += c.value;
      
      const ovk = `${c.office}|${c.vendor}`;
      if (!officeVendorFlows[ovk]) officeVendorFlows[ovk] = {source: c.office, target: c.vendor, value: 0};
      officeVendorFlows[ovk].value += c.value;
    }
  });
  
  // Step 2: Create nodes with specific types to ensure proper hierarchy
  Object.values(agencyOfficeFlows).forEach(f => {
    if (!nodeMap.has(f.source)) nodeMap.set(f.source, {name: f.source, type: 'agency'});
    if (!nodeMap.has(f.target)) nodeMap.set(f.target, {name: f.target, type: 'office'});
  });
  
  Object.values(officeVendorFlows).forEach(f => {
    // Ensure we don't override existing nodes' types
    if (!nodeMap.has(f.source)) nodeMap.set(f.source, {name: f.source, type: 'office'});
    if (!nodeMap.has(f.target)) nodeMap.set(f.target, {name: f.target, type: 'vendor'});
  });
  
  // Step 3: Create arrays of nodes and assign IDs
  const nodesArray = Array.from(nodeMap.values());
  nodesArray.forEach((n, i) => n.id = i);
  
  // Create a mapping from node name to index
  const nodeIndexMap = new Map();
  nodesArray.forEach((n, i) => nodeIndexMap.set(n.name, i));
  
  // Step 4: Create links with proper source/target indices
  const agencyOfficeLinks = Object.values(agencyOfficeFlows).map(f => ({
    source: nodeIndexMap.get(f.source),
    target: nodeIndexMap.get(f.target),
    value: f.value,
    type: 'agency-office'
  }));
  
  const officeVendorLinks = Object.values(officeVendorFlows).map(f => ({
    source: nodeIndexMap.get(f.source),
    target: nodeIndexMap.get(f.target),
    value: f.value,
    type: 'office-vendor'
  }));
  
  // Step 5: Remove circular links
  let linksArray = [...agencyOfficeLinks, ...officeVendorLinks];
  
  // First, ensure hierarchy is maintained
  linksArray = linksArray.filter(link => {
    const sourceNode = nodesArray[link.source];
    const targetNode = nodesArray[link.target];
    
    // Only allow agency->office and office->vendor flows
    // This enforces a strict hierarchy and prevents cycles
    if (sourceNode.type === 'agency' && targetNode.type === 'office') return true;
    if (sourceNode.type === 'office' && targetNode.type === 'vendor') return true;
    return false;
  });
  
  // Then remove any remaining circular links
  linksArray = this.removeSankeyCircularLinks(nodesArray, linksArray);
  
  // Step 6: Sort by value and limit if needed
  linksArray.sort((a, b) => b.value - a.value);
  
  // Adjust limit to available links
  const effectiveLimit = limit === 0 ? linksArray.length : Math.min(limit, linksArray.length);
  
  const topLinks = [];
  const includedNodes = new Set();
  
  // Add links up to the effective limit
  for (let i = 0; i < effectiveLimit && i < linksArray.length; i++) {
    topLinks.push(linksArray[i]);
    includedNodes.add(linksArray[i].source);
    includedNodes.add(linksArray[i].target);
  }
  
  // Ensure we have at least one link if possible
  if (topLinks.length === 0 && linksArray.length > 0) {
    topLinks.push(linksArray[0]);
    includedNodes.add(linksArray[0].source);
    includedNodes.add(linksArray[0].target);
  }
  
  // Step 7: Create the final nodes list from included nodes
  const finalNodes = [];
  const nodeIdMap = new Map(); // Map old indices to new indices
  
  // Add nodes that are actually used in the links
  nodesArray.forEach((node, oldIndex) => {
    if (includedNodes.has(oldIndex)) {
      nodeIdMap.set(oldIndex, finalNodes.length);
      finalNodes.push({...node, id: finalNodes.length});
    }
  });
  
  // Step 8: Remap link indices to the new node indices
  const finalLinks = topLinks.map(link => ({
    source: nodeIdMap.get(link.source),
    target: nodeIdMap.get(link.target),
    value: link.value,
    type: link.type
  }));
  
  return {nodes: finalNodes, links: finalLinks};
}
};
const filterManager = {
  applyFilters: function() {
    const filters = app.filters;
    let filtered = [...app.data];
    if (filters.valueRange) filtered = filtered.filter(c => c.value >= filters.valueRange.min && c.value <= filters.valueRange.max);
    if (filters.startDate) filtered = filtered.filter(c => c.parsedDate && c.parsedDate >= new Date(filters.startDate));
    if (filters.endDate) { const ed = new Date(filters.endDate); ed.setHours(23, 59, 59, 999); filtered = filtered.filter(c => c.parsedDate && c.parsedDate <= ed); }
    if (filters.agency) filtered = filtered.filter(c => c.agency === filters.agency);
    if (filters.office) filtered = filtered.filter(c => c.office === filters.office);
    if (filters.naics) filtered = filtered.filter(c => c.naics === filters.naics);
    if (filters.psc) filtered = filtered.filter(c => c.psc === filters.psc);
    if (filters.vendor) filtered = filtered.filter(c => c.vendor === filters.vendor);
    if (filters.search) { const s = filters.search.toLowerCase(); filtered = filtered.filter(c => (c.id && c.id.toLowerCase().includes(s)) || (c.agency && c.agency.toLowerCase().includes(s)) || (c.office && c.office.toLowerCase().includes(s)) || (c.vendor && c.vendor.toLowerCase().includes(s)) || (c.description && c.description.toLowerCase().includes(s)) || (c.naicsDescription && c.naicsDescription.toLowerCase().includes(s)) || (c.pscDescription && c.pscDescription.toLowerCase().includes(s))); }
    app.filteredData = filtered;
    return filtered;
  },
  applySelectionFilter: function(type, value, container) {
    document.querySelectorAll('.selection-indicator').forEach(ind => ind.style.display = 'none');
    if (app.selection.type === type && app.selection.value === value) { app.selection = { type: null, value: null, container: null }; delete app.filters[type]; } 
    else {
      delete app.filters.agency; delete app.filters.office; delete app.filters.naics; delete app.filters.vendor;
      if (type && value) { app.filters[type] = value; app.selection = { type, value, container }; if (container) { const ind = container.querySelector('.selection-indicator'); if (ind) ind.style.display = 'block'; } }
    }
    this.applyFilters(); this.updateFilterTags(); dashboardManager.refreshDashboard();
  },
  updateFilterTags: function() {
    const filters = app.filters;
    const activeFiltersContainer = elements.activeFilters;
    activeFiltersContainer.innerHTML = '';
    const tags = [];
    if (filters.valueRange) tags.push({ key: 'valueRange', label: 'Value', value: `${utils.formatMoney(filters.valueRange.min)} - ${utils.formatMoney(filters.valueRange.max)}` });
    if (filters.startDate) tags.push({ key: 'startDate', label: 'From', value: new Date(filters.startDate).toLocaleDateString() });
    if (filters.endDate) tags.push({ key: 'endDate', label: 'To', value: new Date(filters.endDate).toLocaleDateString() });
    if (filters.agency) tags.push({ key: 'agency', label: 'Agency', value: filters.agency });
    if (filters.office) tags.push({ key: 'office', label: 'Office', value: filters.office });
    if (filters.naics) tags.push({ key: 'naics', label: 'NAICS', value: filters.naics });
    if (filters.psc) tags.push({ key: 'psc', label: 'PSC', value: filters.psc });
    if (filters.vendor) tags.push({ key: 'vendor', label: 'Vendor', value: filters.vendor });
    if (filters.search) tags.push({ key: 'search', label: 'Search', value: filters.search });
    
    tags.forEach(tag => {
      const tagElement = document.createElement('div');
      tagElement.className = 'filter-tag';
      tagElement.innerHTML = `${tag.label}: ${utils.truncateText(tag.value, 15)} <button class="filter-tag-remove" data-filter="${tag.key}"><i class="fas fa-times"></i></button>`;
      activeFiltersContainer.appendChild(tagElement);
      tagElement.querySelector('.filter-tag-remove').addEventListener('click', function() {
        const filterKey = this.getAttribute('data-filter');
        if (filterKey === 'valueRange') { delete app.filters.valueRange; elements.valueFilter.value = ''; } 
        else if (filterKey === 'startDate') { delete app.filters.startDate; elements.startDate.value = ''; } 
        else if (filterKey === 'endDate') { delete app.filters.endDate; elements.endDate.value = ''; } 
        else if (filterKey === 'agency') { delete app.filters.agency; elements.agencyFilter.value = ''; if (app.selection.type === 'agency') app.selection = { type: null, value: null, container: null }; } 
        else if (filterKey === 'office') { delete app.filters.office; elements.officeFilter.value = ''; if (app.selection.type === 'office') app.selection = { type: null, value: null, container: null }; } 
        else if (filterKey === 'naics') { delete app.filters.naics; elements.naicsFilter.value = ''; if (app.selection.type === 'naics') app.selection = { type: null, value: null, container: null }; } 
        else if (filterKey === 'psc') { delete app.filters.psc; elements.pscFilter.value = ''; if (app.selection.type === 'psc') app.selection = { type: null, value: null, container: null }; } 
        else if (filterKey === 'vendor') { delete app.filters.vendor; elements.vendorFilter.value = ''; if (app.selection.type === 'vendor') app.selection = { type: null, value: null, container: null }; } 
        else if (filterKey === 'search') { delete app.filters.search; elements.searchInput.value = ''; }
        document.querySelectorAll('.selection-indicator').forEach(ind => ind.style.display = 'none');
        filterManager.applyFilters(); dashboardManager.refreshDashboard();
      });
    });

    const statusTitleElement = document.querySelector('#statusBox .status-title');
    let titleText = '';
    let dateRangeSuffix = '';

    if (app.filteredData.length > 0) {
        let minDate = null;
        let maxDate = null;
        app.filteredData.forEach(contract => {
            if (contract.parsedDate && contract.parsedDate instanceof Date && !isNaN(contract.parsedDate.getTime())) {
                if (!minDate || contract.parsedDate < minDate) minDate = contract.parsedDate;
                if (!maxDate || contract.parsedDate > maxDate) maxDate = contract.parsedDate;
            }
        });
        if (minDate && maxDate) {
            const formattedMinDate = utils.formatDate(minDate);
            const formattedMaxDate = utils.formatDate(maxDate);
            if (formattedMinDate === formattedMaxDate) {
                if (formattedMinDate !== 'N/A') dateRangeSuffix = ` (Date: ${formattedMinDate})`;
            } else {
                if (formattedMinDate !== 'N/A' && formattedMaxDate !== 'N/A') dateRangeSuffix = ` (${formattedMinDate} - ${formattedMaxDate})`;
                else if (formattedMinDate !== 'N/A') dateRangeSuffix = ` (From: ${formattedMinDate})`;
                else if (formattedMaxDate !== 'N/A') dateRangeSuffix = ` (To: ${formattedMaxDate})`;
            }
        }
    }
    if (statusTitleElement) {
        if (app.data.length === 0 && app.filteredData.length === 0) titleText = 'No data loaded';
        else if (app.filteredData.length === 0 && app.data.length > 0) titleText = 'No contracts match current filters';
        else if (app.filteredData.length < app.data.length) titleText = `Viewing ${app.filteredData.length.toLocaleString()} filtered contracts`;
        else titleText = `Viewing ${app.filteredData.length.toLocaleString()} contracts`;
        statusTitleElement.textContent = titleText + dateRangeSuffix;
    }
  },
  resetFilters: function() {
    app.filters = {}; app.selection = { type: null, value: null, container: null };
    elements.valueFilter.value = ''; elements.startDate.value = ''; elements.endDate.value = '';
    elements.agencyFilter.value = ''; elements.officeFilter.value = ''; elements.naicsFilter.value = '';
    elements.pscFilter.value = ''; elements.vendorFilter.value = ''; elements.searchInput.value = '';
    document.querySelectorAll('.selection-indicator').forEach(ind => ind.style.display = 'none');
    app.filteredData = [...app.data];
    this.updateFilterTags(); dashboardManager.refreshDashboard();
  }
}; 

const chartManager = {
  initCharts: function() {
    Object.values(app.charts).forEach(c => { if (c instanceof Chart) c.destroy(); });
    app.charts = {};
    
    const cssVars = {
      fontFamily: getComputedStyle(document.documentElement).getPropertyValue('--font-sans').trim(),
      textSecondary: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim(),
      border: getComputedStyle(document.documentElement).getPropertyValue('--border').trim(),
      bgPrimary: getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim(),
      textPrimary: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
      primary: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()
    };
    
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.font.size = 11;
    Chart.defaults.color = cssVars.textSecondary;
    
    // Add this helper function for high-resolution chart rendering
    this.setupHighResChart = function(ctx) {
      // Get the device pixel ratio
      const dpr = window.devicePixelRatio || 1;
      
      // Get the canvas element
      const canvas = ctx.canvas;
      
      // Get the parent container's dimensions
      const rect = canvas.parentElement.getBoundingClientRect();
      
      // Set the canvas dimensions accounting for the device pixel ratio
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      
      // Scale the context to match the DPR
      ctx.scale(dpr, dpr);
      
      // Set the display size back to the original dimensions
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      
      return ctx;
    };
    
    this.initValueTimeChart(); 
    this.initAgencyChart(); 
    this.initNaicsBubbleChart(cssVars); 
    this.initVendorChart(); 
    this.initSankeyChart(); 
    this.addChartClickEvents();
  },

  initValueTimeChart: function() {
    // Setup high-resolution rendering
    this.setupHighResChart(elements.valueTimeChart);
    
    app.charts.valueTimeChart = new Chart(elements.valueTimeChart, { 
      type: 'line', 
      data: { 
        labels: [], 
        datasets: [{ 
          label: 'Contract Value', 
          data: [], 
          borderColor: FREYT_PALETTE[0],
          backgroundColor: utils.getEntityColorWithOpacity('timeline', 0.1), 
          tension: 0.4, 
          fill: true, 
          pointBackgroundColor: FREYT_PALETTE[0],
          pointBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-primary'), 
          pointBorderWidth: 1, 
          pointRadius: 3, 
          borderWidth: 2 
        }] 
      }, 
      options: { 
        devicePixelRatio: window.devicePixelRatio || 1,
        responsive: true, 
        maintainAspectRatio: false, 
        plugins: { 
          legend: { display: false }, 
          tooltip: { callbacks: { label: c => utils.formatMoney(c.raw) } } 
        }, 
        scales: { 
          x: { 
            grid: { display: false }, 
            ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } 
          }, 
          y: { 
            beginAtZero: true,
            grid: { display: false }, 
            ticks: { callback: v => utils.formatMoney(v), font: { size: 10 } } 
          } 
        } 
      } 
    });
  },
  
  initAgencyChart: function() {
    // Setup high-resolution rendering
    this.setupHighResChart(elements.agencyChart);
    
    app.charts.agencyChart = new Chart(elements.agencyChart, { 
      type: 'bar', 
      data: { 
        labels: [], 
        datasets: [{ 
          label: 'Contract Value', 
          data: [], 
          backgroundColor: [], 
          borderWidth: 0, 
          borderRadius: 4, 
          barThickness: 'flex', 
          maxBarThickness: 15 
        }] 
      }, 
      options: { 
        devicePixelRatio: window.devicePixelRatio || 1,
        responsive: true, 
        maintainAspectRatio: false, 
        indexAxis: 'y', 
        plugins: { 
          legend: { display: false }, 
          tooltip: { callbacks: { label: c => utils.formatMoney(c.raw) } } 
        }, 
        scales: { 
          x: { 
            beginAtZero: true,
            grid: { display: false }, 
            ticks: { callback: v => utils.formatMoney(v), font: { size: 10 } } 
          }, 
          y: { 
            grid: { display: false }, 
            ticks: { font: { size: 10 } } 
          } 
        } 
      } 
    });
  },

  initNaicsBubbleChart: function(cssVars) {
    if (!elements.naicsBubbleChart) return;
    
    // Setup high-resolution rendering
    this.setupHighResChart(elements.naicsBubbleChart);
    
    app.charts.naicsBubbleChart = new Chart(elements.naicsBubbleChart, { 
        type: 'bubble', 
        data: { datasets: [] }, 
        options: { 
            devicePixelRatio: window.devicePixelRatio || 1,
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { display: false }, 
                tooltip: { 
                    callbacks: { 
                        label: function(c) { 
                            const d = c.dataset.data[c.dataIndex]; 
                            return [
                                utils.truncateText(d.label, 40) || '', 
                                `Contracts: ${d.x.toLocaleString()}`, 
                                `Value: ${utils.formatMoney(d.y)}`
                            ]; 
                        } 
                    } 
                } 
            }, 
            scales: { 
                x: { 
                    type: 'logarithmic',
                    position: 'bottom', 
                    title: { display: true, text: 'Number of Contracts (Log Scale)', font: { size: 11 } }, 
                    grid: { display: false },
                    min: 1,
                    max: 10000,
                    ticks: { 
                        font: { size: 10 },
                        maxTicksLimit: 6,
                        callback: function(value, index, values) {
                            if (value === 1 || value === 10 || value === 100 || value === 1000 || value === 10000) {
                                return value.toLocaleString();
                            }
                            return null;
                        }
                    } 
                }, 
                y: { 
                    type: 'logarithmic',
                    title: { display: true, text: 'Total Contract Value (Log Scale)', font: { size: 11 } }, 
                    grid: { display: false },
                    min: 1000,
                    max: 100000000000,
                    ticks: { 
                        maxTicksLimit: 6,
                        callback: function(v) {
                            if (v >= 1000000000) return '$' + (v/1000000000).toFixed(0) + 'B';
                            if (v >= 1000000) return '$' + (v/1000000).toFixed(0) + 'M';
                            if (v >= 1000) return '$' + (v/1000).toFixed(0) + 'K';
                            return '$' + v.toFixed(0);
                        }, 
                        font: { size: 10 } 
                    } 
                } 
            },
            layout: {
                padding: {
                    top: 10,
                    right: 20,
                    bottom: 10,
                    left: 10
                }
            }
        } 
    });
  },

  initVendorChart: function() {
    // Setup high-resolution rendering
    this.setupHighResChart(elements.vendorChart);
    
    app.charts.vendorChart = new Chart(elements.vendorChart, { 
      type: 'bar', 
      data: { 
        labels: [], 
        datasets: [{ 
          label: 'Contract Value', 
          data: [], 
          backgroundColor: [], 
          borderWidth: 0, 
          borderRadius: 4, 
          barThickness: 'flex', 
          maxBarThickness: 15 
        }] 
      }, 
      options: { 
        devicePixelRatio: window.devicePixelRatio || 1,
        responsive: true, 
        maintainAspectRatio: false, 
        indexAxis: 'y', 
        plugins: { 
          legend: { display: false }, 
          tooltip: { callbacks: { label: c => utils.formatMoney(c.raw) } } 
        }, 
        scales: { 
          x: { 
            beginAtZero: true,
            grid: { display: false }, 
            ticks: { callback: v => utils.formatMoney(v), font: { size: 10 } } 
          }, 
          y: { 
            grid: { display: false }, 
            ticks: { font: { size: 10 } } 
          } 
        } 
      } 
    });
  },

  initSankeyChart: function() {
    const c = elements.sankeyChartContainer; 
    if (c) c.querySelector('svg')?.remove();
    elements.sankeyTop10.addEventListener('click', () => { 
      app.sankeyDisplayLimit = 10; 
      elements.sankeyTop10.className = 'btn btn-sm btn-primary'; 
      elements.sankeyTop25.className = 'btn btn-sm btn-secondary'; 
      elements.sankeyAll.className = 'btn btn-sm btn-secondary'; 
      this.updateSankeyChart(); 
    });
    elements.sankeyTop25.addEventListener('click', () => { 
      app.sankeyDisplayLimit = 25; 
      elements.sankeyTop10.className = 'btn btn-sm btn-secondary'; 
      elements.sankeyTop25.className = 'btn btn-sm btn-primary'; 
      elements.sankeyAll.className = 'btn btn-sm btn-secondary'; 
      this.updateSankeyChart(); 
    });
    elements.sankeyAll.addEventListener('click', () => { 
      app.sankeyDisplayLimit = 0; 
      elements.sankeyTop10.className = 'btn btn-sm btn-secondary'; 
      elements.sankeyTop25.className = 'btn btn-sm btn-secondary'; 
      elements.sankeyAll.className = 'btn btn-sm btn-primary'; 
      this.updateSankeyChart(); 
    });
  },

updateSankeyChart: function() {
  const data = app.filteredData; 
  if (!data || data.length === 0) {
    elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:var(--space-6); color:var(--text-secondary);">No data available for Sankey chart.</p>';
    return;
  }
  
  try {
    const sankeyData = dataProcessor.generateSankeyData(data, app.sankeyDisplayLimit);
    
    // Check if we have enough data to display
    if (!sankeyData.links || sankeyData.links.length === 0 || !sankeyData.nodes || sankeyData.nodes.length < 2) {
      elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:var(--space-6); color:var(--text-secondary);">Not enough data to display Sankey diagram.</p>';
      return;
    }
    elements.sankeyChartContainer.innerHTML = '';
    const container = elements.sankeyChartContainer; 
    container.querySelector('svg')?.remove();
    const width = container.clientWidth, height = container.clientHeight;
    if (width <= 0 || height <= 0) return;
    
    // For Sankey chart, use a higher DPR for sharper rendering
    const dpr = window.devicePixelRatio || 1;
    
    const svg = d3.select(container).append('svg')
      .attr('width', width * dpr)
      .attr('height', height * dpr)
      .style('width', width + 'px')
      .style('height', height + 'px');
      
    // Apply scaling for high resolution
    svg.attr('viewBox', `0 0 ${width} ${height}`);
    
    const sankey = d3.sankey()
      .nodeWidth(18)
      .nodePadding(10)
      .extent([[20, 10], [width - 40, height - 30]])
      .nodeSort((a, b) => d3.descending(a.value, b.value));
    
    let graph;
    try {
      graph = sankey({
        nodes: sankeyData.nodes.map(d => Object.assign({}, d)),
        links: sankeyData.links.map(d => Object.assign({}, d))
      });
    } catch (sankeyLayoutError) {
      console.error("Error in Sankey layout:", sankeyLayoutError);
      elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:var(--space-6); color:var(--text-secondary);">Unable to create Sankey diagram with current data.</p>';
      return;
    }
    
    const { nodes, links } = graph;
    
    nodes.forEach(n => n.color = utils.getEntityColor(n.name, n.type)); 
    
    const defs = svg.append("defs");
    links.forEach(l => {
      l.gradientId = `gradient-${l.source.index}-${l.target.index}`;
      const sourceColor = nodes[l.source.index].color;
      const targetColor = nodes[l.target.index].color;
    
      const gradient = defs.append("linearGradient")
        .attr("id", l.gradientId)
        .attr("gradientUnits", "userSpaceOnUse") 
        .attr("x1", nodes[l.source.index].x1) 
        .attr("x2", nodes[l.target.index].x0);

      gradient.append("stop").attr("offset", "0%").attr("stop-color", sourceColor).attr("stop-opacity", 0.7);
      gradient.append("stop").attr("offset", "100%").attr("stop-color", targetColor).attr("stop-opacity", 0.7);
    });

    const link = svg.append('g')
      .attr('fill', 'none')
      .attr('stroke-opacity', 0.55)
      .selectAll('path')
      .data(links)
      .join('path')
      .attr('d', d3.sankeyLinkHorizontal())
      .attr('stroke', d => `url(#${d.gradientId})`)
      .attr('stroke-width', d => Math.max(1.5, d.width))
      .on('mouseover', function(ev, d) { 
        d3.select(this).attr('stroke-opacity', 0.85); 
        const tt = elements.sankeyTooltip; 
        tt.style.display = 'block';
        tt.style.opacity = 1; 
        tt.style.left = (ev.pageX + 15) + 'px'; 
        tt.style.top = (ev.pageY - 15) + 'px'; 
        tt.innerHTML = `<div style="font-weight:600;">${utils.truncateText(nodes[d.source.index].name, 25)}  ${utils.truncateText(nodes[d.target.index].name, 25)}</div><div>Value: ${utils.formatMoney(d.value)}</div>`; 
      })
      .on('mouseout', function() { 
        d3.select(this).attr('stroke-opacity', 0.55); 
        const tt = elements.sankeyTooltip;
        tt.style.opacity = 0; 
        tt.style.display = 'none';
      })
      .on('click', function(ev, d) { 
        const sn = nodes[d.source.index], tn = nodes[d.target.index]; 
        if (sn.type === 'agency' && tn.type === 'office') { 
          filterManager.applySelectionFilter('agency', sn.name, null); 
          elements.agencyFilter.value = sn.name; 
        } else if (sn.type === 'office' && tn.type === 'vendor') { 
          filterManager.applySelectionFilter('office', sn.name, null); 
          elements.officeFilter.value = sn.name; 
        } 
      });
      
    const node = svg.append('g')
      .attr('stroke', 'none')
      .selectAll('rect')
      .data(nodes)
      .join('rect')
      .attr('x', d => d.x0)
      .attr('y', d => d.y0)
      .attr('height', d => Math.max(1, d.y1 - d.y0))
      .attr('width', d => d.x1 - d.x0)
      .attr('fill', d => d.color)
      .attr('rx', 4)
      .attr('ry', 4)
      .on('mouseover', function(ev, d) { 
        d3.select(this).attr('fill', d3.color(d.color).darker(0.3));
        link.attr('stroke-opacity', l => l.source.index === d.index || l.target.index === d.index ? 0.85 : 0.1); 
        const tt = elements.sankeyTooltip; 
        tt.style.display = 'block';
        tt.style.opacity = 1; 
        tt.style.left = (ev.pageX + 15) + 'px'; 
        tt.style.top = (ev.pageY - 15) + 'px'; 
        tt.innerHTML = `<div style="font-weight:600;">${utils.truncateText(d.name, 30)}</div><div style="font-size:12px;">Type: ${d.type.charAt(0).toUpperCase() + d.type.slice(1)}</div><div style="font-size:12px;">Total Flow: ${utils.formatMoney(d.value)}</div>`; 
      })
      .on('mouseout', function(ev, d) { 
        d3.select(this).attr('fill', d.color);
        link.attr('stroke-opacity', 0.55); 
        const tt = elements.sankeyTooltip;
        tt.style.opacity = 0; 
        tt.style.display = 'none';
      })
      .on('click', function(ev, d) { 
        if (d.type === 'agency') { 
          filterManager.applySelectionFilter('agency', d.name, null); 
          elements.agencyFilter.value = d.name; 
        } else if (d.type === 'office') { 
          filterManager.applySelectionFilter('office', d.name, null); 
          elements.officeFilter.value = d.name; 
        } else if (d.type === 'vendor') { 
          filterManager.applySelectionFilter('vendor', d.name, null); 
          elements.vendorFilter.value = d.name; 
        } 
      });
      
    // Sharper text rendering
    svg.append('g')
      .attr('font-family', 'var(--font-sans)')
      .attr('font-size', 11)
      .attr('font-weight', 500)
      .attr('text-rendering', 'geometricPrecision') // Improve text sharpness
      .selectAll('text')
      .data(nodes)
      .join('text')
      .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
      .attr('y', d => (d.y1 + d.y0) / 2)
      .attr('dy', '0.35em')
      .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
      .attr('fill', getComputedStyle(document.documentElement).getPropertyValue('--text-primary'))
      .text(d => utils.truncateText(d.name, (d.x1 - d.x0 > 60) ? 30 : 12));
  
  } catch (sankeyError) {
    console.error("Error rendering Sankey chart:", sankeyError);
    elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:var(--space-6); color:var(--text-secondary);">Error rendering Sankey chart. Please try adjusting filters.</p>';
  }
},
  addChartClickEvents: function() {
    elements.valueTimeChartContainer.addEventListener('click', function(ev) { 
      const chart = app.charts.valueTimeChart;
      const ap = chart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, false); 
      if (ap.length > 0) { 
        const label = chart.data.labels[ap[0].index];
        const match = label.match(/(\w+)\s*'?(\d+)?/); 
        if (match) { 
          const mn = match[1];
          const ys = match[2] || new Date().getFullYear().toString().substr(2);
          const mMap = { 'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5, 'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11 }; 
          if (mMap[mn] !== undefined) { 
            const fullYear = parseInt('20' + ys);
            const startDate = new Date(fullYear, mMap[mn], 1);
            const endDate = new Date(fullYear, mMap[mn] + 1, 0);
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0]; 
            elements.startDate.value = startDateStr; 
            elements.endDate.value = endDateStr; 
            app.filters.startDate = startDateStr; 
            app.filters.endDate = endDateStr; 
            if (app.selection.type) { 
              delete app.filters[app.selection.type]; 
              app.selection = { type: null, value: null, container: null }; 
              document.querySelectorAll('.selection-indicator').forEach(i => i.style.display = 'none'); 
            } 
            filterManager.applyFilters(); 
            filterManager.updateFilterTags(); 
            dashboardManager.refreshDashboard(); 
          } 
        } 
      } 
    });
    
    elements.agencyChartContainer.addEventListener('click', function(ev) { 
      const chart = app.charts.agencyChart;
      const ap = chart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, false); 
      if (ap.length > 0) { 
        const label = chart.data.labels[ap[0].index];
        const agencyName = Object.keys(app.agencies).find(name => name === label || label.includes(name)); 
        if (agencyName) { 
          filterManager.applySelectionFilter('agency', agencyName, elements.agencyChartContainer); 
          elements.agencyFilter.value = agencyName; 
        } 
      } 
    });
    
    elements.naicsBubbleChartContainer.addEventListener('click', function(ev) { 
      const chart = app.charts.naicsBubbleChart;
      const ap = chart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, false); 
      if (ap.length > 0) { 
          const dataPoint = chart.data.datasets[ap[0].datasetIndex].data[ap[0].index];
          const fullLabel = dataPoint.label;
          const naicsCodeMatch = fullLabel.match(/^(\d[\d\w.-]*)/); 
          if (naicsCodeMatch && naicsCodeMatch[1]) {
              const naicsCode = naicsCodeMatch[1];
              filterManager.applySelectionFilter('naics', naicsCode, elements.naicsBubbleChartContainer); 
              elements.naicsFilter.value = naicsCode;
          }
      } 
    });
    
    elements.vendorChartContainer.addEventListener('click', function(ev) { 
      const chart = app.charts.vendorChart;
      const ap = chart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, false); 
      if (ap.length > 0) { 
        const label = chart.data.labels[ap[0].index];
        const vendorName = Object.keys(app.vendors).find(name => name === label || label.includes(name) || name.includes(label)); 
        if (vendorName) { 
          filterManager.applySelectionFilter('vendor', vendorName, elements.vendorChartContainer); 
          elements.vendorFilter.value = vendorName; 
        } 
      } 
    });
  },

  resizeAllCharts: function() {
    Object.values(app.charts).forEach(chartInstance => { 
      if (chartInstance instanceof Chart) {
        chartInstance.resize();
        chartInstance.update('none');
      }
    });
    this.updateSankeyChart();
  },

  updateCharts: function() { 
    this.updateValueTimeChart(); 
    this.updateAgencyChart(); 
    this.updateNaicsBubbleChart(); 
    this.updateVendorChart(); 
    this.updateSankeyChart(); 
  },

  updateValueTimeChart: function() { 
    const data = app.filteredData; 
    if (!data || data.length === 0) return; 
    const valueByMonth = {}; 
    data.forEach(c => { 
      if (c.parsedDate) { 
        const monthYear = `${c.parsedDate.getFullYear()}-${(c.parsedDate.getMonth() + 1).toString().padStart(2, '0')}`; 
        if (!valueByMonth[monthYear]) valueByMonth[monthYear] = 0; 
        valueByMonth[monthYear] += c.value; 
      } 
    }); 
    const sortedMonths = Object.keys(valueByMonth).sort();
    const labels = [], values = []; 
    sortedMonths.forEach(m => { 
      const [year, monthNum] = m.split('-');
      const date = new Date(parseInt(year), parseInt(monthNum) - 1, 1); 
      labels.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })); 
      values.push(valueByMonth[m]); 
    }); 
    const chart = app.charts.valueTimeChart; 
    chart.data.labels = labels; 
    chart.data.datasets[0].data = values; 
    chart.update(); 
  },

  updateAgencyChart: function() { 
    const data = app.filteredData; 
    if (!data || data.length === 0) return; 
    const valueByAgency = {}; 
    data.forEach(c => { 
      if (c.agency) { 
        if (!valueByAgency[c.agency]) valueByAgency[c.agency] = 0; 
        valueByAgency[c.agency] += c.value; 
      } 
    }); 
    const agencies = Object.keys(valueByAgency).map(a => ({ name: a, value: valueByAgency[a] })).sort((a, b) => b.value - a.value).slice(0, 8);
    const chart = app.charts.agencyChart; 
    chart.data.labels = agencies.map(a => utils.truncateText(a.name, 15)); 
    chart.data.datasets[0].data = agencies.map(a => a.value); 
    chart.data.datasets[0].backgroundColor = agencies.map(a => utils.getEntityColor(a.name, 'agency')); 
    chart.update(); 
  },

  updateNaicsBubbleChart: function() { 
    if (!app.charts.naicsBubbleChart) return;
    const data = app.filteredData; 
    const naicsData = {}; 
    data.forEach(c => { 
        if (c.naics) { 
            if (!naicsData[c.naics]) naicsData[c.naics] = { code: c.naics, description: c.naicsDescription || c.naics, count: 0, value: 0 }; 
            naicsData[c.naics].count++; 
            naicsData[c.naics].value += c.value; 
        } 
    }); 
    const topNaics = Object.values(naicsData).filter(n => n.count > 0 && n.value > 0).sort((a, b) => b.value - a.value).slice(0, 25); 
    
    if (topNaics.length === 0) return;
    
    const values = topNaics.map(n => n.value);
    const counts = topNaics.map(n => n.count);
    const maxValue = Math.max(...values, 1);
    const maxCount = Math.max(...counts, 1);
    const minValue = Math.min(...values, 1000);
    const minCount = Math.min(...counts, 1);
    
    const radiusScale = d3.scaleSqrt().domain([minValue, maxValue]).range([6, 25]);

    const chart = app.charts.naicsBubbleChart; 
    
    chart.options.scales.x.min = Math.max(1, minCount * 0.5);
    chart.options.scales.x.max = Math.min(100000, maxCount * 2);
    chart.options.scales.y.min = Math.max(1000, minValue * 0.1);
    chart.options.scales.y.max = Math.min(1000000000000, maxValue * 10);
    
    chart.data.datasets = [{ 
        label: topNaics.map(n => `${n.code} - ${utils.truncateText(n.description, 30)}`),
        data: topNaics.map(n => ({ 
            x: n.count, 
            y: n.value, 
            r: radiusScale(n.value),
            label: `${n.code} - ${n.description}`
        })), 
        backgroundColor: topNaics.map(n => utils.getEntityColorWithOpacity(n.code, 0.7, 'naics')), 
        borderColor: topNaics.map(n => utils.getEntityColor(n.code, 'naics')), 
        borderWidth: 1.5 
    }]; 
    chart.update(); 
  },

  updateVendorChart: function() { 
    const data = app.filteredData; 
    if (!data || data.length === 0) return; 
    const valueByVendor = {}; 
    data.forEach(c => { 
      if (c.vendor) { 
        if (!valueByVendor[c.vendor]) valueByVendor[c.vendor] = 0; 
        valueByVendor[c.vendor] += c.value; 
      } 
    }); 
    const vendors = Object.keys(valueByVendor).map(v => ({ name: v, value: valueByVendor[v] })).sort((a, b) => b.value - a.value).slice(0, 8);
    const chart = app.charts.vendorChart; 
    chart.data.labels = vendors.map(v => utils.truncateText(v.name, 12)); 
    chart.data.datasets[0].data = vendors.map(v => v.value); 
    chart.data.datasets[0].backgroundColor = vendors.map(v => utils.getEntityColor(v.name, 'vendor')); 
    chart.update(); 
  }
};
const tableManager = {
 initTableSorting: function() { 
   document.querySelectorAll('th[data-sort]').forEach(h => { 
     h.addEventListener('click', function() { 
       const table = this.closest('table');
       if (!table) return;
       const tbody = table.querySelector('tbody');
       if (!tbody) return;
       const rowsArray = Array.from(tbody.querySelectorAll('tr'));
       const sortField = this.getAttribute('data-sort'); 
       let sortDirection = 'asc'; 
       if (this.classList.contains('sort-asc')) { sortDirection = 'desc'; } 
       else if (this.classList.contains('sort-desc')) { sortDirection = 'asc'; }
       
       table.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc', 'sort-desc')); 
       this.classList.add(`sort-${sortDirection}`); 
       
       const compareFn = function(a, b) { 
         const cellA = a.querySelector(`td:nth-child(${Array.from(this.parentNode.children).indexOf(this) + 1})`);
         const cellB = b.querySelector(`td:nth-child(${Array.from(this.parentNode.children).indexOf(this) + 1})`);
         if (!cellA || !cellB) return 0;
         let valA = cellA.textContent.trim(), valB = cellB.textContent.trim(); 
         
         if (sortField === 'value' || sortField === 'contracts') { 
           valA = utils.parseMoney(valA); valB = utils.parseMoney(valB); 
         } else if (sortField === 'date') { 
           valA = utils.parseDate(valA)?.getTime() || 0; valB = utils.parseDate(valB)?.getTime() || 0; 
         } else { 
           valA = valA.toLowerCase(); valB = valB.toLowerCase();
         }
         if (valA < valB) return sortDirection === 'asc' ? -1 : 1; 
         if (valA > valB) return sortDirection === 'asc' ? 1 : -1; 
         return 0; 
       }.bind(this); 
       rowsArray.sort(compareFn).forEach(r => tbody.appendChild(r)); 
     }); 
   }); 
 },
 
 updateContractsTable: function() { 
   if (!elements.contractsTable) return;
   const data = app.filteredData, tbody = elements.contractsTable; tbody.innerHTML = ''; 
   [...data].sort((a, b) => (b.parsedDate?.getTime() || 0) - (a.parsedDate?.getTime() || 0)).slice(0, 15).forEach(c => this.addContractRow(c, tbody)); 
 },
 
 updateLargestContractsTable: function() { 
   if (!elements.largestContractsTable) return;
   const data = app.filteredData, tbody = elements.largestContractsTable; tbody.innerHTML = ''; 
   [...data].sort((a, b) => b.value - a.value).slice(0, 15).forEach(c => this.addContractRow(c, tbody)); 
 },
 
 addContractRow: function(contract, tbody) { 
  const row = document.createElement('tr'); 
  const agencyInitials = utils.getInitials(contract.agency), agencyColor = utils.stringToColor(contract.agency);
  const officeInitials = utils.getInitials(contract.office), officeColor = utils.stringToColor(contract.office);
  const vendorInitials = utils.getInitials(contract.vendor), vendorColor = utils.stringToColor(contract.vendor); 
  row.innerHTML = `
      <td class="table-date-cell">${utils.formatDate(contract.date)}</td>
      <td class="table-contract-id">${utils.truncateText(contract.id, 15)}</td>
      <td><div class="agency-badge" title="${contract.agency}"><div class="agency-icon" style="background-color:${agencyColor}">${agencyInitials}</div> ${utils.truncateText(contract.agency,15)}</div></td>
      <td><div class="office-badge" title="${contract.office}"><div class="office-icon" style="background-color:${officeColor}">${officeInitials}</div> ${utils.truncateText(contract.office,15)}</div></td>
      <td><div class="vendor-badge" title="${contract.vendor}"><div class="vendor-icon" style="background-color:${vendorColor}">${vendorInitials}</div> ${utils.truncateText(contract.vendor,15)}</div></td>
      <td title="${contract.description}">${utils.truncateText(contract.description,30)}</td>
      <td class="money table-value-cell">${utils.formatMoney(contract.value)}</td>
      <td class="table-actions-cell"><button class="btn btn-sm btn-primary view-contract" data-id="${contract.id}"><span class="btn-text">Details</span></button></td>`; 
  tbody.appendChild(row); 
  const viewButton = row.querySelector('.view-contract');
  if(viewButton) viewButton.addEventListener('click', function() { tableManager.showContractDetails(this.getAttribute('data-id')); }); 
},
 
 updateOfficesTable: function() { 
   if (!elements.officesTable) return;
   const data = app.filteredData, tbody = elements.officesTable; tbody.innerHTML = ''; 
   const officeData = {}; 
   data.forEach(c => { 
       if (c.office) { 
           if (!officeData[c.office]) officeData[c.office] = { name: c.office, agency: c.agency, count: 0, value: 0, naicsCodes: {}, vendors: {} }; 
           officeData[c.office].count++; officeData[c.office].value += c.value; 
           if (c.naics) { 
               if (!officeData[c.office].naicsCodes[c.naics]) officeData[c.office].naicsCodes[c.naics] = { code: c.naics, description: c.naicsDescription, count: 0, value: 0 }; 
               officeData[c.office].naicsCodes[c.naics].count++; officeData[c.office].naicsCodes[c.naics].value += c.value; 
           } 
           if (c.vendor) { 
               if (!officeData[c.office].vendors[c.vendor]) officeData[c.office].vendors[c.vendor] = { name: c.vendor, count: 0, value: 0 }; 
               officeData[c.office].vendors[c.vendor].count++; officeData[c.office].vendors[c.vendor].value += c.value; 
           } 
       } 
   }); 
   Object.values(officeData).sort((a, b) => b.value - a.value).slice(0, 10).forEach(office => { 
       const topNaics = Object.values(office.naicsCodes).sort((a, b) => b.value - a.value)[0] || { code: 'N/A', description: 'N/A' }; 
       const topVendor = Object.values(office.vendors).sort((a, b) => b.value - a.value)[0] || { name: 'N/A' }; 
       const agencyInitials = utils.getInitials(office.agency), agencyColor = utils.stringToColor(office.agency);
       const officeInitials = utils.getInitials(office.name), officeColor = utils.stringToColor(office.name);
       const vendorInitials = utils.getInitials(topVendor.name), vendorColor = utils.stringToColor(topVendor.name); 
       const row = document.createElement('tr'); 
       row.innerHTML = `
           <td><div class="agency-badge" title="${office.agency}"><div class="agency-icon" style="background-color:${agencyColor}">${agencyInitials}</div> ${utils.truncateText(office.agency,15)}</div></td>
           <td><div class="office-badge" title="${office.name}"><div class="office-icon" style="background-color:${officeColor}">${officeInitials}</div> ${utils.truncateText(office.name,15)}</div></td>
           <td>${office.count.toLocaleString()}</td>
           <td class="money">${utils.formatMoney(office.value)}</td>
           <td><span class="badge badge-primary" title="${topNaics.description}">${topNaics.code}</span></td>
           <td><div class="vendor-badge" title="${topVendor.name}"><div class="vendor-icon" style="background-color:${vendorColor}">${vendorInitials}</div> ${utils.truncateText(topVendor.name,15)}</div></td>`; 
       tbody.appendChild(row); 
       row.addEventListener('click', function() { filterManager.applySelectionFilter('office', office.name, null); if(elements.officeFilter) elements.officeFilter.value = office.name; }); 
   }); 
 },
 
/* Update to the showContractDetails function to include FPDS.gov link */

showContractDetails: function(contractId) { 
  const contract = app.data.find(c => c.id === contractId); 
  if (!contract) { 
    console.error('Contract not found:', contractId);
    return; 
  } 
  
  // Create FPDS.gov URL with contract ID
  const fpdsUrl = `https://www.fpds.gov/ezsearch/fpdsportal?q=PIID%3A%22${encodeURIComponent(contract.id)}%22&s=FPDS.GOV&templateName=1.5.3&indexName=awardfull&x=0&y=0`;
  
  const agencyInitials = utils.getInitials(contract.agency), agencyColor = utils.stringToColor(contract.agency);
  const officeInitials = utils.getInitials(contract.office), officeColor = utils.stringToColor(contract.office);
  const vendorInitials = utils.getInitials(contract.vendor), vendorColor = utils.stringToColor(contract.vendor); 
  
  elements.contractModalBody.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:1.5rem;">
          <div>
              <h4 style="margin-bottom:0.75rem;font-size:1.1rem;color:var(--primary);">Contract Information</h4>
              <p><strong>Contract ID:</strong> ${contract.id}</p>
              <p><strong>Reference IDV:</strong> ${contract.reference||'N/A'}</p>
              <p><strong>Date Signed:</strong> ${utils.formatDate(contract.date)}</p>
              <p><strong>Contract Type:</strong> ${contract.type||'N/A'}</p>
              <p><strong>Value:</strong> <span class="money">${utils.formatMoney(contract.value)}</span></p>
              <p style="margin-top:0.75rem;">
                <a href="${fpdsUrl}" class="btn btn-sm btn-secondary" target="_blank" rel="noopener noreferrer" style="text-decoration:none;">
                  <i class="fas fa-external-link-alt"></i>
                  <span class="btn-text">View on FPDS.gov</span>
                </a>
              </p>
          </div>
          <div>
              <h4 style="margin-bottom:0.75rem;font-size:1.1rem;color:var(--primary);">Parties Involved</h4>
              <p style="display:flex;align-items:center;margin-bottom:0.5rem;"><div class="agency-icon" style="background-color:${agencyColor};margin-right:0.5rem;">${agencyInitials}</div><strong>Agency:</strong> ${contract.agency}</p>
              <p style="display:flex;align-items:center;margin-bottom:0.5rem;"><div class="office-icon" style="background-color:${officeColor};margin-right:0.5rem;">${officeInitials}</div><strong>Office:</strong> ${contract.office||'N/A'}</p>
              <p style="display:flex;align-items:center;margin-bottom:0.5rem;"><div class="vendor-icon" style="background-color:${vendorColor};margin-right:0.5rem;">${vendorInitials}</div><strong>Vendor:</strong> ${contract.vendor}</p>
          </div>
      </div>
      <div style="margin-top:1.5rem;">
          <h4 style="margin-bottom:0.75rem;font-size:1.1rem;color:var(--primary);">Description & Codes</h4>
          <p><strong>Description:</strong> ${contract.description||'No description available.'}</p>
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:1rem;margin-top:1rem;">
              <div><p><strong>NAICS:</strong> ${contract.naics||'N/A'}</p><p style="font-size:var(--font-xs);color:var(--text-secondary);">${contract.naicsDescription||''}</p></div>
              <div><p><strong>PSC:</strong> ${contract.psc||'N/A'}</p><p style="font-size:var(--font-xs);color:var(--text-secondary);">${contract.pscDescription||''}</p></div>
          </div>
      </div>
      <div style="margin-top:1.5rem;display:flex;gap:0.75rem;flex-wrap:wrap;justify-content:center;">
          <button id="modalFilterByAgency" class="btn btn-sm btn-secondary"><i class="fas fa-filter"></i> <span class="btn-text">Filter by Agency</span></button>
          <button id="modalFilterByOffice" class="btn btn-sm btn-secondary"><i class="fas fa-filter"></i> <span class="btn-text">Filter by Office</span></button>
          <button id="modalFilterByVendor" class="btn btn-sm btn-secondary"><i class="fas fa-filter"></i> <span class="btn-text">Filter by Vendor</span></button>
      </div>`; 
  elements.contractModal.classList.add('active'); 
  document.getElementById('modalFilterByAgency')?.addEventListener('click', () => { filterManager.applySelectionFilter('agency', contract.agency, elements.agencyChartContainer); if(elements.agencyFilter) elements.agencyFilter.value = contract.agency; this.hideContractDetails(); }); 
  document.getElementById('modalFilterByOffice')?.addEventListener('click', () => { filterManager.applySelectionFilter('office', contract.office, null); if(elements.officeFilter) elements.officeFilter.value = contract.office; this.hideContractDetails(); }); 
  document.getElementById('modalFilterByVendor')?.addEventListener('click', () => { filterManager.applySelectionFilter('vendor', contract.vendor, elements.vendorChartContainer); if(elements.vendorFilter) elements.vendorFilter.value = contract.vendor; this.hideContractDetails(); }); 
},
 hideContractDetails: function() { elements.contractModal.classList.remove('active'); },
 
 updateTables: function() { this.updateContractsTable(); this.updateLargestContractsTable(); this.updateOfficesTable(); }
};

const dashboardManager = {
 initDashboard: function() { 
   if (!elements.loadingIndicator || !elements.errorMessage || !elements.noDataMessage || !elements.dashboard || !elements.statusBox) {
       console.error("One or more critical dashboard elements are missing from the DOM.");
       return;
   }
   elements.loadingIndicator.style.display = 'none'; 
   elements.errorMessage.style.display = 'none'; 
   elements.noDataMessage.style.display = 'none'; 
   elements.dashboard.style.display = 'flex'; 
   elements.statusBox.style.display = 'flex'; 
   chartManager.initCharts(); 
   tableManager.initTableSorting(); 
   this.refreshDashboard(); 
 },
 
 refreshDashboard: function() { 
   this.updateStats(); chartManager.updateCharts(); tableManager.updateTables(); filterManager.updateFilterTags(); 
 },
 
 updateStats: function() { 
   const d = app.filteredData; 
   if(elements.totalContracts) elements.totalContracts.textContent = d.length.toLocaleString(); 
   if(elements.totalValue) elements.totalValue.textContent = utils.formatMoney(d.reduce((s, c) => s + c.value, 0)); 
   if(elements.avgValue) elements.avgValue.textContent = utils.formatMoney(d.length > 0 ? d.reduce((s, c) => s + c.value, 0) / d.length : 0); 
   if(elements.uniqueVendors) elements.uniqueVendors.textContent = new Set(d.map(c => c.vendor).filter(Boolean)).size.toLocaleString(); 
 }
};

const fileHandler = {
 processAndDisplayCsv: function(csvText, fileNameForDisplay = "Uploaded Data") {
   try {
     filterManager.resetFilters(); 
     const csvData = utils.parseCSV(csvText);
     const processedData = dataProcessor.processData(csvData);
     app.data = processedData; 
     app.filteredData = [...processedData]; 
     const analysis = dataProcessor.analyzeData(processedData);
     app.agencies = analysis.agencies; app.offices = analysis.offices; app.vendors = analysis.vendors;
     app.naicsCodes = analysis.naicsCodes; app.pscCodes = analysis.pscCodes;
     this.populateFilterDropdowns();
     dashboardManager.initDashboard(); 
     const uploadBtnTextSpan = elements.uploadBtn.querySelector('.btn-text');
     if(uploadBtnTextSpan) uploadBtnTextSpan.textContent = 'Upload';
     elements.csvFile.value = ''; 
   } catch (error) {
     console.error('Error processing CSV data:', error);
     this.showError(`Error processing ${fileNameForDisplay}: ${error.message}`);
     if(app.data.length === 0) {
       elements.dashboard.style.display = 'none';
       elements.statusBox.style.display = 'none'; 
       elements.noDataMessage.style.display = 'flex';
     }
   } finally {
     elements.loadingIndicator.style.display = 'none';
   }
 },
 
 loadCsvFromUrl: async function(csvUrl, fileNameForDisplay) {
    const timestamp = new Date().getTime();
	const noCacheUrl = `${csvUrl}?t=${timestamp}`;
    elements.loadingIndicator.style.display = 'flex';
   elements.errorMessage.style.display = 'none';
   elements.noDataMessage.style.display = 'none'; 
   elements.dashboard.style.display = 'none'; 
   elements.statusBox.style.display = 'none'; 
   try {
     const response = await fetch(noCacheUrl);
     if (!response.ok) {
       throw new Error(`Network response was not ok: ${response.status} ${response.statusText} for ${fileNameForDisplay}`);
     }
     const csvText = await response.text();
     this.processAndDisplayCsv(csvText, fileNameForDisplay);
   } catch (error) {
     console.error(`Error fetching CSV from ${csvUrl}:`, error);
     this.showError(`Failed to load ${fileNameForDisplay}: ${error.message}. Check S3 CORS policy and file path.`);
     elements.loadingIndicator.style.display = 'none';
     if(app.data.length === 0) {
       elements.noDataMessage.style.display = 'flex';
     } else {
       elements.dashboard.style.display = 'flex';
       elements.statusBox.style.display = 'flex';
     }
   }
 },
 
 handleFileUpload: function() {
   const file = elements.csvFile.files[0];
   if (!file) return;

   const fileName = file.name.toLowerCase();
   const isValidExtension = fileName.endsWith('.csv') || fileName.endsWith('.xls');

   if (!isValidExtension) {
     this.showError('Please upload a valid CSV file (or .xls if from iOS).');
     elements.csvFile.value = '';
     return;
   }

   elements.loadingIndicator.style.display = 'flex';
   elements.errorMessage.style.display = 'none';
   elements.noDataMessage.style.display = 'none';
   elements.dashboard.style.display = 'none';
   elements.statusBox.style.display = 'none';

   const reader = new FileReader();
   reader.onload = (event) => {
     this.processAndDisplayCsv(event.target.result, file.name);
     const uploadBtnTextSpan = elements.uploadBtn.querySelector('.btn-text');
     if (uploadBtnTextSpan) {
       uploadBtnTextSpan.textContent = ` ${utils.truncateText(file.name, 10)}`;
     }
   };
   reader.onerror = () => {
     this.showError('Error reading the file.');
     elements.loadingIndicator.style.display = 'none';
     if (app.data.length === 0) {
       elements.noDataMessage.style.display = 'flex';
     } else {
       elements.dashboard.style.display = 'flex';
       elements.statusBox.style.display = 'flex';
     }
   };
   reader.readAsText(file);
 },
 
 showError: function(message) { elements.errorMessage.textContent = message; elements.errorMessage.style.display = 'block'; },
 
 populateFilterDropdowns: function() {
   const pop = function(el, it, vf, lf) { 
     while (el.options.length > 1) el.remove(1); 
     [...it].sort((a, b) => b.count - a.count).slice(0, 100).forEach(i => { 
       const o = document.createElement('option'); 
       o.value = i[vf]; 
       o.textContent = lf(i); 
       el.appendChild(o); 
     }); 
   };
   pop(elements.agencyFilter, Object.values(app.agencies), 'name', i => `${utils.truncateText(i.name, 30)} (${i.count})`);
   pop(elements.officeFilter, Object.values(app.offices), 'name', i => `${utils.truncateText(i.name, 30)} (${i.count})`);
   pop(elements.naicsFilter, Object.values(app.naicsCodes), 'code', i => `${i.code} - ${utils.truncateText(i.description, 25)} (${i.count})`);
   pop(elements.pscFilter, Object.values(app.pscCodes), 'code', i => `${i.code} - ${utils.truncateText(i.description, 25)} (${i.count})`);
   pop(elements.vendorFilter, Object.values(app.vendors), 'name', i => `${utils.truncateText(i.name, 30)} (${i.count})`);
 }
};
function setupEventListeners() {
  if(elements.csvFile) elements.csvFile.addEventListener('change', () => fileHandler.handleFileUpload());
  
  if(elements.loadExample1Btn) elements.loadExample1Btn.addEventListener('click', () => { 
    fileHandler.loadCsvFromUrl(app.s3BaseUrl + 'q225.csv', 'YTD Data'); 
    updateExampleButtonActiveState(elements.loadExample1Btn); 
  });
  
  if(elements.loadExample2Btn) elements.loadExample2Btn.addEventListener('click', () => { 
    fileHandler.loadCsvFromUrl(app.s3BaseUrl + 'da10.csv', 'SaaS 3YR Data (da10.csv)'); 
    updateExampleButtonActiveState(elements.loadExample2Btn); 
  });
  
  if(elements.loadExample3Btn) elements.loadExample2Btn.addEventListener('click', () => { 
    fileHandler.loadCsvFromUrl(app.s3BaseUrl + 'q125.csv', 'Q125 > $100K (q125.csv)'); 
    updateExampleButtonActiveState(elements.loadExample3Btn); 
  });

  let searchTimeout;
  if(elements.searchInput) elements.searchInput.addEventListener('input', () => { 
      clearTimeout(searchTimeout); 
      searchTimeout = setTimeout(() => { 
          app.filters.search = elements.searchInput.value; 
          filterManager.applyFilters(); 
          dashboardManager.refreshDashboard(); 
      }, 400); 
  });

  const addFilterListener = function(el, filterKey, chartContainerForSelection) {
    if (el) {
        el.addEventListener('change', () => {
            const value = el.value;
            if (value) app.filters[filterKey] = value;
            else delete app.filters[filterKey];
            
            if (['agency', 'vendor', 'naics', 'psc', 'office'].includes(filterKey)) {
                 filterManager.applySelectionFilter(filterKey, value, chartContainerForSelection);
            } else { 
                filterManager.applyFilters();
                dashboardManager.refreshDashboard();
            }
        });
    }
  };

  addFilterListener(elements.agencyFilter, 'agency', elements.agencyChartContainer);
  addFilterListener(elements.vendorFilter, 'vendor', elements.vendorChartContainer);
  addFilterListener(elements.pscFilter, 'psc', null); 
  
  if(elements.valueFilter) elements.valueFilter.addEventListener('change', () => { 
    const r = elements.valueFilter.value; 
    if (r) { 
      const v = utils.parseValueRange(r); 
      if (v) app.filters.valueRange = v; 
      else delete app.filters.valueRange; 
    } else delete app.filters.valueRange; 
    filterManager.applyFilters(); 
    dashboardManager.refreshDashboard(); 
  });
  
  if(elements.startDate) elements.startDate.addEventListener('change', () => { 
    app.filters.startDate = elements.startDate.value; 
    filterManager.applyFilters(); 
    dashboardManager.refreshDashboard(); 
  });
  
  if(elements.endDate) elements.endDate.addEventListener('change', () => { 
    app.filters.endDate = elements.endDate.value; 
    filterManager.applyFilters(); 
    dashboardManager.refreshDashboard(); 
  });
  
  addFilterListener(elements.officeFilter, 'office', null); 
  addFilterListener(elements.naicsFilter, 'naics', elements.naicsBubbleChartContainer); 

  if(elements.moreFiltersBtn) elements.moreFiltersBtn.addEventListener('click', () => elements.advancedFiltersPanel.classList.toggle('active'));
  if(elements.closeFilters) elements.closeFilters.addEventListener('click', () => elements.advancedFiltersPanel.classList.remove('active'));
  
  // Remove the mobile filter button event listener - we're hiding it with CSS
  
  if(elements.resetFilters) elements.resetFilters.addEventListener('click', () => { 
    filterManager.resetFilters(); 
    if(elements.advancedFiltersPanel) elements.advancedFiltersPanel.classList.remove('active'); 
  });
  
  elements.tabButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      elements.tabButtons.forEach(b => b.classList.remove('active'));
      elements.tabContents.forEach(c => c.classList.remove('active'));
      this.classList.add('active');
      const tabId = this.getAttribute('data-tab') + 'Tab';
      const tabContent = document.getElementById(tabId);
      if (tabContent) {
        tabContent.classList.add('active');
      }
    });
  });

  if(elements.closeModal) elements.closeModal.addEventListener('click', () => tableManager.hideContractDetails());
  if(elements.closeModalBtn) elements.closeModalBtn.addEventListener('click', () => tableManager.hideContractDetails());
  if(elements.contractModal) elements.contractModal.addEventListener('click', e => { if (e.target === elements.contractModal) tableManager.hideContractDetails(); });
  
  let resizeTimer;
  window.addEventListener('resize', () => { 
      clearTimeout(resizeTimer); 
      resizeTimer = setTimeout(() => { 
          if (elements.dashboard && elements.dashboard.style.display !== 'none') { 
              chartManager.resizeAllCharts();
          } 
      }, 150); 
  });
  
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      if (elements.dashboard && elements.dashboard.style.display !== 'none') { 
        chartManager.resizeAllCharts();
      }
    }, 300);
  });
}

function initThemeToggle() {
 const themeToggle = document.getElementById('color-scheme');
 
 const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
 themeToggle.checked = currentTheme === 'dark';
 
 themeToggle.addEventListener('change', function() {
   const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
   const newTheme = currentTheme === 'light' ? 'dark' : 'light';
   document.documentElement.setAttribute('data-theme', newTheme);
   localStorage.setItem('theme', newTheme);
   
   if (app.charts && Object.keys(app.charts).length > 0 && typeof Chart !== 'undefined') {
     Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
     Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();

     Object.values(app.charts).forEach(chartInstance => {
       if (chartInstance instanceof Chart) {
         if (chartInstance.options.scales) {
           Object.values(chartInstance.options.scales).forEach(scale => {
             if (scale.ticks) scale.ticks.color = Chart.defaults.color;
             if (scale.grid) scale.grid.color = Chart.defaults.borderColor + '80';
             if (scale.title && scale.title.display) scale.title.color = Chart.defaults.color;
           });
         }
         if (chartInstance.config.type === 'line' && chartInstance.data.datasets.length > 0) {
           chartInstance.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
           chartInstance.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
           chartInstance.data.datasets[0].backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() + '26';
           chartInstance.data.datasets[0].pointBackgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
           chartInstance.data.datasets[0].pointBorderColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim();
         }
         chartInstance.update('none');
       }
     });
     
     if (elements.dashboard && elements.dashboard.style.display !== 'none') {
       setTimeout(() => chartManager.updateSankeyChart(), 50);
     }
   }
 });
}

function loadSavedTheme() {
 const savedTheme = localStorage.getItem('theme');
 let effectiveTheme = document.documentElement.getAttribute('data-theme') || 
                     (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
 
 if (savedTheme) { 
   document.documentElement.setAttribute('data-theme', savedTheme);
   effectiveTheme = savedTheme;
 } else {
   document.documentElement.setAttribute('data-theme', effectiveTheme); 
 }
 
 const themeToggle = document.getElementById('color-scheme');
 if (themeToggle) {
   themeToggle.checked = effectiveTheme === 'dark';
 }
}

function updateExampleButtonActiveState(activeButton) {
 const exampleButtons = [elements.loadExample1Btn, elements.loadExample2Btn];
 exampleButtons.forEach(button => {
   if (button) {
     if (button === activeButton) {
       button.classList.remove('btn-secondary');
       button.classList.add('btn-primary');
     } else {
       button.classList.remove('btn-primary');
       button.classList.add('btn-secondary');
     }
   }
 });
}

function init() {
 loadSavedTheme();
 initThemeToggle();
 setupEventListeners();
 
 // Initialize mobile header manager
 mobileHeaderManager.init();
 
 // Start with loading sample data
 fileHandler.loadCsvFromUrl(app.s3BaseUrl + 'q225.csv', 'YTD Data (Initially Loaded)');
}

if (document.readyState === 'loading') {
   document.addEventListener('DOMContentLoaded', init);
} else {
   init(); 
}
</script>
</body>
</html>