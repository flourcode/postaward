<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Post Award helps you analyze federal contract data to spot trends, find prime contractors, and identify subcontracting opportunities.">
  <meta name="keywords" content="federal contracts, FPDS, contract analysis, government procurement, subcontracting">
  <meta name="author" content="Mark">
  <!-- Open Graph / Social Media -->
  <meta property="og:title" content="Post Award - Federal Contract Intelligence">
  <meta property="og:description" content="Analyze federal contract data to find opportunities and track spending.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://postaward.com">
  <meta property="og:image" content="https://postaward.com/images/og-image.png">
  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <title>Post Award - Federal Contract Intelligence</title>
  <!-- Preconnect to external domains for faster loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <!-- Stylesheets with preload for critical CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWJYQQZYFW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-YWJYQQZYFW');
  </script>
  <!-- Defer non-critical scripts -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
</script>
  <style>
:root {
  /* Core Colors */
  --primary: #007AFF;
  --primary-dark: #0056b3;
  --primary-light: #58a6ff;
  --secondary: #8A8A8E;
  --success: #34C759;
  --warning: #FF9500;
  --danger: #FF3B30;
  /* Text Colors */
  --text-primary: #1d1d1f;
  --text-secondary: #6e6e73;
  --text-tertiary: #86868b;
  /* Background Colors */
  --bg-primary: #ffffff;
  --bg-secondary: #f7f7f9;
  --bg-tertiary: #e5e5ea;
  --border: #d1d1d6;
  --app-bg: #eaeaef;
  /* Spacing */
  --space-1: 0.25rem;
  --space-2: 0.5rem;
  --space-3: 0.75rem;
  --space-4: 1rem;
  --space-5: 1.25rem;
  --space-6: 1.5rem;
  --space-7: 1.75rem;
  --space-8: 2rem;
  --space-10: 2.5rem;
  --space-12: 3rem;
  /* Typography */
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  --font-xs: 0.75rem;
  --font-sm: 0.875rem;
  --font-base: 1rem;
  --font-lg: 1.125rem;
  --font-xl: 1.25rem;
  --font-2xl: 1.5rem;
  --font-3xl: 1.875rem;
  --font-4xl: 2.25rem;
  /* Radiuses and Shadows */
  --radius-sm: 4px;
  --radius: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 1px 0 rgba(0,0,0,0.02);
  --shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.04), 0 1px 2px 0 rgba(0,0,0,0.03);
  --shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0,0,0,0.04);
  --shadow-lg: 0 10px 20px -5px rgba(0, 0, 0, 0.06), 0 4px 10px -4px rgba(0,0,0,0.05);
  --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  /* Header Heights */
  --header-height-mobile: 60px;
  --header-height-desktop: 80px;
}
/* Theme Overrides */
[data-theme="light"] {
  --primary: #007AFF;
  --primary-dark: #0056b3;
  --primary-light: #58a6ff;
  --secondary: #8A8A8E;
  --success: #34C759;
  --warning: #FF9500;
  --danger: #FF3B30;
  --text-primary: #1d1d1f;
  --text-secondary: #6e6e73;
  --text-tertiary: #86868b;
  --bg-primary: #ffffff;
  --bg-secondary: #f7f7f9;
  --bg-tertiary: #e5e5ea;
  --border: #d1d1d6;
  --app-bg: #eaeaef;
}
[data-theme="dark"] {
  --primary: #0A84FF;
  --primary-dark: #005ecb;
  --primary-light: #64b5f6;
  --secondary: #8E8E93;
  --success: #30D158;
  --warning: #FF9F0A;
  --danger: #FF453A;
  --text-primary: #ffffff;
  --text-secondary: #aeaeb2;
  --text-tertiary: #8e8e93;
  --bg-primary: #1c1c1e;
  --bg-secondary: #2c2c2e;
  --bg-tertiary: #3a3a3c;
  --border: #48484a;
  --app-bg: #000000;
}
/* Reset */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
html, body {
  height: 100%;
  overflow-x: hidden;
}
body {
  font-family: var(--font-sans);
  background-color: var(--app-bg);
  color: var(--text-primary);
  line-height: 1.6;
  font-size: var(--font-base);
}
/* Layout */
.app-container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  width: 100%;
  margin: 0 auto;
  max-width: 1600px;
  padding: 0;
}
/* Header */
.app-header {
  background-color: var(--bg-primary);
  box-shadow: var(--shadow-md);
  padding: var(--space-4) var(--space-6);
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: var(--space-4);
  position: relative;
  transition: transform 0.3s ease;
}
.header-main-content-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  width: 100%;
  margin-bottom: var(--space-4);
}
.logo-container {
  flex: 1;
  max-width: 85%;
}
.logo-main-line {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}
.logo-main-line > i {
  font-size: var(--font-3xl);
  color: var(--text-primary);
}
.logo-main-line > span {
  font-size: var(--font-3xl);
  font-weight: 700;
  color: var(--text-primary);
}
.header-main-content-row .logo-subtitle {
  font-size: var(--font-sm);
  color: var(--text-secondary);
  line-height: 1.5;
  margin-top: var(--space-1);
  max-width: 600px;
}
.header-toggle-btn {
  display: none;
  position: absolute;
  right: var(--space-3);
  font-size: var(--font-lg);
  background: transparent;
  border: none;
  color: var(--text-primary);
  padding: var(--space-2);
  cursor: pointer;
  z-index: 101;
}
.header-actions {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: var(--space-4);
  padding-top: var(--space-2);
}
.header-content {
  display: flex;
  flex-direction: column;
  width: 100%;
  transition: opacity 0.3s ease;
}
/* Theme Toggle */
#color-scheme {
  width: 0;
  height: 0;
  visibility: hidden;
  position: absolute;
}
.toggle-item {
  width: 3em;
  height: 1.5em;
  display: inline-block;
  border-radius: 50px;
  margin: 0;
  position: relative;
  transition: all .3s ease;
  cursor: pointer;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
.toggle-item:before {
  content: '';
  position: absolute;
  display: block;
  width: 1.2em;
  height: 1.2em;
  top: 0.1em;
  left: 0.1em;
  border-radius: 50%;
  transition: .3s ease;
  background: var(--bg-primary);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  border: none;
}
#color-scheme:checked + .toggle-item {
  background: var(--secondary);
  border-color: var(--secondary);
}
#color-scheme:checked + .toggle-item:before {
  transform: translateX(1.4em);
  background: var(--bg-primary);
}
.toggle-item:hover {
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.15), 0 0 0 3px rgba(0, 122, 255, 0.1);
}
[data-theme="dark"] .toggle-item {
  background: var(--secondary);
  border-color: var(--border);
}
[data-theme="dark"] .toggle-item:before {
  background: var(--secondary);
  box-shadow: 0 2px 4px rgba(0,0,0,0.4);
}
[data-theme="dark"] #color-scheme:checked + .toggle-item:before {
  background: var(--bg-primary);
}
/* Data Load Controls */
.data-load-controls .example-csv-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-3);
  align-items: center;
}
.data-load-controls .example-csv-buttons .btn {
  font-weight: 500;
}
.file-input {
  display: none;
}
/* Status and Filters */
.status-and-active-filters {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
  padding: var(--space-3) 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: var(--space-3);
}
.status-and-active-filters .status-title {
  font-size: var(--font-2xl);
  font-weight: 600;
  color: var(--text-primary);
}
.status-and-active-filters .active-filters {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
}
.filter-tag {
  display: flex;
  align-items: center;
  gap: var(--space-1);
  padding: var(--space-1) var(--space-2);
  background-color: var(--bg-tertiary);
  border-radius: var(--radius);
  font-size: var(--font-xs);
  font-weight: 500;
  color: var(--text-secondary);
  transition: var(--transition);
}
.filter-tag:hover {
  background-color: var(--primary);
  color: white;
}
.filter-tag-remove {
  background: none;
  border: none;
  color: inherit;
  cursor: pointer;
  display: flex;
  align-items: center;
  margin-left: var(--space-1);
}
.filter-tag:hover .filter-tag-remove {
  color: white;
}
/* Primary Controls */
.primary-controls-area {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}
.main-filter-inputs {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}
.main-filter-inputs > .search-bar,
.main-filter-inputs > .filter-group {
  width: 100%;
}
.search-bar {
  position: relative;
  width: 100%;
}
.search-input {
  width: 100%;
  padding: var(--space-3) var(--space-4) var(--space-3) var(--space-8);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background-color: var(--bg-secondary);
  color: var(--text-primary);
  font-size: var(--font-base);
  transition: var(--transition);
}
.search-input::placeholder {
  color: var(--text-tertiary);
}
.search-icon {
  position: absolute;
  left: var(--space-4);
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-tertiary);
  font-size: var(--font-lg);
}
.search-input:focus {
  outline: none;
  border-color: var(--primary);
  background-color: var(--bg-primary);
  box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
}
.filter-group {
  display: flex;
  flex-direction: column;
  width: 100%;
  gap: var(--space-1);
}
.filter-label {
  font-size: var(--font-sm);
  color: var(--text-primary);
  font-weight: 500;
  margin-bottom: var(--space-1);
}
.filter-select {
  width: 100%;
  padding: var(--space-3);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background-color: var(--bg-secondary);
  color: var(--text-primary);
  font-size: var(--font-base);
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236e6e73'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right var(--space-3) center;
  background-size: 1.25em;
  padding-right: var(--space-8);
  transition: var(--transition);
}
.filter-select:focus {
  outline: none;
  border-color: var(--primary);
  background-color: var(--bg-primary);
  box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
}
.filter-actions {
  display: flex;
  gap: var(--space-3);
  justify-content: flex-start;
}
/* Buttons */
.btn {
  padding: var(--space-3) var(--space-4);
  border-radius: var(--radius-md);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  font-size: var(--font-base);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  white-space: nowrap;
  border: 1px solid transparent;
  box-shadow: var(--shadow-sm);
  line-height: 1;
}
.btn:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}
.btn:active {
  transform: translateY(0px);
  box-shadow: var(--shadow-sm);
}
.btn-primary {
  background-color: var(--primary);
  color: white;
  border-color: var(--primary);
}
.btn-primary:hover {
  background-color: var(--primary-dark);
  border-color: var(--primary-dark);
}
.btn-secondary {
  background-color: var(--bg-primary);
  color: var(--primary);
  border-color: var(--primary);
}
.btn-secondary:hover {
  background-color: var(--primary-light);
  color: white;
  border-color: var(--primary-light);
}
[data-theme="dark"] .btn-secondary {
  background-color: var(--bg-tertiary);
  color: var(--primary-light);
  border-color: var(--primary-light);
}
[data-theme="dark"] .btn-secondary:hover {
  background-color: var(--primary);
  color: var(--text-primary);
  border-color: var(--primary);
}
.btn-sm {
  padding: var(--space-2) var(--space-3);
  font-size: var(--font-sm);
}
.btn-icon {
  padding: var(--space-2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition);
  box-shadow: none;
}
.btn-icon:hover {
  background-color: var(--bg-tertiary);
  color: var(--text-primary);
  box-shadow: none;
  transform: none;
}
/* Advanced Filters Panel */
#advancedFiltersPanel {
  background-color: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
  margin-top: var(--space-4);
  display: none;
}
#advancedFiltersPanel.active {
  display: block;
}
.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-4);
}
.panel-header h3 {
  font-size: var(--font-2xl);
  font-weight: 600;
  color: var(--text-primary);
}
.filters-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--space-4);
}
.filter-date {
  flex: 1;
  min-width: 0;
  padding: var(--space-3);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background-color: var(--bg-primary);
  color: var(--text-primary);
  font-size: var(--font-base);
}
/* Dashboard */
main#dashboard {
  flex-grow: 1;
  padding: var(--space-6) var(--space-4);
  background-color: var(--bg-secondary);
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
  overflow-y: auto;
}
.dashboard-section-header {
  font-size: var(--font-2xl);
  font-weight: 600;
  color: var(--text-primary);
  padding-bottom: var(--space-3);
  border-bottom: 1px solid var(--border);
  margin-bottom: var(--space-4);
}
/* Stats */
.stats-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--space-4);
}
.stat-card {
  background-color: var(--bg-primary);
  border-radius: var(--radius-lg);
  padding: var(--space-4);
  box-shadow: var(--shadow);
  text-align: left;
}
.stat-label {
  font-size: var(--font-sm);
  color: var(--text-secondary);
  margin-bottom: var(--space-1);
}
.stat-value {
  font-size: var(--font-3xl);
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1.1;
}
.stat-compnay {
  font-size: var(--font-2xl);
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1.1;
}
/* Visualization Sections */
.primary-viz, .charts-grid-container, .tables-section-container {
  background-color: var(--bg-primary);
  padding: var(--space-6);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
}
.sankey-chart-container {
  height: 350px;
}
.chart-container, .bubble-chart-container {
  height: 280px;
}
.charts-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--space-6);
}
/* Primary Viz Row */
.primary-viz-row {
  background-color: var(--bg-primary);
  padding: var(--space-6);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  margin-bottom: var(--space-2);
}
.primary-viz-container {
  display: flex;
  flex-direction: row;
  gap: var(--space-4);
  width: 100%;
  height: 450px;
}
.sankey-wrapper {
  flex: 2;
  height: 100%;
}
.month-chart-wrapper {
  flex: 1;
  height: 100%;
  display: flex;
  flex-direction: column;
}
.month-chart-wrapper .chart-container {
  flex-grow: 1;
  width: 100%;
}
.month-chart-wrapper .chart-title-integrated {
  margin-bottom: var(--space-2);
  font-size: var(--font-lg);
  font-weight: 600;
}
.sankey-chart-container {
  height: 100%;
  width: 100%;
}
/* Charts Grid */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--space-6);
  width: 100%;
}
.chart-item {
  width: 100%;
}
/* Tables */
.tables-section .tabs {
  border-bottom: 2px solid var(--border);
  margin-bottom: var(--space-4);
  background-color: transparent;
}
.tables-section .tab-btn {
  padding: var(--space-3) var(--space-4);
  font-weight: 500;
  font-size: var(--font-base);
  color: var(--text-secondary);
  background-color: transparent;
  border: none;
  position: relative;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  cursor: pointer;
  transition: var(--transition);
}
.tables-section .tab-btn:hover {
  color: var(--primary);
}
.tables-section .tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}
.tab-content {
  display: none;
  background-color: var(--bg-primary);
  border-radius: 0 0 var(--radius-lg) var(--radius-lg);
  overflow: hidden;
}
.tab-content.active {
  display: block;
}
.data-table {
  width: 100%;
  border-collapse: collapse;
}
.data-table th {
  background-color: var(--bg-secondary);
  color: var(--text-primary);
  font-weight: 600;
  text-align: left;
  padding: var(--space-3) var(--space-4);
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  position: relative;
}
.data-table th.sort-asc::after,
.data-table th.sort-desc::after {
  content: '';
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 0;
  height: 0;
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
}
.data-table th.sort-asc::after {
  border-bottom: 5px solid var(--primary);
}
.data-table th.sort-desc::after {
  border-top: 5px solid var(--primary);
}
.data-table td {
  padding: var(--space-3) var(--space-4);
  border-top: 1px solid var(--border);
  color: var(--text-primary);
}
.data-table tr:nth-child(even) {
  background-color: var(--bg-secondary);
}
.data-table tr:hover {
  background-color: var(--bg-tertiary);
}
.data-table .money {
  text-align: right;
  font-weight: 500;
}
/* Table Column Styling */
.data-table td.table-date-cell {
  white-space: nowrap;
  min-width: 80px;
  width: 80px;
}
.data-table td.table-contract-id {
  white-space: nowrap;
  min-width: 120px;
  font-family: monospace;
  font-size: 0.85em;
}
.data-table td.table-value-cell {
  white-space: nowrap;
  text-align: right;
  min-width: 90px;
}
.data-table td.table-actions-cell {
  white-space: nowrap;
  width: 80px;
  text-align: center;
}
/* Entity Badges */
.agency-badge,
.office-badge,
.vendor-badge {
  display: inline-flex;
  align-items: center;
  gap: var(--space-2);
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
}
.agency-icon {
  width: 1.5rem;
  height: 1.5rem;
  border-radius: 50%;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--font-xs);
  font-weight: 600;
  flex-shrink: 0;
}
.office-icon {
  width: 1.5rem;
  height: 1.5rem;
  border-radius: var(--radius-sm);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--font-xs);
  font-weight: 600;
  flex-shrink: 0;
}
.vendor-icon {
  width: 1.5rem;
  height: 1.5rem;
  border-radius: 0;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--font-xs);
  font-weight: 600;
  flex-shrink: 0;
}
.badge {
  padding: var(--space-1) var(--space-2);
  border-radius: var(--radius-sm);
  font-size: var(--font-xs);
  font-weight: 500;
  display: inline-block;
}
.badge-primary {
  background-color: rgba(0, 112, 243, 0.1);
  color: var(--primary);
}
/* Chart Tooltip */
.chart-tooltip {
  position: absolute;
  display: none;
  background-color: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: var(--space-3);
  box-shadow: var(--shadow-md);
  pointer-events: none;
  z-index: 100;
  max-width: 250px;
}
/* Selection Indicator */
.selection-indicator {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: var(--primary);
  display: none;
}
/* Loading & States */
.loading-state, .empty-state, .error-message {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--space-8);
  text-align: center;
  margin: var(--space-4) 0;
  width: 100%;
}
.loading-state, .empty-state {
  background-color: transparent;
}
.error-message {
  background-color: rgba(255, 59, 48, 0.1);
  color: var(--danger);
  border: 1px solid var(--danger);
  border-radius: var(--radius-md);
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}
[data-theme="dark"] .error-message {
  background-color: rgba(255, 69, 58, 0.15);
}
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--border);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: var(--space-4);
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
/* Modal */
.modal-backdrop {
  background-color: rgba(0, 0, 0, 0.7);
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  visibility: hidden;
  opacity: 0;
  transition: visibility 0s linear 0.3s, opacity 0.3s ease;
}
.modal-backdrop.active {
  visibility: visible;
  opacity: 1;
  transition-delay: 0s;
}
.modal {
  background-color: var(--bg-primary);
  border-radius: var(--radius-lg);
  width: 90%;
  max-width: 700px;
  max-height: 90vh;
  overflow: auto;
  box-shadow: var(--shadow-lg);
  transform: translateY(0) scale(1);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.modal-backdrop:not(.active) .modal {
  transform: translateY(20px) scale(0.98);
  opacity: 0;
}
.modal-header {
  padding: var(--space-6);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-title {
  font-size: var(--font-2xl);
  font-weight: 600;
}
.modal-close {
  background: none;
  border: none;
  font-size: var(--font-xl);
  color: var(--text-secondary);
  cursor: pointer;
}
.modal-body {
  padding: var(--space-6);
}
.modal-footer {
  padding: var(--space-4) var(--space-6);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
}
/* Mobile Action Button */
.mobile-action-btn {
  position: fixed;
  bottom: var(--space-6);
  right: var(--space-6);
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: var(--primary);
  color: white;
  border: none;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--font-2xl);
  cursor: pointer;
  z-index: 900;
  transition: var(--transition);
}
.mobile-action-btn:hover {
  background-color: var(--primary-dark);
  transform: scale(1.08);
}
/* Header Placeholder */
.header-placeholder {
  display: none;
  height: var(--header-height-mobile);
}
/* Content Wrapper - Critical for footer integration */
.content-wrapper {
  background-color: var(--bg-primary);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  margin-top: var(--space-6);
  overflow: hidden;
}
.content-wrapper > section {
  margin: 0;
  padding: var(--space-6);
}
/* Footer Styling */
.app-footer {
  display: none;
}
.footer-container {
  max-width: 1600px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--space-6);
  background: none;
  border-top: none;
}
.footer-section {
  padding: var(--space-4);
}
.footer-section h3 {
  font-size: var(--font-lg);
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-4);
  padding-bottom: var(--space-2);
  border-bottom: 2px solid var(--primary);
  display: inline-block;
}
.footer-section p {
  color: var(--text-secondary);
  margin-bottom: var(--space-3);
  font-size: var(--font-sm);
  line-height: 1.6;
}
.footer-links {
  list-style: none;
  padding: 0;
  margin: 0;
}
.footer-links li {
  margin-bottom: var(--space-2);
}
.footer-links a {
  color: var(--primary);
  text-decoration: none;
  font-size: var(--font-sm);
  display: inline-flex;
  align-items: center;
  transition: var(--transition);
}
.footer-links a:hover {
  color: var(--primary-dark);
  text-decoration: underline;
}
.footer-links a i {
  margin-right: var(--space-2);
  font-size: 14px;
}
.connect-card {
  display: flex;
  background-color: var(--bg-secondary);
  border-radius: var(--radius-lg);
  padding: var(--space-4);
  margin-bottom: var(--space-4);
  align-items: center;
  box-shadow: var(--shadow);
}
.connect-avatar {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  overflow: hidden;
  margin-right: var(--space-4);
  flex-shrink: 0;
  background-color: var(--bg-tertiary);
  border: 2px solid var(--primary);
}
.connect-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.connect-info {
  flex: 1;
}
.connect-info h4 {
  font-size: var(--font-base);
  font-weight: 600;
  margin-bottom: var(--space-1);
  color: var(--text-primary);
}
.connect-info p {
  font-size: var(--font-xs);
  margin-bottom: var(--space-2);
}
.connect-buttons {
  display: flex;
  gap: var(--space-2);
}
.connect-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background-color: var(--bg-tertiary);
  color: var(--text-primary);
  border-radius: var(--radius);
  padding: var(--space-1) var(--space-2);
  font-size: var(--font-xs);
  transition: var(--transition);
  border: none;
  cursor: pointer;
  text-decoration: none;
}
.connect-button:hover {
  background-color: var(--primary);
  color: white;
}
.connect-button i {
  margin-right: var(--space-1);
}
.how-to-steps {
  counter-reset: step-counter;
  list-style: none;
  padding: 0;
  margin: 0;
}
.how-to-steps li {
  position: relative;
  padding-left: 35px;
  margin-bottom: var(--space-4);
}
.how-to-steps li::before {
  content: counter(step-counter);
  counter-increment: step-counter;
  position: absolute;
  left: 0;
  top: 0;
  width: 24px;
  height: 24px;
  background-color: var(--primary);
  color: white;
  font-size: var(--font-xs);
  font-weight: 600;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.how-to-steps h4 {
  font-size: var(--font-base);
  font-weight: 600;
  margin-bottom: var(--space-1);
  color: var(--text-primary);
}
.copyright {
  text-align: center;
  padding-top: var(--space-6);
  border-top: 1px solid var(--border);
  color: var(--text-tertiary);
  font-size: var(--font-xs);
  margin-top: var(--space-6);
}
/* Integrated Footer */
.integrated-footer {
  border-top: 1px solid var(--border);
  background: none;
  box-shadow: none;
  margin-top: 0;
}
/* Media Queries */
@media (max-width: 767px) {
  /* Mobile Header */
  .app-header {
    height: var(--header-height-mobile);
    overflow: hidden;
    padding: var(--space-2) var(--space-3);
  }
  .app-header.expanded {
    height: auto;
    overflow: visible;
    box-shadow: var(--shadow-lg);
  }
  .app-header:not(.expanded) .header-content,
  .app-header:not(.expanded) .logo-subtitle {
    display: none !important;
  }
  .header-toggle-btn {
    display: block;
    top: 50%;
    transform: translateY(-50%);
    right: var(--space-4);
  }
  .header-main-content-row {
    padding-right: 40px;
    margin-bottom: 0;
  }
  .header-main-content-row .header-actions {
    position: absolute;
    top: calc(var(--space-3) - var(--space-1));
    right: var(--space-3);
  }
  .header-main-content-row .logo-container {
    padding-right: 50px;
  }
  .logo-main-line {
    height: var(--header-height-mobile);
    align-items: center;
  }
  .logo-main-line > i,
  .logo-main-line > span {
    font-size: var(--font-2xl);
  }
  .logo-subtitle {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.65rem;
    margin-top: var(--space-1);
  }
  .toggle-item {
    width: 2.5em;
    height: 1.25em;
    vertical-align: middle;
    display: inline-flex;
    align-items: center;
    justify-content: flex-start;
  }
  .toggle-item:before {
    width: 1em;
    height: 1em;
    position: relative;
    top: 0;
    margin: 0;
  }
  #color-scheme:checked + .toggle-item:before {
    transform: translateX(1.15em);
  }
  /* Header Placeholder */
  .header-placeholder.visible {
    display: block;
  }
  /* Fixed Header */
  .app-header.fixed {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 200;
  }
  /* Dashboard */
  main#dashboard {
    padding: var(--space-4) var(--space-3);
    gap: var(--space-4);
  }
  /* Buttons and Controls */
  .status-and-active-filters .status-title {
    font-size: var(--font-xl);
  }
  .data-load-controls .example-csv-buttons {
    justify-content: center;
  }
  .data-load-controls .example-csv-buttons .btn {
    min-width: 100px;
  }
  .filter-actions {
    justify-content: center;
  }
  .filter-actions .btn {
    flex-grow: 1;
    max-width: 180px;
  }
  /* Stats and Charts */
  .stats-row {
    gap: var(--space-3);
  }
  .stat-card {
    padding: var(--space-3);
  }
  .stat-value {
    font-size: var(--font-3xl);
  }
  .stat-company {
    font-size: var(--font-xl);
  }
  .primary-viz, .charts-grid-container, .tables-section-container {
    padding: var(--space-4);
  }
  .charts-grid {
    gap: var(--space-4);
    grid-template-columns: 1fr;
  }
  .sankey-chart-container {
    height: 280px;
  }
  .chart-container, .bubble-chart-container {
    height: 220px;
  }
  /* Primary Viz Container */
  .primary-viz-container {
    flex-direction: column;
    height: auto;
  }
  .sankey-wrapper, .month-chart-wrapper {
    width: 100%;
  }
  .sankey-wrapper {
    height: 280px;
  }
  .month-chart-wrapper .chart-container {
    height: 220px;
  }
  /* Table Responsive */
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  .data-table {
    min-width: 800px;
  }
  /* Mobile Action Button */
  .mobile-action-btn {
    display: none !important;
  }
}
@media (min-width: 768px) {
  /* Header */
  .app-header {
    padding: var(--space-4) var(--space-6);
    gap: var(--space-4);
    position: sticky;
    top: 0;
  }
  .header-main-content-row .header-actions {
    position: static;
    padding-top: 0;
  }
  .header-main-content-row .logo-container {
    padding-right: 0;
  }
  .logo-subtitle {
    display: block;
    -webkit-line-clamp: unset;
    font-size: var(--font-sm);
  }
  /* Controls */
  .primary-controls-area {
    flex-direction: row;
    align-items: flex-end;
    gap: var(--space-4);
  }
  .main-filter-inputs {
    flex-grow: 1;
    flex-direction: row;
    gap: var(--space-3);
    align-items: flex-end;
  }
  .main-filter-inputs > .search-bar {
    flex: 2 1 280px;
    width: auto;
  }
  .main-filter-inputs > .filter-group {
    flex: 1 1 200px;
    width: auto;
  }
  .filter-actions {
    justify-content: flex-end;
    flex-shrink: 0;
  }
  /* Grids */
  .filters-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .stats-row {
    grid-template-columns: repeat(2, 1fr);
  }
  .charts-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  /* Charts */
  .sankey-chart-container {
    height: 400px;
  }
  /* Footer */
  .footer-container {
    grid-template-columns: repeat(2, 1fr);
  }
  /* Mobile Elements */
  .mobile-action-btn {
    display: none;
  }
}
@media (min-width: 1024px) {
  .stats-row {
    grid-template-columns: repeat(4, 1fr);
  }
  .footer-container {
    grid-template-columns: repeat(3, 1fr);
  }
}
@media (min-width: 1280px) {
  .app-header {
    padding: var(--space-6) var(--space-8);
  }
  main#dashboard {
    padding: var(--space-8);
    gap: var(--space-8);
  }
  .main-filter-inputs > .search-bar {
    flex-basis: 350px;
  }
  .main-filter-inputs > .filter-group {
    flex-basis: 220px;
  }
  .filters-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  .charts-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  .primary-viz, .charts-grid-container, .tables-section-container {
    padding: var(--space-8);
  }
}
/* Charts Grid with proper sizing - 1/4, 1/4, 1/2 distribution */
.charts-grid {
  display: grid;
  width: 100%;
  gap: var(--space-6);
}
/* For desktop and larger screens */
@media (min-width: 768px) {
  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 2fr;
    gap: var(--space-6);
  }
  /* First chart - Top Agencies (1/4) */
  .chart-item:nth-child(1) {
    grid-column: 1;
  }
  /* Second chart - Top Vendors (1/4) */
  .chart-item:nth-child(2) {
    grid-column: 2;
  }
  /* Third chart - NAICS Distribution (1/2) */
  .chart-item:nth-child(3) {
    grid-column: 3;
  }
}
/* For smaller screens, stack them */
@media (max-width: 767px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
  .chart-item {
    grid-column: 1;
  }
}
/* Charts Grid with proper sizing - 1/4, 1/4, 1/2 distribution */
.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 2fr;
  gap: var(--space-6);
  width: 100%;
}
/* Ensure consistent height for all chart containers */
.chart-container, .bubble-chart-container {
  height: 280px;
}
/* Specific adjustments for the bubble chart */
#naicsBubbleChartContainer {
  height: 290px;
  padding-bottom: 0px; /* Add padding at the bottom for x-axis alignment */
}
/* Adjust chart layout options in JS */
.charts-grid .chart-item:nth-child(3) {
  display: flex;
  flex-direction: column;
}
.charts-grid .chart-item:nth-child(3) h3 {
  margin-bottom: 10px; /* Ensure consistent title spacing */
}
/* For mobile screens */
@media (max-width: 767px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
  .chart-container, .bubble-chart-container {
    height: 220px;
  }
}
@media (max-width: 767px) {
  .search-bar-container {
    position: fixed;
    top: var(--header-height-mobile);
    left: 0;
    right: 0;
    z-index: 95;
    background-color: var(--bg-secondary);
    padding: var(--space-2) var(--space-3);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: var(--transition);
    display: flex;
    max-width: 1600px;
    margin: 0 auto;
    box-sizing: border-box;
    width: 100%;
    transform: translateX(0);
  }
  .search-bar-container .search-bar {
    width: 100%;
    position: relative;
  }
  .search-bar-container .search-input {
    width: 100%;
    border-radius: var(--radius-md);
    background-color: var(--bg-primary);
    padding: var(--space-3) var(--space-4);
    font-size: var(--font-sm);
    height: 40px;
    border: 1px solid var(--border);
    box-sizing: border-box;
  }
  /* Hide the original search bar in header */
  .app-header .search-bar {
    display: none !important;
  }
  /* Add padding to dashboard to account for sticky search */
  main#dashboard {
    padding-top: calc(var(--space-4) + 44px);
  }
  /* Handle scrolling behavior - hide on scroll down, show on scroll up */
  .search-bar-container.hidden {
    transform: translateY(-100%);
  }
  /* Fix for the right-shift issue */
  .app-container,
  .app-header,
  main#dashboard,
  .search-bar-container,
  .header-main-content-row,
  .header-content,
  .primary-viz-row,
  .charts-grid-container,
  .tables-section-container,
  .content-wrapper {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    margin-left: 0;
    margin-right: 0;
    transform: translateX(0);
  }
}
/* Fix for double search bars on desktop */
@media (min-width: 768px) {
  /* Completely hide mobile search on desktop */
  .search-bar-container {
    display: none !important;
  }
}
/* Keep the mobile search only on mobile */
@media (max-width: 767px) {
  .search-bar-container {
    display: flex;
    position: fixed;
    top: var(--header-height-mobile);
    left: 0;
    right: 0;
    z-index: 95;
    background-color: var(--bg-secondary);
    padding: var(--space-2) var(--space-3);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: var(--transition);
    max-width: 1600px;
    margin: 0 auto;
    box-sizing: border-box;
    width: 100%;
    transform: translateX(0);
  }
  /* Hide the original search bar in header */
  .app-header .search-bar {
    display: none !important;
  }
}
/* Reduce overall dashboard spacing */
main#dashboard {
  gap: var(--space-3) !important; /* Reduce from --space-6 to --space-3 */
  padding: var(--space-4) var(--space-4) !important; /* Reduce top/bottom padding */
}

/* Reduce header padding */
.app-header {
  padding: var(--space-3) var(--space-6) !important; /* Reduce vertical padding */
  gap: var(--space-2) !important; /* Reduce gap between header elements */
}

/* Reduce stats section margins */
.stats-section {
  margin-bottom: var(--space-3) !important; /* Reduce bottom margin */
}

.stats-row {
  gap: var(--space-2) !important; /* Reduce gap between stat cards */
}

.stat-card {
  padding: var(--space-3) !important; /* Reduce card padding */
}

/* Reduce primary viz section spacing */
.primary-viz-row {
  margin-bottom: var(--space-3) !important; /* Reduce bottom margin */
  padding: var(--space-4) !important; /* Reduce internal padding */
}

.dashboard-section-header {
  margin-bottom: var(--space-2) !important; /* Reduce bottom margin */
  padding-bottom: var(--space-2) !important; /* Reduce bottom padding */
}

/* Reduce charts grid container spacing */
.charts-grid-container {
  padding: var(--space-4) !important; /* Reduce padding */
  margin-bottom: var(--space-3) !important; /* Reduce bottom margin */
}

.charts-grid {
  gap: var(--space-4) !important; /* Reduce gap between charts */
}

/* Reduce content wrapper margins */
.content-wrapper {
  margin-top: var(--space-3) !important; /* Reduce top margin */
}

/* Reduce tables section padding */
.tables-section-container {
  padding: var(--space-4) !important; /* Reduce padding */
}

/* Reduce primary viz container spacing */
.primary-viz-container {
  gap: var(--space-3) !important; /* Reduce gap between sankey and time chart */
}

/* Reduce status and filters spacing */
.status-and-active-filters {
  gap: var(--space-2) !important; /* Reduce gap */
  padding: var(--space-2) 0 !important; /* Reduce padding */
  margin-bottom: var(--space-2) !important; /* Reduce bottom margin */
}

/* Reduce primary controls spacing */
.primary-controls-area {
  gap: var(--space-2) !important; /* Reduce gap */
}

/* Reduce main filter inputs spacing */
.main-filter-inputs {
  gap: var(--space-2) !important; /* Reduce gap between filter elements */
}

/* Reduce advanced filters panel spacing */
#advancedFiltersPanel {
  margin-top: var(--space-2) !important; /* Reduce top margin */
  padding: var(--space-4) !important; /* Reduce padding */
}

.filters-grid {
  gap: var(--space-3) !important; /* Reduce gap between filter items */
}

/* Reduce chart title spacing */
.chart-title-integrated {
  margin-bottom: var(--space-1) !important; /* Reduce bottom margin */
}

/* Reduce tab spacing */
.tables-section .tabs {
  margin-bottom: var(--space-2) !important; /* Reduce bottom margin */
}

/* Mobile specific reductions */
@media (max-width: 767px) {
  main#dashboard {
    padding: var(--space-3) var(--space-3) !important; /* Further reduce on mobile */
    gap: var(--space-2) !important; /* Further reduce gaps on mobile */
  }
  
  .stats-row {
    gap: var(--space-2) !important; /* Reduce gap between stat cards on mobile */
  }
  
  .primary-viz-row {
    padding: var(--space-3) !important; /* Reduce padding on mobile */
  }
  
  .charts-grid-container {
    padding: var(--space-3) !important; /* Reduce padding on mobile */
  }
  
  .tables-section-container {
    padding: var(--space-3) !important; /* Reduce padding on mobile */
  }
}

/* Desktop specific adjustments */
@media (min-width: 768px) {
  .app-header {
    padding: var(--space-4) var(--space-6) !important; /* Slightly more padding on desktop */
  }
}

/* Hide the status box completely */
.status-and-active-filters,
#statusBox {
  display: none !important;
}

/* Alternative: Make it invisible but keep layout space */
/*
.status-and-active-filters,
#statusBox {
  visibility: hidden !important;
}
*/

/* Alternative: Move it off-screen (for screen readers) */
/*
.status-and-active-filters,
#statusBox {
  position: absolute !important;
  left: -9999px !important;
  top: -9999px !important;
}
*/
/* Add small vertical gap between load controls and primary controls */
.data-load-controls {
  margin-bottom: var(--space-4) !important; /* Adds gap after load controls */
}

/* Alternative: Add gap before primary controls */
.primary-controls-area {
  margin-top: var(--space-4) !important; /* Adds gap before primary controls */
}

/* For smaller gap, use --space-3 instead */
/*
.data-load-controls {
  margin-bottom: var(--space-3) !important;
}
*/

/* For larger gap, use --space-6 instead */
/*
.data-load-controls {
  margin-bottom: var(--space-6) !important;
}
*/

/* Mobile specific - smaller gap on mobile */
@media (max-width: 767px) {
  .data-load-controls {
    margin-bottom: var(--space-3) !important;
  }
}
/* Complete reset of mobile search positioning */
@media (max-width: 767px) {
  /* Hide the original search in header completely */
  .app-header .search-bar,
  .header-content .search-bar {
    display: none !important;
  }
  
  /* Remove any existing mobile search containers */
  .search-bar-container {
    display: none !important;
  }
  
  /* Position the new search bar fixed at the top */
  .mobile-search-fixed {
    position: fixed;
    top: var(--header-height-mobile);
    left: 0;
    right: 0;
    z-index: 999; /* Higher than other elements */
    background-color: var(--bg-primary);
    padding: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    width: 100%;
  }
  
  .mobile-search-fixed .search-input {
    width: 100%;
    height: 36px;
    border-radius: 4px;
    padding: 0 12px;
    border: 1px solid var(--border);
    background-color: var(--bg-secondary);
  }
  
  /* Add proper spacing to dashboard content */
  main#dashboard {
    padding-top: 100px !important; /* Fixed value to ensure enough space */
  }
  
  /* Hide potentially interfering elements */
  .header-main-content-row .search-bar,
  .primary-controls-area .search-bar {
    display: none !important;
  }
  
  /* Ensure stats cards display properly */
  .stats-section {
    margin-top: 10px;
  }
}
/* Complete reset of mobile search positioning */
@media (max-width: 767px) {
  /* Hide the original search in header completely */
  .app-header .search-bar,
  .header-content .search-bar {
    display: none !important;
  }
  
  /* Remove any existing mobile search containers */
  .search-bar-container {
    display: none !important;
  }
  
  /* Position the new search bar fixed at the top */
  .mobile-search-fixed {
    position: fixed;
    top: var(--header-height-mobile);
    left: 0;
    right: 0;
    z-index: 999; /* Higher than other elements */
    background-color: var(--bg-primary);
    padding: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    width: 100%;
    display: block; /* Ensure it's visible on mobile */
  }
  
  .mobile-search-fixed .search-input {
    width: 100%;
    height: 36px;
    border-radius: 4px;
    padding: 0 12px;
    border: 1px solid var(--border);
    background-color: var(--bg-secondary);
  }
  
  /* Add proper spacing to dashboard content */
  main#dashboard {
    padding-top: 100px !important; /* Fixed value to ensure enough space */
  }
  
  /* Hide potentially interfering elements */
  .header-main-content-row .search-bar,
  .primary-controls-area .search-bar {
    display: none !important;
  }
  
  /* Ensure stats cards display properly */
  .stats-section {
    margin-top: 10px;
  }
}

/* IMPORTANT: Completely hide mobile search on desktop */
@media (min-width: 768px) {
  .mobile-search-fixed {
    display: none !important; /* Force hide on desktop */
  }
  
  /* Make sure the original search bar is visible on desktop */
  .app-header .search-bar,
  .header-content .search-bar,
  .primary-controls-area .search-bar {
    display: block !important;
  }
}
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Placeholder for header height when header is fixed -->
    <div class="header-placeholder"></div>
    <header class="app-header">
        <!-- Mobile header toggle button -->
        <button class="header-toggle-btn" id="headerToggleBtn">
            <i class="fas fa-caret-down"></i>
        </button>
        <div class="header-main-content-row">
            <!-- Logo on the left -->
            <div class="logo-container">
                <div class="logo-main-line">
                    <i class="fa-regular fa-newspaper"></i>
                    <span>Post Award</span>
                </div>
                <span class="logo-subtitle">
                    A Free Do Your Own Research Tool
                </span>
            </div>
            <!-- Theme toggle on the right -->
            <div class="header-actions">
                <input id="color-scheme" type="checkbox" aria-hidden />
                <label class="toggle-item" for="color-scheme"></label>
            </div>
        </div>
        <!-- Rest of the header content -->
        <div class="header-content">
            <div class="data-load-controls example-csv-loader">
                <div class="example-csv-buttons">
                    <button id="loadExample1" class="btn btn-secondary"><span class="btn-text">YTD > $100K</span></button>
					 <button id="loadExample4" class="btn btn-primary"><span class="btn-text">VMware</span></button>
                    <button id="loadExample2" class="btn btn-secondary"><span class="btn-text">SaaS 3YR</span></button>
                    <input type="file" id="csvFile" accept=".csv,.xls" class="file-input" style="display: none;">
                    <label for="csvFile" class="btn btn-secondary"><i class="fas fa-upload mr-2"></i>
                        <span class="btn-text">Upload fpds.gov CSV</span>
                    </label>
            </div>
            <div class="status-and-active-filters" id="statusBox">
                <div class="status-title">No data loaded</div>
                <div id="activeFilters" class="active-filters">
                </div>
            </div>
            <div class="primary-controls-area">
                <div class="main-filter-inputs">
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Search contracts, agencies, vendors..." class="search-input">
                    </div>
                    <div class="filter-group">
                        <select id="agencyFilter" class="filter-select" aria-label="Filter by agency">
                            <option value="">All Agencies</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select id="vendorFilter" class="filter-select" aria-label="Filter by vendor">
                            <option value="">All Vendors</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select id="pscFilter" class="filter-select" aria-label="Filter by PSC">
                            <option value="">Any PSC</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button id="resetFilters" class="btn btn-secondary">
                        <i class="fas fa-undo"></i>
                        <span class="btn-text">Reset</span>
                    </button>
                    <button id="moreFiltersBtn" class="btn btn-secondary">
                        <i class="fas fa-sliders-h"></i>
                        <span class="btn-text">More Filters</span>
                    </button>
                </div>
            </div>
            <section id="advancedFiltersPanel" class="filters-panel">
                <div class="panel-header">
                    <h3>Advanced Filters</h3>
                    <button id="closeFilters" class="btn-icon" aria-label="Close advanced filters">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="startDate" class="filter-label"></label> 
                        <div class="date-range-picker" id="dateRangeLabel">
                            <input type="date" id="startDate" class="filter-date" aria-label="Start date">
                            <span class="date-separator">to</span>
                            <input type="date" id="endDate" class="filter-date" aria-label="End date">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="officeFilter" class="filter-label"></label> 
                        <select id="officeFilter" class="filter-select" aria-label="Filter by contracting office">
                            <option value="">Any Office</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="naicsFilter" class="filter-label"></label> 
                        <select id="naicsFilter" class="filter-select" aria-label="Filter by NAICS code">
                            <option value="">Any NAICS</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="valueFilter" class="filter-label"></label> 
                        <select id="valueFilter" class="filter-select" aria-label="Filter by action obligation value">
                            <option value="">Any Value</option>
                            <option value="0-100000">Under $100K</option>
                            <option value="100000-500000">$100K - $500K</option>
                            <option value="500000-1000000">$500K - $1M</option>
                            <option value="1000000-5000000">$1M - $5M</option>
                            <option value="5000000-10000000">$5M - $10M</option>
                            <option value="10000000-999999999999">Over $10M</option>
                        </select>
                    </div>
                </div>
            </section>
        </div>
    </header> 
	<!-- Mobile-only fixed search bar -->
<div class="mobile-search-fixed" id="mobileSearchFixed">
  <input type="text" class="search-input" placeholder="Search contracts, agencies, vendors..." id="mobileSearchInput">
</div>

<script>
  // Sync the mobile search with the main search
  document.addEventListener('DOMContentLoaded', function() {
    const mobileSearch = document.getElementById('mobileSearchInput');
    const mainSearch = document.getElementById('searchInput');
    
    if (mobileSearch && mainSearch) {
      // Sync input values both ways
      mobileSearch.addEventListener('input', function() {
        mainSearch.value = this.value;
        // Trigger the search functionality
        const event = new Event('input', { bubbles: true });
        mainSearch.dispatchEvent(event);
      });
    }
  });
</script>
    <div id="loadingIndicator" class="loading-state" style="display: none;">
        <div class="loading-spinner"></div>
        <div>Loading and processing contract data...</div>
    </div>
    <div id="errorMessage" class="error-message" style="display: none;">
    </div>
    <div id="noDataMessage" class="empty-state">
        <i class="fas fa-file-upload"></i>
        <h2>No Contract Data Loaded</h2>
        <p>Upload a CSV file from an FPDS.gov Search Result.</p>
    </div>
    <main id="dashboard" style="display: none;">
	<!-- Federal Sales Insights Panel -->
<section class="insights-panel" style="margin-bottom: var(--space-4);">
  <div class="primary-viz-row" style="margin-bottom: var(--space-3);">
    <div class="dashboard-section-header" style="display:flex; justify-content: space-between; align-items:center;">
      <span>Federal Sales Insights</span>
      <div class="insights-controls">
        <button id="refreshInsights" class="btn btn-sm btn-secondary"><i class="fas fa-sync-alt"></i><span class="btn-text">Refresh</span></button>
      </div>
    </div>
    <div class="insights-container">
      <!-- Insights Header with Date -->
      <div class="insights-header" style="display: flex; justify-content: space-between; margin-bottom: var(--space-3);">
        <div class="insights-title">
          <h3 style="margin: 0; font-size: var(--font-xl); font-weight: 600; color: var(--text-primary);">
            Actionable Insights
          </h3>
          <p style="margin: 0; font-size: var(--font-sm); color: var(--text-secondary);">
            Based on your filtered contract data
          </p>
        </div>
        <div class="current-date" style="text-align: right; font-size: var(--font-sm); color: var(--text-secondary);">
          <!-- Current date populated by JS -->
        </div>
      </div>
      
      <!-- Main Insights Grid -->
      <div class="insights-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-4);">
        <!-- Spending Trends Card -->
        <div class="insight-card" style="background-color: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--space-4); box-shadow: var(--shadow);">
          <div style="display: flex; align-items: center; margin-bottom: var(--space-3);">
            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: var(--space-3);">
              <i class="fas fa-chart-line" style="color: white; font-size: var(--font-lg);"></i>
            </div>
            <h4 style="margin: 0; font-size: var(--font-lg); font-weight: 600; color: var(--text-primary);">Spending Trends</h4>
          </div>
          <div class="insight-content" id="spending-trends-content">
            <p style="margin-bottom: var(--space-2);">
              <span id="trend-message">Analyzing spending patterns...</span>
            </p>
            <ul style="padding-left: var(--space-4); margin-bottom: 0;">
              <li id="trend-point-1" style="margin-bottom: var(--space-2);">Peak buying month: <strong>September</strong></li>
              <li id="trend-point-2" style="margin-bottom: var(--space-2);">Q4 accounts for <strong>38%</strong> of annual spend</li>
              <li id="trend-point-3">Month-over-month growth: <strong>+12%</strong></li>
            </ul>
          </div>
        </div>
        
        <!-- Vendor Opportunities Card -->
        <div class="insight-card" style="background-color: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--space-4); box-shadow: var(--shadow);">
          <div style="display: flex; align-items: center; margin-bottom: var(--space-3);">
            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: var(--success); display: flex; align-items: center; justify-content: center; margin-right: var(--space-3);">
              <i class="fas fa-handshake" style="color: white; font-size: var(--font-lg);"></i>
            </div>
            <h4 style="margin: 0; font-size: var(--font-lg); font-weight: 600; color: var(--text-primary);">Vendor Opportunities</h4>
          </div>
          <div class="insight-content" id="vendor-opportunities-content">
            <p style="margin-bottom: var(--space-2);">
              <span id="vendor-message">Top vendor opportunities:</span>
            </p>
            <ul style="padding-left: var(--space-4); margin-bottom: 0;">
              <li id="vendor-point-1" style="margin-bottom: var(--space-2);"><strong>VMware</strong> has renewed contracts with <strong>5</strong> agencies</li>
              <li id="vendor-point-2" style="margin-bottom: var(--space-2);">Multi-year SaaS contracts expiring in <strong>Q3</strong></li>
              <li id="vendor-point-3">Subcontracting with <strong>top 3 primes</strong> can unlock <strong>$12.5M</strong></li>
            </ul>
          </div>
        </div>
        
        <!-- Agency Intelligence Card -->
        <div class="insight-card" style="background-color: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--space-4); box-shadow: var(--shadow);">
          <div style="display: flex; align-items: center; margin-bottom: var(--space-3);">
            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: var(--warning); display: flex; align-items: center; justify-content: center; margin-right: var(--space-3);">
              <i class="fas fa-building" style="color: white; font-size: var(--font-lg);"></i>
            </div>
            <h4 style="margin: 0; font-size: var(--font-lg); font-weight: 600; color: var(--text-primary);">Agency Intelligence</h4>
          </div>
          <div class="insight-content" id="agency-intelligence-content">
            <p style="margin-bottom: var(--space-2);">
              <span id="agency-message">Agency buying patterns:</span>
            </p>
            <ul style="padding-left: var(--space-4); margin-bottom: 0;">
              <li id="agency-point-1" style="margin-bottom: var(--space-2);"><strong>DOD</strong> prioritizing cloud security contracts</li>
              <li id="agency-point-2" style="margin-bottom: var(--space-2);"><strong>HHS</strong> increasing spend on data analytics by <strong>22%</strong></li>
              <li id="agency-point-3">Agencies with most frequent buys: <strong>DHS, VA, GSA</strong></li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Recommendations Section -->
      <div class="recommendations-section" style="background-color: var(--bg-primary); border-radius: var(--radius-lg); padding: var(--space-4); box-shadow: var(--shadow);">
        <h4 style="margin-top: 0; margin-bottom: var(--space-3); font-size: var(--font-lg); font-weight: 600; color: var(--primary); display: flex; align-items: center;">
          <i class="fas fa-lightbulb" style="margin-right: var(--space-2); color: var(--primary);"></i>
          Recommended Actions
        </h4>
        <div class="recommendations-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-3);">
          <!-- Recommendation 1 -->
          <div class="recommendation-item" id="recommendation-1" style="padding: var(--space-3); background-color: var(--bg-secondary); border-left: 3px solid var(--primary); border-radius: var(--radius); display: flex; align-items: flex-start;">
            <div style="min-width: 24px; margin-right: var(--space-2); color: var(--primary);">1</div>
            <div>
              <p style="margin: 0; font-weight: 500;">Engage contracting officers at <strong>GSA</strong> for upcoming SaaS renewals</p>
            </div>
          </div>
          
          <!-- Recommendation 2 -->
          <div class="recommendation-item" id="recommendation-2" style="padding: var(--space-3); background-color: var(--bg-secondary); border-left: 3px solid var(--primary); border-radius: var(--radius); display: flex; align-items: flex-start;">
            <div style="min-width: 24px; margin-right: var(--space-2); color: var(--primary);">2</div>
            <div>
              <p style="margin: 0; font-weight: 500;">Focus on <strong>DOD offices</strong> with highest propensity to buy in Q3</p>
            </div>
          </div>
          
          <!-- Recommendation 3 -->
          <div class="recommendation-item" id="recommendation-3" style="padding: var(--space-3); background-color: var(--bg-secondary); border-left: 3px solid var(--primary); border-radius: var(--radius); display: flex; align-items: flex-start;">
            <div style="min-width: 24px; margin-right: var(--space-2); color: var(--primary);">3</div>
            <div>
              <p style="margin: 0; font-weight: 500;">Target subcontracting opportunities with <strong>top VMware resellers</strong></p>
            </div>
          </div>
          
          <!-- Recommendation 4 -->
          <div class="recommendation-item" id="recommendation-4" style="padding: var(--space-3); background-color: var(--bg-secondary); border-left: 3px solid var(--primary); border-radius: var(--radius); display: flex; align-items: flex-start;">
            <div style="min-width: 24px; margin-right: var(--space-2); color: var(--primary);">4</div>
            <div>
              <p style="margin: 0; font-weight: 500;">Prepare for federal fiscal year-end spending in <strong>August-September</strong></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
	<!-- Mobile Persistent Search Bar -->
<div class="search-bar-container">
  <div class="search-bar" style="position: relative; width: 100%;">
    <input type="text" id="mobileSearchInput" placeholder="Search contracts, agencies, vendors..." class="search-input">
  </div>
</div>

      <!-- First row: Sankey (2/3) and Value by Month (1/3) -->
      <section class="primary-viz-row">
        <div class="dashboard-section-header" style="display:flex; justify-content: space-between; align-items:center;">
          <span>Award Flow & Monthly Buying Trends</span>  
          <div class="sankey-controls">
            <button id="sankeyTop10" class="btn btn-sm btn-primary"><span class="btn-text">Top 10</span></button>
            <button id="sankeyTop25" class="btn btn-sm btn-secondary"><span class="btn-text">Top 25</span></button>
            <button id="sankeyAll" class="btn btn-sm btn-secondary"><span class="btn-text">All</span></button>
          </div>
        </div>
		<div class="welcome-message">-</div></br>
        <div class="primary-viz-container">
          <div class="sankey-wrapper">
            <div class="sankey-chart-container" id="sankeyChartContainer">
              <div id="sankeyTooltip" class="chart-tooltip"></div>
            </div>
          </div>
          <div class="month-chart-wrapper">
            <h3 class="chart-title-integrated">Award Value by Month</h3>
            <div class="chart-container" id="valueTimeChartContainer">
              <canvas id="valueTimeChart"></canvas>
              <div class="selection-indicator"></div>
            </div>
          </div>
        </div>
      </section>
	   <!-- Stats Cards in Container -->
<section class="stats-section">
  <div class="stats-row">
      <div class="stat-card">
      <p class="stat-label"">Contract Value</p>
      <div class="stat-value" id="stat-value">-</div>
    </div>
    <div class="stat-card">
      <p class="stat-label">Total Awards</p>
      <div class="stat-value" id="stat-contracts">-</div>
    </div>
    <div class="stat-card">
      <p class="stat-label"">Companies</p>
      <div class="stat-value" id="stat-companies">-</div>
    </div>
		<div class="stat-card">
      <p class="stat-label"">Market Leader</p>
      <div class="stat-company" id="stat-top-company">-</div>
    </div>
  </div>
</section>
      <!-- Second row: Three equal charts -->
      <section class="charts-grid-container">
        <h2 class="dashboard-section-header">Visualizations</h2>
        <div class="charts-grid">
          <div class="chart-item">
            <h3 class="chart-title-integrated">Top Agencies</h3>
            <div class="chart-container" id="agencyChartContainer">
              <canvas id="agencyChart"></canvas>
              <div class="selection-indicator"></div>
            </div>
          </div>
          <div class="chart-item">
            <h3 class="chart-title-integrated">Top Vendors</h3>
            <div class="chart-container" id="vendorChartContainer">
              <canvas id="vendorChart"></canvas>
              <div class="selection-indicator"></div>
            </div>
          </div>
          <div class="chart-item">
            <h3 class="chart-title-integrated">NAICS Distribution</h3>
            <div class="bubble-chart-container" id="naicsBubbleChartContainer">
              <canvas id="naicsBubbleChart"></canvas>
              <div class="selection-indicator"></div>
            </div>
          </div>
        </div>
      </section>
  
      <!-- Combined wrapper for tables and footer -->
      <div class="content-wrapper">
        <!-- Tables section -->
        <section class="tables-section-container" style="border-radius: 0; box-shadow: none; margin-bottom: 0;">
          <h2 class="dashboard-section-header">Propensity to Buy (Experimental)</h2>
          <div class="tables-section">
            <div class="tabs">
              <button class="tab-btn active" data-tab="recent">Recent Awards</button>
              <button class="tab-btn" data-tab="largest">Largest Awards</button>
              <button class="tab-btn" data-tab="offices">Top Contracting Offices</button>
            </div>
            <div id="recentTab" class="tab-content active">
              <div class="table-container">
                <table id="contractsTable" class="data-table">
                  <thead>
                    <tr>
                      <th data-sort="date">Date</th>
                      <th data-sort="id">Contract ID</th>
                      <th data-sort="agency">Agency</th>
                      <th data-sort="office">Office</th>
                      <th data-sort="vendor">Vendor</th>
                      <th data-sort="description">Description</th>
                      <th data-sort="value">Value</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div id="largestTab" class="tab-content">
              <div class="table-container">
                <table id="largestContractsTable" class="data-table">
                  <thead>
                    <tr>
                      <th data-sort="date">Date</th>
                      <th data-sort="id">Contract ID</th>
                      <th data-sort="agency">Agency</th>
                      <th data-sort="office">Office</th>
                      <th data-sort="vendor">Vendor</th>
                      <th data-sort="description">Description</th>
                      <th data-sort="value">Value</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div id="officesTab" class="tab-content">
              <div class="table-container">
                <table id="officesTable" class="data-table">
                  <thead>
                    <tr>
                      <th data-sort="agency">Agency</th>
                      <th data-sort="office">Office</th>
                      <th data-sort="contracts">Contracts</th>
                      <th data-sort="value">Total Value</th>
                      <th data-sort="naics">Top NAICS</th>
                      <th data-sort="vendor">Top Vendor</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
        <!-- Integrated footer - no margin/padding between this and tables -->
        <section class="integrated-footer" style="border-top: 1px solid var(--border); background: none; box-shadow: none; margin-top: 0;">
          <div class="footer-container" style="background: none; border-top: none;">
            <!-- Connect Card Section -->
            <div class="footer-section">
              <h3>Let's Connect</h3>
              <div class="connect-card">
                <div class="connect-avatar">
                  <img src="markgs.jpg" alt="Mark's profile picture">
                </div>
                <div class="connect-info">
                  <h4>Hi, I'm Mark</h4>
                  <p>Federal primes with contracts over $750K must create SBA subcontracting plans. After 30+ years of being both a governement customer and seller, I've created a suite of Post-Award Intelligence tools that help you find those primes, follow the money, and unlock more opportunities.</p>
                  <div class="connect-buttons">
                    <a href="https://www.linkedin.com/in/markflournoy/" class="connect-button" target="_blank" rel="noopener">
                      <i class="fab fa-linkedin"></i> Connect
                    </a>
                    <a href="mailto:mark@subhoo.com" class="connect-button">
                      <i class="fas fa-envelope"></i> Email
                    </a>
                  </div>
                </div>
              </div>
              <p>Reach out if I can help with federal contracting insights, subcontracting plans, or just to chat about government procurement opportunities.</p>
            </div>
            <!-- How To Use Section -->
            <div class="footer-section">
              <h3>How To Use PostAward</h3>
              <ul class="how-to-steps">
                <li>
                  <h4>Find Contract Data</h4>
                  <p>Go to FPDS.gov and perform an "EZ Search" by agency, vendor, or keyword to locate federal contract awards.</p>
                </li>
                <li>
                  <h4>Download CSV File</h4>
                  <p>Export your search results as a CSV file to get detailed contract information.</p>
                </li>
                <li>
                  <h4>Upload & Analyze</h4>
                  <p>Upload the CSV to PostAward to visualize spending patterns, identify key vendors, and explore subcontracting opportunities.</p>
                </li>
                <li>
                  <h4>Filter & Explore</h4>
                  <p>Use our interactive filters to narrow down results and find the most promising contracting opportunities.</p>
                </li>
              </ul>
            </div>
            <!-- Resources Section -->
            <div class="footer-section">
              <h3>Useful Resources</h3>
              <p>Explore these government contracting resources to enhance your federal procurement knowledge.</p>
              <ul class="footer-links">
                <li>
                  <a href="https://www.fpds.gov" target="_blank" rel="noopener">
                    <i class="fas fa-external-link-alt"></i> Federal Procurement Data System
                  </a>
                </li>
                <li>
                  <a href="https://www.sba.gov" target="_blank" rel="noopener">
                    <i class="fas fa-external-link-alt"></i> Small Business Administration
                  </a>
                </li>
                <li>
                  <a href="https://sam.gov" target="_blank" rel="noopener">
                    <i class="fas fa-external-link-alt"></i> SAM.gov
                  </a>
                </li>
                <li>
                  <a href="https://www.acquisition.gov" target="_blank" rel="noopener">
                    <i class="fas fa-external-link-alt"></i> Acquisition.gov
                  </a>
                </li>
                <li>
                  <a href="https://www.gsa.gov" target="_blank" rel="noopener">
                    <i class="fas fa-external-link-alt"></i> General Services Administration
                  </a>
                </li>
                <li>
                  <a href="https://www.subhoo.com" target="_blank" rel="noopener">
                    <i class="fas fa-external-link-alt"></i> Subhoo.com
                  </a>
                </li>
                <li>
                  <a href="https://www.usaspending.gov" target="_blank" rel="noopener">
                    <i class="fas fa-external-link-alt"></i> USAspending.gov
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <!-- Copyright Section -->
          <div class="copyright">
            <p>&copy; 2025 PostAward by Subhoo. All rights reserved.</p>
          </div>
        </section>
      </div>
    </main>
  </div> 
  <div id="contractModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Contract Details</h3>
        <button id="closeModal" class="modal-close" aria-label="Close modal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="contractModalBody"></div>
      <div class="modal-footer">
        <button id="closeModalBtn" class="btn btn-secondary"><span class="btn-text">Close</span></button>
      </div>
    </div>
  </div>
  <button id="mobileFilterBtn" class="mobile-action-btn" aria-label="Open filters">
    <i class="fas fa-filter"></i>
  </button>
<script>
// Main application data object
const app = {
  data: [],
  filteredData: [],
  agencies: {},
  offices: {},
  vendors: {},
  naicsCodes: {},
  pscCodes: {},
  charts: {},
  filters: {},
  selection: { type: null, value: null, container: null },
  sankeyDisplayLimit: 10,
  s3BaseUrl: "https://subhoodata.s3.us-east-1.amazonaws.com/data/",
  mobileHeaderState: {
    expanded: false,
    fixed: false,
    lastScrollY: 0
  }
};
const elements = {
  csvFile: document.getElementById('csvFile'),
  uploadBtn: document.querySelector('label[for="csvFile"]'),
  loadExample1Btn: document.getElementById('loadExample1'),
  loadExample2Btn: document.getElementById('loadExample2'),
  loadExample4Btn: document.getElementById('loadExample4'),
  statusBox: document.getElementById('statusBox'), 
  activeFilters: document.getElementById('activeFilters'),
  searchInput: document.getElementById('searchInput'),
  agencyFilter: document.getElementById('agencyFilter'),
  vendorFilter: document.getElementById('vendorFilter'),
  pscFilter: document.getElementById('pscFilter'),
  resetFilters: document.getElementById('resetFilters'),
  moreFiltersBtn: document.getElementById('moreFiltersBtn'),
  advancedFiltersPanel: document.getElementById('advancedFiltersPanel'),
  closeFilters: document.getElementById('closeFilters'),
  startDate: document.getElementById('startDate'),
  endDate: document.getElementById('endDate'),
  officeFilter: document.getElementById('officeFilter'), 
  naicsFilter: document.getElementById('naicsFilter'),   
  valueFilter: document.getElementById('valueFilter'),   
  themeToggle: document.getElementById('themeToggle'),
  loadingIndicator: document.getElementById('loadingIndicator'),
  errorMessage: document.getElementById('errorMessage'),
  noDataMessage: document.getElementById('noDataMessage'),
  dashboard: document.getElementById('dashboard'),
  mobileFilterBtn: document.getElementById('mobileFilterBtn'),
  totalContracts: document.getElementById('totalContracts'),
  totalValue: document.getElementById('totalValue'),
  avgValue: document.getElementById('avgValue'),
  uniqueVendors: document.getElementById('uniqueVendors'),
  sankeyTop10: document.getElementById('sankeyTop10'),
  sankeyTop25: document.getElementById('sankeyTop25'),
  sankeyAll: document.getElementById('sankeyAll'),
  sankeyChartContainer: document.getElementById('sankeyChartContainer'),
  sankeyTooltip: document.getElementById('sankeyTooltip'),
  valueTimeChartContainer: document.getElementById('valueTimeChartContainer'),
  agencyChartContainer: document.getElementById('agencyChartContainer'),
  naicsBubbleChartContainer: document.getElementById('naicsBubbleChartContainer'),
  vendorChartContainer: document.getElementById('vendorChartContainer'),
  valueTimeChart: document.getElementById('valueTimeChart').getContext('2d'),
  agencyChart: document.getElementById('agencyChart').getContext('2d'),
  naicsBubbleChart: document.getElementById('naicsBubbleChart').getContext('2d'),
  vendorChart: document.getElementById('vendorChart').getContext('2d'),
  contractsTable: document.getElementById('contractsTable').querySelector('tbody'),
  largestContractsTable: document.getElementById('largestContractsTable').querySelector('tbody'),
  officesTable: document.getElementById('officesTable').querySelector('tbody'),
  tabButtons: document.querySelectorAll('.tab-btn'),
  tabContents: document.querySelectorAll('.tab-content'),
  contractModal: document.getElementById('contractModal'),
  closeModal: document.getElementById('closeModal'),
  closeModalBtn: document.getElementById('closeModalBtn'),
  contractModalBody: document.getElementById('contractModalBody'),
  // New mobile header elements
  appHeader: document.querySelector('.app-header'),
  headerToggleBtn: document.getElementById('headerToggleBtn'),
  headerPlaceholder: document.querySelector('.header-placeholder')
};
// Define the palette globally before the utils object
const FREYT_PALETTE = ['#004DF3', '#8BAAFA', '#34C759', '#FF9500', '#FF3B30', '#5E5CE6', '#FF2D55', '#AF52DE', '#5AC8FA', '#FF9500'];
const utils = {
  formatMoney: function(value) {
    if (!value && value !== 0) return '$0';
    const number = parseFloat(value);
    if (isNaN(number)) return '$0';
    if (number >= 1000000000) return '$' + (number / 1000000000).toFixed(1) + 'B';
    if (number >= 1000000) return '$' + (number / 1000000).toFixed(1) + 'M';
    if (number >= 1000) return '$' + (number / 1000).toFixed(1) + 'K';
    return '$' + number.toFixed(0);
  },
  formatDate: function(dateInput) { 
    if (!dateInput) return 'N/A';
    const date = (dateInput instanceof Date && !isNaN(dateInput)) ? dateInput : new Date(dateInput);
    if (isNaN(date.getTime())) {
      if (typeof dateInput === 'string') {
        const parts = dateInput.split('-');
        if (parts.length === 3) {
          const months = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11};
          const day = parseInt(parts[0]);
          const month = months[parts[1]];
          let year = parseInt(parts[2]);
          if (year < 100) year = year < 50 ? 2000 + year : 1900 + year;
          if (!isNaN(day) && month !== undefined && !isNaN(year)) {
            const parsedDate = new Date(year, month, day);
            return parsedDate.toLocaleDateString('en-US', { year: '2-digit', month: 'short', day: 'numeric' });
          }
        }
      }
      return String(dateInput); 
    }
    return date.toLocaleDateString('en-US', { year: '2-digit', month: 'short', day: 'numeric' });
  },
  parseMoney: function(value) {
    if (!value) return 0;
    return parseFloat(String(value).replace(/[$,\s]/g, '')) || 0;
  },
  parseCSV: function(text) {
    const lines = text.split(/\r\n|\n/);
    if (lines.length === 0) return { headers: [], data: [] };
    const parseLine = function(line) {
      const values = []; let current = ''; let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i], nextChar = line[i + 1] || '';
        if (char === '"') {
          if (inQuotes && nextChar === '"') { current += '"'; i++; } 
          else inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; } 
        else current += char;
      }
      values.push(current.trim()); return values;
    };
    const headers = parseLine(lines[0]);
    const data = [];
    for (let i = 1; i < lines.length; i++) {
      if (lines[i].trim()) {
        const values = parseLine(lines[i]);
        const row = {};
        for (let j = 0; j < Math.min(headers.length, values.length); j++) {
          if (headers[j]) row[headers[j]] = values[j] || '';
        }
        data.push(row);
      }
    }
    return { headers, data };
  },
  parseDate: function(dateString) {
    if (!dateString) return null;
    if (dateString instanceof Date && !isNaN(dateString)) return dateString; 
    const s = String(dateString);
    const parts = s.split('-');
    if (parts.length === 3) {
      const months = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11};
      const day = parseInt(parts[0]);
      const month = months[parts[1]];
      let year = parseInt(parts[2]);
      if (year < 100) year = year < 50 ? 2000 + year : 1900 + year;
      if (!isNaN(day) && month !== undefined && !isNaN(year)) {
        return new Date(year, month, day);
      }
    }
    const date = new Date(s);
    return !isNaN(date.getTime()) ? date : null;
  },
  truncateText: function(text, maxLength) {
    if (!text || text.length <= maxLength) return text || '';
    return text.substring(0, maxLength) + '...';
  },
  stringToColor: function(str) {
    if (!str) return '#cccccc'; 
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    return FREYT_PALETTE[Math.abs(hash) % FREYT_PALETTE.length];
  },
  // Consistent entity color mapping to ensure same entities have same colors across all charts
  getEntityColor: function(entityName, entityType = '') {
    if (!entityName) return '#cccccc';
    // Use consistent key for same entities regardless of chart
    const key = entityName.toLowerCase().trim();
    return this.stringToColor(key);
  },
  // Enhanced color functions with opacity support
  getEntityColorWithOpacity: function(entityName, opacity = 1, entityType = '') {
    const baseColor = this.getEntityColor(entityName, entityType);
    if (opacity === 1) return baseColor;
    // Convert hex to rgba
    const r = parseInt(baseColor.slice(1, 3), 16);
    const g = parseInt(baseColor.slice(3, 5), 16);
    const b = parseInt(baseColor.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
  },
  getInitials: function(name) {
    if (!name) return '?'; const words = name.split(/\s+/);
    return words.length > 1 ? (words[0].charAt(0) + words[1].charAt(0)).toUpperCase() : name.charAt(0).toUpperCase();
  },
  parseValueRange: function(rangeStr) {
    if (!rangeStr) return null; const parts = rangeStr.split('-');
    return parts.length !== 2 ? null : {min:parseFloat(parts[0]),max:parseFloat(parts[1])};
  }
};
const mobileHeaderManager = {
  init: function() {
    if (!elements.appHeader || !elements.headerToggleBtn || !elements.headerPlaceholder) {
      console.error("Mobile header elements missing");
      return;
    }
    // Start with header collapsed on mobile
    if (window.innerWidth < 768) {
      this.collapseHeader();
    }
    // Set up event listeners
    elements.headerToggleBtn.addEventListener('click', this.toggleHeader.bind(this));
    // Handle scroll events
    window.addEventListener('scroll', this.handleScroll.bind(this));
    // Handle resize events
    window.addEventListener('resize', this.handleResize.bind(this));
  },
  toggleHeader: function() {
    if (app.mobileHeaderState.expanded) {
      this.collapseHeader();
    } else {
      this.expandHeader();
    }
  },
  expandHeader: function() {
    elements.appHeader.classList.add('expanded');
    elements.headerToggleBtn.innerHTML = '<i class="fas fa-caret-up"></i>';
    app.mobileHeaderState.expanded = true;
  },
  collapseHeader: function() {
    elements.appHeader.classList.remove('expanded');
    elements.headerToggleBtn.innerHTML = '<i class="fas fa-caret-down"></i>';
    app.mobileHeaderState.expanded = false;
  },
  handleScroll: function() {
    if (window.innerWidth >= 768) return; // Only apply on mobile
    const currentScrollY = window.scrollY;
    const scrollDelta = currentScrollY - app.mobileHeaderState.lastScrollY;
    // If scrolling down more than 10px, fix header
    if (scrollDelta > 10 && currentScrollY > 50) {
      this.fixHeader();
    } 
    // If scrolling up more than 10px, unfix header
    else if (scrollDelta < -10) {
      this.unfixHeader();
    }
    app.mobileHeaderState.lastScrollY = currentScrollY;
  },
  fixHeader: function() {
    if (!app.mobileHeaderState.fixed) {
      elements.appHeader.classList.add('fixed');
      elements.headerPlaceholder.classList.add('visible');
      app.mobileHeaderState.fixed = true;
      this.collapseHeader(); // Ensure it's collapsed when fixed
    }
  },
  unfixHeader: function() {
    if (app.mobileHeaderState.fixed) {
      elements.appHeader.classList.remove('fixed');
      elements.headerPlaceholder.classList.remove('visible');
      app.mobileHeaderState.fixed = false;
    }
  },
  handleResize: function() {
    if (window.innerWidth >= 768) {
      // On desktop, ensure header is expanded and not fixed
      elements.appHeader.classList.remove('fixed');
      elements.headerPlaceholder.classList.remove('visible');
      elements.appHeader.classList.remove('expanded');
      app.mobileHeaderState.fixed = false;
      app.mobileHeaderState.expanded = false;
    } else {
      // On mobile, start with header collapsed
      if (!app.mobileHeaderState.expanded) {
        this.collapseHeader();
      }
    }
  }
};
const dataProcessor = {
  processData: function(csvData) {
    if (!csvData || !csvData.data || csvData.data.length === 0) throw new Error('No valid data found in CSV file');
    const requiredFields = ['Contract ID','Date Signed','Contracting Agency','Legal Business Name','Action Obligation ($)'];
    for (const field of requiredFields) if (!csvData.headers.includes(field)) throw new Error(`Required field "${field}" not found in CSV file`);
    return csvData.data.map(row => ({
      id:row['Contract ID']||'', reference:row['Reference IDV']||'', modification:row['Modification Number']||'',
      date:row['Date Signed']||'', parsedDate:utils.parseDate(row['Date Signed']), type:row['Award/IDV Type']||'',
      value:utils.parseMoney(row['Action Obligation ($)']), agency:row['Contracting Agency']||'', office:row['Contracting Office Name']||'',
      psc:row['PSC']||'', pscDescription:row['PSC Description']||'', naics:row['NAICS']||'', naicsDescription:row['NAICS Description']||'',
      vendor:row['Legal Business Name']||'', description:row['PSC Description']||''
    }));
  },
  analyzeData: function(data) {
    const agencies={},offices={},vendors={},naicsCodes={},pscCodes={};
    data.forEach(contract => {
      if(contract.agency){
        if(!agencies[contract.agency]) agencies[contract.agency]={name:contract.agency,count:0,value:0,offices:new Set(),vendors:new Set()};
        agencies[contract.agency].count++; agencies[contract.agency].value+=contract.value;
        if(contract.office) agencies[contract.agency].offices.add(contract.office);
        if(contract.vendor) agencies[contract.agency].vendors.add(contract.vendor);
      }
      if(contract.office){
        if(!offices[contract.office]) offices[contract.office]={name:contract.office,agency:contract.agency,count:0,value:0,vendors:new Set(),naicsCodes:{}};
        offices[contract.office].count++; offices[contract.office].value+=contract.value;
        if(contract.vendor) offices[contract.office].vendors.add(contract.vendor);
        if(contract.naics){
          if(!offices[contract.office].naicsCodes[contract.naics]) offices[contract.office].naicsCodes[contract.naics]={code:contract.naics,description:contract.naicsDescription,count:0,value:0};
          offices[contract.office].naicsCodes[contract.naics].count++; offices[contract.office].naicsCodes[contract.naics].value+=contract.value;
        }
      }
      if(contract.vendor){
        if(!vendors[contract.vendor]) vendors[contract.vendor] = {name: contract.vendor,count: 0,value:0,agencies:new Set(),naicsCodes:{}};
        vendors[contract.vendor].count++; vendors[contract.vendor].value+=contract.value;
        if(contract.agency) vendors[contract.vendor].agencies.add(contract.agency);
        if(contract.naics){
          if(!vendors[contract.vendor].naicsCodes[contract.naics]) vendors[contract.vendor].naicsCodes[contract.naics]={code:contract.naics,description:contract.naicsDescription,count:0,value:0};
          vendors[contract.vendor].naicsCodes[contract.naics].count++; vendors[contract.vendor].naicsCodes[contract.naics].value+=contract.value;
        }
      }
      if(contract.naics){
        if(!naicsCodes[contract.naics]) naicsCodes[contract.naics]={code:contract.naics,description:contract.naicsDescription,count:0,value:0,vendors:new Set()};
        naicsCodes[contract.naics].count++; naicsCodes[contract.naics].value+=contract.value;
        if(contract.vendor) naicsCodes[contract.naics].vendors.add(contract.vendor);
      }
      if(contract.psc){
        if(!pscCodes[contract.psc]) pscCodes[contract.psc]={code:contract.psc,description:contract.pscDescription,count:0,value:0};
        pscCodes[contract.psc].count++; pscCodes[contract.psc].value+=contract.value;
      }
    });
    return {agencies,offices,vendors,naicsCodes,pscCodes};
  },
removeSankeyCircularLinks: function(nodes, links) {
  // The current implementation isn't completely resolving circular dependencies
  // Let's implement a more robust solution
  // Step 1: Create a graph representation
  const graph = {};
  nodes.forEach(node => {
    graph[node.id] = {
      id: node.id,
      name: node.name,
      type: node.type,
      outgoing: [],
      incoming: []
    };
  });
  // Step 2: Populate the graph with links
  links.forEach((link, index) => {
    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
    // Store link indices instead of the links themselves
    if (graph[sourceId]) graph[sourceId].outgoing.push({ target: targetId, linkIndex: index });
    if (graph[targetId]) graph[targetId].incoming.push({ source: sourceId, linkIndex: index });
  });
  // Step 3: Identify and break cycles
  const visited = {};
  const stack = {};
  const linksToRemove = new Set();
  function dfs(nodeId) {
    // Already completely visited this node
    if (visited[nodeId] === 2) return false;
    // Found a cycle (node is in current path)
    if (visited[nodeId] === 1) return true;
    visited[nodeId] = 1; // Mark as being in current path
    stack[nodeId] = true;
    // Check all outgoing links
    const node = graph[nodeId];
    if (node && node.outgoing) {
      for (const edge of node.outgoing) {
        if (stack[edge.target] || dfs(edge.target)) {
          // We found a cycle, mark this link for removal
          linksToRemove.add(edge.linkIndex);
          return true;
        }
      }
    }
    delete stack[nodeId]; // Remove from current path
    visited[nodeId] = 2; // Mark as completely visited
    return false;
  }
  // Run DFS from each node
  nodes.forEach(node => {
    if (!visited[node.id]) {
      dfs(node.id);
    }
  });
  // Alternative strategy: If removing links by cycle detection doesn't work well,
  // we enforce a hierarchical structure based on node types
  if (linksToRemove.size === 0) {
    // Group nodes by type
    const nodesByType = {};
    nodes.forEach(node => {
      if (!nodesByType[node.type]) nodesByType[node.type] = [];
      nodesByType[node.type].push(node.id);
    });
    // Check for type-based circular dependencies
    // For example, ensuring vendor -> office or office -> agency links don't exist
    links.forEach((link, index) => {
      const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
      const targetId = typeof link.target === 'object' ? link.target.id : link.target;
      const sourceType = nodes[sourceId]?.type;
      const targetType = nodes[targetId]?.type;
      // Define hierarchy: agency -> office -> vendor
      if ((sourceType === 'vendor' && targetType === 'office') ||
          (sourceType === 'vendor' && targetType === 'agency') ||
          (sourceType === 'office' && targetType === 'agency')) {
        linksToRemove.add(index);
      }
    });
  }
  // Step 4: Return filtered links
  return links.filter((_, index) => !linksToRemove.has(index));
},
// Improved generateSankeyData function that better handles circular references
generateSankeyData: function(data, limit=10) {
  // Step 1: Create the initial flow mappings
  const agencyOfficeFlows = {}, officeVendorFlows = {}, nodeMap = new Map();
  data.forEach(c => {
    if (c.agency && c.office && c.vendor && c.value > 0) {
      const aok = `${c.agency}|${c.office}`;
      if (!agencyOfficeFlows[aok]) agencyOfficeFlows[aok] = {source: c.agency, target: c.office, value: 0};
      agencyOfficeFlows[aok].value += c.value;
      const ovk = `${c.office}|${c.vendor}`;
      if (!officeVendorFlows[ovk]) officeVendorFlows[ovk] = {source: c.office, target: c.vendor, value: 0};
      officeVendorFlows[ovk].value += c.value;
    }
  });
  // Step 2: Create nodes with specific types to ensure proper hierarchy
  Object.values(agencyOfficeFlows).forEach(f => {
    if (!nodeMap.has(f.source)) nodeMap.set(f.source, {name: f.source, type: 'agency'});
    if (!nodeMap.has(f.target)) nodeMap.set(f.target, {name: f.target, type: 'office'});
  });
  Object.values(officeVendorFlows).forEach(f => {
    // Ensure we don't override existing nodes' types
    if (!nodeMap.has(f.source)) nodeMap.set(f.source, {name: f.source, type: 'office'});
    if (!nodeMap.has(f.target)) nodeMap.set(f.target, {name: f.target, type: 'vendor'});
  });
  // Step 3: Create arrays of nodes and assign IDs
  const nodesArray = Array.from(nodeMap.values());
  nodesArray.forEach((n, i) => n.id = i);
  // Create a mapping from node name to index
  const nodeIndexMap = new Map();
  nodesArray.forEach((n, i) => nodeIndexMap.set(n.name, i));
  // Step 4: Create links with proper source/target indices
  const agencyOfficeLinks = Object.values(agencyOfficeFlows).map(f => ({
    source: nodeIndexMap.get(f.source),
    target: nodeIndexMap.get(f.target),
    value: f.value,
    type: 'agency-office'
  }));
  const officeVendorLinks = Object.values(officeVendorFlows).map(f => ({
    source: nodeIndexMap.get(f.source),
    target: nodeIndexMap.get(f.target),
    value: f.value,
    type: 'office-vendor'
  }));
  // Step 5: Remove circular links
  let linksArray = [...agencyOfficeLinks, ...officeVendorLinks];
  // First, ensure hierarchy is maintained
  linksArray = linksArray.filter(link => {
    const sourceNode = nodesArray[link.source];
    const targetNode = nodesArray[link.target];
    // Only allow agency->office and office->vendor flows
    // This enforces a strict hierarchy and prevents cycles
    if (sourceNode.type === 'agency' && targetNode.type === 'office') return true;
    if (sourceNode.type === 'office' && targetNode.type === 'vendor') return true;
    return false;
  });
  // Then remove any remaining circular links
  linksArray = this.removeSankeyCircularLinks(nodesArray, linksArray);
  // Step 6: Sort by value and limit if needed
  linksArray.sort((a, b) => b.value - a.value);
  // Adjust limit to available links
  const effectiveLimit = limit === 0 ? linksArray.length : Math.min(limit, linksArray.length);
  const topLinks = [];
  const includedNodes = new Set();
  // Add links up to the effective limit
  for (let i = 0; i < effectiveLimit && i < linksArray.length; i++) {
    topLinks.push(linksArray[i]);
    includedNodes.add(linksArray[i].source);
    includedNodes.add(linksArray[i].target);
  }
  // Ensure we have at least one link if possible
  if (topLinks.length === 0 && linksArray.length > 0) {
    topLinks.push(linksArray[0]);
    includedNodes.add(linksArray[0].source);
    includedNodes.add(linksArray[0].target);
  }
  // Step 7: Create the final nodes list from included nodes
  const finalNodes = [];
  const nodeIdMap = new Map(); // Map old indices to new indices
  // Add nodes that are actually used in the links
  nodesArray.forEach((node, oldIndex) => {
    if (includedNodes.has(oldIndex)) {
      nodeIdMap.set(oldIndex, finalNodes.length);
      finalNodes.push({...node, id: finalNodes.length});
    }
  });
  // Step 8: Remap link indices to the new node indices
  const finalLinks = topLinks.map(link => ({
    source: nodeIdMap.get(link.source),
    target: nodeIdMap.get(link.target),
    value: link.value,
    type: link.type
  }));
  return {nodes: finalNodes, links: finalLinks};
}
};
const filterManager = {
  applyFilters: function() {
    const filters = app.filters;
    let filtered = [...app.data];
    if (filters.valueRange) filtered = filtered.filter(c => c.value >= filters.valueRange.min && c.value <= filters.valueRange.max);
    if (filters.startDate) filtered = filtered.filter(c => c.parsedDate && c.parsedDate >= new Date(filters.startDate));
    if (filters.endDate) { const ed = new Date(filters.endDate); ed.setHours(23, 59, 59, 999); filtered = filtered.filter(c => c.parsedDate && c.parsedDate <= ed); }
    if (filters.agency) filtered = filtered.filter(c => c.agency === filters.agency);
    if (filters.office) filtered = filtered.filter(c => c.office === filters.office);
    if (filters.naics) filtered = filtered.filter(c => c.naics === filters.naics);
    if (filters.psc) filtered = filtered.filter(c => c.psc === filters.psc);
    if (filters.vendor) filtered = filtered.filter(c => c.vendor === filters.vendor);
    if (filters.search) { const s = filters.search.toLowerCase(); filtered = filtered.filter(c => (c.id && c.id.toLowerCase().includes(s)) || (c.agency && c.agency.toLowerCase().includes(s)) || (c.office && c.office.toLowerCase().includes(s)) || (c.vendor && c.vendor.toLowerCase().includes(s)) || (c.description && c.description.toLowerCase().includes(s)) || (c.naicsDescription && c.naicsDescription.toLowerCase().includes(s)) || (c.pscDescription && c.pscDescription.toLowerCase().includes(s))); }
    app.filteredData = filtered;
    return filtered;
  },
  applySelectionFilter: function(type, value, container) {
    document.querySelectorAll('.selection-indicator').forEach(ind => ind.style.display = 'none');
    if (app.selection.type === type && app.selection.value === value) { app.selection = { type: null, value: null, container: null }; delete app.filters[type]; } 
    else {
      delete app.filters.agency; delete app.filters.office; delete app.filters.naics; delete app.filters.vendor;
      if (type && value) { app.filters[type] = value; app.selection = { type, value, container }; if (container) { const ind = container.querySelector('.selection-indicator'); if (ind) ind.style.display = 'block'; } }
    }
    this.applyFilters(); this.updateFilterTags(); dashboardManager.refreshDashboard();
  },
  updateFilterTags: function() {
    const filters = app.filters;
    const activeFiltersContainer = elements.activeFilters;
    activeFiltersContainer.innerHTML = '';
    const tags = [];
    if (filters.valueRange) tags.push({ key: 'valueRange', label: 'Value', value: `${utils.formatMoney(filters.valueRange.min)} - ${utils.formatMoney(filters.valueRange.max)}` });
    if (filters.startDate) tags.push({ key: 'startDate', label: 'From', value: new Date(filters.startDate).toLocaleDateString() });
    if (filters.endDate) tags.push({ key: 'endDate', label: 'To', value: new Date(filters.endDate).toLocaleDateString() });
    if (filters.agency) tags.push({ key: 'agency', label: 'Agency', value: filters.agency });
    if (filters.office) tags.push({ key: 'office', label: 'Office', value: filters.office });
    if (filters.naics) tags.push({ key: 'naics', label: 'NAICS', value: filters.naics });
    if (filters.psc) tags.push({ key: 'psc', label: 'PSC', value: filters.psc });
    if (filters.vendor) tags.push({ key: 'vendor', label: 'Vendor', value: filters.vendor });
    if (filters.search) tags.push({ key: 'search', label: 'Search', value: filters.search });
    tags.forEach(tag => {
      const tagElement = document.createElement('div');
      tagElement.className = 'filter-tag';
      tagElement.innerHTML = `${tag.label}: ${utils.truncateText(tag.value, 15)} <button class="filter-tag-remove" data-filter="${tag.key}"><i class="fas fa-times"></i></button>`;
      activeFiltersContainer.appendChild(tagElement);
      tagElement.querySelector('.filter-tag-remove').addEventListener('click', function() {
        const filterKey = this.getAttribute('data-filter');
        if (filterKey === 'valueRange') { delete app.filters.valueRange; elements.valueFilter.value = ''; } 
        else if (filterKey === 'startDate') { delete app.filters.startDate; elements.startDate.value = ''; } 
        else if (filterKey === 'endDate') { delete app.filters.endDate; elements.endDate.value = ''; } 
        else if (filterKey === 'agency') { delete app.filters.agency; elements.agencyFilter.value = ''; if (app.selection.type === 'agency') app.selection = { type: null, value: null, container: null }; } 
        else if (filterKey === 'office') { delete app.filters.office; elements.officeFilter.value = ''; if (app.selection.type === 'office') app.selection = { type: null, value: null, container: null }; } 
        else if (filterKey === 'naics') { delete app.filters.naics; elements.naicsFilter.value = ''; if (app.selection.type === 'naics') app.selection = { type: null, value: null, container: null }; } 
        else if (filterKey === 'psc') { delete app.filters.psc; elements.pscFilter.value = ''; if (app.selection.type === 'psc') app.selection = { type: null, value: null, container: null }; } 
        else if (filterKey === 'vendor') { delete app.filters.vendor; elements.vendorFilter.value = ''; if (app.selection.type === 'vendor') app.selection = { type: null, value: null, container: null }; } 
        else if (filterKey === 'search') { delete app.filters.search; elements.searchInput.value = ''; }
        document.querySelectorAll('.selection-indicator').forEach(ind => ind.style.display = 'none');
        filterManager.applyFilters(); dashboardManager.refreshDashboard();
      });
    });
    const statusTitleElement = document.querySelector('#statusBox .status-title');
    let titleText = '';
    let dateRangeSuffix = '';
    if (app.filteredData.length > 0) {
        let minDate = null;
        let maxDate = null;
        app.filteredData.forEach(contract => {
            if (contract.parsedDate && contract.parsedDate instanceof Date && !isNaN(contract.parsedDate.getTime())) {
                if (!minDate || contract.parsedDate < minDate) minDate = contract.parsedDate;
                if (!maxDate || contract.parsedDate > maxDate) maxDate = contract.parsedDate;
            }
        });
        if (minDate && maxDate) {
            const formattedMinDate = utils.formatDate(minDate);
            const formattedMaxDate = utils.formatDate(maxDate);
            if (formattedMinDate === formattedMaxDate) {
                if (formattedMinDate !== 'N/A') dateRangeSuffix = ` (Date: ${formattedMinDate})`;
            } else {
                if (formattedMinDate !== 'N/A' && formattedMaxDate !== 'N/A') dateRangeSuffix = ` (${formattedMinDate} - ${formattedMaxDate})`;
                else if (formattedMinDate !== 'N/A') dateRangeSuffix = ` (From: ${formattedMinDate})`;
                else if (formattedMaxDate !== 'N/A') dateRangeSuffix = ` (To: ${formattedMaxDate})`;
            }
        }
    }
    if (statusTitleElement) {
        if (app.data.length === 0 && app.filteredData.length === 0) titleText = 'No data loaded';
        else if (app.filteredData.length === 0 && app.data.length > 0) titleText = 'No contracts match current filters';
        else if (app.filteredData.length < app.data.length) titleText = `Viewing ${app.filteredData.length.toLocaleString()} filtered contracts`;
        else titleText = `Viewing ${app.filteredData.length.toLocaleString()} contracts`;
        statusTitleElement.textContent = titleText + dateRangeSuffix;
    }
  },
  resetFilters: function() {
    app.filters = {}; app.selection = { type: null, value: null, container: null };
    elements.valueFilter.value = ''; elements.startDate.value = ''; elements.endDate.value = '';
    elements.agencyFilter.value = ''; elements.officeFilter.value = ''; elements.naicsFilter.value = '';
    elements.pscFilter.value = ''; elements.vendorFilter.value = ''; elements.searchInput.value = '';
    document.querySelectorAll('.selection-indicator').forEach(ind => ind.style.display = 'none');
    app.filteredData = [...app.data];
    this.updateFilterTags(); dashboardManager.refreshDashboard();
  }
}; 
const chartManager = {
  initCharts: function() {
    Object.values(app.charts).forEach(c => { if (c instanceof Chart) c.destroy(); });
    app.charts = {};
    const cssVars = {
      fontFamily: getComputedStyle(document.documentElement).getPropertyValue('--font-sans').trim(),
      textSecondary: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim(),
      border: getComputedStyle(document.documentElement).getPropertyValue('--border').trim(),
      bgPrimary: getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim(),
      textPrimary: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
      primary: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()
    };
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.font.size = 11;
    Chart.defaults.color = cssVars.textSecondary;
    // Add this helper function for high-resolution chart rendering
    this.setupHighResChart = function(ctx) {
      // Get the device pixel ratio
      const dpr = window.devicePixelRatio || 1;
      // Get the canvas element
      const canvas = ctx.canvas;
      // Get the parent container's dimensions
      const rect = canvas.parentElement.getBoundingClientRect();
      // Set the canvas dimensions accounting for the device pixel ratio
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      // Scale the context to match the DPR
      ctx.scale(dpr, dpr);
      // Set the display size back to the original dimensions
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      return ctx;
    };
    this.initValueTimeChart(); 
    this.initAgencyChart(); 
    this.initNaicsBubbleChart(cssVars); 
    this.initVendorChart(); 
    this.initSankeyChart(); 
    this.addChartClickEvents();
  },
  initValueTimeChart: function() {
    // Setup high-resolution rendering
    this.setupHighResChart(elements.valueTimeChart);
    app.charts.valueTimeChart = new Chart(elements.valueTimeChart, { 
      type: 'line', 
      data: { 
        labels: [], 
        datasets: [{ 
          label: 'Contract Value', 
          data: [], 
          borderColor: FREYT_PALETTE[0],
          backgroundColor: utils.getEntityColorWithOpacity('timeline', 0.1), 
          tension: 0.4, 
          fill: true, 
          pointBackgroundColor: FREYT_PALETTE[0],
          pointBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-primary'), 
          pointBorderWidth: 1, 
          pointRadius: 3, 
          borderWidth: 2 
        }] 
      }, 
      options: { 
        devicePixelRatio: window.devicePixelRatio || 1,
        responsive: true, 
        maintainAspectRatio: false, 
        plugins: { 
          legend: { display: false }, 
          tooltip: { callbacks: { label: c => utils.formatMoney(c.raw) } } 
        }, 
        scales: { 
          x: { 
            grid: { display: false }, 
            ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } 
          }, 
          y: { 
            beginAtZero: true,
            grid: { display: false }, 
            ticks: { callback: v => utils.formatMoney(v), font: { size: 10 } } 
          } 
        } 
      } 
    });
  },
  initAgencyChart: function() {
    // Setup high-resolution rendering
    this.setupHighResChart(elements.agencyChart);
    app.charts.agencyChart = new Chart(elements.agencyChart, { 
      type: 'bar', 
      data: { 
        labels: [], 
        datasets: [{ 
          label: 'Contract Value', 
          data: [], 
          backgroundColor: [], 
          borderWidth: 0, 
          borderRadius: 4, 
          barThickness: 'flex', 
          maxBarThickness: 15 
        }] 
      }, 
      options: { 
        devicePixelRatio: window.devicePixelRatio || 1,
        responsive: true, 
        maintainAspectRatio: false, 
        indexAxis: 'y', 
        plugins: { 
          legend: { display: false }, 
          tooltip: { callbacks: { label: c => utils.formatMoney(c.raw) } } 
        }, 
        scales: { 
          x: { 
            beginAtZero: true,
            grid: { display: false }, 
            ticks: { callback: v => utils.formatMoney(v), font: { size: 10 } } 
          }, 
          y: { 
            grid: { display: false }, 
            ticks: { font: { size: 10 } } 
          } 
        } 
      } 
    });
  },
  initNaicsBubbleChart: function(cssVars) {
    if (!elements.naicsBubbleChart) return;
    // Setup high-resolution rendering
    this.setupHighResChart(elements.naicsBubbleChart);
    app.charts.naicsBubbleChart = new Chart(elements.naicsBubbleChart, { 
        type: 'bubble', 
        data: { datasets: [] }, 
        options: { 
            devicePixelRatio: window.devicePixelRatio || 1,
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { display: false }, 
                tooltip: { 
                    callbacks: { 
                        label: function(c) { 
                            const d = c.dataset.data[c.dataIndex]; 
                            return [
                                utils.truncateText(d.label, 40) || '', 
                                `Contracts: ${d.x.toLocaleString()}`, 
                                `Value: ${utils.formatMoney(d.y)}`
                            ]; 
                        } 
                    } 
                } 
            }, 
            scales: { 
                x: { 
                    type: 'logarithmic',
                    position: 'bottom', 
                    title: { display: true, text: 'Number of Contracts (Log Scale)', font: { size: 11 } }, 
                    grid: { display: false },
                    min: 1,
                    max: 10000,
                    ticks: { 
                        font: { size: 10 },
                        maxTicksLimit: 6,
                        callback: function(value, index, values) {
                            if (value === 1 || value === 10 || value === 100 || value === 1000 || value === 10000) {
                                return value.toLocaleString();
                            }
                            return null;
                        }
                    } 
                }, 
                y: { 
                    type: 'logarithmic',
                    title: { display: true, text: 'Total Contract Value (Log Scale)', font: { size: 11 } }, 
                    grid: { display: false },
                    min: 1000,
                    max: 100000000000,
                    ticks: { 
                        maxTicksLimit: 6,
                        callback: function(v) {
                            if (v >= 1000000000) return '$' + (v/1000000000).toFixed(0) + 'B';
                            if (v >= 1000000) return '$' + (v/1000000).toFixed(0) + 'M';
                            if (v >= 1000) return '$' + (v/1000).toFixed(0) + 'K';
                            return '$' + v.toFixed(0);
                        }, 
                        font: { size: 10 } 
                    } 
                } 
            },
            layout: {
                padding: {
                    top: 10,
                    right: 20,
                    bottom: 10,
                    left: 10
                }
            }
        } 
    });
  },
  initVendorChart: function() {
    // Setup high-resolution rendering
    this.setupHighResChart(elements.vendorChart);
    app.charts.vendorChart = new Chart(elements.vendorChart, { 
      type: 'bar', 
      data: { 
        labels: [], 
        datasets: [{ 
          label: 'Contract Value', 
          data: [], 
          backgroundColor: [], 
          borderWidth: 0, 
          borderRadius: 4, 
          barThickness: 'flex', 
          maxBarThickness: 15 
        }] 
      }, 
      options: { 
        devicePixelRatio: window.devicePixelRatio || 1,
        responsive: true, 
        maintainAspectRatio: false, 
        indexAxis: 'y', 
        plugins: { 
          legend: { display: false }, 
          tooltip: { callbacks: { label: c => utils.formatMoney(c.raw) } } 
        }, 
        scales: { 
          x: { 
            beginAtZero: true,
            grid: { display: false }, 
            ticks: { callback: v => utils.formatMoney(v), font: { size: 10 } } 
          }, 
          y: { 
            grid: { display: false }, 
            ticks: { font: { size: 10 } } 
          } 
        } 
      } 
    });
  },
  initSankeyChart: function() {
    const c = elements.sankeyChartContainer; 
    if (c) c.querySelector('svg')?.remove();
    elements.sankeyTop10.addEventListener('click', () => { 
      app.sankeyDisplayLimit = 10; 
      elements.sankeyTop10.className = 'btn btn-sm btn-primary'; 
      elements.sankeyTop25.className = 'btn btn-sm btn-secondary'; 
      elements.sankeyAll.className = 'btn btn-sm btn-secondary'; 
      this.updateSankeyChart(); 
    });
    elements.sankeyTop25.addEventListener('click', () => { 
      app.sankeyDisplayLimit = 25; 
      elements.sankeyTop10.className = 'btn btn-sm btn-secondary'; 
      elements.sankeyTop25.className = 'btn btn-sm btn-primary'; 
      elements.sankeyAll.className = 'btn btn-sm btn-secondary'; 
      this.updateSankeyChart(); 
    });
    elements.sankeyAll.addEventListener('click', () => { 
      app.sankeyDisplayLimit = 0; 
      elements.sankeyTop10.className = 'btn btn-sm btn-secondary'; 
      elements.sankeyTop25.className = 'btn btn-sm btn-secondary'; 
      elements.sankeyAll.className = 'btn btn-sm btn-primary'; 
      this.updateSankeyChart(); 
    });
  },
updateSankeyChart: function() {
  const data = app.filteredData; 
  if (!data || data.length === 0) {
    elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:var(--space-6); color:var(--text-secondary);">No data available for Sankey chart.</p>';
    return;
  }
  try {
    const sankeyData = dataProcessor.generateSankeyData(data, app.sankeyDisplayLimit);
    // Check if we have enough data to display
    if (!sankeyData.links || sankeyData.links.length === 0 || !sankeyData.nodes || sankeyData.nodes.length < 2) {
      elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:var(--space-6); color:var(--text-secondary);">Not enough data to display Sankey diagram.</p>';
      return;
    }
    elements.sankeyChartContainer.innerHTML = '';
    const container = elements.sankeyChartContainer; 
    container.querySelector('svg')?.remove();
    const width = container.clientWidth, height = container.clientHeight;
    if (width <= 0 || height <= 0) return;
    // For Sankey chart, use a higher DPR for sharper rendering
    const dpr = window.devicePixelRatio || 1;
    const svg = d3.select(container).append('svg')
      .attr('width', width * dpr)
      .attr('height', height * dpr)
      .style('width', width + 'px')
      .style('height', height + 'px');
    // Apply scaling for high resolution
    svg.attr('viewBox', `0 0 ${width} ${height}`);
    const sankey = d3.sankey()
      .nodeWidth(18)
      .nodePadding(10)
      .extent([[20, 10], [width - 40, height - 30]])
      .nodeSort((a, b) => d3.descending(a.value, b.value));
    let graph;
    try {
      graph = sankey({
        nodes: sankeyData.nodes.map(d => Object.assign({}, d)),
        links: sankeyData.links.map(d => Object.assign({}, d))
      });
    } catch (sankeyLayoutError) {
      console.error("Error in Sankey layout:", sankeyLayoutError);
      elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:var(--space-6); color:var(--text-secondary);">Unable to create Sankey diagram with current data.</p>';
      return;
    }
    const { nodes, links } = graph;
    nodes.forEach(n => n.color = utils.getEntityColor(n.name, n.type)); 
    const defs = svg.append("defs");
    links.forEach(l => {
      l.gradientId = `gradient-${l.source.index}-${l.target.index}`;
      const sourceColor = nodes[l.source.index].color;
      const targetColor = nodes[l.target.index].color;
      const gradient = defs.append("linearGradient")
        .attr("id", l.gradientId)
        .attr("gradientUnits", "userSpaceOnUse") 
        .attr("x1", nodes[l.source.index].x1) 
        .attr("x2", nodes[l.target.index].x0);
      gradient.append("stop").attr("offset", "0%").attr("stop-color", sourceColor).attr("stop-opacity", 0.7);
      gradient.append("stop").attr("offset", "100%").attr("stop-color", targetColor).attr("stop-opacity", 0.7);
    });
    const link = svg.append('g')
      .attr('fill', 'none')
      .attr('stroke-opacity', 0.55)
      .selectAll('path')
      .data(links)
      .join('path')
      .attr('d', d3.sankeyLinkHorizontal())
      .attr('stroke', d => `url(#${d.gradientId})`)
      .attr('stroke-width', d => Math.max(1.5, d.width))
      .on('mouseover', function(ev, d) { 
        d3.select(this).attr('stroke-opacity', 0.85); 
        const tt = elements.sankeyTooltip; 
        tt.style.display = 'block';
        tt.style.opacity = 1; 
        tt.style.left = (ev.pageX + 15) + 'px'; 
        tt.style.top = (ev.pageY - 15) + 'px'; 
        tt.innerHTML = `<div style="font-weight:600;">${utils.truncateText(nodes[d.source.index].name, 25)} → ${utils.truncateText(nodes[d.target.index].name, 25)}</div><div>Value: ${utils.formatMoney(d.value)}</div>`; 
      })
      .on('mouseout', function() { 
        d3.select(this).attr('stroke-opacity', 0.55); 
        const tt = elements.sankeyTooltip;
        tt.style.opacity = 0; 
        tt.style.display = 'none';
      })
      .on('click', function(ev, d) { 
        const sn = nodes[d.source.index], tn = nodes[d.target.index]; 
        if (sn.type === 'agency' && tn.type === 'office') { 
          filterManager.applySelectionFilter('agency', sn.name, null); 
          elements.agencyFilter.value = sn.name; 
        } else if (sn.type === 'office' && tn.type === 'vendor') { 
          filterManager.applySelectionFilter('office', sn.name, null); 
          elements.officeFilter.value = sn.name; 
        } 
      });
    const node = svg.append('g')
      .attr('stroke', 'none')
      .selectAll('rect')
      .data(nodes)
      .join('rect')
      .attr('x', d => d.x0)
      .attr('y', d => d.y0)
      .attr('height', d => Math.max(1, d.y1 - d.y0))
      .attr('width', d => d.x1 - d.x0)
      .attr('fill', d => d.color)
      .attr('rx', 4)
      .attr('ry', 4)
      .on('mouseover', function(ev, d) { 
        d3.select(this).attr('fill', d3.color(d.color).darker(0.3));
        link.attr('stroke-opacity', l => l.source.index === d.index || l.target.index === d.index ? 0.85 : 0.1); 
        const tt = elements.sankeyTooltip; 
        tt.style.display = 'block';
        tt.style.opacity = 1; 
        tt.style.left = (ev.pageX + 15) + 'px'; 
        tt.style.top = (ev.pageY - 15) + 'px'; 
        tt.innerHTML = `<div style="font-weight:600;">${utils.truncateText(d.name, 30)}</div><div style="font-size:12px;">Type: ${d.type.charAt(0).toUpperCase() + d.type.slice(1)}</div><div style="font-size:12px;">Total Flow: ${utils.formatMoney(d.value)}</div>`; 
      })
      .on('mouseout', function(ev, d) { 
        d3.select(this).attr('fill', d.color);
        link.attr('stroke-opacity', 0.55); 
        const tt = elements.sankeyTooltip;
        tt.style.opacity = 0; 
        tt.style.display = 'none';
      })
      .on('click', function(ev, d) { 
        if (d.type === 'agency') { 
          filterManager.applySelectionFilter('agency', d.name, null); 
          elements.agencyFilter.value = d.name; 
        } else if (d.type === 'office') { 
          filterManager.applySelectionFilter('office', d.name, null); 
          elements.officeFilter.value = d.name; 
        } else if (d.type === 'vendor') { 
          filterManager.applySelectionFilter('vendor', d.name, null); 
          elements.vendorFilter.value = d.name; 
        } 
      });
    // Sharper text rendering
    svg.append('g')
      .attr('font-family', 'var(--font-sans)')
      .attr('font-size', 11)
      .attr('font-weight', 500)
      .attr('text-rendering', 'geometricPrecision') // Improve text sharpness
      .selectAll('text')
      .data(nodes)
      .join('text')
      .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
      .attr('y', d => (d.y1 + d.y0) / 2)
      .attr('dy', '0.35em')
      .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
      .attr('fill', getComputedStyle(document.documentElement).getPropertyValue('--text-primary'))
      .text(d => utils.truncateText(d.name, (d.x1 - d.x0 > 60) ? 30 : 20));
  } catch (sankeyError) {
    console.error("Error rendering Sankey chart:", sankeyError);
    elements.sankeyChartContainer.innerHTML = '<p style="text-align:center; padding-top:var(--space-6); color:var(--text-secondary);">Error rendering Sankey chart. Please try adjusting filters.</p>';
  }
},
  addChartClickEvents: function() {
    elements.valueTimeChartContainer.addEventListener('click', function(ev) { 
      const chart = app.charts.valueTimeChart;
      const ap = chart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, false); 
      if (ap.length > 0) { 
        const label = chart.data.labels[ap[0].index];
        const match = label.match(/(\w+)\s*'?(\d+)?/); 
        if (match) { 
          const mn = match[1];
          const ys = match[2] || new Date().getFullYear().toString().substr(2);
          const mMap = { 'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5, 'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11 }; 
          if (mMap[mn] !== undefined) { 
            const fullYear = parseInt('20' + ys);
            const startDate = new Date(fullYear, mMap[mn], 1);
            const endDate = new Date(fullYear, mMap[mn] + 1, 0);
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0]; 
            elements.startDate.value = startDateStr; 
            elements.endDate.value = endDateStr; 
            app.filters.startDate = startDateStr; 
            app.filters.endDate = endDateStr; 
            if (app.selection.type) { 
              delete app.filters[app.selection.type]; 
              app.selection = { type: null, value: null, container: null }; 
              document.querySelectorAll('.selection-indicator').forEach(i => i.style.display = 'none'); 
            } 
            filterManager.applyFilters(); 
            filterManager.updateFilterTags(); 
            dashboardManager.refreshDashboard(); 
          } 
        } 
      } 
    });
    elements.agencyChartContainer.addEventListener('click', function(ev) { 
      const chart = app.charts.agencyChart;
      const ap = chart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, false); 
      if (ap.length > 0) { 
        const label = chart.data.labels[ap[0].index];
        const agencyName = Object.keys(app.agencies).find(name => name === label || label.includes(name)); 
        if (agencyName) { 
          filterManager.applySelectionFilter('agency', agencyName, elements.agencyChartContainer); 
          elements.agencyFilter.value = agencyName; 
        } 
      } 
    });
    elements.naicsBubbleChartContainer.addEventListener('click', function(ev) { 
      const chart = app.charts.naicsBubbleChart;
      const ap = chart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, false); 
      if (ap.length > 0) { 
          const dataPoint = chart.data.datasets[ap[0].datasetIndex].data[ap[0].index];
          const fullLabel = dataPoint.label;
          const naicsCodeMatch = fullLabel.match(/^(\d[\d\w.-]*)/); 
          if (naicsCodeMatch && naicsCodeMatch[1]) {
              const naicsCode = naicsCodeMatch[1];
              filterManager.applySelectionFilter('naics', naicsCode, elements.naicsBubbleChartContainer); 
              elements.naicsFilter.value = naicsCode;
          }
      } 
    });
    elements.vendorChartContainer.addEventListener('click', function(ev) { 
      const chart = app.charts.vendorChart;
      const ap = chart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, false); 
      if (ap.length > 0) { 
        const label = chart.data.labels[ap[0].index];
        const vendorName = Object.keys(app.vendors).find(name => name === label || label.includes(name) || name.includes(label)); 
        if (vendorName) { 
          filterManager.applySelectionFilter('vendor', vendorName, elements.vendorChartContainer); 
          elements.vendorFilter.value = vendorName; 
        } 
      } 
    });
  },
  resizeAllCharts: function() {
    Object.values(app.charts).forEach(chartInstance => { 
      if (chartInstance instanceof Chart) {
        chartInstance.resize();
        chartInstance.update('none');
      }
    });
    this.updateSankeyChart();
  },
  updateCharts: function() { 
    this.updateValueTimeChart(); 
    this.updateAgencyChart(); 
    this.updateNaicsBubbleChart(); 
    this.updateVendorChart(); 
    this.updateSankeyChart(); 
  },
  updateValueTimeChart: function() { 
    const data = app.filteredData; 
    if (!data || data.length === 0) return; 
    const valueByMonth = {}; 
    data.forEach(c => { 
      if (c.parsedDate) { 
        const monthYear = `${c.parsedDate.getFullYear()}-${(c.parsedDate.getMonth() + 1).toString().padStart(2, '0')}`; 
        if (!valueByMonth[monthYear]) valueByMonth[monthYear] = 0; 
        valueByMonth[monthYear] += c.value; 
      } 
    }); 
    const sortedMonths = Object.keys(valueByMonth).sort();
    const labels = [], values = []; 
    sortedMonths.forEach(m => { 
      const [year, monthNum] = m.split('-');
      const date = new Date(parseInt(year), parseInt(monthNum) - 1, 1); 
      labels.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })); 
      values.push(valueByMonth[m]); 
    }); 
    const chart = app.charts.valueTimeChart; 
    chart.data.labels = labels; 
    chart.data.datasets[0].data = values; 
    chart.update(); 
  },
  updateAgencyChart: function() { 
    const data = app.filteredData; 
    if (!data || data.length === 0) return; 
    const valueByAgency = {}; 
    data.forEach(c => { 
      if (c.agency) { 
        if (!valueByAgency[c.agency]) valueByAgency[c.agency] = 0; 
        valueByAgency[c.agency] += c.value; 
      } 
    }); 
    const agencies = Object.keys(valueByAgency).map(a => ({ name: a, value: valueByAgency[a] })).sort((a, b) => b.value - a.value).slice(0, 8);
    const chart = app.charts.agencyChart; 
    chart.data.labels = agencies.map(a => utils.truncateText(a.name, 15)); 
    chart.data.datasets[0].data = agencies.map(a => a.value); 
    chart.data.datasets[0].backgroundColor = agencies.map(a => utils.getEntityColor(a.name, 'agency')); 
    chart.update(); 
  },
  updateNaicsBubbleChart: function() { 
    if (!app.charts.naicsBubbleChart) return;
    const data = app.filteredData; 
    const naicsData = {}; 
    data.forEach(c => { 
        if (c.naics) { 
            if (!naicsData[c.naics]) naicsData[c.naics] = { code: c.naics, description: c.naicsDescription || c.naics, count: 0, value: 0 }; 
            naicsData[c.naics].count++; 
            naicsData[c.naics].value += c.value; 
        } 
    }); 
    const topNaics = Object.values(naicsData).filter(n => n.count > 0 && n.value > 0).sort((a, b) => b.value - a.value).slice(0, 25); 
    if (topNaics.length === 0) return;
    const values = topNaics.map(n => n.value);
    const counts = topNaics.map(n => n.count);
    const maxValue = Math.max(...values, 1);
    const maxCount = Math.max(...counts, 1);
    const minValue = Math.min(...values, 1000);
    const minCount = Math.min(...counts, 1);
    const radiusScale = d3.scaleSqrt().domain([minValue, maxValue]).range([6, 25]);
    const chart = app.charts.naicsBubbleChart; 
    chart.options.scales.x.min = Math.max(1, minCount * 0.5);
    chart.options.scales.x.max = Math.min(100000, maxCount * 2);
    chart.options.scales.y.min = Math.max(1000, minValue * 0.1);
    chart.options.scales.y.max = Math.min(1000000000000, maxValue * 10);
    chart.data.datasets = [{ 
        label: topNaics.map(n => `${n.code} - ${utils.truncateText(n.description, 30)}`),
        data: topNaics.map(n => ({ 
            x: n.count, 
            y: n.value, 
            r: radiusScale(n.value),
            label: `${n.code} - ${n.description}`
        })), 
        backgroundColor: topNaics.map(n => utils.getEntityColorWithOpacity(n.code, 0.7, 'naics')), 
        borderColor: topNaics.map(n => utils.getEntityColor(n.code, 'naics')), 
        borderWidth: 1.5 
    }]; 
    chart.update(); 
  },
  updateVendorChart: function() { 
    const data = app.filteredData; 
    if (!data || data.length === 0) return; 
    const valueByVendor = {}; 
    data.forEach(c => { 
      if (c.vendor) { 
        if (!valueByVendor[c.vendor]) valueByVendor[c.vendor] = 0; 
        valueByVendor[c.vendor] += c.value; 
      } 
    }); 
    const vendors = Object.keys(valueByVendor).map(v => ({ name: v, value: valueByVendor[v] })).sort((a, b) => b.value - a.value).slice(0, 8);
    const chart = app.charts.vendorChart; 
    chart.data.labels = vendors.map(v => utils.truncateText(v.name, 12)); 
    chart.data.datasets[0].data = vendors.map(v => v.value); 
    chart.data.datasets[0].backgroundColor = vendors.map(v => utils.getEntityColor(v.name, 'vendor')); 
    chart.update(); 
  }
};
const tableManager = {
 initTableSorting: function() { 
   document.querySelectorAll('th[data-sort]').forEach(h => { 
     h.addEventListener('click', function() { 
       const table = this.closest('table');
       if (!table) return;
       const tbody = table.querySelector('tbody');
       if (!tbody) return;
       const rowsArray = Array.from(tbody.querySelectorAll('tr'));
       const sortField = this.getAttribute('data-sort'); 
       let sortDirection = 'asc'; 
       if (this.classList.contains('sort-asc')) { sortDirection = 'desc'; } 
       else if (this.classList.contains('sort-desc')) { sortDirection = 'asc'; }
       table.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc', 'sort-desc')); 
       this.classList.add(`sort-${sortDirection}`); 
       const compareFn = function(a, b) { 
         const cellA = a.querySelector(`td:nth-child(${Array.from(this.parentNode.children).indexOf(this) + 1})`);
         const cellB = b.querySelector(`td:nth-child(${Array.from(this.parentNode.children).indexOf(this) + 1})`);
         if (!cellA || !cellB) return 0;
         let valA = cellA.textContent.trim(), valB = cellB.textContent.trim(); 
         if (sortField === 'value' || sortField === 'contracts') { 
           valA = utils.parseMoney(valA); valB = utils.parseMoney(valB); 
         } else if (sortField === 'date') { 
           valA = utils.parseDate(valA)?.getTime() || 0; valB = utils.parseDate(valB)?.getTime() || 0; 
         } else { 
           valA = valA.toLowerCase(); valB = valB.toLowerCase();
         }
         if (valA < valB) return sortDirection === 'asc' ? -1 : 1; 
         if (valA > valB) return sortDirection === 'asc' ? 1 : -1; 
         return 0; 
       }.bind(this); 
       rowsArray.sort(compareFn).forEach(r => tbody.appendChild(r)); 
     }); 
   }); 
 },
 updateContractsTable: function() { 
   if (!elements.contractsTable) return;
   const data = app.filteredData, tbody = elements.contractsTable; tbody.innerHTML = ''; 
   [...data].sort((a, b) => (b.parsedDate?.getTime() || 0) - (a.parsedDate?.getTime() || 0)).slice(0, 15).forEach(c => this.addContractRow(c, tbody)); 
 },
 updateLargestContractsTable: function() { 
   if (!elements.largestContractsTable) return;
   const data = app.filteredData, tbody = elements.largestContractsTable; tbody.innerHTML = ''; 
   [...data].sort((a, b) => b.value - a.value).slice(0, 15).forEach(c => this.addContractRow(c, tbody)); 
 },
 addContractRow: function(contract, tbody) { 
  const row = document.createElement('tr'); 
  const agencyInitials = utils.getInitials(contract.agency), agencyColor = utils.stringToColor(contract.agency);
  const officeInitials = utils.getInitials(contract.office), officeColor = utils.stringToColor(contract.office);
  const vendorInitials = utils.getInitials(contract.vendor), vendorColor = utils.stringToColor(contract.vendor); 
  row.innerHTML = `
      <td class="table-date-cell">${utils.formatDate(contract.date)}</td>
      <td class="table-contract-id">${utils.truncateText(contract.id, 15)}</td>
      <td><div class="agency-badge" title="${contract.agency}"><div class="agency-icon" style="background-color:${agencyColor}">${agencyInitials}</div> ${utils.truncateText(contract.agency,15)}</div></td>
      <td><div class="office-badge" title="${contract.office}"><div class="office-icon" style="background-color:${officeColor}">${officeInitials}</div> ${utils.truncateText(contract.office,15)}</div></td>
      <td><div class="vendor-badge" title="${contract.vendor}"><div class="vendor-icon" style="background-color:${vendorColor}">${vendorInitials}</div> ${utils.truncateText(contract.vendor,15)}</div></td>
      <td title="${contract.description}">${utils.truncateText(contract.description,30)}</td>
      <td class="money table-value-cell">${utils.formatMoney(contract.value)}</td>
      <td class="table-actions-cell"><button class="btn btn-sm btn-primary view-contract" data-id="${contract.id}"><span class="btn-text">Details</span></button></td>`; 
  tbody.appendChild(row); 
  const viewButton = row.querySelector('.view-contract');
  if(viewButton) viewButton.addEventListener('click', function() { tableManager.showContractDetails(this.getAttribute('data-id')); }); 
},
 updateOfficesTable: function() { 
   if (!elements.officesTable) return;
   const data = app.filteredData, tbody = elements.officesTable; tbody.innerHTML = ''; 
   const officeData = {}; 
   data.forEach(c => { 
       if (c.office) { 
           if (!officeData[c.office]) officeData[c.office] = { name: c.office, agency: c.agency, count: 0, value: 0, naicsCodes: {}, vendors: {} }; 
           officeData[c.office].count++; officeData[c.office].value += c.value; 
           if (c.naics) { 
               if (!officeData[c.office].naicsCodes[c.naics]) officeData[c.office].naicsCodes[c.naics] = { code: c.naics, description: c.naicsDescription, count: 0, value: 0 }; 
               officeData[c.office].naicsCodes[c.naics].count++; officeData[c.office].naicsCodes[c.naics].value += c.value; 
           } 
           if (c.vendor) { 
               if (!officeData[c.office].vendors[c.vendor]) officeData[c.office].vendors[c.vendor] = { name: c.vendor, count: 0, value: 0 }; 
               officeData[c.office].vendors[c.vendor].count++; officeData[c.office].vendors[c.vendor].value += c.value; 
           } 
       } 
   }); 
   Object.values(officeData).sort((a, b) => b.value - a.value).slice(0, 10).forEach(office => { 
       const topNaics = Object.values(office.naicsCodes).sort((a, b) => b.value - a.value)[0] || { code: 'N/A', description: 'N/A' }; 
       const topVendor = Object.values(office.vendors).sort((a, b) => b.value - a.value)[0] || { name: 'N/A' }; 
       const agencyInitials = utils.getInitials(office.agency), agencyColor = utils.stringToColor(office.agency);
       const officeInitials = utils.getInitials(office.name), officeColor = utils.stringToColor(office.name);
       const vendorInitials = utils.getInitials(topVendor.name), vendorColor = utils.stringToColor(topVendor.name); 
       const row = document.createElement('tr'); 
       row.innerHTML = `
           <td><div class="agency-badge" title="${office.agency}"><div class="agency-icon" style="background-color:${agencyColor}">${agencyInitials}</div> ${utils.truncateText(office.agency,15)}</div></td>
           <td><div class="office-badge" title="${office.name}"><div class="office-icon" style="background-color:${officeColor}">${officeInitials}</div> ${utils.truncateText(office.name,15)}</div></td>
           <td>${office.count.toLocaleString()}</td>
           <td class="money">${utils.formatMoney(office.value)}</td>
           <td><span class="badge badge-primary" title="${topNaics.description}">${topNaics.code}</span></td>
           <td><div class="vendor-badge" title="${topVendor.name}"><div class="vendor-icon" style="background-color:${vendorColor}">${vendorInitials}</div> ${utils.truncateText(topVendor.name,15)}</div></td>`; 
       tbody.appendChild(row); 
       row.addEventListener('click', function() { filterManager.applySelectionFilter('office', office.name, null); if(elements.officeFilter) elements.officeFilter.value = office.name; }); 
   }); 
 },
/* Update to the showContractDetails function to include FPDS.gov link */
showContractDetails: function(contractId) { 
  const contract = app.data.find(c => c.id === contractId); 
  if (!contract) { 
    console.error('Contract not found:', contractId);
    return; 
  } 
  // Create FPDS.gov URL with contract ID
  const fpdsUrl = `https://www.fpds.gov/ezsearch/fpdsportal?q=PIID%3A%22${encodeURIComponent(contract.id)}%22&s=FPDS.GOV&templateName=1.5.3&indexName=awardfull&x=0&y=0`;
  const agencyInitials = utils.getInitials(contract.agency), agencyColor = utils.stringToColor(contract.agency);
  const officeInitials = utils.getInitials(contract.office), officeColor = utils.stringToColor(contract.office);
  const vendorInitials = utils.getInitials(contract.vendor), vendorColor = utils.stringToColor(contract.vendor); 
  elements.contractModalBody.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:1.5rem;">
          <div>
              <h4 style="margin-bottom:0.75rem;font-size:1.1rem;color:var(--primary);">Contract Information</h4>
              <p><strong>Contract ID:</strong> ${contract.id}</p>
              <p><strong>Reference IDV:</strong> ${contract.reference||'N/A'}</p>
              <p><strong>Date Signed:</strong> ${utils.formatDate(contract.date)}</p>
              <p><strong>Contract Type:</strong> ${contract.type||'N/A'}</p>
              <p><strong>Value:</strong> <span class="money">${utils.formatMoney(contract.value)}</span></p>
              <p style="margin-top:0.75rem;">
                <a href="${fpdsUrl}" class="btn btn-sm btn-secondary" target="_blank" rel="noopener noreferrer" style="text-decoration:none;">
                  <i class="fas fa-external-link-alt"></i>
                  <span class="btn-text">View on FPDS.gov</span>
                </a>
              </p>
          </div>
          <div>
              <h4 style="margin-bottom:0.75rem;font-size:1.1rem;color:var(--primary);">Parties Involved</h4>
              <p style="display:flex;align-items:center;margin-bottom:0.5rem;"><div class="agency-icon" style="background-color:${agencyColor};margin-right:0.5rem;">${agencyInitials}</div><strong>Agency:</strong> ${contract.agency}</p>
              <p style="display:flex;align-items:center;margin-bottom:0.5rem;"><div class="office-icon" style="background-color:${officeColor};margin-right:0.5rem;">${officeInitials}</div><strong>Office:</strong> ${contract.office||'N/A'}</p>
              <p style="display:flex;align-items:center;margin-bottom:0.5rem;"><div class="vendor-icon" style="background-color:${vendorColor};margin-right:0.5rem;">${vendorInitials}</div><strong>Vendor:</strong> ${contract.vendor}</p>
          </div>
      </div>
      <div style="margin-top:1.5rem;">
          <h4 style="margin-bottom:0.75rem;font-size:1.1rem;color:var(--primary);">Description & Codes</h4>
          <p><strong>Description:</strong> ${contract.description||'No description available.'}</p>
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:1rem;margin-top:1rem;">
              <div><p><strong>NAICS:</strong> ${contract.naics||'N/A'}</p><p style="font-size:var(--font-xs);color:var(--text-secondary);">${contract.naicsDescription||''}</p></div>
              <div><p><strong>PSC:</strong> ${contract.psc||'N/A'}</p><p style="font-size:var(--font-xs);color:var(--text-secondary);">${contract.pscDescription||''}</p></div>
          </div>
      </div>
      <div style="margin-top:1.5rem;display:flex;gap:0.75rem;flex-wrap:wrap;justify-content:center;">
          <button id="modalFilterByAgency" class="btn btn-sm btn-secondary"><i class="fas fa-filter"></i> <span class="btn-text">Filter by Agency</span></button>
          <button id="modalFilterByOffice" class="btn btn-sm btn-secondary"><i class="fas fa-filter"></i> <span class="btn-text">Filter by Office</span></button>
          <button id="modalFilterByVendor" class="btn btn-sm btn-secondary"><i class="fas fa-filter"></i> <span class="btn-text">Filter by Vendor</span></button>
      </div>`; 
  elements.contractModal.classList.add('active'); 
  document.getElementById('modalFilterByAgency')?.addEventListener('click', () => { filterManager.applySelectionFilter('agency', contract.agency, elements.agencyChartContainer); if(elements.agencyFilter) elements.agencyFilter.value = contract.agency; this.hideContractDetails(); }); 
  document.getElementById('modalFilterByOffice')?.addEventListener('click', () => { filterManager.applySelectionFilter('office', contract.office, null); if(elements.officeFilter) elements.officeFilter.value = contract.office; this.hideContractDetails(); }); 
  document.getElementById('modalFilterByVendor')?.addEventListener('click', () => { filterManager.applySelectionFilter('vendor', contract.vendor, elements.vendorChartContainer); if(elements.vendorFilter) elements.vendorFilter.value = contract.vendor; this.hideContractDetails(); }); 
},
 hideContractDetails: function() { elements.contractModal.classList.remove('active'); },
 updateTables: function() { this.updateContractsTable(); this.updateLargestContractsTable(); this.updateOfficesTable(); }
};
const dashboardManager = {
 initDashboard: function() { 
   if (!elements.loadingIndicator || !elements.errorMessage || !elements.noDataMessage || !elements.dashboard || !elements.statusBox) {
       console.error("One or more critical dashboard elements are missing from the DOM.");
       return;
   }
   elements.loadingIndicator.style.display = 'none'; 
   elements.errorMessage.style.display = 'none'; 
   elements.noDataMessage.style.display = 'none'; 
   elements.dashboard.style.display = 'flex'; 
   elements.statusBox.style.display = 'flex'; 
   chartManager.initCharts(); 
   tableManager.initTableSorting(); 
   this.refreshDashboard(); 
 },
 refreshDashboard: function() { 
   this.updateStats(); chartManager.updateCharts(); tableManager.updateTables(); filterManager.updateFilterTags(); updateInsightBanner(app.filteredData, app.filters.psc);
 },
 updateStats: function() { 
   const d = app.filteredData; 
   if(elements.totalContracts) elements.totalContracts.textContent = d.length.toLocaleString(); 
   if(elements.totalValue) elements.totalValue.textContent = utils.formatMoney(d.reduce((s, c) => s + c.value, 0)); 
   if(elements.avgValue) elements.avgValue.textContent = utils.formatMoney(d.length > 0 ? d.reduce((s, c) => s + c.value, 0) / d.length : 0); 
   if(elements.uniqueVendors) elements.uniqueVendors.textContent = new Set(d.map(c => c.vendor).filter(Boolean)).size.toLocaleString(); 
 }
};
const fileHandler = {
 processAndDisplayCsv: function(csvText, fileNameForDisplay = "Uploaded Data") {
   try {
     filterManager.resetFilters(); 
     const csvData = utils.parseCSV(csvText);
     const processedData = dataProcessor.processData(csvData);
     app.data = processedData; 
     app.filteredData = [...processedData]; 
     const analysis = dataProcessor.analyzeData(processedData);
     app.agencies = analysis.agencies; app.offices = analysis.offices; app.vendors = analysis.vendors;
     app.naicsCodes = analysis.naicsCodes; app.pscCodes = analysis.pscCodes;
     this.populateFilterDropdowns();
     dashboardManager.initDashboard(); 
	 updateInsightBanner(app.filteredData);
     const uploadBtnTextSpan = elements.uploadBtn.querySelector('.btn-text');
     if(uploadBtnTextSpan) uploadBtnTextSpan.textContent = 'Upload';
     elements.csvFile.value = ''; 
   } catch (error) {
     console.error('Error processing CSV data:', error);
     this.showError(`Error processing ${fileNameForDisplay}: ${error.message}`);
     if(app.data.length === 0) {
       elements.dashboard.style.display = 'none';
       elements.statusBox.style.display = 'none'; 
       elements.noDataMessage.style.display = 'flex';
     }
   } finally {
     elements.loadingIndicator.style.display = 'none';
   }
 },
 loadCsvFromUrl: async function(csvUrl, fileNameForDisplay) {
    const timestamp = new Date().getTime();
	const noCacheUrl = `${csvUrl}?t=${timestamp}`;
    elements.loadingIndicator.style.display = 'flex';
   elements.errorMessage.style.display = 'none';
   elements.noDataMessage.style.display = 'none'; 
   elements.dashboard.style.display = 'none'; 
   elements.statusBox.style.display = 'none'; 
   try {
     const response = await fetch(noCacheUrl);
     if (!response.ok) {
       throw new Error(`Network response was not ok: ${response.status} ${response.statusText} for ${fileNameForDisplay}`);
     }
     const csvText = await response.text();
     this.processAndDisplayCsv(csvText, fileNameForDisplay);
   } catch (error) {
     console.error(`Error fetching CSV from ${csvUrl}:`, error);
     this.showError(`Failed to load ${fileNameForDisplay}: ${error.message}. Check S3 CORS policy and file path.`);
     elements.loadingIndicator.style.display = 'none';
     if(app.data.length === 0) {
       elements.noDataMessage.style.display = 'flex';
     } else {
       elements.dashboard.style.display = 'flex';
       elements.statusBox.style.display = 'flex';
     }
   }
 },
 handleFileUpload: function() {
   const file = elements.csvFile.files[0];
   if (!file) return;
   const fileName = file.name.toLowerCase();
   const isValidExtension = fileName.endsWith('.csv') || fileName.endsWith('.xls');
   if (!isValidExtension) {
     this.showError('Please upload a valid CSV file (or .xls if from iOS).');
     elements.csvFile.value = '';
     return;
   }
   elements.loadingIndicator.style.display = 'flex';
   elements.errorMessage.style.display = 'none';
   elements.noDataMessage.style.display = 'none';
   elements.dashboard.style.display = 'none';
   elements.statusBox.style.display = 'none';
   const reader = new FileReader();
   reader.onload = (event) => {
     this.processAndDisplayCsv(event.target.result, file.name);
     const uploadBtnTextSpan = elements.uploadBtn.querySelector('.btn-text');
     if (uploadBtnTextSpan) {
       uploadBtnTextSpan.textContent = ` ${utils.truncateText(file.name, 10)}`;
     }
   };
   reader.onerror = () => {
     this.showError('Error reading the file.');
     elements.loadingIndicator.style.display = 'none';
     if (app.data.length === 0) {
       elements.noDataMessage.style.display = 'flex';
     } else {
       elements.dashboard.style.display = 'flex';
       elements.statusBox.style.display = 'flex';
     }
   };
   reader.readAsText(file);
 },
 showError: function(message) { elements.errorMessage.textContent = message; elements.errorMessage.style.display = 'block'; },
 populateFilterDropdowns: function() {
   const pop = function(el, it, vf, lf) { 
     while (el.options.length > 1) el.remove(1); 
     [...it].sort((a, b) => b.count - a.count).slice(0, 100).forEach(i => { 
       const o = document.createElement('option'); 
       o.value = i[vf]; 
       o.textContent = lf(i); 
       el.appendChild(o); 
     }); 
   };
   pop(elements.agencyFilter, Object.values(app.agencies), 'name', i => `${utils.truncateText(i.name, 30)} (${i.count})`);
   pop(elements.officeFilter, Object.values(app.offices), 'name', i => `${utils.truncateText(i.name, 30)} (${i.count})`);
   pop(elements.naicsFilter, Object.values(app.naicsCodes), 'code', i => `${i.code} - ${utils.truncateText(i.description, 25)} (${i.count})`);
   pop(elements.pscFilter, Object.values(app.pscCodes), 'code', i => `${i.code} - ${utils.truncateText(i.description, 25)} (${i.count})`);
   pop(elements.vendorFilter, Object.values(app.vendors), 'name', i => `${utils.truncateText(i.name, 30)} (${i.count})`);
 }
};
function setupEventListeners() {
  if(elements.csvFile) elements.csvFile.addEventListener('change', () => fileHandler.handleFileUpload());
  // Example 1 button (works)
if(elements.loadExample1Btn) elements.loadExample1Btn.addEventListener('click', () => { 
  fileHandler.loadCsvFromUrl(app.s3BaseUrl + 'ytd.csv', 'YTD > $100K (ytd.csv)'); 
  updateExampleButtonActiveState(elements.loadExample1Btn); 
});
// Example 2 button (works)
if(elements.loadExample2Btn) elements.loadExample2Btn.addEventListener('click', () => { 
  fileHandler.loadCsvFromUrl(app.s3BaseUrl + 'da10.csv', 'SaaS 3YR (da10.csv)'); 
  updateExampleButtonActiveState(elements.loadExample2Btn); 
});

// Example 4 button (not working - fixed version)
if(elements.loadExample4Btn) elements.loadExample4Btn.addEventListener('click', () => { 
  fileHandler.loadCsvFromUrl(app.s3BaseUrl + 'vmware.csv', 'VMware (vmware.csv)'); 
  updateExampleButtonActiveState(elements.loadExample4Btn); 
});
  let searchTimeout;
  if(elements.searchInput) elements.searchInput.addEventListener('input', () => { 
      clearTimeout(searchTimeout); 
      searchTimeout = setTimeout(() => { 
          app.filters.search = elements.searchInput.value; 
          filterManager.applyFilters(); 
          dashboardManager.refreshDashboard(); 
      }, 400); 
  });
  const addFilterListener = function(el, filterKey, chartContainerForSelection) {
    if (el) {
        el.addEventListener('change', () => {
            const value = el.value;
            if (value) app.filters[filterKey] = value;
            else delete app.filters[filterKey];
            if (['agency', 'vendor', 'naics', 'psc', 'office'].includes(filterKey)) {
                 filterManager.applySelectionFilter(filterKey, value, chartContainerForSelection);
            } else { 
                filterManager.applyFilters();
                dashboardManager.refreshDashboard();
            }
        });
    }
  };
  if(elements.pscFilter) {
  elements.pscFilter.addEventListener('change', () => {
    const value = elements.pscFilter.value;
    if (value) app.filters.psc = value;
    else delete app.filters.psc;
    updateInsightsAfterFilter();
  });
}
  addFilterListener(elements.agencyFilter, 'agency', elements.agencyChartContainer);
  addFilterListener(elements.vendorFilter, 'vendor', elements.vendorChartContainer);
  addFilterListener(elements.pscFilter, 'psc', null); 
  if(elements.valueFilter) elements.valueFilter.addEventListener('change', () => { 
    const r = elements.valueFilter.value; 
    if (r) { 
      const v = utils.parseValueRange(r); 
      if (v) app.filters.valueRange = v; 
      else delete app.filters.valueRange; 
    } else delete app.filters.valueRange; 
    filterManager.applyFilters(); 
    dashboardManager.refreshDashboard(); 
  });
  if(elements.startDate) elements.startDate.addEventListener('change', () => { 
    app.filters.startDate = elements.startDate.value; 
    filterManager.applyFilters(); 
    dashboardManager.refreshDashboard(); 
  });
  if(elements.endDate) elements.endDate.addEventListener('change', () => { 
    app.filters.endDate = elements.endDate.value; 
    filterManager.applyFilters(); 
    dashboardManager.refreshDashboard(); 
  });
  addFilterListener(elements.officeFilter, 'office', null); 
  addFilterListener(elements.naicsFilter, 'naics', elements.naicsBubbleChartContainer); 
  if(elements.moreFiltersBtn) elements.moreFiltersBtn.addEventListener('click', () => elements.advancedFiltersPanel.classList.toggle('active'));
  if(elements.closeFilters) elements.closeFilters.addEventListener('click', () => elements.advancedFiltersPanel.classList.remove('active'));
  // Remove the mobile filter button event listener - we're hiding it with CSS
  if(elements.resetFilters) elements.resetFilters.addEventListener('click', () => { 
    filterManager.resetFilters(); 
    if(elements.advancedFiltersPanel) elements.advancedFiltersPanel.classList.remove('active'); 
  });
  elements.tabButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      elements.tabButtons.forEach(b => b.classList.remove('active'));
      elements.tabContents.forEach(c => c.classList.remove('active'));
      this.classList.add('active');
      const tabId = this.getAttribute('data-tab') + 'Tab';
      const tabContent = document.getElementById(tabId);
      if (tabContent) {
        tabContent.classList.add('active');
      }
    });
  });
  if(elements.closeModal) elements.closeModal.addEventListener('click', () => tableManager.hideContractDetails());
  if(elements.closeModalBtn) elements.closeModalBtn.addEventListener('click', () => tableManager.hideContractDetails());
  if(elements.contractModal) elements.contractModal.addEventListener('click', e => { if (e.target === elements.contractModal) tableManager.hideContractDetails(); });
  let resizeTimer;
  window.addEventListener('resize', () => { 
      clearTimeout(resizeTimer); 
      resizeTimer = setTimeout(() => { 
          if (elements.dashboard && elements.dashboard.style.display !== 'none') { 
              chartManager.resizeAllCharts();
          } 
      }, 150); 
  });
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      if (elements.dashboard && elements.dashboard.style.display !== 'none') { 
        chartManager.resizeAllCharts();
      }
    }, 300);
  });
}
function initThemeToggle() {
 const themeToggle = document.getElementById('color-scheme');
 const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
 themeToggle.checked = currentTheme === 'dark';
 themeToggle.addEventListener('change', function() {
   const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
   const newTheme = currentTheme === 'light' ? 'dark' : 'light';
   document.documentElement.setAttribute('data-theme', newTheme);
   localStorage.setItem('theme', newTheme);
   if (app.charts && Object.keys(app.charts).length > 0 && typeof Chart !== 'undefined') {
     Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
     Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
     Object.values(app.charts).forEach(chartInstance => {
       if (chartInstance instanceof Chart) {
         if (chartInstance.options.scales) {
           Object.values(chartInstance.options.scales).forEach(scale => {
             if (scale.ticks) scale.ticks.color = Chart.defaults.color;
             if (scale.grid) scale.grid.color = Chart.defaults.borderColor + '80';
             if (scale.title && scale.title.display) scale.title.color = Chart.defaults.color;
           });
         }
         if (chartInstance.config.type === 'line' && chartInstance.data.datasets.length > 0) {
           chartInstance.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
           chartInstance.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
           chartInstance.data.datasets[0].backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() + '26';
           chartInstance.data.datasets[0].pointBackgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
           chartInstance.data.datasets[0].pointBorderColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim();
         }
         chartInstance.update('none');
       }
     });
     if (elements.dashboard && elements.dashboard.style.display !== 'none') {
       setTimeout(() => chartManager.updateSankeyChart(), 50);
     }
   }
 });
}
function loadSavedTheme() {
 const savedTheme = localStorage.getItem('theme');
 let effectiveTheme = document.documentElement.getAttribute('data-theme') || 
                     (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
 if (savedTheme) { 
   document.documentElement.setAttribute('data-theme', savedTheme);
   effectiveTheme = savedTheme;
 } else {
   document.documentElement.setAttribute('data-theme', effectiveTheme); 
 }
 const themeToggle = document.getElementById('color-scheme');
 if (themeToggle) {
   themeToggle.checked = effectiveTheme === 'dark';
 }
}
function updateExampleButtonActiveState(activeButton) {
  const exampleButtons = [elements.loadExample1Btn, elements.loadExample2Btn, elements.loadExample4Btn];
  exampleButtons.forEach(button => {
    if (button) {
      if (button === activeButton) {
        button.classList.remove('btn-secondary');
        button.classList.add('btn-primary');
      } else {
        button.classList.remove('btn-primary');
        button.classList.add('btn-secondary');
      }
    }
  });
}
function init() {
  loadSavedTheme();
  initThemeToggle();
  setupEventListeners();
  mobileHeaderManager.init();
  fileHandler.loadCsvFromUrl(app.s3BaseUrl + 'vmware.csv', 'YTD Data (Initially Loaded)');
  setTimeout(setupMobileSearch, 500);
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
function setupMobileSearch() {
  // Do nothing on desktop - only run on mobile
  if (window.innerWidth >= 768) {
    // Remove mobile search if it exists when resizing to desktop
    const existingSearchBar = document.querySelector('.search-bar-container');
    if (existingSearchBar) {
      existingSearchBar.remove();
    }
    return;
  }
  // Continue with mobile search setup
  let searchBarContainer = document.querySelector('.search-bar-container');
  if (!searchBarContainer) {
    searchBarContainer = document.createElement('div');
    searchBarContainer.className = 'search-bar-container';
    searchBarContainer.innerHTML = `
      <div class="search-bar" style="position: relative; width: 100%;">
        <input type="text" id="mobileSearchInput" placeholder="Search contracts, agencies, vendors..." class="search-input">
      </div>
    `;
    const dashboard = document.getElementById('dashboard');
    if (dashboard && dashboard.firstChild) {
      dashboard.insertBefore(searchBarContainer, dashboard.firstChild);
    } else if (dashboard) {
      dashboard.appendChild(searchBarContainer);
    }
  }
  const mobileSearchInput = document.getElementById('mobileSearchInput');
  if (!mobileSearchInput) return;
  // Execute search function - called when typing stops or enter is pressed
  function executeSearch() {
    app.filters.search = mobileSearchInput.value;
    filterManager.applyFilters();
    dashboardManager.refreshDashboard();
  }
  // Handle Enter key
  mobileSearchInput.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      executeSearch();
      mobileSearchInput.blur(); // Close keyboard on Enter
    }
  });
  // Search as you type with debounce
  let searchTimeout;
  mobileSearchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(executeSearch, 500); // 500ms debounce
  });
  // Sync with main search if it exists
  if (elements.searchInput) {
    elements.searchInput.addEventListener('input', function() {
      mobileSearchInput.value = elements.searchInput.value;
    });
    mobileSearchInput.addEventListener('input', function() {
      elements.searchInput.value = mobileSearchInput.value;
    });
    if (app.filters.search) {
      mobileSearchInput.value = app.filters.search;
    }
  }
  // Connect reset button to mobile search
  if (elements.resetFilters) {
    const originalResetHandler = elements.resetFilters.onclick;
    elements.resetFilters.onclick = function(e) {
      // Clear mobile search
      if (mobileSearchInput) {
        mobileSearchInput.value = '';
      }
      // Call original handler if it exists
      if (typeof originalResetHandler === 'function') {
        originalResetHandler.call(this, e);
      } else {
        // Fallback reset logic if original handler is not available
        app.filters = {};
        app.selection = { type: null, value: null, container: null };
        // Clear all filter inputs
        if (elements.valueFilter) elements.valueFilter.value = '';
        if (elements.startDate) elements.startDate.value = '';
        if (elements.endDate) elements.endDate.value = '';
        if (elements.agencyFilter) elements.agencyFilter.value = '';
        if (elements.officeFilter) elements.officeFilter.value = '';
        if (elements.naicsFilter) elements.naicsFilter.value = '';
        if (elements.pscFilter) elements.pscFilter.value = '';
        if (elements.vendorFilter) elements.vendorFilter.value = '';
        if (elements.searchInput) elements.searchInput.value = '';
        // Clear indicators
        document.querySelectorAll('.selection-indicator').forEach(ind => ind.style.display = 'none');
        // Reset filtered data
        if (app.data && app.data.length) {
          app.filteredData = [...app.data];
        }
        // Update UI
        if (filterManager && filterManager.updateFilterTags) {
          filterManager.updateFilterTags();
        }
        if (dashboardManager && dashboardManager.refreshDashboard) {
          dashboardManager.refreshDashboard();
        }
        // Close advanced filters if open
        if (elements.advancedFiltersPanel) {
          elements.advancedFiltersPanel.classList.remove('active');
        }
      }
    };
  }
  // Also handle filter tag removal for search
  document.addEventListener('click', function(e) {
    if (e.target && e.target.closest('.filter-tag-remove') && 
        e.target.closest('.filter-tag-remove').getAttribute('data-filter') === 'search') {
      if (mobileSearchInput) {
        mobileSearchInput.value = '';
      }
    }
  }, true);
  // Scroll behavior
  let lastScrollY = window.scrollY;
  let scrollingDown = false;
  window.addEventListener('scroll', function() {
    const currentScrollY = window.scrollY;
    if (currentScrollY > lastScrollY) {
      if (!scrollingDown && currentScrollY > 100) {
        searchBarContainer.classList.add('hidden');
        scrollingDown = true;
      }
    } else {
      if (scrollingDown) {
        searchBarContainer.classList.remove('hidden');
        scrollingDown = false;
      }
    }
    lastScrollY = currentScrollY;
  });
}
// Ensure proper handling of resize events
window.addEventListener('resize', function() {
  clearTimeout(window.resizeTimer);
  window.resizeTimer = setTimeout(function() {
    // If we're now on desktop, remove mobile search
    if (window.innerWidth >= 768) {
      const existingSearchBar = document.querySelector('.search-bar-container');
      if (existingSearchBar) {
        existingSearchBar.remove();
      }
    } else {
      // If we're on mobile, set up mobile search
      setupMobileSearch();
    }
  }, 250);
});
// Add these functions to your existing app.js

// Function to analyze the data and generate market insights
function generateContractInsights(data) {
  if (!data || data.length === 0) return null;
  
  // Calculate total contract value
  const totalValue = data.reduce((sum, contract) => sum + contract.value, 0);
  
  // Get unique companies and their market share
  const companyData = {};
  data.forEach(contract => {
    if (!contract.vendor) return;
    
    if (!companyData[contract.vendor]) {
      companyData[contract.vendor] = {
        name: contract.vendor,
        value: 0,
        count: 0
      };
    }
    
    companyData[contract.vendor].value += contract.value;
    companyData[contract.vendor].count++;
  });
  
  // Convert to array and sort by value
  const companies = Object.values(companyData)
    .map(company => ({
      ...company,
      marketShare: (company.value / totalValue) * 100
    }))
    .sort((a, b) => b.value - a.value);
  
  // Get top company
  const topCompany = companies[0];
  
  // Calculate time-based trends
  const monthlyData = {};
  data.forEach(contract => {
    if (!contract.parsedDate) return;
    
    const monthYear = `${contract.parsedDate.getFullYear()}-${(contract.parsedDate.getMonth() + 1).toString().padStart(2, '0')}`;
    if (!monthlyData[monthYear]) {
      monthlyData[monthYear] = { value: 0, count: 0 };
    }
    
    monthlyData[monthYear].value += contract.value;
    monthlyData[monthYear].count++;
  });
  
  // Sort months and find trend
  const sortedMonths = Object.keys(monthlyData).sort();
  let trend = 'stable';
  if (sortedMonths.length > 1) {
    const firstMonth = monthlyData[sortedMonths[0]].value;
    const lastMonth = monthlyData[sortedMonths[sortedMonths.length - 1]].value;
    const percentChange = ((lastMonth - firstMonth) / firstMonth) * 100;
    
    if (percentChange > 15) trend = 'increasing';
    else if (percentChange < -15) trend = 'decreasing';
  }
  
  // Get PSC code breakdown
  const pscData = {};
  data.forEach(contract => {
    if (!contract.psc) return;
    
    if (!pscData[contract.psc]) {
      pscData[contract.psc] = {
        code: contract.psc,
        description: contract.pscDescription || '',
        value: 0,
        count: 0
      };
    }
    
    pscData[contract.psc].value += contract.value;
    pscData[contract.psc].count++;
  });
  
  // Get top PSC code
  const topPSC = Object.values(pscData)
    .sort((a, b) => b.value - a.value)[0];
  
  // Format money values
  const formatLargeValue = (value) => {
    if (value >= 1000000000) return `$${(value / 1000000000).toFixed(1)}B`;
    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
    if (value >= 1000) return `$${(value / 1000).toFixed(1)}K`;
    return `$${value.toFixed(0)}`;
  };
  
  return {
    totalValue: formatLargeValue(totalValue),
    totalContracts: data.length,
    totalCompanies: companies.length,
    topCompany: {
      name: topCompany?.name || 'N/A',
      value: formatLargeValue(topCompany?.value || 0),
      marketShare: topCompany ? topCompany.marketShare.toFixed(1) + '%' : 'N/A'
    },
    trend,
    dateRange: {
      start: sortedMonths.length > 0 ? sortedMonths[0] : 'N/A',
      end: sortedMonths.length > 0 ? sortedMonths[sortedMonths.length - 1] : 'N/A'
    },
    topPSC: topPSC ? {
      code: topPSC.code,
      description: topPSC.description,
      value: formatLargeValue(topPSC.value)
    } : { code: 'N/A', description: 'N/A', value: '$0' }
  };
}

// Function to generate insight text based on data analysis
function generateInsightMessage(insights, pscCode = null) {
  if (!insights) return "No data available for analysis.";
  
  // Create dynamic message based on available insights
  const messages = [];
  
  // PSC-specific message
  if (pscCode) {
    messages.push(`Analysis of PSC ${pscCode} (${insights.topPSC.description}) shows 
    ${insights.totalValue} in total contract value across ${insights.totalContracts} awards to 
    ${insights.totalCompanies} companies.`);
  } else {
    messages.push(`Current analysis shows ${insights.totalValue} across ${insights.totalContracts} 
    contract awards to ${insights.totalCompanies} companies.`);
  }
  
  // Add top company insight
  if (insights.topCompany.name !== 'N/A') {
    messages.push(`${insights.topCompany.name} is the market leader with ${insights.topCompany.marketShare} 
    market share (${insights.topCompany.value}).`);
  }
  
  // Add trend insight
  if (insights.trend === 'increasing') {
    messages.push(`Contract spending is trending upward over the analyzed period.`);
  } else if (insights.trend === 'decreasing') {
    messages.push(`Contract spending is trending downward over the analyzed period.`);
  }
  
  return messages.join(' ');
}

// Function to update the insight banner with real analytics
function updateInsightBanner(data, pscCode = null) {
  const insights = generateContractInsights(data);
  if (!insights) return;
  
  // Update date display
  const dateElement = document.querySelector('.current-date');
  if (dateElement) {
    const now = new Date();
    const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
    dateElement.textContent = now.toLocaleDateString('en-US', options);
  }
  
  // Update insight message
  const messageElement = document.querySelector('.welcome-message');
  if (messageElement) {
    const insightText = generateInsightMessage(insights, pscCode);
    messageElement.innerHTML = insightText;
  }
  
  // Update featured stats
  updateFeaturedStats(insights);
}

// Update the featured stats cards with real data
function updateFeaturedStats(insights) {
  if (!insights) return;
  
  const statElements = {
    contracts: document.querySelector('#stat-contracts'),
    value: document.querySelector('#stat-value'),
    companies: document.querySelector('#stat-companies'),
    topCompany: document.querySelector('#stat-top-company')
  };
  
  if (statElements.contracts) {
    statElements.contracts.textContent = insights.totalContracts.toLocaleString();
  }
  
  if (statElements.value) {
    statElements.value.textContent = insights.totalValue;
  }
  
  if (statElements.companies) {
    statElements.companies.textContent = insights.totalCompanies;
  }
  
  if (statElements.topCompany) {
    statElements.topCompany.textContent = `${insights.topCompany.name} (${insights.topCompany.marketShare})`;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Find tables section tabs
  const tabsContainer = document.querySelector('.tables-section .tabs');
  if (!tabsContainer) {
    console.error("Could not find tabs container to add propensity tab");
    return;
  }
  
  // Add the propensity tab button
  const propensityTabBtn = document.createElement('button');
  propensityTabBtn.className = 'tab-btn';
  propensityTabBtn.setAttribute('data-tab', 'propensity');
  propensityTabBtn.textContent = 'Propensity to Buy';
  tabsContainer.appendChild(propensityTabBtn);
  
  // Find tab content container
  const tabContentsContainer = document.querySelector('.tables-section');
  if (!tabContentsContainer) {
    console.error("Could not find tab contents container");
    return;
  }
  
  // Create and add propensity tab content
  const propensityTab = document.createElement('div');
  propensityTab.id = 'propensityTab';
  propensityTab.className = 'tab-content';
  propensityTab.innerHTML = `
    <div class="propensity-header" style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
      <div class="propensity-info">
        <h4 style="margin: 0; font-size: 16px; color: var(--text-primary);">
          Agency Propensity to Buy Analysis
        </h4>
        <p style="margin: 5px 0 0; font-size: 13px; color: var(--text-secondary);">
        Propensity to Buy scores help prioritize which federal agencies are most likely to make a purchase soon—based on how they’ve behaved in the past. Each agency receives a score from 0 to 100, based on four factors: how recently they last awarded a contract (weighted at 30 points), how frequently they buy (25 points), their average contract value (25 points), and how consistently they work with the same vendors (20 points). We also estimate when each agency is likely to buy again by analyzing the typical time gaps between past awards. These scores are meant to guide sales outreach and help identify high-potential opportunities, but they aren’t foolproof. Budget shifts, leadership changes, and external events—like COVID-19—can all disrupt normal procurement cycles. Use these insights alongside your own research and competitive intel. To generate your own Propensity to Buy list, run an EZ Search on fpds.gov, download the CSV, then upload it here to view and export your results.

        </p>
      </div>
      
      <div class="propensity-actions">
        <button id="exportPropensityBtn" class="btn btn-sm btn-secondary">
          <i class="fas fa-download"></i>
          <span class="btn-text">Export</span>
        </button>
      </div>
    </div>
    
    <div class="propensity-legend" style="margin-bottom: 15px; display: flex; gap: 15px; justify-content: flex-start; flex-wrap: wrap;">
      <div class="legend-item" style="display: flex; align-items: center; font-size: 13px;">
        <span class="badge bg-success" style="min-width: 30px; margin-right: 5px;">70+</span>
        <span>High Propensity</span>
      </div>
      <div class="legend-item" style="display: flex; align-items: center; font-size: 13px;">
        <span class="badge bg-warning" style="min-width: 30px; margin-right: 5px;">40-69</span>
        <span>Medium Propensity</span>
      </div>
      <div class="legend-item" style="display: flex; align-items: center; font-size: 13px;">
        <span class="badge bg-danger" style="min-width: 30px; margin-right: 5px;">0-39</span>
        <span>Low Propensity</span>
      </div>
    </div>
    
    <div class="table-container">
      <table id="propensityTable" class="data-table">
        <thead>
          <tr>
            <th data-sort="agency">Agency</th>
            <th data-sort="office">Office</th>
            <th data-sort="score" class="text-center">Score</th>
            <th data-sort="spend">Total Spend</th>
            <th data-sort="contracts">Contracts</th>
            <th data-sort="next-purchase">Next Likely Purchase</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="propensityTableBody">
          <!-- Propensity data will be populated here -->
        </tbody>
      </table>
    </div>
  `;
  
  tabContentsContainer.appendChild(propensityTab);
  
  // Create and add recommendations modal
  const modalDiv = document.createElement('div');
  modalDiv.id = 'recommendationsModal';
  modalDiv.className = 'modal-backdrop';
  modalDiv.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Agency Buying Opportunities</h3>
        <button id="closeRecommendationsBtn" class="modal-close" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="recommendationsModalBody">
        <!-- Recommendations content will be populated here -->
      </div>
      <div class="modal-footer">
        <button id="closeRecommendationsModalBtn" class="btn btn-secondary">
          <span class="btn-text">Close</span>
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modalDiv);
  
  // Add styles
  const styleTag = document.createElement('style');
  styleTag.textContent = `
    /* Style badges */
    .badge {
      display: inline-block;
      padding: 0.25em 0.6em;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 10px;
      color: white;
    }
    
    .bg-success {
      background-color: var(--success);
    }
    
    .bg-warning {
      background-color: var(--warning);
    }
    
    .bg-danger {
      background-color: var(--danger);
    }
    
    .text-center {
      text-align: center;
    }
    
    /* Custom styles for the propensity tab */
    #propensityTable .agency-badge,
    #propensityTable .office-badge {
      display: flex;
      align-items: center;
    }
    
    #propensityTable .agency-icon,
    #propensityTable .office-icon {
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    /* Recommendations modal styles */
    #recommendationsModalBody .agency-badge {
      display: flex;
      align-items: center;
    }
    
    #recommendationsModalBody .vendor-item:hover {
      background-color: var(--bg-tertiary) !important;
      transition: background-color 0.2s ease;
    }
    
    /* Animation for the propensity score */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    #propensityTable .badge {
      animation: pulse 2s infinite;
    }
  `;
  
  document.head.appendChild(styleTag);
});

// Add propensity analyzer to the app object
if (!app.propensityAnalyzer) {
// This is the complete updated propensityAnalyzer object with the future date logic implemented
// You can replace the entire app.propensityAnalyzer section with this updated version

app.propensityAnalyzer = {
  propensityResults: [],
  
  // Calculate propensity to buy based on contract history
  analyzePropensity: function(data) {
    if (!data || data.length === 0) return [];
    
    // Group contracts by agency and office
    const agencyOfficeContracts = {};
    
    data.forEach(contract => {
      if (!contract.agency) return;
      
      const agency = contract.agency;
      const office = contract.office || 'Unknown Office';
      const key = `${agency}|${office}`;
      
      if (!agencyOfficeContracts[key]) {
        agencyOfficeContracts[key] = {
          agency: agency,
          office: office,
          contracts: []
        };
      }
      
      agencyOfficeContracts[key].contracts.push(contract);
    });
    
    // Analyze each agency/office's purchase patterns
    const propensityResults = [];
    const today = new Date();
    
    Object.keys(agencyOfficeContracts).forEach(key => {
      const agencyOffice = agencyOfficeContracts[key];
      const contracts = agencyOffice.contracts;
      
      // Skip agencies with too few contracts for meaningful analysis
      if (contracts.length < 2) return;
      
      // Calculate total spend
      const totalSpend = contracts.reduce((sum, c) => sum + c.value, 0);
      
      // Analyze vendors purchased from
      const vendorCounts = {};
      const pscCounts = {};
      const naicsCounts = {};
      
      contracts.forEach(c => {
        // Track vendors
        if (c.vendor) {
          if (!vendorCounts[c.vendor]) {
            vendorCounts[c.vendor] = {
              name: c.vendor,
              count: 0,
              value: 0,
              lastPurchase: null
            };
          }
          
          vendorCounts[c.vendor].count++;
          vendorCounts[c.vendor].value += c.value;
          
          // Track most recent purchase from this vendor
          const purchaseDate = c.parsedDate;
          if (purchaseDate && (!vendorCounts[c.vendor].lastPurchase || 
                              purchaseDate > vendorCounts[c.vendor].lastPurchase)) {
            vendorCounts[c.vendor].lastPurchase = purchaseDate;
          }
        }
        
        // Track PSC codes
        if (c.psc) {
          if (!pscCounts[c.psc]) {
            pscCounts[c.psc] = {
              code: c.psc,
              description: c.pscDescription || '',
              count: 0,
              value: 0
            };
          }
          
          pscCounts[c.psc].count++;
          pscCounts[c.psc].value += c.value;
        }
        
        // Track NAICS codes
        if (c.naics) {
          if (!naicsCounts[c.naics]) {
            naicsCounts[c.naics] = {
              code: c.naics,
              description: c.naicsDescription || '',
              count: 0,
              value: 0
            };
          }
          
          naicsCounts[c.naics].count++;
          naicsCounts[c.naics].value += c.value;
        }
      });
      
      // Find top vendors by spend
      const topVendors = Object.values(vendorCounts)
        .sort((a, b) => b.value - a.value)
        .slice(0, 5);
      
      // Find top PSC categories
      const topPSCs = Object.values(pscCounts)
        .sort((a, b) => b.value - a.value)
        .slice(0, 3);
      
      // Find purchase frequency and recency
      let mostRecentPurchase = null;
      contracts.forEach(c => {
        if (c.parsedDate && (!mostRecentPurchase || c.parsedDate > mostRecentPurchase)) {
          mostRecentPurchase = c.parsedDate;
        }
      });
      
      // Calculate average time between purchases (in days) by agency/office
      const sortedDates = contracts
        .map(c => c.parsedDate)
        .filter(d => d instanceof Date && !isNaN(d))
        .sort((a, b) => a - b);
      
      let avgPurchaseInterval = 0;
      if (sortedDates.length > 1) {
        let totalIntervals = 0;
        for (let i = 1; i < sortedDates.length; i++) {
          const daysDiff = (sortedDates[i] - sortedDates[i-1]) / (1000 * 60 * 60 * 24);
          totalIntervals += daysDiff;
        }
        avgPurchaseInterval = Math.round(totalIntervals / (sortedDates.length - 1));
      }
      
      // Calculate next likely purchase date (ensuring it's in the future)
      let nextLikelyPurchaseDate = null;
      if (mostRecentPurchase && avgPurchaseInterval > 0) {
        // Start with the most recent purchase date
        nextLikelyPurchaseDate = new Date(mostRecentPurchase.getTime());
        
        // Add purchase interval to get the next predicted date
        nextLikelyPurchaseDate.setDate(nextLikelyPurchaseDate.getDate() + avgPurchaseInterval);
        
        // If this date is still in the past, keep adding intervals until we get a future date
        while (nextLikelyPurchaseDate < today) {
          nextLikelyPurchaseDate.setDate(nextLikelyPurchaseDate.getDate() + avgPurchaseInterval);
        }
      }
      
      // Calculate propensity score (0-100)
      // Factors: recency, frequency, monetary value, consistency
      let propensityScore = 0;
      
      // Recency factor (max 30 points)
      if (mostRecentPurchase) {
        const daysSinceLastPurchase = (today - mostRecentPurchase) / (1000 * 60 * 60 * 24);
        propensityScore += Math.max(0, 30 - Math.min(30, Math.floor(daysSinceLastPurchase / 30)));
      }
      
      // Frequency factor (max 25 points)
      if (avgPurchaseInterval > 0) {
        // More points for shorter intervals (more frequent purchases)
        propensityScore += Math.min(25, Math.max(0, 25 - Math.floor(avgPurchaseInterval / 30)));
      }
      
      // Monetary value factor (max 25 points)
      const avgContractValue = totalSpend / contracts.length;
      propensityScore += Math.min(25, Math.floor(avgContractValue / 10000));
      
      // Consistency factor (max 20 points)
      // More points if repeatedly buys from same vendors
      if (topVendors.length > 0) {
        const topVendorPercentage = topVendors[0].value / totalSpend;
        propensityScore += Math.min(20, Math.floor(topVendorPercentage * 100 / 5));
      }
      
      // Add to results
      propensityResults.push({
        agency: agencyOffice.agency,
        office: agencyOffice.office,
        score: Math.min(100, propensityScore), // Cap at 100
        totalSpend,
        contractCount: contracts.length,
        mostRecentPurchase,
        avgPurchaseInterval,
        nextLikelyPurchaseDate,
        topVendors,
        topPSCs,
        topNAICS: Object.values(naicsCounts).sort((a, b) => b.value - a.value).slice(0, 3)
      });
    });
    
    // Sort by propensity score (highest first)
    propensityResults.sort((a, b) => b.score - a.score);
    
    this.propensityResults = propensityResults;
    return propensityResults;
  },
  
  // Generate agency-specific buying opportunities
  generateOpportunities: function(agency, office) {
    const agencyData = this.propensityResults.find(a => 
      a.agency === agency && a.office === office);
    
    if (!agencyData) return { vendors: [], opportunities: [] };
    
    // Top vendors this agency buys from
    const vendors = agencyData.topVendors.map(vendor => ({
      name: vendor.name,
      spend: vendor.value,
      count: vendor.count,
      lastPurchase: vendor.lastPurchase
    }));
    
    // Generate strategic opportunities
    const opportunities = [];
    const today = new Date();
    
    // Next purchase timing opportunity
    if (agencyData.nextLikelyPurchaseDate) {
      const timeUntilNext = Math.round((agencyData.nextLikelyPurchaseDate - today) / (1000 * 60 * 60 * 24));
      
      if (timeUntilNext <= 0) {
        // Overdue purchase
        opportunities.push({
          type: 'timing',
          title: 'Immediate Purchase Opportunity',
          description: `Agency is due for a purchase now based on historical buying patterns`,
          priority: 'high'
        });
      } else if (timeUntilNext < 30) {
        // Coming soon
        opportunities.push({
          type: 'timing',
          title: 'Upcoming Purchase Window',
          description: `Agency likely to make purchases in the next ${timeUntilNext} days based on historical buying patterns`,
          priority: 'high'
        });
      } else if (timeUntilNext < 90) {
        // On the horizon
        opportunities.push({
          type: 'timing',
          title: 'Purchase Window Approaching',
          description: `Agency likely to make purchases in ${timeUntilNext} days based on historical buying patterns`,
          priority: 'medium'
        });
      }
    }
    
    // Vendor competitive opportunity
    if (vendors.length > 1) {
      const topVendor = vendors[0];
      const runnerUpVendor = vendors[1];
      
      if (topVendor.spend > runnerUpVendor.spend * 2) {
        opportunities.push({
          type: 'vendor',
          title: 'Dominant Vendor Relationship',
          description: `${topVendor.name} currently dominates agency spend with ${utils.formatMoney(topVendor.spend)}`,
          priority: 'medium'
        });
      } else {
        opportunities.push({
          type: 'competitive',
          title: 'Competitive Vendor Environment',
          description: `Multiple vendors competing for this agency's business`,
          priority: 'medium'
        });
      }
    }
    
    // Budget-based opportunity
    if (agencyData.totalSpend > 1000000) {
      opportunities.push({
        type: 'budget',
        title: 'High-Value Agency',
        description: `Total spend of ${utils.formatMoney(agencyData.totalSpend)} indicates significant budget authority`,
        priority: 'high'
      });
    }
    
    // Product category opportunity
    if (agencyData.topPSCs.length > 0) {
      const topCategory = agencyData.topPSCs[0];
      
      opportunities.push({
        type: 'category',
        title: 'Primary Product Category',
        description: `Agency primarily purchases ${topCategory.description || topCategory.code}`,
        priority: 'medium'
      });
    }
    
    // Seasonal trends
    if (agencyData.mostRecentPurchase) {
      const monthOfLastPurchase = agencyData.mostRecentPurchase.getMonth();
      const currentMonth = today.getMonth();
      
      // If recent purchase was in the same quarter as current month
      if (Math.floor(monthOfLastPurchase / 3) === Math.floor(currentMonth / 3)) {
        opportunities.push({
          type: 'seasonal',
          title: 'Active Buying Season',
          description: `Agency is currently in an active buying period based on seasonal patterns`,
          priority: 'high'
        });
      }
    }
    
    return {
      vendors,
      opportunities
    };
  }
};
  }
// Updated updatePropensityTable function
function updatePropensityTable(propensityResults) {
  const tbody = document.getElementById('propensityTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (!propensityResults || propensityResults.length === 0) {
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = '<td colspan="7" class="text-center">No propensity data available. Try adjusting filters or loading more contract data.</td>';
    tbody.appendChild(emptyRow);
    return;
  }
  
  // Get current date for comparing next purchase dates
  const today = new Date();
  
  propensityResults.slice(0, 15).forEach(result => {
    const row = document.createElement('tr');
    
    // Create score badge with color based on score
    let scoreColor = 'bg-success';
    if (result.score < 40) scoreColor = 'bg-danger';
    else if (result.score < 70) scoreColor = 'bg-warning';
    
    const scoreBadge = `<span class="badge ${scoreColor}" style="min-width: 40px;">${result.score}</span>`;
    
    // Format date with urgency indicator
    let nextPurchaseDateText = 'Unknown';
    let nextPurchaseDateClass = '';
    
    if (result.nextLikelyPurchaseDate) {
      if (result.nextLikelyPurchaseDate <= today) {
        nextPurchaseDateText = '<span style="color: var(--danger); font-weight: 600;">Due now</span>';
        nextPurchaseDateClass = 'urgent-date';
      } else {
        const daysUntil = Math.round((result.nextLikelyPurchaseDate - today) / (1000 * 60 * 60 * 24));
        if (daysUntil < 30) {
          nextPurchaseDateText = `<span style="color: var(--warning); font-weight: 600;">${utils.formatDate(result.nextLikelyPurchaseDate)}</span>`;
          nextPurchaseDateClass = 'soon-date';
        } else {
          nextPurchaseDateText = utils.formatDate(result.nextLikelyPurchaseDate);
        }
      }
    }
    
    // Agency and office badges
    const agencyInitials = utils.getInitials(result.agency);
    const agencyColor = utils.stringToColor(result.agency);
    
    const officeInitials = utils.getInitials(result.office);
    const officeColor = utils.stringToColor(result.office);
    
    row.innerHTML = `
      <td>
        <div class="agency-badge" title="${result.agency}">
          <div class="agency-icon" style="background-color:${agencyColor}">${agencyInitials}</div>
          ${utils.truncateText(result.agency, 20)}
        </div>
      </td>
      <td>
        <div class="office-badge" title="${result.office}">
          <div class="office-icon" style="background-color:${officeColor}">${officeInitials}</div>
          ${utils.truncateText(result.office, 20)}
        </div>
      </td>
      <td class="text-center">${scoreBadge}</td>
      <td>${utils.formatMoney(result.totalSpend)}</td>
      <td>${result.contractCount}</td>
      <td class="${nextPurchaseDateClass}">${nextPurchaseDateText}</td>
      <td class="table-actions-cell">
        <button class="btn btn-sm btn-primary view-opportunities" data-agency="${result.agency.replace(/"/g, '&quot;')}" data-office="${result.office.replace(/"/g, '&quot;')}">
          <span class="btn-text">Opportunities</span>
        </button>
      </td>
    `;
    
    tbody.appendChild(row);
    
    // Add event listener for opportunities button
    const viewBtn = row.querySelector('.view-opportunities');
    if (viewBtn) {
      viewBtn.addEventListener('click', function() {
        const agency = this.getAttribute('data-agency');
        const office = this.getAttribute('data-office');
        showOpportunitiesModal(agency, office);
      });
    }
  });
}


// Add this function to refresh purchase dates that may be in the past
function refreshPropensityDates() {
  if (!app.propensityAnalyzer || !app.propensityAnalyzer.propensityResults) return;
  
  const now = new Date();
  let needsUpdate = false;
  
  // Check if any next purchase dates are in the past
  app.propensityAnalyzer.propensityResults.forEach(result => {
    if (result.nextLikelyPurchaseDate && result.nextLikelyPurchaseDate < now) {
      needsUpdate = true;
    }
  });
  
  // If we found past dates, reanalyze to refresh them
  if (needsUpdate) {
    app.propensityAnalyzer.analyzePropensity(app.filteredData);
    updatePropensityTable(app.propensityAnalyzer.propensityResults);
  }
}

// Add this CSS to style the date indicators
document.addEventListener('DOMContentLoaded', function() {
  const styleTag = document.createElement('style');
  styleTag.textContent = `
    .urgent-date {
      color: var(--danger);
      font-weight: 600;
    }
    
    .soon-date {
      color: var(--warning);
      font-weight: 600;
    }
  `;
  document.head.appendChild(styleTag);
  
  // Set up an event listener for tab changes to refresh dates
  document.body.addEventListener('click', function(event) {
    if (event.target.classList.contains('tab-btn') && 
        event.target.getAttribute('data-tab') === 'propensity') {
      // Refresh the dates when the propensity tab is clicked
      refreshPropensityDates();
    }
  });
  
  // Also refresh on initial load if propensity tab is active
  setTimeout(function() {
    const propensityTab = document.querySelector('.tab-btn[data-tab="propensity"]');
    if (propensityTab && propensityTab.classList.contains('active')) {
      refreshPropensityDates();
    }
  }, 1000);
});

function showOpportunitiesModal(agency, office) {
  // Get opportunities for this agency
  const { vendors, opportunities } = app.propensityAnalyzer.generateOpportunities(agency, office);
  
  // Get agency data
  const agencyData = app.propensityAnalyzer.propensityResults.find(a => 
    a.agency === agency && a.office === office);
  
  if (!agencyData) return;
  
  // Update modal content
  const modalBody = document.getElementById('recommendationsModalBody');
  if (!modalBody) return;
  
  // Agency details section
  const agencyInitials = utils.getInitials(agency);
  const agencyColor = utils.stringToColor(agency);
  
  const officeInitials = utils.getInitials(office);
  const officeColor = utils.stringToColor(office);
  
  // Format next purchase date
  const nextPurchaseDate = agencyData.nextLikelyPurchaseDate ? 
    utils.formatDate(agencyData.nextLikelyPurchaseDate) : 'Unknown';
  
  modalBody.innerHTML = `
    <div class="agency-detail-header">
      <div class="agency-office-badges" style="display: flex; align-items: center; margin-bottom: 15px;">
        <div class="agency-badge" style="margin-right: 15px;">
          <div class="agency-icon" style="background-color:${agencyColor}; width: 40px; height: 40px; font-size: 18px;">${agencyInitials}</div>
          <h3 style="margin: 0 0 0 15px;">${agency}</h3>
        </div>
        <div class="office-badge">
          <div class="office-icon" style="background-color:${officeColor}; width: 40px; height: 40px; font-size: 18px;">${officeInitials}</div>
          <h4 style="margin: 0 0 0 15px;">${office}</h4>
        </div>
      </div>
      
      <div class="agency-stats" style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
        <div class="stat-item">
          <div class="stat-label" style="font-size: 12px; color: var(--text-secondary);">Propensity Score</div>
          <div class="stat-value" style="font-size: 24px; font-weight: 600;">${agencyData.score}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label" style="font-size: 12px; color: var(--text-secondary);">Total Spend</div>
          <div class="stat-value" style="font-size: 24px; font-weight: 600;">${utils.formatMoney(agencyData.totalSpend)}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label" style="font-size: 12px; color: var(--text-secondary);">Purchase Interval</div>
          <div class="stat-value" style="font-size: 24px; font-weight: 600;">${agencyData.avgPurchaseInterval || 'N/A'} days</div>
        </div>
      </div>
    </div>
    
    <h4 style="margin: 20px 0 15px; font-size: 18px; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 8px;">
      Top Vendors
    </h4>
  `;
  
  // Add vendor list
  if (vendors.length > 0) {
    const vendorsContainer = document.createElement('div');
    vendorsContainer.className = 'vendors-list';
    vendorsContainer.style.display = 'grid';
    vendorsContainer.style.gap = '10px';
    
    vendors.forEach(vendor => {
      const vendorItem = document.createElement('div');
      vendorItem.className = 'vendor-item';
      vendorItem.style.padding = '12px';
      vendorItem.style.borderRadius = 'var(--radius)';
      vendorItem.style.backgroundColor = 'var(--bg-secondary)';
      vendorItem.style.display = 'flex';
      vendorItem.style.justifyContent = 'space-between';
      vendorItem.style.alignItems = 'center';
      
      const vendorInitials = utils.getInitials(vendor.name);
      const vendorColor = utils.stringToColor(vendor.name);
      
      const lastPurchaseDate = vendor.lastPurchase ? 
        utils.formatDate(vendor.lastPurchase) : 'Unknown';
      
      vendorItem.innerHTML = `
        <div style="display: flex; align-items: center;">
          <div class="vendor-icon" style="background-color:${vendorColor}; width: 30px; height: 30px; font-size: 14px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">${vendorInitials}</div>
          <div>
            <div style="font-weight: 600; color: var(--text-primary);">${vendor.name}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Last purchase: ${lastPurchaseDate}</div>
          </div>
        </div>
        <div style="text-align: right;">
          <div style="font-weight: 600; color: var(--text-primary);">${utils.formatMoney(vendor.spend)}</div>
          <div style="font-size: 12px; color: var(--text-secondary);">${vendor.count} contracts</div>
        </div>
      `;
      
      vendorsContainer.appendChild(vendorItem);
    });
    
    modalBody.appendChild(vendorsContainer);
  } else {
    modalBody.innerHTML += '<p>No vendor data available for this agency.</p>';
  }
  
  // Add opportunities section
  if (opportunities.length > 0) {
    const opportunitiesSection = document.createElement('div');
    opportunitiesSection.style.marginTop = '25px';
    opportunitiesSection.innerHTML = `
      <h4 style="margin: 0 0 15px; font-size: 18px; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 8px;">
        Buying Opportunities
      </h4>
    `;
    
    const opportunitiesList = document.createElement('div');
    opportunitiesList.className = 'opportunities-list';
    opportunitiesList.style.display = 'grid';
    opportunitiesList.style.gap = '15px';
    
    opportunities.forEach(opp => {
      const priorityColor = opp.priority === 'high' ? 'var(--success)' : 
                           (opp.priority === 'medium' ? 'var(--warning)' : 'var(--secondary)');
      
      const oppItem = document.createElement('div');
      oppItem.className = 'opportunity-item';
      oppItem.style.padding = '15px';
      oppItem.style.borderRadius = 'var(--radius)';
      oppItem.style.backgroundColor = 'var(--bg-secondary)';
      oppItem.style.borderLeft = `4px solid ${priorityColor}`;
      
      let iconClass;
      switch (opp.type) {
        case 'timing': iconClass = 'fa-clock'; break;
        case 'vendor': iconClass = 'fa-building'; break;
        case 'competitive': iconClass = 'fa-trophy'; break;
        case 'budget': iconClass = 'fa-dollar-sign'; break;
        case 'category': iconClass = 'fa-tags'; break;
        case 'seasonal': iconClass = 'fa-calendar'; break;
        default: iconClass = 'fa-lightbulb';
      }
      
      oppItem.innerHTML = `
        <div style="display: flex; align-items: flex-start;">
          <div style="margin-right: 12px; color: ${priorityColor};">
            <i class="fas ${iconClass}" style="font-size: 20px;"></i>
          </div>
          <div>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">${opp.title}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${opp.description}</div>
          </div>
        </div>
      `;
      
      opportunitiesList.appendChild(oppItem);
    });
    
    opportunitiesSection.appendChild(opportunitiesList);
    modalBody.appendChild(opportunitiesSection);
    
    // Add specific action steps
    const actionSteps = document.createElement('div');
    actionSteps.style.marginTop = '25px';
    actionSteps.innerHTML = `
      <h4 style="margin: 0 0 15px; font-size: 18px; color: var(--primary); border-bottom:1px solid var(--border); padding-bottom: 8px;">
        Recommended Actions
      </h4>
      <ul style="padding-left: 20px; margin-bottom: 0;">
        <li style="margin-bottom: 8px;">Monitor ${agency}'s ${nextPurchaseDate === 'Unknown' ? 'purchasing calendar' : 'upcoming purchase window around ' + nextPurchaseDate}</li>
        <li style="margin-bottom: 8px;">Research existing contracts with ${vendors.length > 0 ? vendors[0].name : 'top vendors'}</li>
        <li style="margin-bottom: 8px;">Track subcontracting opportunities with prime contractors</li>
        <li style="margin-bottom: 8px;">Schedule follow-up calls with contracting officers</li>
      </ul>
    `;
    
    modalBody.appendChild(actionSteps);
  }
  
  // Show modal
  const modal = document.getElementById('recommendationsModal');
  if (modal) modal.classList.add('active');
}
// Process propensity data function
function processPropensityData() {
  // Analyze propensity based on current filtered data
  const propensityResults = app.propensityAnalyzer.analyzePropensity(app.filteredData);
  
  // Display results in the propensity table
  updatePropensityTable(propensityResults);
}

// Hook into existing fileHandler
const originalProcessAndDisplayCsv = fileHandler.processAndDisplayCsv;
fileHandler.processAndDisplayCsv = function(csvText, fileNameForDisplay = "Uploaded Data") {
  originalProcessAndDisplayCsv.call(this, csvText, fileNameForDisplay);
  // Add propensity analysis after processing data
  processPropensityData();
};

// Hook into existing dashboardManager
const originalRefreshDashboard = dashboardManager.refreshDashboard;
dashboardManager.refreshDashboard = function() {
  originalRefreshDashboard.call(this);
  // Update propensity data with current filtered data
  app.propensityAnalyzer.analyzePropensity(app.filteredData);
  updatePropensityTable(app.propensityAnalyzer.propensityResults);
};

// Set up event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners for modal close buttons
  document.body.addEventListener('click', function(event) {
    // Close recommendations modal
    if (event.target.id === 'closeRecommendationsBtn' || 
        event.target.id === 'closeRecommendationsModalBtn') {
      const recommendationsModal = document.getElementById('recommendationsModal');
      if (recommendationsModal) recommendationsModal.classList.remove('active');
    }
    
    // Close modal when clicking outside
    if (event.target.id === 'recommendationsModal') {
      event.target.classList.remove('active');
    }
    
    // Handle propensity tab click
    if (event.target.classList.contains('tab-btn') && 
        event.target.getAttribute('data-tab') === 'propensity') {
      // Make sure all other tabs are inactive
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Make this tab active
      event.target.classList.add('active');
      
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Show propensity tab content
      const propensityTab = document.getElementById('propensityTab');
      if (propensityTab) {
        propensityTab.classList.add('active');
      }
      
      // Update propensity data
      app.propensityAnalyzer.analyzePropensity(app.filteredData);
      updatePropensityTable(app.propensityAnalyzer.propensityResults);
    }
    
    // Handle export button
    if (event.target.id === 'exportPropensityBtn' || 
        (event.target.parentElement && event.target.parentElement.id === 'exportPropensityBtn')) {
      exportPropensityData();
    }
  });
});

// Function to export propensity data
function exportPropensityData() {
  const results = app.propensityAnalyzer.propensityResults;
  if (!results || results.length === 0) return;
  
  // Create CSV content
  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "Agency,Office,Propensity Score,Total Spend,Contracts,Next Likely Purchase,Top Vendor\n";
  
  results.forEach(item => {
    const nextPurchaseDate = item.nextLikelyPurchaseDate ? 
      utils.formatDate(item.nextLikelyPurchaseDate) : 'Unknown';
    
    const topVendor = item.topVendors && item.topVendors.length > 0 ? item.topVendors[0].name : 'N/A';
    
    csvContent += [
      `"${item.agency}"`,
      `"${item.office}"`,
      item.score,
      `"${utils.formatMoney(item.totalSpend)}"`,
      item.contractCount,
      `"${nextPurchaseDate}"`,
      `"${topVendor}"`
    ].join(',') + "\n";
  });
  
  // Create download link
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "agency_propensity_to_buy.csv");
  document.body.appendChild(link);
  
  // Trigger download
  link.click();
  
  // Clean up
  document.body.removeChild(link);
}

// Initialize propensity tab
document.addEventListener('DOMContentLoaded', function() {
  console.log("Agency Propensity to Buy feature initialized!");
});
// Add this to the DOMContentLoaded event handler at the bottom of your file,
// or near the end of the propensity feature implementation:

document.addEventListener('DOMContentLoaded', function() {
  // Wait a short moment after page load to ensure all elements are ready
  setTimeout(function() {
    // Find the propensity tab button
    const propensityTabBtn = document.querySelector('.tab-btn[data-tab="propensity"]');
    
    if (propensityTabBtn) {
      // Make sure all other tabs are inactive
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Make propensity tab active
      propensityTabBtn.classList.add('active');
      
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Show propensity tab content
      const propensityTab = document.getElementById('propensityTab');
      if (propensityTab) {
        propensityTab.classList.add('active');
      }
      
      // Update propensity data to ensure it's displayed
      if (app.propensityAnalyzer) {
        app.propensityAnalyzer.analyzePropensity(app.filteredData);
        updatePropensityTable(app.propensityAnalyzer.propensityResults);
      }
    }
  }, 500); // 500ms delay to ensure everything is loaded
});
// Add this simple fix at the end of your JavaScript
// This solution doesn't rely on event delegation and directly attaches click handlers

// Define a function to close the recommendations modal
function closeRecommendationsModal() {
  const modal = document.getElementById('recommendationsModal');
  if (modal) {
    modal.classList.remove('active');
  }
}

// Function to set up close buttons after DOM is loaded
function setupModalCloseButtons() {
  // Set up the X button in the modal header
  const closeBtn = document.getElementById('closeRecommendationsBtn');
  if (closeBtn) {
    closeBtn.onclick = closeRecommendationsModal;
  }
  
  // Set up the Close button in the modal footer
  const closeModalBtn = document.getElementById('closeRecommendationsModalBtn');
  if (closeModalBtn) {
    closeModalBtn.onclick = closeRecommendationsModal;
  }
  
  // Set up the backdrop click to close
  const modal = document.getElementById('recommendationsModal');
  if (modal) {
    modal.onclick = function(event) {
      if (event.target === modal) {
        closeRecommendationsModal();
      }
    };
  }
}

// Run setup when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Initial setup
  setupModalCloseButtons();
  
  // Re-run setup when propensity tab is activated (in case modal was created after initial load)
  const propensityTabBtn = document.querySelector('.tab-btn[data-tab="propensity"]');
  if (propensityTabBtn) {
    propensityTabBtn.addEventListener('click', function() {
      setTimeout(setupModalCloseButtons, 100);
    });
  }
  
  // Setup buttons again after showOpportunitiesModal is called
  const originalShowOpportunitiesModal = showOpportunitiesModal;
  if (typeof showOpportunitiesModal === 'function') {
    window.showOpportunitiesModal = function(agency, office) {
      originalShowOpportunitiesModal(agency, office);
      setTimeout(setupModalCloseButtons, 100);
    };
  }
  
  // Add keyboard support to close with Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeRecommendationsModal();
    }
  });
});
// Function to update the insight panels with real data from loaded CSV
function updateInsightBanner(data, pscCode = null) {
  if (!data || data.length === 0) return;
  
  // Update date display
  const dateElement = document.querySelector('.current-date');
  if (dateElement) {
    const now = new Date();
    dateElement.textContent = now.toLocaleDateString('en-US', { 
      weekday: 'long', 
      month: 'long', 
      day: 'numeric', 
      year: 'numeric' 
    });
  }
  
  // Calculate total contract value
  const totalValue = data.reduce((sum, contract) => sum + contract.value, 0);
  
  // Analyze vendors and get top vendors
  const vendorData = {};
  data.forEach(contract => {
    if (!contract.vendor) return;
    if (!vendorData[contract.vendor]) {
      vendorData[contract.vendor] = {
        name: contract.vendor,
        value: 0,
        count: 0,
        agencies: new Set()
      };
    }
    vendorData[contract.vendor].value += contract.value;
    vendorData[contract.vendor].count++;
    if (contract.agency) vendorData[contract.vendor].agencies.add(contract.agency);
  });
  
  const vendors = Object.values(vendorData)
    .map(v => ({
      ...v,
      agencyCount: v.agencies.size,
      marketShare: (v.value / totalValue) * 100
    }))
    .sort((a, b) => b.value - a.value);
  
  const topVendor = vendors[0] || null;
  
  // Analyze monthly trends
  const monthlyData = {};
  data.forEach(contract => {
    if (!contract.parsedDate) return;
    const monthYear = `${contract.parsedDate.getFullYear()}-${(contract.parsedDate.getMonth() + 1).toString().padStart(2, '0')}`;
    if (!monthlyData[monthYear]) monthlyData[monthYear] = { value: 0, count: 0 };
    monthlyData[monthYear].value += contract.value;
    monthlyData[monthYear].count++;
  });
  
  // Calculate growth rates
  const sortedMonths = Object.keys(monthlyData).sort();
  let avgGrowthRate = 0;
  let peakMonthName = 'N/A';
  let peakValue = 0;
  
  if (sortedMonths.length > 1) {
    const growthRates = [];
    for (let i = 1; i < sortedMonths.length; i++) {
      const prevValue = monthlyData[sortedMonths[i-1]].value;
      const currValue = monthlyData[sortedMonths[i]].value;
      if (prevValue > 0) {
        growthRates.push(((currValue - prevValue) / prevValue) * 100);
      }
      if (monthlyData[sortedMonths[i]].value > peakValue) {
        peakValue = monthlyData[sortedMonths[i]].value;
        const [year, month] = sortedMonths[i].split('-');
        const date = new Date(parseInt(year), parseInt(month) - 1, 1);
        peakMonthName = date.toLocaleString('default', { month: 'long' });
      }
    }
    if (growthRates.length > 0) {
      avgGrowthRate = growthRates.reduce((sum, rate) => sum + rate, 0) / growthRates.length;
    }
  }
  
  // Calculate quarterly data
  const quarterlyData = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };
  data.forEach(contract => {
    if (!contract.parsedDate) return;
    const month = contract.parsedDate.getMonth();
    if (month >= 0 && month <= 2) quarterlyData.Q1 += contract.value;
    else if (month >= 3 && month <= 5) quarterlyData.Q2 += contract.value;
    else if (month >= 6 && month <= 8) quarterlyData.Q3 += contract.value;
    else quarterlyData.Q4 += contract.value;
  });
  
  // Find highest quarter
  const totalQuarterlySpend = Object.values(quarterlyData).reduce((sum, val) => sum + val, 0);
  const quarterlyPercentages = {};
  let highestQuarter = null;
  let highestPercentage = 0;
  
  if (totalQuarterlySpend > 0) {
    Object.entries(quarterlyData).forEach(([quarter, value]) => {
      const percentage = (value / totalQuarterlySpend) * 100;
      quarterlyPercentages[quarter] = percentage;
      if (percentage > highestPercentage) {
        highestPercentage = percentage;
        highestQuarter = quarter;
      }
    });
  }
  
  // Analyze agencies
  const agencyData = {};
  data.forEach(contract => {
    if (!contract.agency) return;
    if (!agencyData[contract.agency]) {
      agencyData[contract.agency] = {
        name: contract.agency,
        value: 0,
        count: 0,
        vendors: new Set()
      };
    }
    agencyData[contract.agency].value += contract.value;
    agencyData[contract.agency].count++;
    if (contract.vendor) agencyData[contract.agency].vendors.add(contract.vendor);
  });
  
  const agencies = Object.values(agencyData)
    .map(a => ({
      ...a,
      vendorCount: a.vendors.size
    }))
    .sort((a, b) => b.value - a.value);
  
  const highFrequencyAgencies = agencies
    .filter(a => a.count > 5)
    .sort((a, b) => b.count - a.count)
    .slice(0, 3)
    .map(a => a.name);
  
  // Update Spending Trends card
  updateSpendingTrendsCard(peakMonthName, highestQuarter, highestPercentage, avgGrowthRate);
  
  // Update Vendor Opportunities card
  updateVendorOpportunitiesCard(topVendor, vendors, highestQuarter);
  
  // Update Agency Intelligence card
  updateAgencyIntelligenceCard(agencies, highFrequencyAgencies);
  
  // Update Recommendations
  updateRecommendationsCard(agencies, highestQuarter, vendors, peakMonthName);
  
  // Update stats
  updateStatsSummary(data.length, totalValue, vendors.length, topVendor);
}

function updateSpendingTrendsCard(peakMonth, highestQuarter, highestPercentage, growthRate) {
  const trendMessage = document.getElementById('trend-message');
  const trendPoint1 = document.getElementById('trend-point-1');
  const trendPoint2 = document.getElementById('trend-point-2');
  const trendPoint3 = document.getElementById('trend-point-3');
  
  if (!trendMessage || !trendPoint1 || !trendPoint2 || !trendPoint3) return;
  
  // Format growth rate
  const growthRateFormatted = growthRate.toFixed(1);
  const growthSign = growthRate >= 0 ? '+' : '';
  
  // Set trend message based on growth rate
  if (growthRate > 5) {
    trendMessage.innerHTML = `Spending is <strong style="color: var(--success);">increasing</strong> by ${growthRateFormatted}% on average`;
  } else if (growthRate < -5) {
    trendMessage.innerHTML = `Spending is <strong style="color: var(--danger);">decreasing</strong> by ${Math.abs(growthRateFormatted)}% on average`;
  } else {
    trendMessage.innerHTML = `Spending is <strong>stable</strong> with ${Math.abs(growthRateFormatted)}% variance`;
  }
  
  // Set peak month
  trendPoint1.innerHTML = `Peak buying month: <strong>${peakMonth}</strong>`;
  
  // Set quarterly spend info
  if (highestQuarter) {
    trendPoint2.innerHTML = `${highestQuarter} accounts for <strong>${highestPercentage.toFixed(0)}%</strong> of annual spend`;
  } else {
    trendPoint2.innerHTML = `Quarterly data not available`;
  }
  
  // Set growth rate
  trendPoint3.innerHTML = `Month-over-month growth: <strong>${growthSign}${growthRateFormatted}%</strong>`;
}

function updateVendorOpportunitiesCard(topVendor, vendors, highestQuarter) {
  const vendorMessage = document.getElementById('vendor-message');
  const vendorPoint1 = document.getElementById('vendor-point-1');
  const vendorPoint2 = document.getElementById('vendor-point-2');
  const vendorPoint3 = document.getElementById('vendor-point-3');
  
  if (!vendorMessage || !vendorPoint1 || !vendorPoint2 || !vendorPoint3) return;
  
  // Set vendor message
  vendorMessage.textContent = `Top vendor opportunities:`;
  
  // Set top vendor info
  if (topVendor) {
    vendorPoint1.innerHTML = `<strong>${topVendor.name}</strong> has contracts with <strong>${topVendor.agencyCount}</strong> agencies`;
  } else {
    vendorPoint1.innerHTML = `No dominant vendor identified`;
  }
  
  // Set contract expiration prediction
  if (highestQuarter) {
    vendorPoint2.innerHTML = `Multi-year contracts likely expiring in <strong>${highestQuarter}</strong>`;
  } else {
    vendorPoint2.innerHTML = `Contract expiration data not available`;
  }
  
  // Set subcontracting opportunity
  if (vendors && vendors.length >= 3) {
    const top3Value = vendors.slice(0, 3).reduce((sum, v) => sum + v.value, 0);
    const formattedValue = utils.formatMoney(top3Value);
    vendorPoint3.innerHTML = `Subcontracting with <strong>top 3 primes</strong> can unlock <strong>${formattedValue}</strong>`;
  } else {
    vendorPoint3.innerHTML = `Diversify vendor relationships to expand market reach`;
  }
}

function updateAgencyIntelligenceCard(agencies, highFrequencyAgencies) {
  const agencyMessage = document.getElementById('agency-message');
  const agencyPoint1 = document.getElementById('agency-point-1');
  const agencyPoint2 = document.getElementById('agency-point-2');
  const agencyPoint3 = document.getElementById('agency-point-3');
  
  if (!agencyMessage || !agencyPoint1 || !agencyPoint2 || !agencyPoint3) return;
  
  // Set agency message
  agencyMessage.textContent = `Agency buying patterns:`;
  
  // Set top agency info
  if (agencies && agencies.length > 0) {
    const topAgency = agencies[0];
    agencyPoint1.innerHTML = `<strong>${topAgency.name}</strong> leads with <strong>${utils.formatMoney(topAgency.value)}</strong> in contract value`;
  } else {
    agencyPoint1.innerHTML = `No agency data available`;
  }
  
  // Set secondary agency info
  if (agencies && agencies.length > 1) {
    const secondAgency = agencies[1];
    agencyPoint2.innerHTML = `<strong>${secondAgency.name}</strong> has awarded <strong>${secondAgency.count}</strong> contracts worth <strong>${utils.formatMoney(secondAgency.value)}</strong>`;
  } else {
    agencyPoint2.innerHTML = `Limited agency diversity in dataset`;
  }
  
  // Set high frequency agencies
  if (highFrequencyAgencies && highFrequencyAgencies.length > 0) {
    const agencyNames = highFrequencyAgencies
      .map(name => `<strong>${name}</strong>`)
      .join(', ');
    
    agencyPoint3.innerHTML = `Agencies with most frequent buys: ${agencyNames}`;
  } else {
    agencyPoint3.innerHTML = `No agencies with high purchase frequency detected`;
  }
}

function updateRecommendationsCard(agencies, highestQuarter, vendors, peakMonth) {
  const rec1 = document.getElementById('recommendation-1');
  const rec2 = document.getElementById('recommendation-2');
  const rec3 = document.getElementById('recommendation-3');
  const rec4 = document.getElementById('recommendation-4');
  
  if (!rec1 || !rec2 || !rec3 || !rec4) return;
  
  // Recommendation 1: Target highest spending agency
  if (agencies && agencies.length > 0) {
    const topAgency = agencies[0];
    rec1.querySelector('p').innerHTML = `Engage contracting officers at <strong>${topAgency.name}</strong> for upcoming opportunities`;
  } else {
    rec1.querySelector('p').innerHTML = `Expand agency relationships to diversify customer base`;
  }
  
  // Recommendation 2: Focus on peak spending period
  if (highestQuarter) {
    rec2.querySelector('p').innerHTML = `Prepare sales pipeline for <strong>${highestQuarter}</strong> peak buying season`;
  } else {
    rec2.querySelector('p').innerHTML = `Analyze historical spending patterns to identify peak buying seasons`;
  }
  
  // Recommendation 3: Target subcontracting
  if (vendors && vendors.length > 0) {
    const topVendor = vendors[0];
    rec3.querySelector('p').innerHTML = `Target subcontracting opportunities with <strong>${topVendor.name}</strong> and other top vendors`;
  } else {
    rec3.querySelector('p').innerHTML = `Identify prime contractors for potential subcontracting partnerships`;
  }
  
  // Recommendation 4: Specific to the data
  if (peakMonth && peakMonth !== 'N/A') {
    rec4.querySelector('p').innerHTML = `Focus resources on <strong>${peakMonth}</strong> for highest contract win probability`;
  } else {
    rec4.querySelector('p').innerHTML = `Develop year-round engagement strategy with contracting officers`;
  }
}

function updateStatsSummary(contractCount, totalValue, vendorCount, topVendor) {
  const statContracts = document.getElementById('stat-contracts');
  const statValue = document.getElementById('stat-value');
  const statCompanies = document.getElementById('stat-companies');
  const statTopCompany = document.getElementById('stat-top-company');
  
  if (statContracts) {
    statContracts.textContent = contractCount.toLocaleString();
  }
  
  if (statValue) {
    statValue.textContent = utils.formatMoney(totalValue);
  }
  
  if (statCompanies) {
    statCompanies.textContent = vendorCount;
  }
  
  if (statTopCompany && topVendor) {
    statTopCompany.textContent = `${topVendor.name} (${topVendor.marketShare.toFixed(1)}%)`;
  } else if (statTopCompany) {
    statTopCompany.textContent = 'None';
  }
}

// Function to handle updates after filter changes
function updateInsightsAfterFilter() {
  filterManager.applyFilters();
  updateInsightBanner(app.filteredData, app.filters.psc);
  dashboardManager.refreshDashboard();
}

// Add event listener for refresh insights button
document.addEventListener('DOMContentLoaded', function() {
  const refreshInsightsBtn = document.getElementById('refreshInsights');
  if (refreshInsightsBtn) {
    refreshInsightsBtn.addEventListener('click', function() {
      updateInsightBanner(app.filteredData, app.filters.psc);
    });
  }
});
</script>
</body>
</html>